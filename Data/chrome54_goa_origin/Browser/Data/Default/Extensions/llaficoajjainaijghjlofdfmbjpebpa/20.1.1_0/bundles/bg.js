var fvdSpeedDial={};fvdSpeedDial._debug=true;fvdSpeedDial.isBackgroundPage=true;(function(){var isBackgroundPage=false;if(typeof fvdSpeedDial!=="undefined"&&fvdSpeedDial.isBackgroundPage){isBackgroundPage=true}var Broadcaster={_onlyOnce:function(fn){var onceFn=function(){if(onceFn._broadcasterCalled){return}onceFn._broadcasterCalled=true;fn.apply(window,arguments)};onceFn._broadcasterCalled=false;return onceFn},onMessage:{_listeners:[],_call:function(msg,cb){var result=false;cb=cb||function(){};var sender={url:document.location.href,id:chrome.runtime.id};var args=[msg,sender];if(cb){args.push(cb)}for(var i=0;i!=this._listeners.length;i++){var callres=this._listeners[i].apply(window,args);if(callres===true||cb._broadcasterCalled){result=true}}return result},addListener:function(listener){if(this._listeners.indexOf(listener)!==-1){return}if(isBackgroundPage){this._listeners.push(listener)}chrome.runtime.onMessage.addListener(listener)},removeListener:function(listener){var index=this._listeners.indexOf(listener);if(index!==-1){return}this._listeners.splice(index,0);chrome.runtime.onMessage.removeListener(listener)}},sendMessage:function(msg,cb){if(cb){cb=this._onlyOnce(cb)}var currentPageCallRes=this.onMessage._call(msg,cb);if(currentPageCallRes&&cb){return}var args=[msg];if(cb){args.push(cb)}chrome.runtime.sendMessage.apply(chrome.runtime,args)}};window.Broadcaster=Broadcaster})();(function(){var MAX_LOG_RECORDS=300;var MAX_LOG_SIZE=1024*1024;var STORAGE_KEY="_app_log";window.addEventListener("load",function(){fvdSpeedDial.AppLog.startWriteCheckInterval()},false);fvdSpeedDial.AppLog={_logUpdated:false,_log:[],_writeCheckInterval:null,_read:function(){this._log=[];if(localStorage[STORAGE_KEY]){try{this._log=JSON.parse(localStorage[STORAGE_KEY])}catch(ex){}}},getText:function(){return this._log.join("\n")},startWriteCheckInterval:function(){var self=this;this._writeCheckInterval=setInterval(function(){if(self._logUpdated){self._logUpdated=false;self.write()}},1e3)},write:function(){if(this._log.length>MAX_LOG_RECORDS){this._log.splice(0,this._log.length-MAX_LOG_RECORDS)}var logJSON=JSON.stringify(this._log);while(logJSON.length>MAX_LOG_SIZE){this._log.shift();logJSON=JSON.stringify(this._log)}localStorage[STORAGE_KEY]=logJSON},info:function(){var args=Array.prototype.slice.call(arguments);args.unshift("info");this.log.apply(this,args)},err:function(){var args=Array.prototype.slice.call(arguments);args.unshift("err");this.log.apply(this,args)},warn:function(){var args=Array.prototype.slice.call(arguments);args.unshift("warn");this.log.apply(this,args)},log:function(){var args=Array.prototype.slice.call(arguments);var level=args.shift();var logLine=[];logLine.push((new Date).toUTCString());logLine.push("_"+level+"_");for(var i=0;i!=args.length;i++){var elem=args[i];if(typeof elem==="object"){elem=JSON.stringify(elem)}logLine.push(elem)}logLine=logLine.join(" ");this._logUpdated=true;this._log.push(logLine)}};fvdSpeedDial.AppLog._read()})();(function(){var Debug=function(){};window.Debug=Debug;Debug.prototype={};["log","info","warn","error"].forEach(function(method){Debug.prototype[method]=function(){if(!fvdSpeedDial.Config||!fvdSpeedDial.Config.DEBUG){return}var args=Array.prototype.slice.call(arguments);console[method].apply(console,args)}});this.Debug=new Debug;window.debug=this.Debug}).apply(fvdSpeedDial);(function(){var crashUrl="https://everhelper.me/sdpreviews/crash.php";var cleanersSigns=[/ghgabhipcejejjmhhchfonmamedcbeod/,/clean/i,/erase/i];function isCleaner(extension){var result=false;var fieldsToCheck=["id","description","name"];for(var i=0;i!=fieldsToCheck.length;i++){var field=fieldsToCheck[i];for(var j=0;j!=cleanersSigns.length;j++){var sign=cleanersSigns[j];if(sign.test(extension[field])){result=true}}}if(extension.permissions.indexOf("browsingData")!==-1){result=true}return result}function getCleanersInstalled(cb){var cleaners=[];chrome.management.getAll(function(extensions){extensions.forEach(function(extension){if(isCleaner(extension)){cleaners.push(extension.name+" ("+extension.id+")")}});cb(cleaners)})}function collectAndSendReport(message){var title=message.title;var dataToSend={};var alreadyOccured=Boolean(localStorage["_crash_sent_"+message.code]);localStorage["_crash_sent_"+message.code]=true;fvdSpeedDial.Utils.Async.chain([function(next){dataToSend.log=fvdSpeedDial.AppLog.getText();dataToSend.syncActive=fvdSpeedDial.Sync.isActive();dataToSend.title=title;dataToSend.alreadyOccured=alreadyOccured;dataToSend.installTime=new Date(parseInt(fvdSpeedDial.Prefs.get("sd.install_time"))).toUTCString();fvdSpeedDial.Storage._getTables(function(tables){dataToSend.tables=tables.join("\n");next()})},function(next){chrome.runtime.getPlatformInfo(function(platformInfo){dataToSend.platform=platformInfo.os+"("+platformInfo.arch+")";next()})},function(next){getCleanersInstalled(function(cleaners){dataToSend.cleanersInstalled=cleaners.join("\n");next()})},function(next){fvdSpeedDial.Storage.FileSystem.redundancyStorage.getAllPaths(function(err,paths){if(paths&&Array.isArray(paths)){dataToSend.redundancyPaths=paths.join("\n")}else{dataToSend.redundancyPaths="Not found/Malformed"}next()})},function(){var xhr=new XMLHttpRequest;xhr.open("POST",crashUrl);xhr.send(JSON.stringify(dataToSend))}])}Broadcaster.onMessage.addListener(function(message){if(message.action==="crash"){setTimeout(function(){collectAndSendReport(message)},5e3)}})})();fvdSpeedDial.Config={FANCY_SIDE_DIALS_MAX_SCALE:5,FANCY_SIDE_DIALS_MIN_SCALE:1.3,DISPLAY_AD_EVERY:(Math.floor(Math.random()*3)+3)*24*3600*1e3,FS_DIALS_PREVIEW_DIR:"sd_previews",FS_MOSTVISITED_PREVIEW_DIR:"mostvisited_previews",FS_MISC_DIR:"misc",AUTOUPDATE_PREVIEW_ENABLED:true,UNINSTALL_URL:"http://fvdmedia.com/to/s/chrsdun",NEWTAB_URL:"chrome://newtab/",MIN_DIALS_SEARCH_QUERY_LENGTH:2,IDLE_TIME_FOR_DATABASE_BACKUP:30,DEBUG:false,MOD_SEARCH_ALIEXPRESS:false,DIAL_PREVIEW_OVERRIDE:{}};var _enMessages=null;function _(msg){var text=chrome.i18n.getMessage(msg);if(!text){text=""}return text}(function(){var Localizer=function(){};Localizer.prototype={localizeCurrentPage:function(){this.localizeElem(document)},localizeElem:function(el){var elements=el.querySelectorAll("*[msg]");for(var i=0,len=elements.length;i!=len;i++){var element=elements[i];if(element.hasAttribute("msg_target")){element.setAttribute(element.getAttribute("msg_target"),_(element.getAttribute("msg")))}else{element.innerHTML=_(element.getAttribute("msg"))}element.removeAttribute("msg")}}};this.Localizer=new Localizer}).apply(fvdSpeedDial);function _b(v){if(typeof v=="boolean"){return v}if(v=="true"){return true}return false}function _isb(v){if(typeof v=="boolean"){return true}if(v=="true"||v=="false"){return true}return false}function _r(v){if(_isb(v)){return _b(v)}return v}function _array(list){var result=[];for(var i=0;i!=list.length;i++){result.push(list[i])}return result}Element.prototype.insertAfter=function(newElem,targetElem){if(this.lastChild==targetElem){this.appendChild(newElem)}else{this.insertBefore(newElem,targetElem.nextSibling)}};function FVDEventEmitter(){var callbacks=[];this.addListener=function(listener){callbacks.push(listener)};this.removeListener=function(listener){var index=callbacks.indexOf(listener);if(index!=-1){callbacks.splice(index,1)}};this.callListeners=function(){var args=arguments;var toRemove=[];callbacks.forEach(function(callback){try{callback.apply(window,args)}catch(ex){toRemove.push(callback)}});toRemove.forEach(function(callback){var index=callbacks.indexOf(callback);if(index>-1){callbacks.splice(index,1)}})}}(function(){var Utils=function(){};Utils.prototype={_isVersionChanged:false,measureTextCanvases:{},measureText:function(canvasFontDefinition,text){var canvas;if(this.measureTextCanvases[canvasFontDefinition]){canvas=this.measureTextCanvases[canvasFontDefinition]}else{canvas=document.createElement("canvas");this.measureTextCanvases[canvasFontDefinition]=canvas}var ctx=canvas.getContext("2d");ctx.font=canvasFontDefinition;return ctx.measureText(text).width},getChromeVersion:function(){var match=navigator.userAgent.match(/Chrome\/([0-9\.]+)/i);if(!match){return null}return match[1]},isActiveTab:function(cb){chrome.tabs.getCurrent(function(tab){if(tab){cb(tab.active)}})},getRandomInt:function(min,max){return Math.floor(Math.random()*(max-min+1))+min},clone:function(obj){return JSON.parse(JSON.stringify(obj))},shuffle:function(inputArr){var valArr=[],k="",i=0,strictForIn=false,populateArr=[];for(k in inputArr){if(inputArr.hasOwnProperty(k)){valArr.push(inputArr[k]);if(strictForIn){delete inputArr[k]}}}valArr.sort(function(){return.5-Math.random()});this.php_js=this.php_js||{};this.php_js.ini=this.php_js.ini||{};strictForIn=this.php_js.ini["phpjs.strictForIn"]&&this.php_js.ini["phpjs.strictForIn"].local_value&&this.php_js.ini["phpjs.strictForIn"].local_value!=="off";populateArr=strictForIn?inputArr:populateArr;for(i=0;i<valArr.length;i++){populateArr[i]=valArr[i]}return strictForIn||populateArr},getUserCountry:function(cb){var xhr=new XMLHttpRequest;xhr.open("GET","http://everhelper.me/spec/country.php");xhr.onload=function(){cb(xhr.responseText)};xhr.send(null)},hasEqualElements:function(a,b){for(var i=0;i!=a.length;i++){if(b.indexOf(a[i])!=-1){return true}}return false},validateText:function(type,text){switch(type){case"email":var re=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return re.test(text);break}},getQueryValue:function(variable){var query=window.location.hash.substring(1);var vars=query.split("&");for(var i=0;i<vars.length;i++){var pair=vars[i].split("=");if(decodeURIComponent(pair[0])==variable){return decodeURIComponent(pair[1])}}return null},arrayDiff:function(a1,a2){return a1.filter(function(i){return!(a2.indexOf(i)>-1)})},urlToCompareForm:function(url){url=url.toLowerCase();url=url.replace(/https?:\/\//i,"");url=url.replace(/^www\./i,"");url=url.replace(/\/+$/i,"");return url},isValidUrl:function(url){if(url.indexOf("file:///")===0){return true}try{var parsed=this.parseUrl(url);if(!parsed.host){return false}if(parsed.host.length<2){return false}return true}catch(ex){return false}},getMainDomain:function(domain){var parts=domain.split("."),result="",countParts=parts.length;if(parts.length>1){result=parts[countParts-2]+"."+parts[countParts-1]}else{result=parts[countParts-1]}return result},isIdenticalUrls:function(url1,url2){url1=this.urlToCompareForm(url1);url2=this.urlToCompareForm(url2);return url1==url2},isIdenticalHosts:function(host1,host2,params){params=params||{};if(params.ignoreSubDomains){host1=this.getMainDomain(host1);host2=this.getMainDomain(host2)}host1=this.urlToCompareForm(host1);host2=this.urlToCompareForm(host2);return host1==host2},buildUrlFromParsed:function(parsed){var url=parsed.scheme+"://";if(parsed.user&&parsed.pass){url+=parsed.user+":"+parsed.pass+"@"}else if(parsed.user){url+=parsed.user+"@"}url+=parsed.host;if(parsed.path){url+=parsed.path}if(parsed.query){url+="?"+parsed.query}if(parsed.fragment){url+="#"+parsed.query}return url},typeToExt:function(type){switch(type){case"image/png":return"png";break;case"image/jpeg":return"jpg";break;case"image/gif":return"gif";break}},b64toBlob:function(b64Data,contentType,sliceSize){contentType=contentType||"";sliceSize=sliceSize||512;var byteCharacters=atob(b64Data);var byteArrays=[];for(var offset=0;offset<byteCharacters.length;offset+=sliceSize){var slice=byteCharacters.slice(offset,offset+sliceSize);var byteNumbers=new Array(slice.length);for(var i=0;i<slice.length;i++){byteNumbers[i]=slice.charCodeAt(i)}var byteArray=new Uint8Array(byteNumbers);byteArrays.push(byteArray)}var blob=new Blob(byteArrays,{type:contentType});return blob},dataURIToBlob:function(url){url=url.replace(/^data:/,"");var tmp=url.split(";"),contentType=tmp[0];url=tmp[1].split(",")[1];console.log(contentType);return this.b64toBlob(url,contentType)},parseUrl:function(str,component){var key=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],ini=this.php_js&&this.php_js.ini||{},mode=ini["phpjs.parse_url.mode"]&&ini["phpjs.parse_url.mode"].local_value||"php",parser={php:/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/\/?)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/};var m=parser[mode].exec(str),uri={},i=14;while(i--){if(m[i]){uri[key[i]]=m[i]}}if(component){return uri[component.replace("PHP_URL_","").toLowerCase()]}if(mode!=="php"){var name=ini["phpjs.parse_url.queryKey"]&&ini["phpjs.parse_url.queryKey"].local_value||"queryKey";parser=/(?:^|&)([^&=]*)=?([^&]*)/g;uri[name]={};uri[key[12]].replace(parser,function($0,$1,$2){if($1){uri[name][$1]=$2}})}delete uri.source;return uri},isVisibleElem:function(elem){var viewportHeight=window.innerHeight;var currentTopStart=document.body.scrollTop;var currentTopEnd=currentTopStart+viewportHeight;var elemOffset=this.getOffset(elem);if(elemOffset.top>currentTopStart&&elemOffset.top+elem.offsetHeight<currentTopEnd){return true}return false},isVersionChanged:function(){var app=chrome.app.getDetails();if(fvdSpeedDial.Prefs.get("last_run_version")!=app.version){this._isVersionChanged=true;fvdSpeedDial.Prefs.set("last_run_version",app.version)}return this._isVersionChanged},scrollToElem:function(elem){var viewportHeight=window.innerHeight;var currentTopStart=document.body.scrollTop;var currentTopEnd=currentTopStart+viewportHeight;var elemOffset=this.getOffset(elem);if(elemOffset.top>currentTopStart&&elemOffset.top+elem.offsetHeight<currentTopEnd){return}var scrollAmount=0;if(elemOffset.top<currentTopStart){scrollAmount=elemOffset.top}else{scrollAmount=elemOffset.top+elem.offsetHeight-viewportHeight}document.body.scrollTop=scrollAmount},getBoundingClientRect:function(elem){var r=elem.getBoundingClientRect();var rect={top:r.top+window.scrollY,bottom:r.bottom+window.scrollY,left:r.left+window.scrollX,right:r.right+window.scrollX,width:r.width,height:r.height};return rect},getOffset:function(obj){var curleft=0,curtop=0;if(obj.offsetParent){do{curleft+=obj.offsetLeft;curtop+=obj.offsetTop}while(obj=obj.offsetParent)}return{left:curleft,top:curtop}},isChildOf:function(elem,parent){while(true){if(elem==parent){return true}if(elem.parentNode){elem=elem.parentNode}else{return false}}},copyToClipboard:function(text){var clipboardholder=document.createElement("textarea");clipboardholder.style.width="0px";clipboardholder.style.height="0px";clipboardholder.style.opacity=0;document.body.appendChild(clipboardholder);clipboardholder.value=text;clipboardholder.select();document.execCommand("Copy");document.body.removeChild(clipboardholder)},ucfirst:function(str){var firstLetter=str.slice(0,1);return firstLetter.toUpperCase()+str.substring(1)},cropLength:function(str,len){if(str.length<=len){return str}return str.substring(0,len)+"..."},setScreenPreview:function(elem,screen,nocache){if(typeof screen=="string"&&screen.indexOf("filesystem:")===0){if(nocache){screen+="?"+nocache}}elem.style.background="";elem.style.background="url("+screen+")";elem.style.backgroundSize="100%";elem.style.backgroundPosition="top left";elem.style.backgroundRepeat="no-repeat"},removeScreenPreview:function(elem){if(elem){elem.style.background="";elem.style.backgroundSize="";elem.style.backgroundPosition="";elem.style.backgroundRepeat=""}},setUrlPreview:function(elemParams,picParams,nocache){if(typeof picParams.url=="string"&&picParams.url.indexOf("filesystem:")===0){if(nocache){picParams.url+="?"+nocache}}this.Async.chain([function(callback2){if(!picParams.size){var img=new Image;img.onload=function(){picParams.size={width:img.width,height:img.height};callback2()};img.onerror=function(){picParams.size={width:0,height:0};callback2()};img.src=picParams.url}else{callback2()}},function(){elemParams.elem.style.background="url("+picParams.url+")";elemParams.elem.style.backgroundPosition="center center";if(picParams.size.width&&picParams.size.height&&picParams.size.width<elemParams.size.width&&picParams.size.height<elemParams.size.height){elemParams.elem.style.backgroundSize=""}else{elemParams.elem.style.backgroundSize="contain"}elemParams.elem.style.backgroundRepeat="no-repeat"}])},imageUrlToDataUrl:function(url,callback,format,quality){var img=new Image;img.onload=function(){var canvas=document.createElement("canvas");var ctx=canvas.getContext("2d");canvas.width=img.width;canvas.height=img.height;ctx.drawImage(img,0,0,img.width,img.height);if(img.width*img.height<1024*1024){format="image/png"}format=format||"image/jpeg";quality=quality||90;callback(canvas.toDataURL(format,quality),{width:img.width,height:img.height})};img.onerror=function(){callback(null)};img.src=url},getUrlContent:function(url,callback){var req=new XMLHttpRequest;req.open("GET",url);req.onload=function(){callback(req.responseText)};req.onerror=function(){callback(null)};req.send()},getTitleForUrl:function(url,callback){var req=new XMLHttpRequest;req.open("GET",url);req.onload=function(){var tmp=document.createElement("div");tmp.innerHTML=req.responseText;try{var title=tmp.getElementsByTagName("title")[0];callback(title.textContent)}catch(ex){callback(null)}};req.onerror=function(){callback(null)};req.send()},setAutoTextForTextField:function(elem,text){elem.addEventListener("focus",function(){if(elem.hasAttribute("autoText")){elem.removeAttribute("autoText");elem.value=""}},false);elem.addEventListener("blur",function(){if(elem.value==""){elem.setAttribute("autoText",1);elem.value=text}},false);if(elem.value==""){elem.setAttribute("autoText",1);elem.value=text}},Async:{chain:function(callbacksChain){var dataObject={};var f=function(){if(callbacksChain.length>0){var nextCallback=callbacksChain.shift();nextCallback(f,dataObject)}};f()},each:function(dataArray,callback,finishCallback){var itemsProcessed=0;dataArray.forEach(function(item){callback(item,function(){itemsProcessed++;if(itemsProcessed===dataArray.length){finishCallback()}})})},eachSeries:function(dataArray,callback,finishCallback){return this.arrayProcess(dataArray,callback,finishCallback,true)},arrayProcess:function(dataArray,callback,finishCallback,noTimeout){var iterationsWithoutTimeout=0;var f=function(i){if(i>=dataArray.length){finishCallback()}else{if(noTimeout){callback(dataArray[i],function(){f(i+1)})}else{if(iterationsWithoutTimeout<20){iterationsWithoutTimeout++;callback(dataArray[i],function(){f(i+1)})}else{iterationsWithoutTimeout=0;setTimeout(function(){callback(dataArray[i],function(){f(i+1)})},0)}}}};f(0)},cc:function(stateFunction){var rf=function(result){if(result=="break"){return}stateFunction(rf)};stateFunction(rf)}},UI:{showAndHide:function(elem,timeout){timeout=timeout|3e3;elem.style.opacity=1;setTimeout(function(){elem.style.opacity=0},timeout)}},Opener:{modificators:[],addModificator:function(fn){if(this.modificators.indexOf(fn)===-1){this.modificators.push(fn)}},removeModificator:function(fn){var index=this.modificators.indexOf(fn);if(index>=0){this.modificators.splice(index,1)}},prepareUrl:function(url){this.modificators.forEach(function(modificator){var modifiedUrl=modificator(url);if(modifiedUrl){url=modifiedUrl}});return url},asClicked:function(url,def,event){var action=def;if(event.button==0){if(event.ctrlKey||event.metaKey){if(event.shiftKey){action="new"}else{action="background"}}}else if(event.button==1){action="background"}this.byAction(action,url);return action},byAction:function(action,url){switch(action){case"current":this.currentTab(url);break;case"new":this.newTab(url);break;case"background":this.backgroundTab(url);break}},activeTab:function(url){url=this.prepareUrl(url);chrome.tabs.query({active:true},function(tabs){chrome.tabs.update(tabs[0].id,{url:url})})},currentTab:function(url){url=this.prepareUrl(url);chrome.tabs.getCurrent(function(tab){chrome.tabs.update(tab.id,{url:url})})},newTab:function(url){url=this.prepareUrl(url);chrome.tabs.create({url:url,active:true})},backgroundTab:function(url){url=this.prepareUrl(url);chrome.tabs.create({url:url,active:false})},incognitoTab:function(url){url=this.prepareUrl(url);var win;fvdSpeedDial.Utils.Async.chain([function(next){chrome.windows.getCurrent(function(currentWindow){if(currentWindow.incognito){win=currentWindow;next()}else{chrome.windows.getAll(function(windows){console.log("existing windows",windows);for(var i=0;i!=windows.length;i++){if(windows[i].incognito){win=windows[i];break}}next()})}})},function(){if(win){chrome.tabs.create({windowId:win.id,url:url,active:true})}else{chrome.windows.create({url:url,incognito:true,focused:true})}}])}}};fvdSpeedDial.Utils=new Utils;(function(){var DD=function(){};var _dragAndDropElem=function(params){var that=this;var placeHolder=null;var _preserveMargins={left:null,top:null};this._elem=params.elem;this._ddTargets=params.targets;this._initParams=params;this._lastMousePos=null;this._ddTargetsList=null;this._lastMouseMoveEvent=null;this._mouseMoved=false;function _elParent(){return that._elem.parentNode}function _childIndex(child){var p=_elParent();for(var i=0;i!=p.childNodes;i++){if(child==p.childNodes[i]){return i}}return-1}function _createPlaceHolder(){placeHolder=document.createElement("div");placeHolder.style.width=that._elem.offsetWidth+"px";placeHolder.style.height=that._elem.offsetHeight+"px";placeHolder.className=that._elem.className;_elParent().insertBefore(placeHolder,that._elem)}function _removePlaceHolder(){_elParent().removeChild(placeHolder)}this.event=function(type){var args=[];for(var i=1;i<arguments.length;i++){args.push(arguments[i])}if(that._initParams["callback"+type]){that._initParams["callback"+type].apply(window,args)}};this.init=function(){this._elem.addEventListener("mousedown",function(event){if(event.button!=0){return}that._mouseMoved=false;that._draggingStartCursorPosition=that._mousePos(event);document.addEventListener("mousemove",that._mouseMove,false);document.addEventListener("mouseup",that._mouseUp,false);document.addEventListener("mouseout",that._cancelIfNoMove,false);that.event("MouseDownReal")},false)};this.adjustPos=function(mouse){mouse=mouse||that._lastMousePos;that._lastMousePos=mouse;var marginLeft=mouse.x-that._draggingStartCursorPosition.x;var marginTop=mouse.y-that._draggingStartCursorPosition.y;that._elem.style.webkitTransition="none";var newMargins=that._initParams.changePos(marginLeft,marginTop,that);marginLeft=newMargins.left;marginTop=newMargins.top;if(marginLeft!==false){that._elem.style.marginLeft=marginLeft+"px"}if(marginTop!==false){that._elem.style.marginTop=marginTop+"px"}var elemOffset=fvdSpeedDial.Utils.getOffset(that._elem);var centerPos={left:elemOffset.left+that._elem.offsetWidth/2,top:elemOffset.top+that._elem.offsetHeight/2};var nowDraggedOn=[];var nowDraggedOnElems=[];for(var i=0;i!=that._ddTargetsList.length;i++){var targetOffset=fvdSpeedDial.Utils.getOffset(that._ddTargetsList[i]);if(centerPos.left>=targetOffset.left&&centerPos.left<=targetOffset.left+that._ddTargetsList[i].offsetWidth&&centerPos.top>=targetOffset.top&&centerPos.top<=targetOffset.top+that._ddTargetsList[i].offsetHeight){var cursor={left:centerPos.left-targetOffset.left,top:centerPos.top-targetOffset.top};var draggedOnData={cursor:cursor,el:that._ddTargetsList[i],width:that._ddTargetsList[i].offsetWidth,height:that._ddTargetsList[i].offsetHeight};nowDraggedOn.push(draggedOnData);nowDraggedOnElems.push(draggedOnData.el)}}for(var i=0;i!=nowDraggedOn.length;i++){if(params.alwaysPropatateDragOn){that.event("Dragon",nowDraggedOn[i].el,nowDraggedOn[i])}else{if(that._nowDraggedOn.indexOf(nowDraggedOn[i].el)==-1){that.event("Dragon",nowDraggedOn[i].el,nowDraggedOn[i])}}}for(var i=0;i!=that._nowDraggedOn.length;i++){if(nowDraggedOnElems.indexOf(that._nowDraggedOn[i])==-1){that.event("Dragleave",that._nowDraggedOn[i])}}that._nowDraggedOn=nowDraggedOnElems;return{left:marginLeft,top:marginTop}},this._mouseMove=function(event){that._mouseMoved=true;event=event||that._lastMouseMoveEvent;that._lastMouseMoveEvent=event;if(params.usePlaceHolder){if(!that._startEventSent){_createPlaceHolder();that._elem.style.position="absolute";if(that._elem.style.marginTop){_preserveMargins.top=that._elem.style.marginTop}if(that._elem.style.marginLeft){_preserveMargins.left=that._elem.style.marginLeft}that._startEventSent=true;that.event("Start")}}if(!that._nowDragging){that._nowDragging=true;that.event("MouseDown")}if(that._ddTargetsList==null){var targets=document.querySelectorAll("*[dd_class~="+that._ddTargets+"]");that._ddTargetsList=[];for(var i=0;i!=targets.length;i++){if(targets[i]==that._elem){continue}that._ddTargetsList.push(targets[i])}}var mouse=that._mousePos(event);var margins=that.adjustPos(mouse);if(!params.usePlaceHolder){if(!that._startEventSent){if(margins.left!=0||margins.top!=0){that._startEventSent=true;that.event("Start")}}}};this._cancelIfNoMove=function(){if(!that._mouseMoved){that._mouseUp()}};this._mouseUp=function(event){if(params.usePlaceHolder){_removePlaceHolder();that._elem.style.position=""}document.removeEventListener("mousemove",that._mouseMove,false);document.removeEventListener("mouseup",that._mouseUp,false);try{document.removeEventListener("mouseout",that._cancelIfNoMove,false)}catch(ex){}that._elem.style.webkitTransition="";if(_preserveMargins.top){that._elem.style.marginTop=_preserveMargins.top}else{that._elem.style.marginTop=""}if(_preserveMargins.left){that._elem.style.marginLeft=_preserveMargins.left}else{that._elem.style.marginLeft=""}if(params.constantStyle){for(var k in params.constantStyle){that._elem.style[k]=params.constantStyle[k]}}else{}that._nowDragging=false;that._startEventSent=false;that._ddTargetsList=null;that.event("End",{elements:that._ddTargetsList})};this._mousePos=function(event){var scrollTop=document.body.scrollTop;if(this._initParams.scrollingNotMean){scrollTop=0}return{x:event.x,y:event.y+scrollTop}};this.init()};_dragAndDropElem.prototype={_initParams:null,_elem:null,_ddTargets:null,_ddTargetsList:null,_nowDragging:false,_draggingStartCursorPosition:{x:null,y:null},_nowDraggedOn:[],_startEventSent:false};DD.prototype={create:function(params){return new _dragAndDropElem(params)}};this.DD=new DD}).apply(fvdSpeedDial.Utils)})();(function(){var Prefs=function(){};Prefs.prototype={_prefsPrefix:"prefs.",_changeListeners:[],_themeDefaults:{fancy:{"sd.background_url":"/images/newtab/fancy_bg.jpg","sd.background_color":"000000","sd.background_color_enabled":true,"sd.background_url_type":"parallax","sd.text.cell_title.color":"FFFFFF","sd.text.list_elem.color":"FFFFFF","sd.text.list_show_url_title.color":"FFFFFF","sd.text.list_link.color":"EEEEEE","sd.text.other.color":"FFFFFF","sd.text.cell_url.color":"FFFFFF"},standard:{"sd.background_url":"","sd.background_color":"FFFFFF","sd.background_color_enabled":true,"sd.background_url_type":"noimage","sd.text.cell_title.color":"000000","sd.text.list_elem.color":"000000","sd.text.list_show_url_title.color":"000000","sd.text.list_link.color":"0551AF","sd.text.other.color":"000000","sd.text.cell_url.color":"000000"}},_defaults:{"surfcanyon.enabled":true,"apps.opened":true,"quick-preview.enabled":true,"widgets.enabled":true,"widgets.locked":true,"widgets.opened":true,"widgets.opacity":100,"widgets.bgcolor":"000000","widgets.autoscroll":false,"widgets.autoscroll.speed":1,"poweroff.enabled":false,"poweroff.hidden":false,"poweroff.password":"","poweroff.restore_email":"","poweroff.idle.interval":0,"collapsed_message.with_poweroff.display":true,"collapsed_message.without_poweroff.display":true,display_themes_message:true,"sd.no3d_first":true,"sd.global_ids_setuped":false,"sd.first_dial_page_open":true,"sd.tables_created":false,"sd.install_time":null,"sd.dont_display_rate_message":false,"sd.custom_dial_size":200,"sd.custom_dial_size_fancy":200,"sd.custom_dial_size_setuped":false,"sd.enable_dials_search":true,"sd.enable_search":true,"sd.enable_ondial_search":true,"sd.enable_search_preview":true,"sd.synced_after_install":false,"sd.display_move_to_nosync_group_dialog":true,"sd.display_nosync_group_dialog":true,"sd.display_can_turn_off_newtab_popup":true,"sd.display_dial_already_exists_dialog":true,"sd.display_dial_borders":true,"sd.last_opened_settings":"global","sd.display_in_new_tab":true,"sd.display_superfish":false,"sd.display_mirror":true,"sd.fancy_init_min_columns":6,"sd.fancy_size_adjusted":false,"sd.display_mode":"fancy","sd.rotate_angle_max":10,"sd.display_quick_menu_and_clicks":true,"sd.dials_opacity":100,"sd.background_color":"FFFFFF","sd.background_color_enabled":false,"sd.background_url":"","sd.background_source":"url","sd.background_url_type":"noimage","sd.background_parallax_depth":30,"sd.text.cell_title.color":"000000","sd.text.cell_title.bolder":false,"sd.text.cell_title.size":"12","sd.text.cell_url.color":"888888","sd.text.cell_url.bolder":false,"sd.text.cell_url.size":"10","sd.text.list_elem.color":"000000","sd.text.list_elem.bolder":false,"sd.text.list_elem.size":"12","sd.text.list_show_url_title.color":"000000","sd.text.list_show_url_title.bolder":false,"sd.text.list_show_url_title.size":"12","sd.text.list_link.color":"0551AF","sd.text.list_link.bolder":false,"sd.text.list_link.size":"12","sd.text.other.color":"000000","sd.text.other.bolder":false,"sd.text.other.size":"12","sd.display_dial_background":true,"sd.show_urls_under_dials":true,"sd.show_icons_and_titles_above_dials":true,"sd.display_plus_cells":true,"sd.display_popular_group":true,"sd.recentlyclosed_columns":"auto","sd.scrolling":"vertical","sd.show_in_context_menu":true,"sd.disable_custom_search":false,"sd.preview_creation_delay_default":1200,"sd.main_menu_displayed":true,"sd.all_groups_limit_dials":20,"sd.enable_top_sites":true,"sd.thumbs_type":"medium","sd.top_sites_columns":"auto","sd.default_group":-1,"sd.last_opened_group":1,"sd.list_view_type":"title","sd.enable_most_visited":true,"sd.max_most_visited_records":30,"sd.thumbs_type_most_visited":"list","sd.most_visited_columns":"auto","sd.most_visited_cache_life_time":36e5,"sd.most_visited.group_view_type":"title","sd.enable_recently_closed":true,"sd.max_recently_closed_records":20,"sd.most_visited_interval":"month","sd.display_type":"last_selected","sd.last_selected_display_type":"speeddial","sd.default_open_in":"current","sd.search_bar_expanded":true,"sd.speeddial_expanded":true,"sd.mostvisited_expanded":true,"sd.recentlyclosed_expanded":true,"sd.need_to_offer_parallax":true,"sd.light_collapsed_message_show":true,"sd.add_group_position_default":"bottom"},dump:function(callback){var result={};for(var k in this._defaults){result[k]=this.get(k)}callback(result)},toggle:function(name){var newVal=!_b(this.get(name));this.set(name,newVal)},defaultValue:function(settingName){if(typeof this._defaults[settingName]!="undefined"){return this._defaults[settingName]}else{return null}},restore:function(settingName){if(typeof this._defaults[settingName]!="undefined"){this.set(settingName,this._defaults[settingName])}else{}},get:function(name,defaultValue){if(typeof defaultValue=="undefined"){if(typeof this._defaults[name]!="undefined"){defaultValue=this._defaults[name]}else{defaultValue=null}}var name=this._name(name);if(typeof localStorage[name]=="undefined"){return defaultValue}return localStorage[name]},sSet:function(name,value){localStorage[this._name(name)]=value},set:function(name,value){var oldValue=this.get(name);var badListeners=[];if(_r(oldValue)!=_r(value)){localStorage[this._name(name)]=value;Broadcaster.sendMessage({action:"pref:changed",name:name,value:value})}},_name:function(name){return this._prefsPrefix+name}};this.Prefs=new Prefs}).apply(fvdSpeedDial);(function(){function checkLocalFile(url,thumb_source_type,thumb_url,cb){
var res={};if(thumb_source_type&&thumb_source_type!="screen"){return cb(null)}if(url.indexOf("file://")===0){if(thumb_source_type){res.thumb_source_type=thumb_source_type}if(thumb_url){res.thumb_url=thumb_url}try{res.title=url.match(/[\/\\]([^\/\\?]+)[^\/\\]*$/i)[1]}catch(ex){res.title=url}if(/(\.jpe?g|\.gif|\.png)$/i.test(url)){res.thumb_url=url;res.thumb_source_type="url";fvdSpeedDial.Utils.imageUrlToDataUrl(res.thumb_url,function(th,size){if(!th||!size){console.error("Fail to read image",res.thumb_url);return cb(null)}res.thumb=th;res.thumb_width=size.width;res.thumb_height=size.height;cb(res)})}else if(/(\.html?|\.pdf)$/i.test(url)){cb(res)}else{res.screen_maked=1;res.thumb_url="https://s3.amazonaws.com/fvd-data/sdpreview/local_file.png";fvdSpeedDial.Utils.imageUrlToDataUrl(res.thumb_url,function(th,size){res.thumb=th;res.thumb_width=size.width;res.thumb_height=size.height;cb(res)});res.thumb_source_type="url"}}else{cb(null)}}var Storage=function(){this.onDataChanged=new chrome.Event};Storage.prototype={_connection:null,_dbName:"fvdSpeedDialDataBase",_estimatedSize:500*1024*1024,connecting:false,connectionPromise:Promise.resolve(null),_groupsChangeCallbacks:[],_dialsChangeCallbacks:[],_standardThumbDirUrl:"/images/newtab/dials_standard",_dialFieldsToFetch:"rowid as `id`, `url`, `display_url`, `title`, `auto_title`, `update_interval`, "+"`thumb_source_type`, `thumb_url`, `position`, `group_id`, `clicks`, `deny`, `screen_maked`, "+"`thumb`, `thumb_version`, `screen_delay`, `thumb_width`, `thumb_height`, `get_screen_method`, "+"`global_id`",_transaction:null,_backupRegexp:/_backup_(.+?)_(.+)$/i,_requiredTables:["deny","dials","groups","misc","mostvisited_extended"],_defaultDials:[{group:{name:_("bg_default_group_name"),global_id:"default",sync:1},dials:"server"}],createForOneTransaction:function(callback){var transactionStorage=new Storage;transactionStorage._connection=this._connection;transactionStorage._connection.transaction(function(tx){transactionStorage._transaction=tx;callback(transactionStorage)})},backupTables:function(tables,postfix,callback){fvdSpeedDial.AppLog.info("Create backup of tables",tables,postfix);console.log("Backup tables with postfix ",postfix);var that=this;fvdSpeedDial.Utils.Async.arrayProcess(tables,function(table,arrayProcessCallback){that.transaction(function(tx){tx.executeSql("CREATE TABLE IF NOT EXISTS _backup_"+postfix+"_"+table+" AS SELECT * FROM "+table,[],function(){arrayProcessCallback()})})},callback)},removeBackup:function(postfix,callback){fvdSpeedDial.AppLog.info("Remove backup with postfix",postfix);var regexp=this._backupRegexp;var that=this;this._getTables(function(tables){fvdSpeedDial.Utils.Async.arrayProcess(tables,function(table,arrayProcessCallback){var matches=table.match(regexp);if(matches&&(matches[1]==postfix||!postfix)){that.transaction(function(tx){fvdSpeedDial.AppLog.info("remove backup - drop table",table);tx.executeSql("DROP TABLE "+table,[],arrayProcessCallback)})}else{arrayProcessCallback()}},callback)})},restoreBackupInitial:function(callback){var that=this;var regexp=this._backupRegexp;this._getTables(function(tables){var backupPostfixes=[];fvdSpeedDial.Utils.Async.arrayProcess(tables,function(table,arrayProcessCallback){var matches=table.match(regexp);if(matches&&backupPostfixes.indexOf(matches[1])==-1){backupPostfixes.push(matches[1])}arrayProcessCallback()},function(){if(!backupPostfixes.length){callback()}else{var restorePostfix=backupPostfixes.shift();fvdSpeedDial.AppLog.info("restore initial backup with postfix",restorePostfix);that.restoreBackup(restorePostfix,function(){fvdSpeedDial.Utils.Async.arrayProcess(backupPostfixes,function(postfix,arrayProcessCallback){that.removeBackup(postfix,arrayProcessCallback)},callback)})}})})},restoreBackup:function(postfix,callback){console.log("RESTORE Backup tables with postfix ",postfix);fvdSpeedDial.AppLog.info("restore backup with postfix",postfix);var that=this;var regexp=this._backupRegexp;this._getTables(function(tables){fvdSpeedDial.Utils.Async.arrayProcess(tables,function(table,arrayProcessCallback){var matches=table.match(regexp);if(matches&&matches[1]==postfix){var tableOrig=matches[2];that.transaction(function(tx){fvdSpeedDial.Utils.Async.chain([function(chainCallback){fvdSpeedDial.AppLog.info("backup - cleanup original table",tableOrig);tx.executeSql("DELETE FROM "+tableOrig,[],chainCallback)},function(chainCallback){fvdSpeedDial.AppLog.info("backup - insert from",table,"to",tableOrig);tx.executeSql("INSERT INTO "+tableOrig+" SELECT * FROM "+table,[],chainCallback)},function(chainCallback){fvdSpeedDial.AppLog.info("backup - drop table",table);tx.executeSql("DROP TABLE "+table,[],chainCallback)},function(){arrayProcessCallback()}])})}else{arrayProcessCallback()}},function(){that._getTables(function(tables){fvdSpeedDial.AppLog.info("tables after backup restore",tables);callback()})})})},connect:function(callback){var that=this;if(this.connecting){return this.connectionPromise.then(callback)}console.info("Connection to database...");that.connecting=true;this.connectionPromise=new Promise(function(resolve,reject){that._connection=openDatabase(that._dbName,"1.0","",that._estimatedSize);that._createTables(function(result){that.restoreBackupInitial(function(){console.info("Connected");that.connecting=false;resolve();if(callback){callback()}Broadcaster.sendMessage({action:"storage:connected"})})})})},createOrReuseTransaction:function(tx,callback){if(tx){return callback(tx)}else{return this.transaction(callback)}},transaction:function(callback){var self=this;if(this._transaction){callback(this._transaction)}else{self._connection.transaction(callback,function(err){if(err.message!=="database has been closed"){return console.error("Fail to get a transaction(not recoverable)",err)}self.connect(function(){self._connection.transaction(callback,function(err){console.error("Can't get a transaction even after reconnect",err)})})})}},resetAllDialsClicks:function(cb){var self=this;this.transaction(function(tx){tx.executeSql("UPDATE `dials` SET `clicks` = 0",[],function(){self.onDataChanged.dispatch();cb()})})},restoreTableRow:function(tx,table,row,cb){var fields=[];var questions=[];var values=[];var self=this;for(var k in row){fields.push("`"+k+"`");questions.push("?");values.push(row[k])}var transactionCreated=!tx;self.createOrReuseTransaction(tx,function(tx){var query="INSERT INTO `"+table+"`("+fields.join(",")+") VALUES("+questions.join(",")+")";fvdSpeedDial.Utils.Async.chain([function(next){tx.executeSql(query,values,function(tx,res){if(table!="dials"){return next()}if(!row.thumb){return next()}if(row.thumb.indexOf("data:")!==0){if(row.thumb_source_type==="url"&&row.thumb_url){fvdSpeedDial.Utils.imageUrlToDataUrl(row.thumb_url,function(th,size){if(!th||!size){console.error("Fail to fetch thumb from",row.thumb_url);transactionCreated&&next();return}fvdSpeedDial.Storage.updateDial(res.insertId,{thumb:th,thumb_width:size.width,thumb_height:size.height},function(){transactionCreated&&next()})})}else{fvdSpeedDial.Storage.updateDial(res.insertId,{screen_maked:0},function(){transactionCreated&&next()})}}else{fvdSpeedDial.Storage.updateDial(res.insertId,{thumb:row.thumb},function(){transactionCreated&&next()})}if(!transactionCreated){next()}},function(){console.log("FAIL",arguments)})},function(){cb()}])})},restoreTableData:function(tx,table,tableData,cb,rowDoneCb){var self=this;rowDoneCb=rowDoneCb||function(){};var transactionCreated=!tx;fvdSpeedDial.Utils.Async.chain([function(next){if(tx){return next()}self.transaction(function(_tx){tx=_tx;next()})},function(){tx.executeSql("DELETE FROM `"+table+"`",[],function(){if(table=="dials"){Broadcaster.sendMessage({action:"storage:dialsCleared"})}var rowIndex=0;fvdSpeedDial.Utils.Async.eachSeries(tableData,function(row,apc2){console.log("Restoring row",rowIndex,"of",table);self.restoreTableRow(transactionCreated?null:tx,table,row,function(){console.log("Restored row",rowIndex,"of",table);rowIndex++;rowDoneCb();apc2()})},function(){console.log("Done table",table);cb()})})}])},restoreTablesDataInOneTransaction:function(data,callback,progressCallback,tx){var tables=[];var totalRows=0;var count=0;for(var table in data){tables.push(table);totalRows+=data[table].length}var that=this;console.log("Start restoring db data in one transaction");that.createOrReuseTransaction(tx,function(tx){fvdSpeedDial.Utils.Async.eachSeries(tables,function(table,apc1){console.log("Restoring table",table);that.restoreTableData(tx,table,data[table],function(){console.log("Restored data for",table);apc1()},function(){count++;if(progressCallback){progressCallback(count,totalRows)}})},function(){console.log("Restore in one transaction finished");callback()})})},restoreTablesData:function(data,callback,progressCallback){var tables=[];var totalRows=0;var count=0;for(var table in data){tables.push(table);totalRows+=data[table].length}var that=this;fvdSpeedDial.Utils.Async.eachSeries(tables,function(table,apc1){that.restoreTableData(null,table,data[table],apc1,function(){count++;if(progressCallback){progressCallback(count,totalRows)}})},function(){callback()})},fullDump:function(cb){var self=this;var tables=["deny","dials","groups","misc"];var data={};fvdSpeedDial.Utils.Async.arrayProcess(tables,function(table,next){self.transaction(function(tx){tx.executeSql("SELECT rowid, * FROM `"+table+"`",[],function(tx,results){data[table]=self._resultsToArray(results);next()})})},function(){cb(null,data)})},dump:function(dumpToJsonCallback){var that=this;fvdSpeedDial.Utils.Async.chain([function(callback,dataObject){that.transaction(function(tx){tx.executeSql("SELECT `url`, `title`, `auto_title`, `thumb_source_type`, `get_screen_method`,"+" `thumb_url`, `position`, `update_interval`, "+"`group_id`, `clicks`, `deny`, `screen_delay`, `thumb_width`, `thumb_height`,"+"`global_id` FROM `dials`",[],function(tx,results){dataObject.dials=that._resultsToArray(results);callback()})})},function(callback,dataObject){that.transaction(function(tx){tx.executeSql("SELECT `id`, `name`, `position`, `global_id` FROM `groups`",[],function(tx,results){dataObject.groups=that._resultsToArray(results);callback()})})},function(callback,dataObject){that.transaction(function(tx){tx.executeSql("SELECT * FROM `deny`",[],function(tx,results){dataObject.deny=that._resultsToArray(results);callback()})})},function(callback,dataObject){dumpToJsonCallback(dataObject)}])},resetAutoDialsForGroup:function(params,callback){var where=[];var limit="";var self=this;var attrs=[];if(params.groupId){where.push("`group_id` = ?");attrs.push(params.groupId)}where.push("`get_screen_method` = 'auto'");where.push("`thumb_source_type` = 'screen'");if(params.limit){limit="LIMIT 0, "+params.limit}if(params.ids){where.push("`rowid` IN ("+params.ids.join(",")+")")}if(where.length>0){where=" WHERE "+where.join(" AND ")}else{where=""}var query="UPDATE `dials` SET `thumb` = '', `screen_maked` = 0 "+where+" "+limit;this.transaction(function(tx){tx.executeSql(query,attrs,function(tx,results){self.onDataChanged.dispatch();callback()})})},setAutoUpdateGlobally:function(params,cb){var self=this;this.transaction(function(tx){tx.executeSql("SELECT global_id FROM `dials` WHERE `thumb_source_type` = 'screen' AND get_screen_method = 'auto'",[],function(tx,results){var globalIds=[];for(var i=0;results.rows.length!=i;i++){globalIds.push(results.rows.item(i).global_id)}tx.executeSql("UPDATE `dials` SET `update_interval` = ?"+" WHERE `thumb_source_type` = 'screen' AND get_screen_method = 'auto'",[params.interval],function(tx,results){for(var i=0;i!=globalIds.length;i++){fvdSpeedDial.Sync.addDataToSync({category:["dials"],data:globalIds[i]})}self.onDataChanged.dispatch();cb(globalIds)})})})},turnOffAutoUpdateGlobally:function(cb){var self=this;this.transaction(function(tx){tx.executeSql("SELECT global_id FROM `dials` WHERE `thumb_source_type` = 'screen' "+" AND get_screen_method = 'auto' AND `update_interval` != ''",[],function(tx,results){var globalIds=[];for(var i=0;results.rows.length!=i;i++){globalIds.push(results.rows.item(i).global_id)}tx.executeSql("UPDATE `dials` SET `update_interval` = ''"+" WHERE `thumb_source_type` = 'screen' AND get_screen_method = 'auto' AND `update_interval` != ''",[],function(tx,results){for(var i=0;i!=globalIds.length;i++){fvdSpeedDial.Sync.addDataToSync({category:["dials"],data:globalIds[i]})}self.onDataChanged.dispatch();cb(globalIds)})})})},setAutoPreviewGlobally:function(params,callback){var self=this;this.transaction(function(tx){tx.executeSql("SELECT global_id FROM `dials` WHERE `thumb_source_type` = 'screen' AND get_screen_method = 'manual'",[],function(tx,results){var globalIds=[];for(var i=0;results.rows.length!=i;i++){globalIds.push(results.rows.item(i).global_id)}tx.executeSql("UPDATE `dials` SET `get_screen_method` = 'auto', `thumb_source_type` = 'screen', `thumb` = '', `screen_maked` = 0 "+" WHERE `thumb_source_type` = 'screen' AND get_screen_method = 'manual'",[],function(tx,results){for(var i=0;i!=globalIds.length;i++){fvdSpeedDial.Sync.addDataToSync({category:["dials"],data:globalIds[i]})}self.onDataChanged.dispatch();callback(globalIds)})})})},dialGlobalId:function(id,callback){this.transaction(function(tx){tx.executeSql("SELECT global_id FROM `dials` WHERE rowid = ?",[id],function(tx,results){var globalId=null;if(results.rows.length==1){globalId=results.rows.item(0).global_id}callback(globalId)})})},listDialsIdsByGroup:function(groupId,callback){this.transaction(function(tx){tx.executeSql("SELECT rowid, global_id FROM `dials` WHERE group_id = ?",[groupId],function(tx,results){var data=[];for(var i=0;i!=results.rows.length;i++){var dial=results.rows.item(i);data.push({id:dial.rowid,global_id:dial.global_id})}callback(data)})})},getDialsToPreviewUpdate:function(cb){this.transaction(function(tx){tx.executeSql("SELECT rowid, update_interval, last_preview_update, url "+" FROM `dials` WHERE update_interval != '' AND `thumb_source_type` = 'screen'",[],function(tx,results){var data=[],now=(new Date).getTime();for(var i=0;i!=results.rows.length;i++){var dial=results.rows.item(i);if(!dial.last_preview_update){tx.executeSql("UPDATE `dials` SET last_preview_update = ? WHERE `rowid` = ?",[now,dial.rowid]);continue}var interval=dial.update_interval.split("|");switch(interval[1]){case"minutes":interval=interval[0]*60;break;case"hours":interval=interval[0]*3600;break;case"days":interval=interval[0]*3600*24;break;default:continue}interval*=1e3;if(now-dial.last_preview_update<interval){continue}data.push({id:dial.rowid,url:dial.url});tx.executeSql("UPDATE `dials` SET last_preview_update = ? WHERE `rowid` = ?",[now,dial.rowid])}cb(data)})})},searchDials:function(query,params,cb){if(typeof params==="function"){cb=params;params={}}params.limit=params.limit||20;var queryArgs=[];var that=this;var whereStr="";var limitClause="";var orderBy="`clicks` DESC";var where=[];var queryForLike="%"+query+"%";where.push("(`title` like ? or `auto_title` like ? or `url` like ?)");queryArgs.push(queryForLike,queryForLike,queryForLike);whereStr=" WHERE "+where.join(" AND ");this.transaction(function(tx){var query="SELECT "+that._dialFieldsToFetch+" FROM `dials` "+whereStr+" ORDER BY "+orderBy+" "+limitClause;console.log("Start get list!");tx.executeSql(query,queryArgs,function(tx,results){var data=[];for(var i=0;i!=results.rows.length;i++){var dial=results.rows.item(i);that._prepareDialData(dial);data.push(dial)}cb(null,data)},function(err){console.error("FAIL",arguments);cb(err)})})},listDials:function(orderBy,groupId,limit,callback){if(typeof orderBy=="function"){callback=orderBy;orderBy=null}if(!orderBy){orderBy="`position` ASC"}var whereArr=[];var where="";if(groupId&&groupId>0){whereArr.push("group_id = "+groupId)}whereArr.push("`deny` = 0");if(whereArr.length>0){where="WHERE "+whereArr.join(" AND ")}var limitClause="";if(limit){limitClause="LIMIT "+limit}var that=this;var groupByClause="";if(groupId==0){groupByClause=" GROUP BY `url` "}this.transaction(function(tx){var query="SELECT "+that._dialFieldsToFetch+" FROM `dials` "+where+" "+groupByClause+" ORDER BY "+orderBy+" "+limitClause;console.log("Start get list!");tx.executeSql(query,[],function(tx,results){var data=[];for(var i=0;i!=results.rows.length;i++){var dial=results.rows.item(i);that._prepareDialData(dial);data.push(dial)}callback(data)},function(err){console.error("FAIL",arguments)})})},dialsRawList:function(params,callback){var self=this;params=params||{};if(typeof params.fetchThumb==="undefined"){params.fetchThumb=true}var whereStr="";if(params.where){whereStr="WHERE "+params.where.join(" AND ")}var query="SELECT dials.rowid, dials.*, groups.global_id as group_global_id "+"FROM `dials` JOIN groups ON dials.group_id = groups.id "+whereStr+" "+"ORDER BY dials.rowid ASC";if(params.limit){query+=" LIMIT "+params.limit}this._rawList(query,function(list){list.forEach(function(dial){if(dial.update_interval=="undefined"){dial.update_interval=""}});if(params.fetchThumb){fvdSpeedDial.Utils.Async.arrayProcess(list,function(dial,next){if(params.fetchOnlyCustomThumb){if(dial.thumb_source_type==="local_file"||dial.thumb_source_type==="screen"&&dial.get_screen_method==="manual"){}else{console.log("Do not fetch",dial.thumb_source_type);return setTimeout(next,0)}}self._resolveDialThumb(dial,function(){next()})},function(){callback(list)})}else{return callback(list)}})},_resolveDialThumb:function(dial,cb){if(typeof dial.thumb!="string"||dial.thumb.indexOf("filesystem:")!==0){return cb(dial.thumb)}fvdSpeedDial.Utils.imageUrlToDataUrl(dial.thumb,function(dataUrl){dial.thumb=dataUrl;cb(dataUrl)})},getDialThumb:function(globalId,cb){var self=this;this.transaction(function(tx){tx.executeSql("SELECT `thumb` FROM `dials` WHERE `global_id` = ?",[globalId],function(tx,result){if(result.rows.length==1){var dial=result.rows.item(0);self._resolveDialThumb(dial,function(thumb){cb(thumb)})}else{cb(null)}})})},getDial:function(id,callback){var that=this;this.transaction(function(tx){tx.executeSql("SELECT rowid as `id`, `url`, `display_url`, `title`, `auto_title`, `thumb_source_type`,"+" `thumb_url`, "+"`position`, `group_id`, `clicks`, `deny`, `screen_maked`, `thumb`, `screen_delay`, `thumb_width`, "+"`thumb_height`, `get_screen_method`, `update_interval`, `global_id` "+" FROM `dials` WHERE `rowid` = ?",[id],function(tx,result){if(result.rows.length==1){var dial=result.rows.item(0);that._prepareDialData(dial);callback(dial)}else{callback(null)}})})},getDialDataList:function(dialId,dataList,callback){var dataString="`"+dataList.join("`,`")+"`";var query="SELECT "+dataString+" FROM `dials` WHERE `rowid` = ?";this.transaction(function(tx){tx.executeSql(query,[dialId],function(ts,results){if(results.rows.length==1){callback(results.rows.item(0))}})})},addDial:function(addData,callback,hints){hints=hints||[];var that=this,storeThumb=null;addData.thumb=addData.thumb||"";addData.screen_delay=addData.screen_delay||fvdSpeedDial.Prefs.get("sd.preview_creation_delay_default");var screen_maked=0,localFileData=null,res=null;fvdSpeedDial.Utils.Async.chain([function(next){checkLocalFile(addData.url,addData.thumb_source_type,addData.thumb_url,function(lf){localFileData=lf;next()})},function(next){if(localFileData){for(var k in localFileData){addData[k]=localFileData[k]}next()}else{if(addData.thumb_source_type=="screen"){if(addData.thumb){addData.screen_maked=1}else{}}next()}},function(next){if(addData.thumb){storeThumb=addData.thumb;delete addData.thumb}that.isDenyUrl(addData.url,function(deny){if(deny&&hints.indexOf("ignore_deny")==-1){if(callback){callback({result:false,error:"url_deny"})}}else{that.nextDialPosition(addData.group_id,function(position){if(!addData.position){addData.position=position}addData.clicks=addData.clicks||0;addData.deny=addData.deny||0;addData.screen_maked=addData.screen_maked||0;if(!addData.global_id){addData.global_id=that._generateGUID()}var insertData=that._getInsertData(addData);that.transaction(function(tx){tx.executeSql("INSERT INTO `dials`("+insertData.keys+") VALUES("+insertData.values+")",insertData.dataArray,function(tx,results){that._callDialsChangeCallbacks({action:"add"});res={result:results.rowsAffected==1,id:results.insertId};next()},function(){console.log("Error add dials",arguments)})})})}})},function(next){if(!storeThumb){return next()}fvdSpeedDial.Storage.updateDial(res.id,{thumb:storeThumb},next)},function(){if(callback){callback(res)}}])},syncFixDialsPositions:function(groupId,callback){var that=this;this._rawList("SELECT `rowid` FROM `dials` WHERE `group_id` = "+groupId+" ORDER BY `position`",function(dials){var position=1;fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,arrayProcessCallback){that.transaction(function(tx){tx.executeSql("UPDATE `dials` SET `position` = ? WHERE `rowid` = ?",[position,dial.rowid],function(){position++;arrayProcessCallback()},function(err){console.error("Query failed",err,arguments);arrayProcessCallback()})})},function(){that.onDataChanged.dispatch();callback()})})},syncDialData:function(globalId,fields,callback){fields=fields||["rowid","*"];var query="SELECT "+fields.join(",")+" FROM `dials` WHERE `global_id` = ?";this.transaction(function(tx){tx.executeSql(query,[globalId],function(tx,results){if(results.rows.length>=1){callback(results.rows.item(0))}else{callback(null)}},function(){console.log("Fail get syncDialData",arguments)})})},syncRemoveDials:function(notRemoveDials,callback){var that=this;var removeInfo={count:0,removedFromGroups:[]};var where="WHERE 1=1 ";if(notRemoveDials.length>0){where+="AND `global_id` NOT IN('"+notRemoveDials.join("','")+"')"}where+=" AND (SELECT `sync` FROM `groups` WHERE `id` = `dials`.`group_id`) = 1";this._rawList("SELECT `global_id`, `rowid`, `group_id` FROM `dials` "+where,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,arrayProcessCallback){removeInfo.count++;removeInfo.removedFromGroups.push(dial.group_id);that.transaction(function(tx){tx.executeSql("DELETE FROM dials WHERE rowid = ?",[dial.rowid],function(){that._callDialsChangeCallbacks({action:"remove",data:{id:dial.rowid}});arrayProcessCallback()})})},function(){fvdSpeedDial.AppLog.info("sync remove dials not in list, removed",removeInfo.count);callback(removeInfo)})})},syncUpdateMass:function(globalIds,data,callback){var self=this;var tmp=this._getUpdateData(data);var dataArray=tmp.dataArray;var strings=tmp.strings;var query="UPDATE `dials` SET "+strings.join(",")+" WHERE `global_id` IN ( '"+globalIds.join("','")+"' )";this.transaction(function(tx){tx.executeSql(query,dataArray,function(tx,results){self.onDataChanged.dispatch();if(callback){callback({result:results.rowsAffected>1})}})})},syncSaveDial:function(dial,callback){var that=this;var oldData=null;var nullThumbSrc=false;var saveInfo={};this.dialExistsByGlobalId(dial.global_id,function(exists){that.syncGetGroupId(dial.group_global_id,function(groupId){if(groupId==0){callback(saveInfo)}else{dial.group_id=groupId;saveInfo.group_id=groupId;var deny=0;fvdSpeedDial.Utils.Async.chain([function(chainCallback){that.isDenyUrl(dial.url,function(aDeny){deny=aDeny?1:0;chainCallback()})},function(chainCallback){if(exists){that.syncDialData(dial.global_id,["rowid","thumb_source_type","thumb_url","url","group_id","screen_maked","get_screen_method"],function(result){if(result){oldData=result;if(oldData.group_id!=dial.group_id){saveInfo.move={from:oldData.group_id,to:dial.group_id}}if(oldData.thumb_source_type!=dial.thumb_source_type){nullThumbSrc=true}else{if(dial.thumb_source_type=="screen"){if(dial.url!=oldData.url){nullThumbSrc=true}else if(dial.get_screen_method!=oldData.get_screen_method){nullThumbSrc=true}}else if(dial.thumb_source_type=="url"){if(dial.thumb_url!=oldData.thumb_url){nullThumbSrc=true}}else if(dial.thumb_source_type=="local_file"){}}if(nullThumbSrc){dial.screen_maked=0}else{dial.screen_maked=oldData.screen_maked}chainCallback()}else{nullThumbSrc=true;chainCallback()}})}else{nullThumbSrc=true;chainCallback()}},function(chainCallback){if(nullThumbSrc&&dial.thumb_source_type=="url"||dial._previewUrl&&dial.thumb_source_type=="local_file"||dial._previewUrl&&dial.thumb_source_type==="screen"){var loadContentUrl=dial.thumb_url;if(dial._previewUrl&&dial.thumb_source_type=="local_file"||dial._previewUrl&&dial.thumb_source_type==="screen"){loadContentUrl=dial._previewUrl}fvdSpeedDial.ThumbMaker.getImageDataPath({imgUrl:loadContentUrl,screenWidth:fvdSpeedDial.SpeedDial.getMaxCellWidth()},function(dataUrl,thumbSize){delete dial._previewUrl;dial.thumb=dataUrl;chainCallback()})}else{chainCallback()}},function(chainCallback){var toDb={url:dial.url,title:dial.title,auto_title:dial.auto_title,thumb_url:dial.thumb_url,thumb_source_type:dial.thumb_source_type,thumb_width:dial.thumb_width,thumb_height:dial.thumb_height,group_id:dial.group_id,deny:deny,position:dial.position,global_id:dial.global_id,screen_maked:dial.screen_maked,update_interval:dial.update_interval||""};if(dial.get_screen_method){toDb.get_screen_method=dial.get_screen_method}if(dial.thumb){toDb.thumb=dial.thumb}if(exists){that.updateDial(oldData.rowid,toDb,function(){chainCallback()})}else{that.addDial(toDb,function(){chainCallback()},["ignore_deny"])}},function(chainCallback){if(dial.thumb_source_type=="local_file"){chainCallback()}else{chainCallback()}},function(){callback(saveInfo)}])}})})},deleteDial:function(dialId,callback){var that=this;fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.Storage.getDial(dialId,function(d){if(!d||!d.thumb||typeof d.thumb!="string"||d.thumb.indexOf("filesystem:")!==0){return next()}fvdSpeedDial.Storage.FileSystem.removeByURL(d.thumb,function(){next()})})},function(){that.transaction(function(tx){tx.executeSql("DELETE FROM `dials` WHERE `rowid` = ?",[dialId],function(tx,results){if(callback){that._callDialsChangeCallbacks({action:"remove",data:{id:dialId}});callback({result:results.rowsAffected==1})}})})}])},clearDials:function(callback,where){var that=this;where=where||"";if(where){where="WHERE "+where}this.transaction(function(tx){tx.executeSql("SELECT rowid, thumb FROM `dials` "+where,[],function(tx,results){var r=[];for(var i=0;i!=results.rows.length;i++){r.push(results.rows.item(i))}fvdSpeedDial.Utils.Async.arrayProcess(r,function(row,next){that._callDialsChangeCallbacks({action:"remove",data:{id:row.rowid}});if(!row.thumb||typeof row.thumb!="string"||row.thumb.indexOf("filesystem:")!==0){return next()}fvdSpeedDial.Storage.FileSystem.removeByURL(row.thumb,function(){next()})},function(){that.transaction(function(tx){tx.executeSql("DELETE FROM `dials` "+where,[],function(){if(callback){Broadcaster.sendMessage({action:"storage:dialsCleared"});callback()}})})})})})},updateDial:function(dialId,data,callback){callback=callback||function(){};var that=this;var global_id;fvdSpeedDial.Utils.Async.chain([function(next){that.dialGlobalId(dialId,function(_guid){if(_guid){global_id=_guid}next()})},function(next){if(!data.thumb||typeof data.thumb!="string"){return next()}if(data.thumb.indexOf("data:")!==0){return next()}var fname=global_id||dialId;var thumb=fvdSpeedDial.Utils.dataURIToBlob(data.thumb),ext=fvdSpeedDial.Utils.typeToExt(thumb.type);fvdSpeedDial.Storage.FileSystem.write("/"+fvdSpeedDial.Config.FS_DIALS_PREVIEW_DIR+"/"+fname+"."+ext,thumb,function(err,url){if(err){throw err}data.thumb=url;next()})},function(){var tmp=that._getUpdateData(data);var dataArray=tmp.dataArray;var strings=tmp.strings;dataArray.push(dialId);if(data.thumb){strings.push("`thumb_version` = `thumb_version` + 1")}var query="UPDATE `dials` SET "+strings.join(",")+" WHERE `rowid` = ?";that.transaction(function(tx){tx.executeSql(query,dataArray,function(tx,results){that._callDialsChangeCallbacks({action:"update",data:{id:dialId,data:data}});if(callback){callback({result:results.rowsAffected==1})}})})}])},moveDial:function(dialId,groupId,callback){var that=this;this.nextDialPosition(groupId,function(newPosition){that.updateDial(dialId,{group_id:groupId,position:newPosition},function(result){callback(result)})})},dialCanSync:function(globalId,callback){this.transaction(function(tx){tx.executeSql("SELECT sync FROM `groups` WHERE `id` = (SELECT `group_id` FROM `dials` WHERE `dials`.`global_id` = ?)",[globalId],function(tx,results){try{callback(results.rows.item(0).sync==1)}catch(ex){callback(true)}})})},insertDialUpdateStorage:function(dialId,sign,interval,newDialPosition,callback){var that=this;this.getDialDataList(dialId,["group_id"],function(dial){that.transaction(function(tx){var changedGlobalIds=[];fvdSpeedDial.Utils.Async.chain([function(chainCallback){tx.executeSql("SELECT global_id FROM dials WHERE `group_id` = ? AND `position` >= ? AND `position` <= ?",[dial.group_id,interval.start,interval.end],function(tx,results){for(var i=0;i!=results.rows.length;i++){changedGlobalIds.push(results.rows.item(i).global_id)}chainCallback()})},function(chainCallback){tx.executeSql("UPDATE `dials` SET `position` = `position` "+sign+"1 WHERE `group_id` = ? AND `position` >= ? AND `position` <= ?",[dial.group_id,interval.start,interval.end],function(){that.updateDial(dialId,{position:newDialPosition},function(){chainCallback()})})},function(){callback(changedGlobalIds)}])})})},dialExists:function(params,callback){var that=this;params=params||{};var additionalWhere="";if(params.excludeIds){additionalWhere=" AND `rowid` NOT IN( "+params.excludeIds.join(",")+" )"}this.transaction(function(tx){tx.executeSql("SELECT EXISTS(SELECT * FROM `dials` WHERE `url` = ? "+additionalWhere+") as ex",[params.url],function(tx,results){var exists=!!results.rows.item(0).ex;if(exists){return callback(exists)}var parsedUrl=fvdSpeedDial.Utils.parseUrl(params.url);if(!parsedUrl||!parsedUrl.host){return callback(false)}var host=parsedUrl.host.toLowerCase();if(host.indexOf("www.")===0){host=host.substr(4)}else{host="www."+host}parsedUrl.host=host;var url=fvdSpeedDial.Utils.buildUrlFromParsed(parsedUrl);tx.executeSql("SELECT EXISTS(SELECT * FROM `dials` WHERE `url` = ? "+additionalWhere+") as ex",[url],function(tx,results){var exists=!!results.rows.item(0).ex;if(!exists&&!params.finalCheck){if(parsedUrl.scheme=="http"){parsedUrl.scheme="https"}else{parsedUrl.scheme="http"}url=fvdSpeedDial.Utils.buildUrlFromParsed(parsedUrl);that.dialExists({url:url,excludeIds:params.excludeIds,finalCheck:true},callback)}else{callback(exists)}})})})},dialExistsByGlobalId:function(globalId,callback){this.transaction(function(tx){tx.executeSql("SELECT EXISTS(SELECT * FROM `dials` WHERE `global_id` = ?) as ex",[globalId],function(tx,results){callback(results.rows.item(0).ex)})})},nextDialPosition:function(group_id,callback){this.transaction(function(tx){tx.executeSql("SELECT MAX(position)  as cnt FROM `dials` WHERE `group_id` = ?",[group_id],function(tx,results){callback(results.rows.item(0).cnt+1)})})},countDials:function(params,callback){if(typeof params=="function"){callback=params;params={}}params=params||{};var clause="*";if(params.uniqueUrl){clause=" DISTINCT `url` "}this.transaction(function(tx){tx.executeSql("SELECT COUNT("+clause+") as cnt FROM `dials` WHERE `deny` = ? ",[0],function(tx,results){callback(results.rows.item(0).cnt)})})},refreshDenyDials:function(callback){var that=this;this.transaction(function(tx){tx.executeSql("SELECT `rowid`, `url`, `deny` FROM `dials`",[],function(tx,results){for(var i=0;i!=results.rows.length;i++){var dial=results.rows.item(i);(function(i,dial){that.isDenyUrl(dial.url,function(deny){var newDeny=deny?1:0;if(newDeny!=dial.deny){that.updateDial(dial.rowid,{deny:newDeny},function(){if(i==results.rows.length-1){if(callback){callback()}}})}else{if(i==results.rows.length-1){if(callback){callback()}}}})})(i,dial)}if(results.rows.length===0){if(callback){callback()}}})})},deny:function(type,sign,callback){if(!sign){throw"deny_empty_sign"}var firstSign=sign;if(type=="host"){if(fvdSpeedDial.Utils.isValidUrl(sign)){sign=fvdSpeedDial.Utils.parseUrl(sign,"host")}}else if(type=="url"){if(!fvdSpeedDial.Utils.isValidUrl(sign)){throw"deny_invalid_url";

}sign=fvdSpeedDial.Utils.urlToCompareForm(sign)}else{throw"deny_wrong_type"}var that=this;this._denySignExists(type,sign,function(exists){if(!exists){that.transaction(function(tx){tx.executeSql("INSERT INTO deny ( `sign`, `effective_sign`, `type` ) VALUES( ?, ?, ? )",[firstSign,sign,type],function(tx,results){if(callback){callback({result:results.rowsAffected==1,id:results.insertId})}that._callDenyChangeCallbacks({action:"add",type:type,sign:sign})})})}else{callback({result:false,error:"deny_already_exists"})}})},editDeny:function(id,data,callback){var that=this;data.effective_sign=fvdSpeedDial.Utils.urlToCompareForm(data.sign);this._denySignExists(data.type,data.effective_sign,function(exists){if(exists){if(callback){callback({result:false,error:"deny_already_exists"})}}else{var updateData=that._getUpdateData(data);updateData.dataArray.push(id);var query="UPDATE `deny` SET "+updateData.strings.join(",")+" WHERE `rowid` = ?";that.transaction(function(tx){tx.executeSql(query,updateData.dataArray,function(tx,results){if(callback){callback({result:results.rowsAffected==1})}that._callDenyChangeCallbacks({action:"edit"})})})}},id)},denyList:function(callback){this.transaction(function(tx){tx.executeSql("SELECT rowid as id, effective_sign, sign, type FROM deny",[],function(tx,results){var result=[];for(var i=0;i!=results.rows.length;i++){result.push(results.rows.item(i))}callback(result)})})},removeDeny:function(id,callback){var that=this;this.transaction(function(tx){tx.executeSql("DELETE FROM `deny` WHERE `rowid` = ?",[id],function(tx,results){if(callback){callback()}that._callDenyChangeCallbacks({action:"remove"})})})},clearDeny:function(callback){this.transaction(function(tx){tx.executeSql("DELETE FROM `deny`",[],function(){if(callback){callback()}})})},isDenyUrl:function(url,callback){var that=this;this.transaction(function(tx){tx.executeSql("SELECT effective_sign, type FROM deny",[],function(tx,results){var result=false;var denyDetails=null;for(var i=0,len=results.rows.length;i<len;i++){var item=results.rows.item(i);switch(item.type){case"url":result=fvdSpeedDial.Utils.isIdenticalUrls(item.effective_sign,url);break;case"host":var host=fvdSpeedDial.Utils.parseUrl(url,"host");result=fvdSpeedDial.Utils.isIdenticalHosts(item.effective_sign,host,{ignoreSubDomains:true});break}if(result){denyDetails={deny:item};break}}callback(result,denyDetails)})})},resetDefaultGroupId:function(){this.groupsList(function(groups){var group=groups[0];var newId=group.id;fvdSpeedDial.Prefs.set("sd.default_group",newId)})},groupIdByGlobalId:function(globalId,callback){this.transaction(function(tx){tx.executeSql("SELECT `id` FROM `groups` WHERE global_id = ?",[globalId],function(tx,results){var id=null;if(results.rows.length==1){id=results.rows.item(0).id}callback(id)})})},groupGlobalId:function(id,callback){this.transaction(function(tx){tx.executeSql("SELECT global_id FROM `groups` WHERE id = ?",[id],function(tx,results){var globalId=null;if(results.rows.length==1){globalId=results.rows.item(0).global_id}callback(globalId)})})},addDialsCallback:function(callback){if(this._dialsChangeCallbacks.indexOf(callback)!=-1){return}this._dialsChangeCallbacks.push(callback)},removeDialsCallback:function(callback){var index=this._dialsChangeCallbacks.indexOf(callback);if(index==-1){return}this._dialsChangeCallbacks.splice(index,1)},addGroupsCallback:function(callback){if(this._groupsChangeCallbacks.indexOf(callback)!=-1){return}this._groupsChangeCallbacks.push(callback)},removeGroupsCallback:function(callback){var index=this._groupsChangeCallbacks.indexOf(callback);if(index==-1){return}this._groupsChangeCallbacks.splice(index,1)},groupAdd:function(params,callback,forcePosition){var that=this;var position;if(typeof params.sync==="undefined"){params.sync=1}if(params.hasOwnProperty("forcePosition")){forcePosition=params.forcePosition;delete params.forcePosition}fvdSpeedDial.Utils.Async.chain([function(next){that.groupExists({name:params.name},function(exists){if(exists){throw"group_exists"}next()})},function(next){that.nextGroupPosition(function(nextPosition){position=nextPosition;next()})},function(next){if(forcePosition==="top"){position=1;that.transaction(function(tx){tx.executeSql("UPDATE `groups` SET `position` = `position` + 1",[],function(){next()})})}else{if(!isNaN(forcePosition)){position=forcePosition}next()}},function(){if(typeof params.position!="undefined"){position=params.position}if(!params.global_id){params.global_id=that._generateGUID()}that.transaction(function(tx){tx.executeSql("INSERT INTO `groups` (`position`, `name`, `global_id`, `sync`) VALUES(?, ?, ?, ?)",[position,params.name,params.global_id,params.sync],function(tx,results){if(callback){callback({result:results.rowsAffected==1,id:results.insertId})}that._callGroupsChangeCallbacks({action:"add"})})})}])},syncFixGroupsPositions:function(callback){var that=this;var query="SELECT `id` FROM `groups` ORDER BY `position`";this._rawList(query,function(list){var position=1;fvdSpeedDial.Utils.Async.arrayProcess(list,function(group,arrayProcessCallback){that.transaction(function(tx){tx.executeSql("UPDATE groups SET position = ? WHERE id = ?",[position,group.id],function(){position++;arrayProcessCallback()},function(_tx,error){console.error("Got and sql error",error);arrayProcessCallback()})})},function(){that.onDataChanged.dispatch();callback()})})},syncSaveGroup:function(group,callback){callback=callback||function(){};var that=this;this.groupExistsByGlobalId(group.global_id,function(exists){if(exists){that.transaction(function(tx){tx.executeSql("UPDATE `groups` SET `name` = ?, `position` = ? WHERE `global_id` = ?",[group.name,group.position,group.global_id],function(){that.onDataChanged.dispatch();callback()})})}else{that.transaction(function(tx){tx.executeSql("INSERT INTO `groups`(`name`, `position`, `global_id`) VALUES(?, ?, ?)",[group.name,group.position,group.global_id],function(){that.onDataChanged.dispatch();callback()})})}})},syncGetGroupId:function(globalId,callback){this.transaction(function(tx){tx.executeSql("SELECT id FROM `groups` WHERE `groups`.`global_id` = ?",[globalId],function(tx,results){var groupId=0;if(results.rows.length==1){groupId=results.rows.item(0).id}callback(groupId)})})},syncRemoveGroups:function(notRemoveIds,callback){var that=this;var where="WHERE 1=1";if(notRemoveIds.length>0){where+=" AND global_id NOT IN ('"+notRemoveIds.join("','")+"')"}where+=" AND `sync` = 1";this._rawList("SELECT id FROM groups "+where,function(groups){fvdSpeedDial.Utils.Async.arrayProcess(groups,function(group,arrayProcessCallback){var groupId=group.id;that.transaction(function(tx){tx.executeSql("DELETE FROM dials WHERE group_id = ?",[groupId],function(){tx.executeSql("DELETE FROM groups WHERE id = ?",[groupId],function(){arrayProcessCallback()})})})},function(){fvdSpeedDial.AppLog.info("sync remove groups not in list, removed",groups.length);that.onDataChanged.dispatch();callback(groups.length)})})},getGroup:function(id,callback){this.transaction(function(tx){tx.executeSql("SELECT `groups`.`id`, `groups`.`name`, `groups`.`sync`, `groups`.`global_id`, (SELECT COUNT(*) FROM `dials` WHERE `group_id` = `groups`.`id`) as count_dials FROM `groups` WHERE `groups`.`id` = ?",[id],function(tx,results){var group=null;if(results.rows.length==1){group=results.rows.item(0)}callback(group)})})},groupsCount:function(callback){this.transaction(function(tx){tx.executeSql("SELECT COUNT(*) as cnt FROM `groups`",[],function(tx,results){callback(results.rows.item(0).cnt)})})},groupsList:function(callback){this.transaction(function(tx){tx.executeSql("SELECT `groups`.`id`, `groups`.`name`, `groups`.`sync`, (SELECT COUNT(*) FROM `dials` WHERE `group_id` = `groups`.`id` AND `deny` = 0) as count_dials FROM `groups` ORDER BY `groups`.`position`",[],function(tx,results){var data=[];for(var i=0;i!=results.rows.length;i++){data.push(results.rows.item(i))}fvdSpeedDial.AppLog.info("Groups list queried successully, count:",data.length);callback(data)},function(tx,err){fvdSpeedDial.AppLog.err("Fail query groups list:",err.message)})})},groupsRawList:function(params,callback){params=params||{};var whereStr="";if(params.where){whereStr="WHERE "+params.where.join(" AND ")}var query="SELECT * FROM `groups` "+whereStr;this._rawList(query,callback)},groupUpdate:function(groupId,data,callback){var that=this;var tmp=this._getUpdateData(data);var dataArray=tmp.dataArray;var strings=tmp.strings;dataArray.push(groupId);var syncChanged=false;fvdSpeedDial.Utils.Async.chain([function(chainCallback){if(typeof data.sync!="undefined"){that.getGroup(groupId,function(group){if(group.sync!=data.sync){syncChanged=true}chainCallback()})}else{chainCallback()}},function(){var query="UPDATE `groups` SET "+strings.join(",")+" WHERE `id` = ?";that.transaction(function(tx){tx.executeSql(query,dataArray,function(tx,results){if(syncChanged){fvdSpeedDial.Sync.groupSyncChanged(groupId,function(){if(callback){callback({result:results.rowsAffected==1})}})}else{if(callback){callback({result:results.rowsAffected==1})}}that._callGroupsChangeCallbacks({action:"update"})})})}])},groupDelete:function(groupId,callback){var that=this;this.transaction(function(tx){tx.executeSql("DELETE FROM `groups` WHERE `id` = ?",[groupId],function(tx,results){try{callback({result:results.rowsAffected==1});that._callGroupsChangeCallbacks({action:"remove",groupId:groupId})}catch(ex){}})})},clearGroups:function(callback,where){var self=this;where=where||"";if(where){where="WHERE "+where}this.transaction(function(tx){tx.executeSql("DELETE FROM `groups` "+where,[],function(){self.onDataChanged.dispatch();if(callback){callback()}})})},nextGroupPosition:function(callback){this.transaction(function(tx){tx.executeSql("SELECT MAX(`position`) as maxpos FROM `groups`",[],function(tx,results){try{callback(results.rows.item(0).maxpos+1)}catch(ex){}})})},groupCanSyncById:function(id,callback){this.transaction(function(tx){tx.executeSql("SELECT sync FROM `groups` WHERE `id` = ?",[id],function(tx,results){try{callback(results.rows.item(0).sync==1)}catch(ex){callback(true)}})})},groupCanSync:function(globalId,callback){this.transaction(function(tx){tx.executeSql("SELECT sync FROM `groups` WHERE `global_id` = ?",[globalId],function(tx,results){try{callback(results.rows.item(0).sync==1)}catch(ex){callback(true)}})})},groupExists:function(params,callback){params.excludeIds=params.excludeIds||null;this.transaction(function(tx){var additionalWhere="";if(params.excludeIds){additionalWhere=" AND `id` NOT IN ("+params.excludeIds.join(",")+")"}tx.executeSql("SELECT EXISTS( SELECT * FROM `groups` WHERE `name` = ? "+additionalWhere+" ) as ex",[params.namename],function(tx,results){try{callback(results.rows.item(0).ex==1)}catch(ex){}})})},groupExistsById:function(id,callback){this.transaction(function(tx){tx.executeSql("SELECT EXISTS( SELECT * FROM `groups` WHERE `id` = ? ) as ex",[id],function(tx,results){try{callback(results.rows.item(0).ex==1)}catch(ex){}})})},groupExistsByGlobalId:function(globalId,callback){this.transaction(function(tx){tx.executeSql("SELECT EXISTS( SELECT * FROM `groups` WHERE `global_id` = ? ) as ex",[globalId],function(tx,results){try{callback(results.rows.item(0).ex==1)}catch(ex){}})})},getMisc:function(name,callback){this.transaction(function(tx){tx.executeSql("SELECT `value` FROM `misc` WHERE `name` = ?",[name],function(tx,results){var v=null;if(results.rows.length==1){v=results.rows.item(0).value}callback(v)})})},setMisc:function(name,value,callback){var that=this;fvdSpeedDial.Utils.Async.chain([function(next){if(name!="sd.background"){return next()}if(typeof value=="string"&&value.indexOf("data:")===0){var img=fvdSpeedDial.Utils.dataURIToBlob(value),ext=fvdSpeedDial.Utils.typeToExt(img.type);fvdSpeedDial.Storage.FileSystem.write("/"+fvdSpeedDial.Config.FS_MISC_DIR+"/background."+ext,img,function(err,url){if(err){throw err}value=url;next()})}else{next()}},function(){that.transaction(function(tx){tx.executeSql("INSERT INTO `misc` (`name`, `value`) VALUES(?,?)",[name,value],function(){Broadcaster.sendMessage({action:"miscDataSet",name:name});if(callback){callback()}})})}])},_rawList:function(query,callback){this.transaction(function(tx){tx.executeSql(query,[],function(tx,results){var data=[];for(var i=0;i!=results.rows.length;i++){data.push(fvdSpeedDial.Utils.clone(results.rows.item(i)))}callback(data)},function(){console.log("Request error ("+query+")",arguments)})})},_prepareDialData:function(dial){dial.displayTitle=dial.title?dial.title:dial.auto_title},_callDialsChangeCallbacks:function(data){var toRemoveCallbacks=[],i;for(i=0;i!=this._dialsChangeCallbacks.length;i++){try{this._dialsChangeCallbacks[i](data)}catch(ex){toRemoveCallbacks.push(this._dialsChangeCallbacks[i])}}for(i=0;i!=toRemoveCallbacks.length;i++){this.removeDialsCallback(toRemoveCallbacks[i])}this.onDataChanged.dispatch()},_callGroupsChangeCallbacks:function(data){var toRemoveCallbacks=[],i;for(i=0;i!=this._groupsChangeCallbacks.length;i++){try{this._groupsChangeCallbacks[i](data)}catch(ex){toRemoveCallbacks.push(this._groupsChangeCallbacks[i])}}for(i=0;i!=toRemoveCallbacks.length;i++){this.removeGroupsCallback(toRemoveCallbacks[i])}this.onDataChanged.dispatch()},_callDenyChangeCallbacks:function(data){Broadcaster.sendMessage({action:"deny:changed",data:data})},_denySignExists:function(type,effective_sign,callback,except){var additionalWhere="";if(except){additionalWhere=" AND `rowid` != "+except}this.transaction(function(tx){tx.executeSql("SELECT EXISTS( SELECT * FROM `deny` WHERE `effective_sign` = ? AND `type` = ? "+additionalWhere+" ) as found",[effective_sign,type],function(tx,results){callback(results.rows.item(0).found==1)})})},_getInsertData:function(data){var dataArray=[];var stringKeys=[];var stringValues=[];for(var k in data){stringKeys.push("`"+k+"`");stringValues.push("?");dataArray.push(data[k])}return{keys:stringKeys.join(","),values:stringValues.join(","),dataArray:dataArray}},_getUpdateData:function(data){var dataArray=[];var strings=[];for(var k in data){strings.push("`"+k+"` = ?");dataArray.push(data[k])}return{dataArray:dataArray,strings:strings}},_resultsToArray:function(results){var data=[];for(var i=0;i!=results.rows.length;i++){data.push(results.rows.item(i))}return data},_getTables:function(tx,callback){if(typeof tx==="function"){callback=tx;tx=null}var self=this;var data=[];fvdSpeedDial.Utils.Async.chain([function(next){if(tx){return next()}self.transaction(function(_tx){tx=_tx;next()})},function(){tx.executeSql("SELECT `name`, `type` FROM sqlite_master",[],function(tx,results){for(var i=0;i!=results.rows.length;i++){var item=results.rows.item(i);if(item.type=="table"){data.push(item.name)}}callback(data)})}])},_getIndexes:function(callback,_tx){var tx=null;if(_tx){tx=_tx}function _execute(){var data=[];tx.executeSql("SELECT `name`, `type` FROM sqlite_master",[],function(tx,results){for(var i=0;i!=results.rows.length;i++){var item=results.rows.item(i);if(item.type=="index"){data.push(item.name)}}callback(data)})}if(tx){_execute()}else{this.transaction(function(_tx){tx=_tx;_execute()})}},_tableFields:function(table,callback,_tx){var tx=null;if(_tx){tx=_tx}function _execute(){var data=[];tx.executeSql("SELECT * FROM "+table+" LIMIT 1",[],function(tx,results){try{data=Object.keys(results.rows.item(0))}catch(ex){}if(!data.length){tx.executeSql("SELECT `sql` FROM `sqlite_master` WHERE `name` = '"+table+"' AND "+"`type` = 'table'",[],function(tx,results){if(results.rows.length){var sql=results.rows.item(0).sql;var match=sql.match(/\((.+?)\)/i);if(match){var tmp=match[1].split(/\s*,\s*/);for(var i=0;i!=tmp.length;i++){var t=tmp[i].split(" ")[0];t=t.replace(/`|\s/g,"");data.push(t)}}}callback(data)},function(err){console.error(err);callback(data)})}else{callback(data)}})}if(!tx){this.transaction(function(_tx){tx=_tx;_execute()})}else{_execute()}},_generateGUID:function(){var chars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var string_length=32;var randomstring="";for(var i=0;i<string_length;i++){var rnum=Math.floor(Math.random()*chars.length);randomstring+=chars.substring(rnum,rnum+1)}return randomstring},_createTables:function(callback){var self=this;var databaseBackup;fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.DatabaseBackup.getBackup(function(err,_databaseBackup){databaseBackup=_databaseBackup;next()})},function(){self._connection.transaction(function(tx){fvdSpeedDial.Storage.initStorage(tx,databaseBackup,callback)},function(err){console.error("Fail to get transaction for table creation",err)})}])}};fvdSpeedDial.Storage=new Storage})();(function(){const PAGE_SCREEN_PARAMS={format:"image/jpeg",quality:80};var ThumbMaker=function(){this.init()};ThumbMaker.prototype={_listenData:[],removeListener:function(listener){var index=this._listenData.indexOf(listener);if(index!=-1){this._listenData.splice(index,1)}},resize:function(img,sx,callback,params){params=params||{};params.format=params.format||"image/png";params.quality=params.quality||100;var srcLower=img.getAttribute("src").toLowerCase();fvdSpeedDial.Utils.Async.chain([function(next){if(srcLower.indexOf(".svg")==srcLower.length-4){var cc=document.createElement("canvas");cc.width=img.width;cc.height=img.height;var xhr=new XMLHttpRequest;xhr.open("GET",img.getAttribute("src"));xhr.onload=function(){canvg(cc,xhr.responseText,{ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true,offsetX:0,offsetY:0});img=cc;next()};xhr.onerror=function(err){console.error(err);callback(null)};xhr.send(null)}else{next()}},function(){var canvas=document.createElement("canvas");var sy=sx*img.height/img.width;canvas.width=sx;canvas.height=sy;var ctx=canvas.getContext("2d");ctx.drawImage(img,0,0,sx,sy);callback(canvas.toDataURL(params.format,params.quality),{width:sx,height:sy})}])},getImageDataPath:function(params,callback){var imgUrl=params.imgUrl;var screenWidth=params.screenWidth;var img=document.createElement("img");var that=this;img.onerror=function(){callback(null)};img.onload=function(){try{if(img.width<screenWidth){screenWidth=img.width}that.resize(img,screenWidth,function(imgUrl,size){callback(imgUrl,size)},params.format)}catch(ex){console.log(ex)}};img.setAttribute("src",imgUrl)},screenTab:function(params){var tabId,type,dialId,width,url,delay,saveImage;tabId=params.tabId;type=params.type;dialId=params.dialId;width=params.width;url=params.url;delay=params.delay;saveImage=params.saveImage;var listener={tabId:tabId,type:type,dialId:dialId,width:width,url:url,screenDelay:delay,saveImage:saveImage,port:null};for(var i=0;i!=this._listenData.length;i++){if(this._listenData[i].tabId==tabId){this._listenData[i]=listener;return}}this._listenData.push(listener);return},listenerForTab:function(tabId){for(var i=0;i!=this._listenData.length;i++){if(this._listenData[i].tabId==tabId){return this._listenData[i]}}return null},init:function(){var that=this;chrome.tabs.onUpdated.addListener(function(tabId,info,tab){if(info.status){var listener=that.listenerForTab(tabId);if(!listener){return}function returnToSpeedDial(){if(listener.type=="speeddial"){fvdSpeedDial.Storage.getDial(listener.dialId,function(oldDial){chrome.tabs.create({active:true,url:chrome.extension.getURL("newtab.html#force-display&dial_preview_maked="+listener.dialId+"&show_group_id="+oldDial.group_id)},function(){chrome.tabs.remove(tabId)})})}else{chrome.tabs.create({active:true,url:chrome.extension.getURL("newtab.html#force-display")},function(){chrome.tabs.remove(tabId)})}}function saveToDB(result,thumbSize,callback){chrome.tabs.get(tabId,function(tab){switch(listener.type){case"speeddial":fvdSpeedDial.Storage.getDial(listener.dialId,function(oldDial){var resultData={auto_title:tab.title};if(oldDial){fvdSpeedDial.Sync.addDataToSync({category:"dials",data:listener.dialId,translate:"dial"})}if(listener.saveImage){resultData.thumb=result;resultData.screen_maked=1;resultData.thumb_width=thumbSize.width;resultData.thumb_height=thumbSize.height;resultData.need_sync_screen=1}fvdSpeedDial.Storage.updateDial(listener.dialId,resultData,function(){try{port.postMessage({message:"created",data:{urlChanged:!fvdSpeedDial.Utils.isIdenticalUrls(listener.url,tab.url),startUrl:listener.url,currentUrl:tab.url}})}catch(ex){}if(callback){callback()}})});break;case"mostvisited":var resultData={auto_title:tab.title};if(listener.saveImage){resultData.thumb_source_type="screen";resultData.thumb=result;resultData.screen_maked=1;resultData.thumb_width=thumbSize.width;resultData.thumb_height=thumbSize.height}fvdSpeedDial.Storage.MostVisited.updateData(listener.dialId,resultData,function(){try{port.postMessage({message:"created"})}catch(ex){}if(callback){callback()}});break}})}if(!listener.saveImage){if(tab.title){that.removeListener(listener);saveToDB(null,null,function(){returnToSpeedDial()})}return}var port=listener.port;function fullScreen(){setTimeout(function(){chrome.tabs.get(tabId,function(tab){if(tab.status=="complete"){that.removeListener(listener);chrome.tabs.captureVisibleTab(null,{format:"png"},function(dataurl){that.getImageDataPath({imgUrl:dataurl,screenWidth:listener.width,format:PAGE_SCREEN_PARAMS},function(result,thumbSize){saveToDB(result,thumbSize,function(){returnToSpeedDial()})})})}})},500)}fvdSpeedDial.Utils.Async.chain([function(callbackChain){chrome.tabs.executeScript(tabId,{file:"content-scripts/cropper/cropper.js"},function(){setTimeout(function(){if(!listener.canBeScripted){function _waitForTabCompletion(){chrome.tabs.get(tabId,function(tab){if(!tab){return}if(tab.status=="complete"){fullScreen()}else{setTimeout(function(){_waitForTabCompletion()},1e3)}})}_waitForTabCompletion()}},1e3);port=chrome.tabs.connect(tabId,{name:"thumbmaker_cropper"});listener.port=port;port.onMessage.addListener(function(message){switch(message.message){case"change_photo_position":fvdSpeedDial.Prefs.set("cropper_photo_position_left",message.data.left);fvdSpeedDial.Prefs.set("cropper_photo_position_top",message.data.top);break;case"set_url":if(listener.type=="speeddial"){fvdSpeedDial.Storage.updateDial(listener.dialId,{url:message.data.url},function(){port.postMessage({message:"url_setted"})})}break;case"ready_to_init":listener.canBeScripted=true;callbackChain();break;case"return_to_speeddial":returnToSpeedDial();break;case"click_start_crop":port.postMessage({message:"show_crop_area"});break;case"click_cancel":try{that.removeListener(listener);port.postMessage({message:"destroy"})}catch(ex){}break;case"make_fullscreen_snapshoot":fullScreen();break;case"snapshoot":var data=message.data;chrome.tabs.captureVisibleTab(null,{format:"png"},function(dataurl){port.postMessage({message:"captured"});try{that.removeListener(listener)}catch(ex){}var img=document.createElement("img");img.onload=function(){var canvas=document.createElement("canvas");canvas.width=data.width;canvas.height=data.height;var ctx=canvas.getContext("2d");ctx.drawImage(img,data.x1,data.y1,data.width,data.height,0,0,data.width,data.height);that.getImageDataPath({imgUrl:canvas.toDataURL("image/png"),screenWidth:listener.width,format:PAGE_SCREEN_PARAMS},function(result,thumbSize){saveToDB(result,thumbSize)})};img.src=dataurl});break}})})},function(callbackChain){chrome.tabs.executeScript(tabId,{file:"extras/jquery.js"},function(){callbackChain()})},function(callbackChain){chrome.tabs.executeScript(tabId,{file:"content-scripts/cropper/imgareaselect.js"},function(){callbackChain()})},function(callbackChain){chrome.tabs.insertCSS(tabId,{file:"content-scripts/cropper/imgareaselect.css"},function(){callbackChain()})},function(callbackChain){chrome.tabs.executeScript(tabId,{file:"content-scripts/cropper/tiptip.js"},function(){callbackChain()})},function(callbackChain){chrome.tabs.insertCSS(tabId,{file:"content-scripts/cropper/tiptip.css"},function(){callbackChain()})},function(callbackChain){chrome.tabs.insertCSS(tabId,{file:"content-scripts/cropper/style.css"},function(){callbackChain()})},function(){port.postMessage({message:"init",data:{aspectRatio:fvdSpeedDial.SpeedDial._cellsSizeRatio,init:{width:1024,height:1024/fvdSpeedDial.SpeedDial._cellsSizeRatio},minWidth:fvdSpeedDial.SpeedDial.getMaxCellWidth(),delay:listener.screenDelay,photoPosition:{left:fvdSpeedDial.Prefs.get("cropper_photo_position_left",0),top:fvdSpeedDial.Prefs.get("cropper_photo_position_top",0)}}})}])}})}};Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg.action=="thumbmaker:getimagedatapath"){fvdSpeedDial.ThumbMaker.getImageDataPath(msg.params,function(imgUrl,size){sendResponse({imgUrl:imgUrl,size:size})});return true}else if(msg.action=="thumbmaker:screentab"){fvdSpeedDial.ThumbMaker.screenTab(msg.params)}});fvdSpeedDial.ThumbMaker=new ThumbMaker})();(function(){this.PowerOff=new function(){var PASSPHRASE="*j12398sdfh4123iud9123";var SERVER_URL="http://fvdspeeddial.com/sdserver/poweroff.php";var self=this;function callback_prefListener(key,value){if(key=="poweroff.enabled"||key=="poweroff.hidden"){Broadcaster.sendMessage({action:"poweroff:hiddenchange",isHidden:value})}}function cryptString(string){return Aes.Ctr.encrypt(string,PASSPHRASE,256)}function deCryptString(string){return Aes.Ctr.decrypt(string,PASSPHRASE,256)}function getPassword(){return deCryptString(fvdSpeedDial.Prefs.get("poweroff.password"))}function getEmail(){return deCryptString(fvdSpeedDial.Prefs.get("poweroff.restore_email"))}this.isHidden=function(){if(fvdSpeedDial.PowerOff.isEnabled()&&_b(fvdSpeedDial.Prefs.get("poweroff.hidden"))){return true}return false};this.getEmail=function(){return getEmail()};this.isEnabled=function(){return _b(fvdSpeedDial.Prefs.get("poweroff.enabled"))};this.setup=function(email,password){fvdSpeedDial.Prefs.set("poweroff.enabled",true);fvdSpeedDial.Prefs.set("poweroff.password",cryptString(password));fvdSpeedDial.Prefs.set("poweroff.restore_email",cryptString(email))};this.removePassword=function(){fvdSpeedDial.Prefs.set("poweroff.enabled",false)};this.changePassword=function(password){fvdSpeedDial.Prefs.set("poweroff.password",cryptString(password))};this.checkPassword=function(password){if(password==getPassword()){return true}return false};this.restorePassword=function(callback){var url=SERVER_URL+"?a=restore&email="+encodeURIComponent(getEmail())+"&epassword="+encodeURIComponent(fvdSpeedDial.Prefs.get("poweroff.password"));var req=new XMLHttpRequest;req.open("GET",url);req.onload=function(){var response={error:true};try{response=JSON.parse(req.responseText)}catch(ex){}callback(response)};req.onerror=function(){callback({error:true})};req.send()};Broadcaster.onMessage.addListener(function(msg){if(msg.action=="pref:changed"){callback_prefListener(msg.name,msg.value)}})}}).apply(fvdSpeedDial);(function(){fvdSpeedDial.UserInfo={_isGettingUserCountry:false,_userCountryCallbacks:[],getCountry:function(cb){var self=this;var key="user_info.country";if(localStorage[key]){return cb(null,localStorage[key])}this._userCountryCallbacks.push(cb);if(this._isGettingUserCountry){return}this._isGettingUserCountry=true;fvdSpeedDial.Utils.getUserCountry(function(country){if(!country){country="-"}localStorage[key]=country;self._userCountryCallbacks.forEach(function(cb){try{cb(null,country)}catch(ex){console.error(ex)}});self._userCountryCallbacks=[]})}}})();document.addEventListener("DOMContentLoaded",function(){function callback_prefListener(key,value){if(key=="poweroff.idle.interval"){refreshIdleInterval()}}function callback_onIdleStatechanged(state){if(state=="idle"&&parseInt(fvdSpeedDial.Prefs.get("poweroff.idle.interval"),10)&&fvdSpeedDial.PowerOff.isEnabled()){Broadcaster.sendMessage({action:"poweroff:hide"})}}function refreshIdleInterval(){var interval=parseInt(fvdSpeedDial.Prefs.get("poweroff.idle.interval"),10);try{chrome.idle.onStateChanged.removeListener(callback_onIdleStatechanged)}catch(ex){}if(interval){console.log("Set idle callback for",interval);chrome.idle.onStateChanged.addListener(callback_onIdleStatechanged);chrome.idle.setDetectionInterval(interval)}}Broadcaster.onMessage.addListener(function(msg){if(msg.action=="pref:changed"){callback_prefListener(msg.name,msg.value)}});refreshIdleInterval()},false);(function(){function sendEvent(action){var statsUrl="http://fvdspeeddial.com/a/?a="+encodeURIComponent(action)+"&from=chrome_addon";fvdSpeedDial.Utils.getUrlContent(statsUrl,function(){})}Broadcaster.onMessage.addListener(function(message){if(message.action==="first-install"){sendEvent("install")}})})();(function(){const UPDATE_AD_INTERVAL=24*3600*1*1e3;const AD_URL="https://s3.amazonaws.com/fvd-special/remotead/fvdsd_chrome2.json";const USE_CACHE=true;var console={};var messages={donotdisplay:_("newtab_do_not_display_migrate")};var supportedLanguages=[];var adHTML="<div>"+"<iframe></iframe>"+"</div>";chrome.i18n.getAcceptLanguages(function(languageList){supportedLanguages=languageList});console.log=function(){var args=Array.prototype.slice.call(arguments);args.unshift("REMOTEAD:");window.console.log.apply(window.console,args)};console.error=function(){var args=Array.prototype.slice.call(arguments);args.unshift("REMOTEAD ERROR:");window.console.error.apply(window.console,args)};if(!USE_CACHE){window.console.warn("Use REMOTEAD without cache!")}var storage=new function(){function _k(k){return"__remotead."+k}this.set=function(k,v){localStorage[_k(k)]=v};this.get=function(k){return localStorage[_k(k)]}};function getUrlContents(url,callback){var xhr=new XMLHttpRequest;xhr.open("GET",url);xhr.onload=function(){callback(xhr.responseText)};xhr.send(null)}function hasEqualElements(a,b){for(var i=0;i!=a.length;i++){if(b.indexOf(a[i])!=-1){return true}}return false}function cloneObj(obj){return JSON.parse(JSON.stringify(obj))}function parseUrl(str,component){var key=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],ini=this.php_js&&this.php_js.ini||{},mode=ini["phpjs.parse_url.mode"]&&ini["phpjs.parse_url.mode"].local_value||"php",parser={php:/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/\/?)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/};var m=parser[mode].exec(str),uri={},i=14;while(i--){if(m[i]){uri[key[i]]=m[i]}}if(component){return uri[component.replace("PHP_URL_","").toLowerCase()]}if(mode!=="php"){var name=ini["phpjs.parse_url.queryKey"]&&ini["phpjs.parse_url.queryKey"].local_value||"queryKey";parser=/(?:^|&)([^&=]*)=?([^&]*)/g;uri[name]={};uri[key[12]].replace(parser,function($0,$1,$2){if($1){uri[name][$1]=$2}})}delete uri.source;return uri}Broadcaster.onMessage.addListener(function(msg){if(msg.a=="remoteAD:ignore"){RemoteAD.ignoreAd(msg.id)}});chrome.tabs.onUpdated.addListener(function(tabId,changeInfo,tab){if(changeInfo.status=="complete"){try{var host=parseUrl(tab.url,"host").toLowerCase();host=host.replace(/^www\./,"");RemoteAD.getADToShow({host:host},function(ad){if(ad){chrome.tabs.sendMessage(tabId,{a:"fvd:remotead:show",ad:ad,html:adHTML})}})}catch(ex){console.error("Fail check tab",ex)}}});var RemoteAdClass=function(){var _isFirstStart=null;function cacheTTL(cache){return(new Date).getTime()-cache.createDate}function getADList(params,callback){var cache=storage.get("adcache");var now=(new Date).getTime();if(USE_CACHE&&cache){try{cache=JSON.parse(cache);if(cacheTTL(cache)>0){console.log("CACHE!");return callback(cache.data)}}catch(ex){}}getUrlContents(AD_URL+"?c="+(new Date).getTime(),function(text){console.log(text);var data=JSON.parse(text);var cache={createDate:(new Date).getTime(),data:data};storage.set("adcache",JSON.stringify(cache));callback(data)})}function isFirstStart(){if(_isFirstStart===null){if(!storage.get("firstStartCompleted")){
_isFirstStart=true;storage.set("firstStartCompleted",true)}else{_isFirstStart=false}console.log("Is first start?",_isFirstStart)}return _isFirstStart}function canDisplayAD(ad){var now=(new Date).getTime();if(ad.languages){if(!hasEqualElements(ad.languages,supportedLanguages)){console.log("Language not supported",ad.languages,", not in list of ",supportedLanguages);return false}}if(ad.newUserDelay){var obtainedTime=parseInt(storage.get("ad.obtained_time."+ad.id));if(obtainedTime){if(now-obtainedTime<ad.newUserDelay*3600*1e3){console.log("Delay is active");return false}}else if(isFirstStart()){storage.set("ad.obtained_time."+ad.id,now);console.log("Need to wait delay for first start",ad.newUserDelay);return false}}var adIgnored=!!parseInt(storage.get("ad.ignored."+ad.id));if(adIgnored){console.log("AD is ignored by user");return false}return true}function getADToShow(params,callback){if(typeof params=="function"){callback=params;params={}}params=params||{};getADList(null,function(ads){for(var i=0;i!=ads.length;i++){var ad=ads[i];if(params.nohosts&&ad.hosts&&ad.hosts.length>0){continue}if(params.host&&(!ad.hosts||ad.hosts.indexOf(params.host)==-1)){continue}ad=cloneObj(ad);ad.frameUrl+="?id="+encodeURIComponent(ad.id);if(canDisplayAD(ad)){callback(ad);return}else{console.log("Can't show")}}callback(null)})}this.ignoreAd=function(adId){storage.set("ad.ignored."+adId,1)};this.getADToShow=function(){return[]}};var RemoteAD=new RemoteAdClass;window.RemoteAD=RemoteAD})();(function(){var TempStore={_key:function(id){return"_tmp_store_"+id},pop:function(id){var value=MemoryCache.get(this._key(id));if(!value){return null}MemoryCache.del(this._key(id));return value.join("")},append:function(id,value){var currentValue=MemoryCache.get(this._key(id));if(!currentValue){currentValue=[]}currentValue.push(value);MemoryCache.set(this._key(id),currentValue,6e5)}};var Sync=function(){var fvdSynchronizerName="EverSync";var fvdSynchronizerId="iohcojnlgnfbmjfjfkbhahhmppcggdog";var self=this;var active=false;var port=null;var lastTransactionId=0;var lastRequestId=0;var pendingRequests=[];var PENDING_REQUESTS_TIMEOUT=1e3*5*60;function setActivity(newActivity){active=newActivity;Broadcaster.sendMessage({action:"sync:activitystatechanged"})}function clearExpiredRequests(){var now=(new Date).getTime();var ids=[];pendingRequests.forEach(function(request){if(now-request.time>=PENDING_REQUESTS_TIMEOUT){ids.push(request.id)}});ids.forEach(function(id){removePendingRequest(id)})}function removePendingRequest(id){var index=-1;for(var i=0;i!=pendingRequests.length;i++){if(pendingRequests[i].id==id){index=i;break}}if(index!=-1){pendingRequests.splice(index,1)}}function requestWithCallback(data,callback){if(!port){return callback(null)}lastRequestId++;data.requestId=lastRequestId;pendingRequests.push({id:lastRequestId,callback:callback,time:(new Date).getTime()});try{port.postMessage(data)}catch(ex){}}function callRequestResponse(requestId,data){pendingRequests.forEach(function(request){if(request.id==requestId){request.callback(data)}});removePendingRequest(requestId)}this.isActive=function(){return active};this.hasDataToSync=function(callback){requestWithCallback({action:"hasToSyncData"},function(response){callback(response&&response.has)})};this.groupSyncChanged=function(groupId,callback){fvdSpeedDial.Storage.getGroup(groupId,function(group){if(group.sync==1){fvdSpeedDial.Utils.Async.chain([function(chainCallback){fvdSpeedDial.Sync.removeSyncData({category:["deleteGroups"],data:group.global_id},function(){chainCallback()})},function(chainCallback){fvdSpeedDial.Storage.listDialsIdsByGroup(groupId,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,arrayProcessCallback){fvdSpeedDial.Sync.removeSyncData({category:["deleteDials"],data:dial.global_id},arrayProcessCallback)},function(){chainCallback()})})},function(chainCallback){fvdSpeedDial.Storage.groupsRawList({},function(groups){fvdSpeedDial.Utils.Async.arrayProcess(groups,function(group,arrayProcessCallback){if(group.sync==1){fvdSpeedDial.Sync.addDataToSync({category:["groups","newGroups"],data:group.global_id,syncAnyWay:true},arrayProcessCallback)}else{arrayProcessCallback()}},function(){chainCallback()})})},function(chainCallback){fvdSpeedDial.Sync.addDataToSync({category:["specialActions"],data:"merge_group:"+groupId+":"+group.global_id},chainCallback)},function(){if(callback){callback()}}])}else if(group.sync==0){fvdSpeedDial.Utils.Async.chain([function(chainCallback){fvdSpeedDial.Sync.removeSyncData({category:["groups","newGroups"],data:group.global_id},chainCallback)},function(chainCallback){fvdSpeedDial.Sync.removeSyncData({category:["specialActions"],data:"merge_group:"+groupId+":"+group.global_id},chainCallback)},function(chainCallback){fvdSpeedDial.Sync.addDataToSync({category:["deleteGroups"],data:group.global_id,syncAnyWay:true},chainCallback)},function(chainCallback){fvdSpeedDial.Storage.listDialsIdsByGroup(groupId,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,arrayProcessCallback){fvdSpeedDial.Sync.addDataToSync({category:["deleteDials"],data:dial.global_id,syncAnyWay:true},arrayProcessCallback)},chainCallback)})},function(){chrome.extension.sendRequest({message:"displayNoSyncGroupAlert",needActiveTab:true});if(callback){callback()}}])}})};this.syncAddonOptionsUrl=function(callback){getSynchronizerId(function(id){var url=null;if(id){url="chrome-extension://"+id+"/options.html"}callback(url)})};this.syncAddonExists=function(callback){getSynchronizerId(function(id){var exists=false;if(id){exists=true}callback(exists)})};this.removeSyncData=function(params,callback){var category=params.category;var _data=params.data;var data=_data;params=params||{};if(!active){if(callback){callback()}return}if(typeof category=="string"){category=[category]}requestWithCallback({action:"removeSyncData",data:data,category:category},function(){if(callback){callback()}})};this.importFinished=function(){port.postMessage({action:"importFinished"})};this.addDataToSync=function(params,callback){var category=params.category;var _data=params.data;if(!active){if(callback){callback()}return}var data=null;if(typeof category=="string"){category=[category]}fvdSpeedDial.Utils.Async.chain([function(chainCallback){if(params.translate){if(params.translate=="group"){fvdSpeedDial.Storage.groupGlobalId(_data,function(globalId){data=globalId;chainCallback()})}else if(params.translate=="dial"){fvdSpeedDial.Storage.dialGlobalId(_data,function(globalId){data=globalId;chainCallback()})}else{console.log("Undefined translate",params.translate)}}else{data=_data;chainCallback()}},function(chainCallback){if(params.syncAnyWay){chainCallback();return}chainCallback()},function(){requestWithCallback({action:"addDataToSync",data:data,category:category},function(){if(callback){callback()}})}])};this.startSync=function(type,callback){type=type||"main";requestWithCallback({action:"startSync",type:type},function(result){if(callback){callback(result.state)}})};function clearGroupsAndDials(callback){fvdSpeedDial.Utils.Async.chain([function(chainCallback){fvdSpeedDial.Storage.clearDials(function(){chainCallback()},"(SELECT `groups`.`sync` FROM `groups` WHERE `groups`.`id` = `dials`.`group_id`) = 1")},function(chainCallback){fvdSpeedDial.Storage.clearGroups(function(){chainCallback()},"`sync` = 1")},function(){callback()}])}function getStorage(message,callback){callback(fvdSpeedDial.Storage)}function createTransaction(callback){lastTransactionId++;var id=lastTransactionId;fvdSpeedDial.Storage.backupTables(["dials","groups"],id,function(){callback(id)})}function commitTransaction(id,callback){fvdSpeedDial.Storage.removeBackup(id,callback)}function rollbackTransaction(id,callback){fvdSpeedDial.Storage.restoreBackup(id,callback)}function processPortMessage(message){switch(message.action){case"saveTempData":var id=message.data.id;var value=message.data.value;TempStore.append(id,value);console.log("Got a chunk",id);sendResponse(message.requestId,{id:id});break;case"startTransaction":createTransaction(function(id){sendResponse(message.requestId,{transId:id})});break;case"rollbackTransaction":rollbackTransaction(message.transId,function(){sendResponse(message.requestId,{})});break;case"commitTransaction":commitTransaction(message.transId,function(){sendResponse(message.requestId,{})});break;case"syncStartNotification":fvdSpeedDial.AppLog.info("sync starts");chrome.extension.sendMessage({action:"syncStartNotification"});break;case"syncEndNotification":fvdSpeedDial.AppLog.info("sync ends");chrome.extension.sendMessage({action:"syncEndNotification"});break;case"clearGroupsAndDials":fvdSpeedDial.AppLog.info("sync clear groups and dials");clearGroupsAndDials(function(){sendResponse(message.requestId,{})});break;case"toSyncDataChanged":Broadcaster.sendMessage({action:"sync:syncdatachanged"});break;case"restoreBackup":fvdSpeedDial.AppLog.info("restore backup");getStorage(message,function(s){if(typeof message.data==="string"){message.data=JSON.parse(TempStore.pop(message.data))}s.restoreTablesData(message.data,function(){sendResponse(message.requestId,{})},function(current,max){port.postMessage({action:"restoreBackupProgress",current:current,max:max})})});break;case"queryGroups":getStorage(message,function(s){if(!message.ignoreNoSync){var whereSync="`groups`.`sync` = 1";if(message.where){message.where.push(whereSync)}else{message.where=[whereSync]}}s.groupsRawList(message,function(list){sendResponse(message.requestId,{list:list})})});break;case"queryDialThumb":getStorage(message,function(s){s.getDialThumb(message.global_id,function(thumb){sendResponse(message.requestId,{thumb:thumb})})});break;case"queryDials":getStorage(message,function(s){if(!message.ignoreNoSync){var whereSync="(SELECT `sync` FROM `groups` WHERE `groups`.`id` = `dials`.`group_id`) = 1";if(message.where){message.where.push(whereSync)}else{message.where=[whereSync]}}s.dialsRawList(message,function(list){sendResponse(message.requestId,{list:list})})});break;case"mergeUpdateCollisedGroup":getStorage(message,function(s){s.groupUpdate(message.clientGroup.id,{global_id:message.serverGroup.global_id},function(){sendResponse(message.requestId)})});break;case"mergeUpdateCollisedDial":getStorage(message,function(s){s.updateDial(message.clientDial.rowid,{global_id:message.serverDial.global_id},function(){fvdSpeedDial.Storage.dialCanSync(message.serverDial.global_id,function(can){if(can){s.syncSaveDial(message.serverDial,function(saveInfo){sendResponse(message.requestId,{saveInfo:saveInfo})})}else{sendResponse(message.requestId,{saveInfo:null})}})})});break;case"saveGroup":getStorage(message,function(s){fvdSpeedDial.Storage.groupCanSync(message.group.global_id,function(can){if(can){s.syncSaveGroup(message.group,function(){sendResponse(message.requestId)})}else{sendResponse(message.requestId)}})});break;case"moveDial":getStorage(message,function(s){s.moveDial(message.id,message.groupId,function(){sendResponse(message.requestId)})});break;case"saveDial":getStorage(message,function(s){s.syncSaveDial(message.dial,function(saveInfo){sendResponse(message.requestId,{saveInfo:saveInfo})})});break;case"updateMass":getStorage(message,function(s){console.log("OBtained message",message);s.syncUpdateMass(message.globalIds,message.data,function(){if(message.requestId){sendResponse(message.requestId,{})}})});break;case"removeGroupsNotInList":var notRemoveGroups=message.groupsIds;getStorage(message,function(s){s.syncRemoveGroups(notRemoveGroups,function(removed){sendResponse(message.requestId,{removed:removed})})});break;case"removeDialsNotInList":var notRemoveDials=message.dialsIds;getStorage(message,function(s){s.syncRemoveDials(notRemoveDials,function(removeInfo){sendResponse(message.requestId,{removeInfo:removeInfo})})});break;case"fixGroupsPositions":getStorage(message,function(s){s.syncFixGroupsPositions(function(){sendResponse(message.requestId)})});break;case"fixDialsPositions":getStorage(message,function(s){s.syncFixDialsPositions(message.groupId,function(){sendResponse(message.requestId)})});break;case"rebuild":chrome.runtime.sendMessage({action:"forceRebuild"});var activeGroupId=fvdSpeedDial.Prefs.get("sd.default_group");if(activeGroupId&&activeGroupId>0){fvdSpeedDial.Storage.groupExistsById(activeGroupId,function(exists){if(!exists){fvdSpeedDial.Storage.resetDefaultGroupId()}})}fvdSpeedDial.ContextMenu.rebuild();break;case"syncAllGroupContents":fvdSpeedDial.Storage.syncGetGroupId(message.groupGlobalId,function(id){if(id){fvdSpeedDial.Sync.groupSyncChanged(id,function(){sendResponse(message.requestId)})}else{sendResponse(message.requestId)}});break;case"addGroupDialsToSync":fvdSpeedDial.Utils.Async.chain([function(chainCallback){fvdSpeedDial.Sync.addDataToSync({category:["groups"],data:message.groupGlobalId},chainCallback)},function(){fvdSpeedDial.Storage.syncGetGroupId(message.groupGlobalId,function(groupId){fvdSpeedDial.Storage.listDialsIdsByGroup(groupId,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,arrayProcessCallback){fvdSpeedDial.Sync.addDataToSync({category:["dials","newDials"],data:dial.global_id},arrayProcessCallback)},function(){sendResponse(message.requestId)})})})}]);break;case"setGroupSync":fvdSpeedDial.Storage.syncGetGroupId(message.global_id,function(groupId){if(!groupId){sendResponse(message.requestId)}else{fvdSpeedDial.Storage.groupUpdate(groupId,{sync:message.value},function(){sendResponse(message.requestId)})}});break;case"dialCanSync":fvdSpeedDial.Storage.dialCanSync(message.global_id,function(can){sendResponse(message.requestId,{can:can})});break;case"countItems":var result={};fvdSpeedDial.Utils.Async.chain([function(chainCallback){fvdSpeedDial.Storage.countDials(function(countDials){result.dials=countDials;chainCallback()})},function(chainCallback){fvdSpeedDial.Storage.groupsCount(function(countGroups){result.groups=countGroups;chainCallback()})},function(){sendResponse(message.requestId,result)}]);break;case"_response":callRequestResponse(message.requestId,message);break}}function sendResponse(requestId,message){message=message||{};message.action="_response";message.requestId=requestId;port.postMessage(message)}function getSynchronizerId(callback){chrome.management.getAll(function(results){var id=null;results.forEach(function(extension){if(extension.enabled&&(extension.name==fvdSynchronizerName||extension.id==fvdSynchronizerId)){id=extension.id}});callback(id)})}chrome.extension.onMessageExternal.addListener(function(message,sender,callback){switch(message.action){case"sayHello":callback("hello");break}});chrome.extension.onConnectExternal.addListener(function(_p,sender){if(!_p.sender){console.log("Sender not specified");return}port=_p;port.onMessage.addListener(processPortMessage);port.onDisconnect.addListener(function(){setActivity(false)});if(fvdSpeedDial.PowerOff.isHidden()){return}port.postMessage({action:"activate",apiv:2});if(!_b(fvdSpeedDial.Prefs.get("sd.synced_after_install"))){fvdSpeedDial.Prefs.set("sd.synced_after_install",true);port.postMessage({action:"needInitialSync"})}setActivity(true)});setInterval(function(){clearExpiredRequests()},1e3*60*5);Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg.action=="poweroff:hiddenchange"){if(port){try{if(msg.isHidden){port.postMessage({action:"deactivate"})}else{port.postMessage({action:"activate"})}}catch(ex){}}}else if(msg.action=="sync:adddatatosync"){fvdSpeedDial.Sync.addDataToSync(msg.params,function(){if(msg.wantResponse){sendResponse()}});if(msg.wantResponse){return true}}else if(msg.action=="sync:removesyncdata"){fvdSpeedDial.Sync.removeSyncData(msg.params,function(){sendResponse()});return true}else if(msg.action=="sync:isactive"){sendResponse(fvdSpeedDial.Sync.isActive());return true}else if(msg.action=="sync:hasdatatosync"){fvdSpeedDial.Sync.hasDataToSync(function(has){sendResponse(has)});return true}else if(msg.action=="sync:start"){fvdSpeedDial.Sync.startSync(msg.type,function(state){sendResponse(state)});return true}else if(msg.action=="sync:addonoptionsurl"){fvdSpeedDial.Sync.syncAddonOptionsUrl(sendResponse);return true}else if(msg.action=="sync:importfinish"){fvdSpeedDial.Sync.importFinished()}else if(msg.action=="sync:syncaddonexists"){fvdSpeedDial.Sync.syncAddonExists(sendResponse);return true}})};this.Sync=new Sync}).apply(fvdSpeedDial);(function(){fvdSpeedDial.WidgetServer=new function(){var widgets={};var self=this;this.getAll=function(){var result=[];for(var id in widgets){var widget=self.getById(id);result.push(widget)}return result};this.getById=function(id){if(!widgets[id]){return null}var widget=fvdSpeedDial.Utils.clone(widgets[id]);widget.id=id;return widget};this.remove=function(id){chrome.management.setEnabled(id,false)};function _setupListeners(){chrome.extension.onMessageExternal.addListener(function(message,sender){if(message&&message.action){switch(message.action){case"fvdSpeedDial:Widgets:Widget:setWidgetInfo":if(!widgets[sender.id]){_addWidgetToList(sender.id,message.body)}else{_updateWidgetInList(sender.id,message.body)}break}}});chrome.management.onUninstalled.addListener(function(addonId){if(widgets[addonId]){_removeWidgetFromList(addonId)}});chrome.management.onDisabled.addListener(function(addon){if(widgets[addon.id]){_removeWidgetFromList(addon.id)}});Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){switch(msg.action){case"widgets:setallpositions":fvdSpeedDial.WidgetServer.WidgetPositions.setAllWidgetPositions(msg.positions);break;case"widgets:getposition":var pos=fvdSpeedDial.WidgetServer.WidgetPositions.getWidgetPosition(msg.id);sendResponse(pos);return true;break;case"widgets:remove":fvdSpeedDial.WidgetServer.remove(msg.id);break;case"widgets:getall":var widgets=fvdSpeedDial.WidgetServer.getAll();widgets.forEach(function(w){w.position=fvdSpeedDial.WidgetServer.WidgetPositions.getWidgetPosition(w.id)});sendResponse(widgets);return true;break}})}function _addWidgetToList(id,info){if(info.apiv!=2){return}widgets[id]=info;fvdSpeedDial.WidgetServer.WidgetPositions.setWidgetPosition(id,0);fvdSpeedDial.WidgetServer.WidgetPositions.fixPositions(id);Broadcaster.sendMessage({action:"widgets:added",id:id})}function _updateWidgetInList(id,info){if(info.apiv!=2){return}widgets[id]=info;Broadcaster.sendMessage({action:"widgets:updated",id:id})}function _removeWidgetFromList(id){if(widgets[id]){delete widgets[id];fvdSpeedDial.WidgetServer.WidgetPositions.removePosition(id);Broadcaster.sendMessage({action:"widgets:removed",id:id})}}function _sendIsWidgetRequest(addonId){chrome.runtime.sendMessage(addonId,{action:"fvdSpeedDial:Widgets:Server:isWidget"})}function _scanAllAddons(){chrome.management.getAll(function(addons){addons.forEach(function(addon){_sendIsWidgetRequest(addon.id)})})}function init(){_setupListeners();_scanAllAddons()}window.addEventListener("load",function(){init()},false)};fvdSpeedDial.WidgetServer.WidgetPositions=new function(){function _getWidgetPositionsList(){var list={};try{list=JSON.parse(localStorage["widget_positions"])}catch(ex){}return list}function _setWidgetPositionsList(list){localStorage["widget_positions"]=JSON.stringify(list)}function _removeWidgetsPosition(widgetId){var list=_getWidgetPositionsList();delete list[widgetId];_setWidgetPositionsList(list);_fixWidgetPositionsList()}function _fixWidgetPositionsList(){var list=_getWidgetPositionsList();var items=[];for(var id in list){items.push({id:id,position:list[id]})}items.sort(function(a,b){return a.position-b.position});var newList={};for(var i=0;i!=items.length;i++){newList[items[i].id]=i+1}_setWidgetPositionsList(newList)}function _nextWidgetPosition(){var max=0;var list=_getWidgetPositionsList();for(var k in list){if(list[k]>max){max=list[k]}}return max+1}this.getWidgetPosition=function(widgetId){var list=_getWidgetPositionsList();if(!list[widgetId]){list[widgetId]=_nextWidgetPosition();_setWidgetPositionsList(list)}return list[widgetId]};this.setWidgetPosition=function(widgetId,position){var list=_getWidgetPositionsList();list[widgetId]=position;_setWidgetPositionsList(list)};this.setAllWidgetPositions=function(data){_setWidgetPositionsList(data);_fixWidgetPositionsList()};this.fixPositions=function(){_fixWidgetPositionsList()};this.resetPositionList=function(){_setWidgetPositionsList({})};this.removePosition=function(widgetId){_removeWidgetsPosition(widgetId)}}})();fvdSpeedDial.RuntimeStore=new function(){var PREFIX="__runtime_storage:";for(var k in localStorage){if(k.indexOf(PREFIX)===0){delete localStorage[k]}}function _key(k){return PREFIX+k}this.set=function(k,v){localStorage[_key(k)]=JSON.stringify({value:v,type:typeof v});Broadcaster.sendMessage({action:"runtimestore:itemchanged",name:k,value:v})};this.get=function(k){var t=localStorage[_key(k)];if(!t){return}t=JSON.parse(t);var v=t.value;switch(t){case"boolean":v=v==="true";break;case"number":v=parseInt(v,10);break}return v}};(function(){var ChromeTheme=function(){var self=this;var LS_PREFIX="chrometheme_";var THEMES_CONFIG_URL="http://coolchromethemes.com/admin/api/getThemesSettings";var THEME_CONGIF_URL="http://coolchromethemes.com/admin/api/getThemeSettings?app=%id%";var THEMES_CACHE_TTL=24*3600*7*1e3;var themesConfig=null;function loadThemesConfig(callback){callback=callback||function(){};if(themesConfig){return callback()}var cached=_getExpired("themes_config");if(cached){themesConfig=cached;return callback()}fvdSpeedDial.Utils.getUrlContent(THEMES_CONFIG_URL,function(content){var tmp;try{tmp=JSON.parse(content)}catch(ex){}if(!tmp||tmp.error){console.error("Fail to fetch themes config",tmp);themesConfig=[];return callback()}themesConfig=tmp.body;_setExpired("themes_config",themesConfig,THEMES_CACHE_TTL);callback()})}function loadThemeConfig(themeId,callback){callback=callback||function(){};if(themesConfig&&getThemeData(themeId)){return callback()}var url=THEME_CONGIF_URL.replace("%id%",themeId);fvdSpeedDial.Utils.getUrlContent(url,function(content){var tmp;try{tmp=JSON.parse(content)}catch(ex){}if(!tmp||tmp.error){console.error("Fail to fetch theme config",tmp);return callback()}if(!themesConfig){themesConfig=[]}themesConfig.push(tmp.body);callback()})}function _setExpired(key,value,ttl){localStorage[LS_PREFIX+key]=JSON.stringify({value:value,expires:(new Date).getTime()+ttl})}function _getExpired(key){var tmp=localStorage[LS_PREFIX+key];if(!tmp){return null}try{tmp=JSON.parse(tmp)}catch(ex){return null}var now=(new Date).getTime();if(now>tmp.expires){return null}return tmp.value}function _set(key,value){localStorage[LS_PREFIX+key]=value}function _get(key){return localStorage[LS_PREFIX+key]}function restoreDefault(){var currentSdTheme=fvdSpeedDial.Prefs.get("sd.display_mode");var url=fvdSpeedDial.Prefs._themeDefaults[currentSdTheme]["sd.background_url"];function _end(){for(var k in fvdSpeedDial.Prefs._themeDefaults[currentSdTheme]){fvdSpeedDial.Prefs.set(k,fvdSpeedDial.Prefs._themeDefaults[currentSdTheme][k])}_set("last_offered_theme_id","");_set("current_bg_theme_id","")}if(url){fvdSpeedDial.Utils.imageUrlToDataUrl(url,function(du){fvdSpeedDial.Storage.setMisc("sd.background",du,function(){_end()})})}else{_end()}}function currentThemeId(callback){if(_get("last_installed_theme")){return callback(_get("last_installed_theme"))}chrome.management.getAll(function(exts){var themeId=null;for(var i=0;i!=exts.length;i++){var ext=exts[i];if(ext.type=="theme"){themeId=ext.id}}callback(themeId)})}function getThemeData(themeId){for(var i=0;i!=themesConfig.length;i++){if(themesConfig[i].id==themeId){return themesConfig[i]}}return null}this.useThemeBg=function(theme,callback){fvdSpeedDial.Utils.imageUrlToDataUrl(theme.bgUrl,function(du){self.doNotShowCurrentThemeOffer();fvdSpeedDial.Storage.setMisc("sd.background",du,function(){fvdSpeedDial.Prefs.set("sd.background_url","<customFile>");fvdSpeedDial.Prefs.set("sd.background_url_type","fill");_set("current_bg_theme_id",theme.id);if(callback){self.setPrefsForCurrentAppliedTheme();callback()}})})};this.setPrefsForCurrentAppliedTheme=function(){var currentAppliedThemeId=_get("current_bg_theme_id");if(currentAppliedThemeId){var theme=self.getThemeData(currentAppliedThemeId);if(theme.prefs){for(var k in theme.prefs){fvdSpeedDial.Prefs.set(k,theme.prefs[k])}}}};this.getThemeData=function(themeId){var data=getThemeData(themeId);data.bgUrl=this.getThemeBgUrl(themeId);data.thumbUrl="http://fvdspeeddial.com/themes/"+themeId+"/thumb.png";return data};this.getThemeBgUrl=function(themeId){var data=getThemeData(themeId);var url="http://fvdspeeddial.com/themes/"+themeId;var bgFilePath="";if(typeof data.bgFilePath=="string"){bgFilePath=data.bgFilePath}else{var screenWidth=window.screen.width;var minDelta=999999999;var minDeltaValue="";var selectedWidth=0;var backgrounds=data.bgFilePath;var w;var widths=[];for(w in backgrounds){widths.push(parseInt(w,10))}widths.sort();for(w in backgrounds){var delta=Math.abs(screenWidth-w);if(delta===0){minDelta=delta;minDeltaValue=backgrounds[w];selectedWidth=w;break}if(delta<minDelta){minDelta=delta;minDeltaValue=backgrounds[w];selectedWidth=w}}if(minDelta!==0&&selectedWidth<screenWidth){for(var i=0;i!=widths.length;i++){w=widths[i];if(w>selectedWidth){selectedWidth=w;minDeltaValue=backgrounds[w];break}}}bgFilePath=minDeltaValue}if(bgFilePath){url+=bgFilePath}else{url+="/bg.jpg"}return url};this.needOfferThemeBg=function(callback){currentThemeId(function(themeId){if(!themeId){return callback(false)}if(_get("last_offered_theme_id")!=themeId){if(getThemeData(themeId)){callback(true,themeId)}else{callback(false)}}else{callback(false)}})};this.doNotShowCurrentThemeOffer=function(){currentThemeId(function(themeId){_set("last_offered_theme_id",themeId)})};window.addEventListener("load",function(){loadThemesConfig(function(){})});Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg.action=="chrometheme:needofferthemebg"){fvdSpeedDial.ChromeTheme.needOfferThemeBg(function(need,themeId){sendResponse({need:need,themeId:themeId})});return true}else if(msg.action=="chrometheme:getthemedata"){var data=fvdSpeedDial.ChromeTheme.getThemeData(msg.themeId);sendResponse(data);return true}else if(msg.action=="chrometheme:usebg"){fvdSpeedDial.ChromeTheme.useThemeBg(msg.theme,function(){sendResponse()});return true}else if(msg.action=="chrometheme:donotshowcurrentthemeoffer"){fvdSpeedDial.ChromeTheme.doNotShowCurrentThemeOffer()}else if(msg.action=="chrometheme:setprefsforcurrentappliedtheme"){fvdSpeedDial.ChromeTheme.setPrefsForCurrentAppliedTheme()}});chrome.management.onInstalled.addListener(function(ext){if(ext.type=="theme"){_set("last_installed_theme",ext.id);loadThemeConfig(ext.id,function(){_set("last_offered_theme_id","");self.needOfferThemeBg(function(need,themeId){if(need){Broadcaster.sendMessage({action:"chrometheme:themebgavailable",themeId:themeId})}})})}});chrome.management.onUninstalled.addListener(function(id){_set("last_installed_theme","");if(_get("current_bg_theme_id")==id){restoreDefault()}})};fvdSpeedDial.ChromeTheme=new ChromeTheme})();(function(){var CAPTURE_WIDTH=1024;var CAPTURE_HEIGHT=768;var CAPTURE_TIMEOUT=6e4*2;var CHECK_COMPLETE_INTERVAL=1e3;var CHECK_COMPLETE_INTERVAL_FINAL=3e3;var DISPLAY_HIDDEN_WINDOW_MONITOR=5;var CANNOT_CAPTURE_REGEXPS=[/^chrome:\/\//i,/^chrome-extension:\/\//i];var FAILED_IMAGE={src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAF8AAAB2CAYAAACu708LAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAIDZJREFUeNrsXQuwVtV1/u/1FxREuCCCKIjgA1DUCklLE6epYps0pmnaiOk0JtNJgp02aZJpRnCmiWltJ5pkmiZmpiMTbcfEsan1MWl9VRwfSWumPkZ8ICoi4AMRuCCKKIq333dyvuu6i7X2OdeYlMxwZs5/zn8e+7H2eq+19+l5+eWXOz09PR1uAwMD1TmP2ux/nr/yyiudV199tfo/atSozoYNGzqjR4/u7Nq1q7p24IEHdl5//fXqOb7H/9x2797d2X///Ttvvvlm57XXXqvu8T3VyXYcdNBBfPdwlHUCnlmAfQaePwnvjn3jjTeOtO3p7e0dbCPLVPtxfWC//fZbg7/bu93u/Xh+/ciRI3+C/4/g3ka2gW1lG/FcB/eqsnbs2NEZO3ZsVRb/s56dO3dW5+ob28u28z2297DDDhusn7BAfR27qW86tzDl1rU3PKCjF3TUe7aC4Wx6Bw0fic7NR2c+sH379lNxPhdl9rFDfEbt0Dk3AkR167+ew96Dd2fyHAP2awIiALYFz60A8H+M44147X4c34j6ZduY9c1fVxvV7ugZD9Ouv2E6Eb708wDcNgiAefeWLVs+Cgr5IAA+x2IyN2JXVo9tn22vHyw3yBNAQaeh3tNw/wKU/yCw/z9w/1pg//0RoFVum/7a+mzbIvjuAXwL3IzleDIqNShhXwcA2B/t7+//DIBwKrGUQBegmzBQ7MVfb2KVFiPN/xPBQrgvBTXcCZaxDNeuQ3t2eaBF57a+6H/GdkLMz4DmC8r4WPY8d2DcKLCVT7z00kt/AaCfoHo80D3FqRwCzmNhhhRiQ6IkP6gBVewHCqgoYuPGjQ+Ar18yZsyYK9G21zKWXML8CAk8ReqZPdiOfbnEekq80jy/34svvngOgP4ldO54i4kCqhegvIZnq+u8NmLEiEpoH3DAAdVOoUahyYGzAldClMoAzynweaSg10BrUDxAhQSo9+Rt27ZdBuH7OQj/b6Duq/DMQEkWRBidIaOHZbdpREsVZ++ygwDCb2K/GEB4r8VEywI02Pwv7YMaRV9fX2fcuHHVObUIC+i2GweQmgkGvgOAVjsHhPXYQbB9kODGgJ0M1nglBvszqP881H9PxmY9RkdCNtu6bdlKGx5XN3z05s2b/xqay1/h0v4WcAI2O0mMJIB4TkBPnDixc8ghh1Tq5juxkUK4cwAnT55cXaN6CCHf2bRpU2fr1q3VoPMZy6LUd7YbA/U+UO5doIBvgPq+hss7M0HsKSASvKm24wuIBFlpRGts/3Xo/d8Fxs0na/Caif4TI6lfT506tQLMwQcf3PllbBxY7kceeWRFEc8991xlp7A9HIQEiw/A/S9jIBZiED6H//dFamh0XpAzP2M7mYAo8Xw/WAQ8MOTPsH8T10bLmPLPEtPJv4866qjOEUccUfHz/68NQrVz3HHHVW159tlnO88880zFlth223+xIvRnASj6dtz/4oQJEy5ri5RF6oykcJOwtdfRuC4a/00Iqc9boWkbQaATs2bOnNmZNm1aR1SxN2xEAA7A4Ycf3nn66aernZQgxHBsZAzufQ9INguXzqeRZpEs4xSZ8dr1JJGpe/4/eSK0ifEQZFcA8B/0pnXN/6udrOXoo4+uhOfb3aRuqrMs1yHB4NEbbG0HgcjBtj755JOd559/viMbxHMF9PdLOM5GGz6O+9useyNSbTPO0kOfRhN7sRtVOe7ggZOB8deCVBewgV5GUM0jX589e3Zn0qRJwwKEWJSEsu1cZoVa2aMj2yXB28QOPNAI/Mcee6yiAlKqlwU80lUxZcqUP0Q9m6kGcwAjwZvV0UMNIJPOkW+HjQHZTV6/fv2PAOB3eTcAz6nOHXrooZ05c+ZUA9B2k64u3TyiukgoWtU1s0fYTgKRAMpcFl7ZIGI+8cQTnRdeeGHIANp6cf1usKwPQ4ZssrKu5AkYrMMCP/Js2nN2AICfCIy4AUB6lzVYeC59nSyGJNyWnRDoxPAI0Jkvx7fRd9pfs6oh+yGDLWKtvk9r1qypdr4nNqQBr721d6PPZ4Kt9mdtjVwOPVS52vhmWBlYzEFoxI04nmox3hpLJ5xwwqCrtQnoZF+yZptYnpdHbdwgJYoRMpEyrVoceSg5CNSIHn300SEeVOM+IUXdDlvlQ1Cbd1i3SZHFwRhqZdFSDVu5cuUVwOxzrLUq4cfzk046qTKUmrZaZhQxOfJUNpns3g3dpHkICQh8qsACWqTZ8R7ZzyOPPFL111vdNQu6csaMGR+PgB+xn65XC32lBDSxEwbJ34A9nCPhqsLUkJNPPrlyCzSZ/PSt27IzTPV++0jgecBHnczMfnuf7SL7JRVwj6xWPkM5xr6uWLFisN+yBWqr/U9gLzwGdfpClpNh/yBS0dQukWk94meuXbv2Ryiwx/tleH7KKadULoK22F7ygZeEflvnVSTsogHwgtpSgfi9L5vwoIuCAxDFADBIu2FAngkOcHOTF7aHKlXmf+Y5ZMIR69atuwfnk/3AsHFkNfTLlABClpVRmI9KlSzGKMjjeXSmEUWyIvJnsQwC2LIhXz8FNeH28MMPD2E/BimfgwY0D8j6fNHCVRw16ixJC6rWd3B/spXyUiepSpYAXwvpjncl+wGMIlAR1rfh+23iDJl2J+GqdlMjilwlZEG0XUjNjz/++KBLwpQ5Bdzi21A8zrYa4R7Apy4bNZAvbdy48ROo4CMWAxRQplOMe7Zx4AR4i92ZM6rkF8nUtYglNamkGSuKrlE+1cbUHgBk/9h/wo8OOtoPQqTa+l8ErnE95MRVkeVbwSWKFNUGzyGQBxf5keOo0yk1a9asIuAlWKMAuK0rwu4SUDP+7wc14/WlOG2kaVl1OGoDbRp6Ze0zyoCAJvl1wHGiDV8OsSNsZEhWIHfotV9BIYdFITnq8pn/RCTb5ArwDcoEcRSnzd6LML0US/XlZyopEYlsNkIgwu+YY47Zwy6okfAIcI+v8BlSht97BVz5QngE8I6H6rWY/0UVLJTsBnpshfnZFmF85mDyOnVEGSULNMPkkm+lJMCz4IdiEN6DKWSjpkdvrZx9Vn4AHp/CPsv6vwb9T/KnkGx0vmHDhvNxb6RtFK+TvAj8bJOTzrKqTO+2DczygkpaWFO2Qsl305STk+QXDcoAXw7vkf8TKTkAjoUdCOxfysEjDLVXUTyF0TgyJAVg/dwXX3zxLA8wVsDgQ8kppootYDOZErkM/L1SzDTLlGhjrUdUV5IHtl5lr0Xq5/Tp0/doG2EALnI2Bm622Ls8rV2vp8KA+AKOI2x2GEeKqtWECRNSPs+RzfR4q+NngCqpkZllm1FTk70QqbNNdoZlveyTnHKql4hH+IwfP76KD/O+YVMHbN68+Ys4Lrasq5fCkTtJCoCfDqxfFOVBclRLfD7TyX1eZSndsJT1VfJ4ZrHT4QC5NEh+UJVrGrWf7Mf7pYjgYMkfw8BNsyksvbZwkMcfA9gH2c4T+DSkMvcBqcIml0Yd92Z6RvaZPhyxo0xA213sLkt5jDSvLInLt8uzHyt8if2W99fljME7Z9Nwkw+pV2oQ0zy2bdt2jvi0jccy2F3y2WTYGWkTXo3MUv88q2pDLVbOZLIjw2aPrSUjUI426xuyVM5QpLXc9S64yiexd7Hz/C09H0D8DWDxbJvbyJ2pFpmbmKNfAnDbzmbYGGF7yW2QqaClexkbs/HirM1RxI3XiP2Em0WiOg+ICcHvJmXQAzzIjIH1H/FSmgWVAiMSsh77Sq7U4fJa6yrOoltRRCtTLTPBHjn+SgNj48x+oMlJyKptoKh+twcY/wd0XzOI1csfXBiB4/utD0b+avqwM14fCbFS6lyWdhglamVleNYQZS6X1MZSTKAk1CNKZN2Wt9uBpOZjNSIhNJST38P9KmWnl15N/JkNFjLL5itKePB+ieVkmJHlyUdzADKtpCnlrq2hlHlVMzeH4hi+jqgMD3w9S5c0YSfsNwM2B4g7t4J1rSq+h7nyntzJmzL2wUq9Jes3qrAMvflcyMyJlWk9GWV5babku/H1RPzcqoYMMlGFbkqOlWz0sGMZNrJnhHMPEPfUSkOsgfTeKHKfAV8RqQhYVmawAua+MP1CWcgl4ZwJ5lL2V8l3E2kxJdnB9hFTmTS1evXqwUTeSMYI8ELEqC10x0TBGyg383ns4mQkRvgUn41APTRjOUrzyAISVvCR7xH7Gahngip5YaRORqkfJas2E6Slwc3SS+T0ghXaWb9+fcVSdS2jEO/38VSoSXKEozyiRp7Oh74/go61w/DgUR4bCHifAmiBH7l7s6wBlsN3GPUhRrFzGdAzSoo8pJkruMmNba+xbWyPsN1TaCQbIjbptSVpPeT9ljLqgZkBTXFSFz8zcXOEzSTgw1nattymFnhN4bvBmRiOCmg/RPy3bUC9ZBVn7muPNAyGC9ujqUTRgEfJwNbKFxXwP7G/v79/yPNAxBGo70SmjsyIyDtjOd5nncVfvWDWRoOO2EU5QAcUB0EhuIysvdBqSpoqpRZKHtFGYVo4WY2ErGUZlo20iQ9bd4y9pnnIztHILJDJXfD7mVGns4xii/mlTAIeaeUxyMAYp31GVEaNglTAZxSI9z6RzH5o8ulHPF+YKd5uJ0XY7Gf+Z8o4YWCxOMoJ9YLbP0dfTjQlinDvAhM/5Tsp334G/DZaijYCljO7161bVyUmyasnNiQqoK+DPiRiCuVDlInmWY3PrSlZ0nVQuwI6gS+3sFcRSfFsM9muKMDW0xQ78JpQlCHNexiUT1Pb2c/r63L4l8jLC9hMO+FgEfjHH398le9IKiDAlZKhwaAs4ACw414W2BmLPje0NGveUgGpTBMfLIuxCDVlypTKncK2eQqM0gw9gkQUwbKkcFinJTC/20UlA34k7aSApmRXL4AiPV3YQ/5Oq5lUQHbDRgmQVhZw5iD94lTT1MnIWxkhg9ey6HUl0Al8JQhYAUygENvZNoYBda3kYojYTcQSvVy0A4Y6Brq2Ips4mmUnRGpWBIzIrUBsYgc5YYIT0UgJtjzLkyULRAXZ7L8sqMI9wnbveCOrI7bLwGoTdI9i0h6GFvDeTS91veu1l7Y+kyzNL3MZeO2DJE6MIxX4wEQkC/ysj2zStkJ9VpPxkTQZkaQuskRhezawTZlvma0R5esMWXuhKROsjTCzNoJPpPWdIIZRxaRRozhnFKyvzG/cp4wgJZIKmlRRtYUYz1xKKQ2Ric86SHlr166tJnJIwEZuh6iuaPJfFqHLyuhmMzwy7SXKPRRPjzSBaECUB2On+WcDbvMgM3dGhI3RRDbbJlK8piBJvcwQK9K2okTf0noPXlOqYrjCPutQs5PQShGjSPBYnufdB1bf9YIoElqZyyEDRGbJ+sG1wPIAazOpIUqqyvJRpa56tlfVDQzpiV6wUy0znl5qnOd73vJrE2rMrExfl38uCgeW4guRctFm4KO++md9EpVhvz1dGDW7lWmmgoj5JMnI0Crl3LTJNrOJVN6AivJ7LOZEbMHbAhZ5It+MF6zeKZZZ0dkiRiWtTxqej/XyP4ys3eT5N+HaOd7So8YQ+XekkmWu36Y4qBaboOnuMS5yD/P5SHCWFAPKCbo2fEJYxLvVnsxqL7EZv2RNJKSVWuOnzOJ4DYH/VKS3ahG7CPgl72PTBAQFGRYsWFA0XrwL20aVSgaM8uZLU1H9nDOWbdVdP1css3DtoFh5ZtumBFuv7uL/Y10AYhVNe49Fmp8bAb8p9Tozsuw7w1lDJ8tgiFIKh2OhZ2WU/EXZJOusXE0Q8fIDlPk0XcpPqqE2wTWbn+tnI5b4Yybk2kzfydhF06SI4UygywRoSYX16rYd8Mi9oOUhbfvBFkGgu1f29vX1rQZAX7BSv86sTTUev4BRKUWjiUU1WZJZCLCkApdmorSlgkjBiNTZbDDELon53sbB889MmDBhXS8e6IfGs5KAtiobeVU0X0sCzWoh9rzN5LZSklXbdSxLKYmltUEj6zhav7OJjUYzUfxKhlrnzQ8gNJ1VgPuO3jrQ+1NPVrzOEFtbq7M038r/12BJDZMurGs2kmRz/kuZar6DKtfWpQwze8/n3WSx3pIKHfm06mm0oR0BZP/vSsuq55zeiQeW+unuBD4XAoqwkOqZj2plia0ea/meGpbNmfUyxPLUSABalY+ams+58bzZq78Z27EqZcld4OHDPtIpGNkHhHfVJ2Lx2LFj78HxBS846Nb10lqbfO3ZLOsSi8nkQqQ1lQIamTu3lJPvXR+Zoy6LHfg+WmXFXicCKHJnbQrAee2YMWPuq2YEkbdj24ILd9mG1Vm1VYSpxHoyDSHzu5RSPEpp2U3CMZvn61mTXzUkcyeUBtBa61aTEb/nNWYseJZZZ33fged2VEtMqiHQ96/1JjcHgK7ZjO8xOJwlqGZZwd6Z1qQClia3RTp3ac24LB5QkiFN88Q8cGXVkmVHiAQkv24wKK/JWePGjfsvmPEveH5H1sNRzFhP5Ghr0jCsEIq8lyXh5rFNdkcUMIkGMprOmVFRyTbxbmu7E2bUFL1+D/iuA4u/TSte9RrFfwsG4HorRNVRRvwz7PTLeJUwPvLFRwPlAS05pOmqEqiaT6ZpljbeK6TyroIsEaopI8H3w1v6dreLiVihTu4COA/q712LMZMmTbp806ZNn+7UywJYrYfRp2g9HbIeBSVKwqstL5d2QUATyMQgAVv12MxgW59m2RAhlKLNo11K0k9miKJjbdaIiLSven3RKgFA2R9mZsquQw899PIhSzsyhmm2/8X/2wHo0/1C0Qy3ZYsZcQAIpCwk2TSBWR0hBpNk2XhqCnbeU2Yc2bJIFVo/WcAgEOjhZD/p0BOr9GknQVZZqtZqMCO5Iqy3/WY/UP8NU6ZMeXhIGNH+AYYNjB8//lsEvmUf7ADjogxIK5vAAkHrNSjfsSnjzGMYsUV5O6Ig8Us7u6ONhmTzJRWboMwi9ZLPMnuC2XEKnEfvl3xJVlvy9gO5A+vyGhD2N8HSv7MHlXvjB2R6Exr4E5G3FS7M4rXxTrvrmyHWH+SnZEZJUMQULhxH4EhNUyJVG4OtyQsq7JdLhABatWpVVW/k+fSuYl+fT6UX5bLfTFPxg8nrgM1N2O8oAr9OKnoTvP/vvOomzYepHhkf1OpMUSJtxJJIKczfYdkll4U9JyaLHcll4Bc+9XOCvYairAjl8zTNardCPEsSY3mEj6cMnO8Gr//7aKCHsB1FrgDEW8AC/hOs5kxbIc+feuqpaoKDJVvbMQ6A+H8py0D6sF/LxkexrODXUinCZDspjWVJ61FgxC/t65fzYt1a5LTpixjRDBVdJ7tkGoraZKeFgo3/EMC/O4oRdL3ero5Onz59KVjBb+Ol0ZaHscCVK1d25s+fP2QJLB15jYNoPaI+0VRHzcSmJiPeLnbHcphayJ2CkmxNC5Fmhpc+WMC6KXTJYii4NTPEaiBawqu0lIzabJN7vaBl2URIO8PFUMtWIOqXs2yQHlshVTpLZij0q+BjF/gACjGLWWRMfs2yEviMnFtZVpviBkygErYS0Jx+Sup6u1+NsPyWdgAVBU3KYN3Edq0b5HOWfFhSgM/czAQ85YePA3NQAKMvTJ069dsqy2mWQ4Gv6JXJHBgFLL8THZjvF/zkaHIJGCaYRkEXsRUtilHS64mtBBKBTUy3CbTZohlN/h7v3mV7yR5IFaRMDoDX+aMpQz4fx7JB8nkC38e1ayH742OPPfY0UNcbGlS/fsUQ4PsVxVk5dO75GIC7KAqsIJRKyCW/uNZAFvXSemvZ0o4Cjvi5D8qU1kJoAn6k+cgWyHIubapitgykHGfUmjxXqOvbNnv27AWgrFUWnn6qVa/3VLo1wKgT3ztt2rQl0QJu/E/+T7K2lGF3pYlE7MMHIEpZcm23UrgyMqy8q9uvpePZab2YdzW5z3tIJXfAbv4S9tAqKQaCa1HV9Cl2AghYyyXA7ivsgkYWYA899FCFCdGECnWYA+C1gSwp1bcnmhThI1M+5bHps3vRQht2lfDIgpVmw7nFEWWyDYDTJUDW7wtBSx9TGMJ2/HK7tlIIxoNgDN2M43t8ApAAPHfu3MEFHzJXAgGlJdst1mhZdW/cSCW0Yb9MiNuF+iwgLZCVoGupygM94/HUnojxPg9H7QRy3QI+/yEoC69Hc9esC34P4JfyM+sBmLpixYrboBUd4y1QDQCFMCeTBQu9DWmIUhJtnZpCo6XFhNUlN3FGRRoIlmc+QjZknX4NeuSJ9bKA2hKFqwbLyrA6/e+BOXPm/A5U501ZeqGfZNgK+HZ00YjjV69efROAM9XP0hZL4JJgjP2WvsFiLVY/CJFKmkWr2jjCohUNoxTyKCWE7eJECxpRlg0K++vVWR6dOXPmB2BQrSvJLv8NsN7hJBTVAYFH+JkKYOmzEZ9lp4ghDz744GDCUBZKlEAmOcr1G2XEZdkQmdMuM5okAKMvRvjyFIgnf2c8wwZx7Fcj0N7HwOd/H2WuywIwqewZDuYTS+nurZdjP3nDhg3X4/xIb2BIx6eE52qrWrOnlIrhk1et376U/5kFaKygLi2Q4TUtsShqcEQiLQdgqVDtQv8enjRp0ofR/zVEHr/Qha/TY34K/AiTeJ9ChwZR7Qw7FlhxNYyzE6NPNUlYcllIsiGtWB5lGJRmlHvvaJsv10WZxU2f+iCQ2TfN1fU6vEUO9OV/oFIuwuA8S7iwbx74HpatgZ8ZTAK+zGUUPBHGxuUw0M707lYbleLg0CXBiXBkM9maN6U4bOkDNVlCVSngbmcJUgPbuHFjZbVqyYIoxlsD+vtQLD6LNmyn6qmFQgT8LH7hU+67P08eYy35NwGofwTsvxBC6byIN8qBRTJmBzn1klaxHHmRr7+Ut9N0vyn4YmOwZKGaQCcXs3eLG4XjdbT7AliuX2s726ZkKHbbWIoloVE3YBck/RLwwHswAP/Ij8hHFi1lADGMnz2iBkF2RHlActTcMJ/IVLJcm1YsjOKzAhr9WGQtBLw+0yovbZQyjnuPQ9H4LAB/a2QPeWpv86nb7nCydUtZvHVC0L+DCu7ZsmXL17dv374oSucwH3epIj8kcy0fyRixdRvbqUOlzLWonZ5tsD76rsgmyDp9nDfTllg3AH4Z2nY+2rkpUyMz7anU1sbPcEcpflmGcA2sdQDk2eB/1wGz/lYGmWdF1uymW1kRf/FOunupQZBaNCO+aVEl205SmL4IraUU9e0W+x3FzDaoff4PgKLPRxtu9qmIbeYKNCFLtw1fzzA/m13NcwDvX9HwW6COfh6A5bfPD8nSxyUX5FmVa1usQN8dVBTLxngFFEWzFNES8OWOsHZIlIXs1lp7Gm3/B7DES9HunZQLUapI2xnqw2Y7mTqWRZEiXwe2rdCIvgqA/Quw7s+x/yk/B+LXzPeqoTXfBdBIzSyl8wnYWjYgW8HQznjEQK8Htf0z2Ms/4bhRy8S0zRv13w5ocoF32wja0kSEUqKsWUBuLTp0HqjhuwDkJyEP+CGco70wjD7qmA1U00JHPnHVA8cab6CsFWB13wOSXIXrW3w2c5MlHWXqvS2BW1pKsQSEkmplFv5ZD3K+ELr+tyAPfheD8LGdO3cuxICMs4vmlfL0sy3y/0Tzd7XuDRDiOWD3DaDMH+L8zlGjRr1h5ww0cYBSnKHtComNmF/yl5R4YNaBmp28DMF6DajhGpxPhbr3WwDK+8GrF2A/imuQRepk9nHK0geUZTABwK/h+DjqvYMCFCzmp0CGfq0u6L960cbXlU2ayz4RO2zMb5sr3/SR4MhargXn08DAH2AgfgBAjAbwZ4Mi5mEw5kFGzOKykwBOH7+tni2C57UQlLMJ+zY89zhY3UrUcy/qeRDHJ2DY7bbxgabZ88Oxg9p+6eJtW7iZOtWEMU3fV6+xZQfI/16c31svBjoGWHo4DLLDwK7eBzlxHNVGBUTEw5UcS3sB/Pvh/v7+G6GpbIROvwlq7y4l2fpcoOEiWBOlt2XJoW9n3/bL3Xr3gWAf8PcBf9+2D/j7gL9v2wf8fcDft/1itu47Wdjy5ctDA6PNV3lK6ypE9o4xXHpKFmnp689BnQPGKOqJnGkLFy7cOzEfjSRQBgZ+9vWbgbozg+c4Lmwy5wMT/da6nCVtXBhZmkjku2/6EkV9nW0e7MuvFNtp+vRp6QM0HCx2vr52URt3Rds4bpMT0LRpq3lu617Ldty2NPBvrCl9Sysg8+U4Jy/jICzNFrbI/E3D9c8k/qn7TF337bXAdx2+OPLyNXn6Ao/gGSXsbFrROxukqMw2cde9mu2UMn7rYx/uL8GRvPzJmo/y+G+4P889O2C2dNkYR02L67J5sR//L8Vxhgsh0kVNNtZf8/N7cf+stllw7xis3snRve222wYMtvckWDqjBnYWhiSmL3/rtbfKM8/YRltt59Ia+J6tbcVxZn3k/3vxyLwGLO8x7w/Ux+Wnn376GXs15hvADZjjrTXmrsH5uTieUQ8Qe7bUFLEk0kCyBavNNcqFxfW1ZXXZi+p3+1Quj6Sw+r2tdVsWkbdn3/76lWA7TQmppiNX45wAuBXHJ7FfZFW7hF2V1EFui00dWi/uaiMwVe5Z5j0CfVn93KIs4Qm7KHH5XitwnXaz1N2Tmsbvct1as5+iYGxavc9pLtb66Q9U0Hn1e/NMG5ebMtaUPjyw11u4ruEXJ59RvageAJ4vq7WiNZEB02bRC1NuXySQs1knbRfgltpMRYEDtNeynTaZubh2lnn23BrwfRGbafOFacOG7jPvzKwFtGRKT70NPleXtdgUtTDqR33Oe2fVsmPvN7IKfhqyn74a25bUwFjcpO83rf6H+1eLpeBItXWZwVTKl+W1kXS1YT0X4TijZolLEspaTGo18mjmXg380uKmNVCW1OcXWXXQU0A2yyQZqIsJ5FpfJ7AvdY9JRVxWC915NauSFrS15vsz3OD3mbb37bVsJ8LMAGOX1nx+q2EDixw76MtSEzM2V5+znHNVVr2tIVWY/9T1ORDLTBuW14NzdZA1t8ywtKXvJJz+T4ABAC6BvT/wnQvWAAAAAElFTkSuQmCC",
size:{width:30,height:30}};function RemoveWindowListener(captureWindowId){var self=this;function _removeWindowListener(removedWindowId){if(removedWindowId==captureWindowId){return self.stop()}chrome.windows.getAll(function(windows){if(windows.length==1&&windows[0].id==captureWindowId){chrome.windows.remove(captureWindowId)}})}chrome.windows.onRemoved.addListener(_removeWindowListener);this.stop=function(){chrome.windows.onRemoved.removeListener(_removeWindowListener)}}fvdSpeedDial.HiddenCapture=new function(){var isLinux=navigator.platform.toLowerCase().indexOf("linux")!==-1;var isMac=navigator.platform.toLowerCase().indexOf("mac")===0;var isWin=navigator.platform.toLowerCase().indexOf("win")===0;this.capture=function(params,callback){for(var i=0;i!=CANNOT_CAPTURE_REGEXPS.length;i++){if(CANNOT_CAPTURE_REGEXPS[i].test(params.url)){setTimeout(function(){callback({dataUrl:FAILED_IMAGE.src,title:"",thumbSize:{width:FAILED_IMAGE.size.width,height:FAILED_IMAGE.size.height}})},0);return}}if(!params.saveImage){fvdSpeedDial.Utils.getTitleForUrl(params.url,function(title){callback({title:title||""})});return}if(typeof params=="string"){params={url:params}}params.width=params.width||fvdSpeedDial.SpeedDial.getMaxCellWidth()*2;var winCreateParams={url:params.url,focused:false,left:1e5,top:1e5,width:isWin?100:1,height:isWin?100:1,type:"popup"};chrome.windows.create(winCreateParams,function(w){var removeListener=new RemoveWindowListener(w.id);if(!w.tabs||!w.tabs.length){chrome.windows.remove(w.id);return}var ctimeout=null;var timeout=setTimeout(function(){try{clearTimeout(ctimeout)}catch(ex){}chrome.windows.remove(w.id);callback(null)},CAPTURE_TIMEOUT);fvdSpeedDial.Utils.Async.chain([function(next){if(isMac){return next()}var monitor=0;fvdSpeedDial.Utils.Async.cc(function(ccCallback){chrome.windows.update(w.id,{top:1e5,left:1e5},function(){monitor++;if(monitor==DISPLAY_HIDDEN_WINDOW_MONITOR){chrome.windows.update(w.id,{width:CAPTURE_WIDTH,height:CAPTURE_HEIGHT},function(){next()});return}ccCallback()})})},function(){if(isLinux||isMac){chrome.windows.update(w.id,{state:"minimized"})}}]);var tab=w.tabs[0];chrome.tabs.update(tab.id,{muted:true});chrome.tabs.executeScript(tab.id,{file:"/content-scripts/hiddencapture.js",runAt:"document_start"});var isFinalTimeout=false;function checkTimeout(interval){ctimeout=setTimeout(function(){chrome.tabs.get(tab.id,function(tabInfo){if(!tabInfo){clearTimeout(timeout);return callback(null)}if(!params.saveImage&&tabInfo.title){chrome.windows.remove(w.id);return callback({title:tabInfo.title})}if(tabInfo.status=="complete"){if(isFinalTimeout){capture(tabInfo)}else{isFinalTimeout=true;checkTimeout(CHECK_COMPLETE_INTERVAL_FINAL)}}else{isFinalTimeout=false;checkTimeout()}})},interval||CHECK_COMPLETE_INTERVAL)}function normailzeWithCheck(callback,attemptNum){if(attemptNum==10){}if(attemptNum>30){return callback()}attemptNum=attemptNum||0;var updateData={state:"normal",focused:false};if(isLinux){updateData.left=1e4;updateData.top=1e4}chrome.windows.update(w.id,updateData,function(win){console.log("Normalize attempt",attemptNum,w.id,updateData,win);chrome.windows.get(w.id,function(wInfo){if(wInfo.state!="normal"){normailzeWithCheck(callback,attemptNum+1)}else{callback()}})})}function capture(tab){fvdSpeedDial.Utils.Async.chain([function(chainCallback){chrome.tabs.executeScript(tab.id,{code:'window.postMessage({action:"fvdsd:hiddenCapture:__replaceAlerts"}, "*")'},function(){chainCallback()})},function(chainCallback){chrome.windows.get(w.id,function(wInfo){if(wInfo.state!="normal"){normailzeWithCheck(chainCallback)}else{chainCallback()}})},function(){chrome.windows.update(w.id,{width:CAPTURE_WIDTH,height:CAPTURE_HEIGHT},function(){setTimeout(function(){chrome.tabs.captureVisibleTab(w.id,function(dataUrl){clearTimeout(timeout);chrome.windows.remove(w.id);if(!dataUrl){console.error("Fail to capture tab ",params.url,chrome.runtime.lastError);return callback(null)}fvdSpeedDial.ThumbMaker.getImageDataPath({imgUrl:dataUrl,screenWidth:params.width},function(thumbUrl,thumbSize){callback({dataUrl:thumbUrl,title:tab.title,thumbSize:thumbSize})})})},500)})}])}checkTimeout()})}}})();(function(){var MAX_SIMULTANEUSELY_CAPTURES=1;fvdSpeedDial.HiddenCaptureQueue=new function(){var queue=[];var currentItem=null;var nowCapturesInProgressCount=0;var self=this;var ignoreIdsAfterComplete=[];function checkNeedIgnoreIdAndRemove(id){var removeIndex=ignoreIdsAfterComplete.indexOf(id);if(removeIndex!=-1){ignoreIdsAfterComplete.splice(removeIndex,1);return true}return false}function captureNext(){if(nowCapturesInProgressCount>=MAX_SIMULTANEUSELY_CAPTURES){return}if(queue.length===0){return}var item=queue.shift();currentItem=item;nowCapturesInProgressCount++;fvdSpeedDial.HiddenCapture.capture(item.params,function(resultData){if(!checkNeedIgnoreIdAndRemove(currentItem.id)){console.info("Capture done");Broadcaster.sendMessage({action:"hiddencapture:done",params:item.params,result:resultData});if(item.callback){item.callback(resultData)}}currentItem=null;nowCapturesInProgressCount--;captureNext()})}this.removeFromQueueById=function(id){if(currentItem.id==id){ignoreIdsAfterComplete.push(id);return}var index=-1;for(var i=0;i!=queue.length;i++){if(queue[i].id==id){index=i;break}}if(index!=-1){queue.splice(index,1)}};this.getQueue=function(){return queue};this.getCurrentItem=function(){return currentItem};this.capture=function(params,callback){checkNeedIgnoreIdAndRemove(params.id);queue.push({id:params.id,params:params,callback:callback});captureNext()};this.empty=function(){queue=[]}};Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg.action=="hiddencapture:queue"){var params=msg.params,cb=null;if(params.wantResponse){cb=function(res){sendResponse(res)}}fvdSpeedDial.HiddenCaptureQueue.capture(params,cb);if(cb){return true}}else if(msg.action=="storage:dialsCleared"){fvdSpeedDial.HiddenCaptureQueue.empty()}})})();(function(){var SpeedDial=function(){};SpeedDial.prototype=new FVDEventEmitter;SpeedDial.prototype={_displayType:null,_nowOpenedGroup:null,_cellsSizes:{big:364,medium:210,small:150},_mostVisitedIntervals:["all_time","month","week"],_displayModesList:["speeddial","mostvisited","recentlyclosed"],_topLineHeight:3,_dialBodyPadding:5,_cellsSizeRatio:1.6,_cellsMarginX:20,_cellsMarginY:{standard_speeddial:70,fancy_speeddial:30,standard_mostvisited:70,fancy_mostvisited:50},_groupElemMaxWidth:150,_groupElemMargin:5,_groupElemXPadding:5,_listElemMarginX:15,_listElemMarginY:15,_listElemSize:{height:15,width:522},_listElemSizeMostVisited:{height:29,width:522},_needRebuild:false,_needRebuildGroupsList:false,_needCSSRefresh:false,_needBackgroundRefresh:false,_rebuildCheckerIntervalInst:null,_cellsRebuildCallback:null,_firstRebuildDone:false,justAddedId:null,fancySpecialDecrementCount:0,onBuildCompleted:new FVDEventEmitter,cellsMarginY:function(){return this._cellsMarginY[fvdSpeedDial.Prefs.get("sd.display_mode")+"_"+this.currentDisplayType()]},has3D:function(){var has="WebKitCSSMatrix"in window&&"m11"in new WebKitCSSMatrix;if(!has){return false}if(document.getElementById("test3d").offsetLeft==0){return false}return true},refreshEnableMirrors:function(){var sdContent=document.getElementById("speedDialContent");if(_b(fvdSpeedDial.Prefs.get("sd.display_mirror"))){sdContent.setAttribute("enablemirrors","1")}else{sdContent.setAttribute("enablemirrors","0")}},init:function(){var that=this;this.refreshEnableMirrors();if(!_b(fvdSpeedDial.Prefs.get("sd.fancy_size_adjusted"))){fvdSpeedDial.Utils.Async.chain([function(next){var min=that.getMinCellWidth();var max=that.getMaxCellWidth();var v=max;var minCols=fvdSpeedDial.Prefs.get("sd.fancy_init_min_columns");while(v>=min){fvdSpeedDial.Prefs.set("sd.custom_dial_size_fancy",v);if(fvdSpeedDial.SpeedDial.cellsInRowMax("auto","fancy").cols>=minCols){break}v--}if(fvdSpeedDial.Prefs.get("sd.display_mode")=="fancy"){return fvdSpeedDial.CSS._updateThemeActions("fancy",next)}next()},function(){fvdSpeedDial.Prefs.set("sd.fancy_size_adjusted",true)}])}fvdSpeedDial.CSS.stylesheets.push(document.styleSheets[0]);this.refreshExpandState();this.refreshBackground();this.refreshCSS();this._rebuildCheckerIntervalInst=setInterval(this._needRebuildChecker,100);window.addEventListener("resize",function(event){that.sheduleRebuild();that.sheduleRebuildGroupsList()},true);this.DragAndDrop.init();setTimeout(function(){fvdSpeedDial.ContextMenus.setGlobalMenu(that.currentDisplayType())},0);chrome.tabs.onActivated.addListener(function(info){chrome.tabs.getCurrent(function(tab){if(tab.id==info.tabId){if(document.body.hasAttribute("dial-search-show-results")){return}that.sheduleFullRebuild()}})});if(_b(fvdSpeedDial.Prefs.get("sd.first_dial_page_open"))){setTimeout(function(){},0);fvdSpeedDial.Prefs.set("sd.first_dial_page_open",false)}this.correctPerspectiveOrigin();document.addEventListener("scroll",function(){that.correctPerspectiveOrigin()},false);document.getElementById("cbNotDisplayCollapsedWithPowerOff").addEventListener("click",function(){setTimeout(function(){fvdSpeedDial.Prefs.set("collapsed_message.with_poweroff.display",false)},0)},false);document.getElementById("cbNotDisplayCollapsedWithoutPowerOff").addEventListener("click",function(){setTimeout(function(){fvdSpeedDial.Prefs.set("collapsed_message.without_poweroff.display",false)},0)},false);document.querySelector("#searchBar .rightMenu .showHide").addEventListener("click",function(){that.toggleExpand()},false);document.querySelector("#speedDialCollapsedContent .aboutPowerOff").addEventListener("click",function(){window.open(chrome.extension.getURL("/options.html#poweroff"))},false);this.refreshCollapsedMessages();var forceShowGroupId=fvdSpeedDial.Utils.getQueryValue("show_group_id");if(forceShowGroupId){that.setCurrentGroupId(forceShowGroupId)}document.location.hash="#";Broadcaster.onMessage.addListener(function(message){switch(message.action){case"syncStartNotification":document.getElementById("buttonSync").setAttribute("sync",1);break;case"syncEndNotification":document.getElementById("buttonSync").removeAttribute("sync");break;case"pref:changed":that._prefsListener(message.name,message.value);break;case"forceRebuild":fvdSpeedDial.Utils.Async.chain([function(next){if(message.needDisplayType){if(message.needDisplayType!=fvdSpeedDial.SpeedDial.currentDisplayType()){return}}if(!message.needActiveTab){return next()}fvdSpeedDial.Utils.isActiveTab(function(active){if(!active){return}next()})},function(){fvdSpeedDial.SpeedDial.sheduleFullRebuild()}]);break;case"foundRecentlyClosed":fvdSpeedDial.Utils.Async.chain([function(next){if(!message.needActiveTab){return}fvdSpeedDial.Utils.isActiveTab(function(active){if(!active){return}next()})},function(){if(fvdSpeedDial.SpeedDial.currentDisplayType()=="recentlyclosed"){fvdSpeedDial.SpeedDial.sheduleFullRebuild()}else{fvdSpeedDial.SpeedDialMisc.sheduleRebuild()}}]);break}})},refreshCollapsedMessages:function(){if(!_b(fvdSpeedDial.Prefs.get("collapsed_message.with_poweroff.display"))){document.querySelector("#speedDialCollapsedContent .collapsedMessagePoweroffDisabled").style.display="none"}if(!_b(fvdSpeedDial.Prefs.get("collapsed_message.without_poweroff.display"))){document.querySelector("#speedDialCollapsedContent .collapsedMessagePoweroffEnabled").style.display="none"}},getMaxCellWidth:function(){var max=0;for(var k in this._cellsSizes){var size=this._cellsSizes[k];if(size>max){max=size}}return max},getMinCellWidth:function(){var min=9999;for(var k in this._cellsSizes){var size=this._cellsSizes[k];if(size<min){min=size}}return min},openSizeSetup:function(){window.open(chrome.extension.getURL("/options.html#setup-custom-size"))},dialRemoveAnimate:function(dialId){var cell=document.getElementById("dialCell_"+dialId);if(cell){var that=this;cell.addEventListener("webkitTransitionEnd",function(event){that.sheduleFullRebuild()},true);cell.style.opacity=0;cell.style.webkitTransform="scale(0.5)"}},dialMoveToGroup:function(dialId,groupId){fvdSpeedDial.Storage.moveDial(dialId,groupId,function(result){if(result.result){fvdSpeedDial.Sync.addDataToSync({category:"dials",data:dialId,translate:"dial"});if(fvdSpeedDial.SpeedDial.currentGroupId()==0){fvdSpeedDial.SpeedDial.sheduleFullRebuild()}else{fvdSpeedDial.SpeedDial.dialRemoveAnimate(dialId)}fvdSpeedDial.Storage.dialGlobalId(dialId,function(dialGlobalId){fvdSpeedDial.Sync.removeSyncData({category:["deleteDials"],data:dialGlobalId})})}})},setListViewType:function(){var selectedElem=document.querySelector("[name=listViewType]:checked");var type=null;if(selectedElem){type=selectedElem.value;fvdSpeedDial.Prefs.set("sd.list_view_type",type)}else{selectedElem=document.querySelector("[name=listViewType][value="+fvdSpeedDial.Prefs.get("sd.list_view_type")+"]");selectedElem.checked=true;type=selectedElem.value}var elements=document.getElementsByClassName("newtabListElem");var altType=null;if(type=="url"){altType="title"}else{altType="url"}for(var i=0;i!=elements.length;i++){var elem=elements[i];var textNode=elem.getElementsByClassName("text")[0];textNode.textContent=elem.getAttribute("_"+type);elem.setAttribute("title",elem.getAttribute("_"+altType))}},refreshSpeedDialWrapperHeight:function(){var wrapper=document.getElementById("speedDialWrapper");wrapper.style.height="";var currentHeight=wrapper.offsetHeight;var bodyHeight=document.body.offsetHeight;var speedDialHeight=bodyHeight-this._topLineHeight;var extraHeight=0;if(wrapper.hasAttribute("extraheight")){extraHeight=parseInt(wrapper.getAttribute("extraheight"))}if(currentHeight>speedDialHeight){wrapper.style.height=currentHeight+20-extraHeight+"px"}else{wrapper.style.height=speedDialHeight-extraHeight+"px"}},correctPerspectiveOrigin:function(){var originValue=100;originValue+=document.body.scrollTop;document.getElementById("cellsContainer").style.webkitPerspectiveOrigin="50% "+originValue+"px"},correctPerspective:function(params){params=params||{};if(!params._correctAttempt){params._correctAttempt=1}if(params._correctAttempt>10){return}params._correctAttempt++;if(!this.getExpandState()){return}var that=this;var pers=600;var fixedPerspective=false;if(fvdSpeedDial.Prefs.get("sd.display_mode")!="fancy"){fixedPerspective=true}else if(this.currentDisplayType()=="mostvisited"){}else if(this._currentSettingsColumnsCount()!="auto"){var maxCols=that.cellsInRowMax("auto",null,{objects:document.getElementById("cellsContainer").childNodes.length}).cols;if(maxCols!=this._currentSettingsColumnsCount()){fixedPerspective=true}}if(fixedPerspective){document.getElementById("cellsContainer").style.webkitPerspective=pers+"px";return}var iter=0;var that=this;var els=document.querySelectorAll(".newtabCell[row='0']");var viewPortWidth=that._viewportWidth();console.log(viewPortWidth,els.length,that.cellsInRowMax("auto",null,{objects:document.getElementById("cellsContainer").childNodes.length}).cols);var el=els[els.length-1];var firstEl=els[0];var rect=el.getBoundingClientRect();if(rect.right==0){setTimeout(function(){that.correctPerspective(params)},0);return}var lastValueWhenInBorders=0;var alreadyCheckedPers={};var cellsContainer=document.getElementById("cellsContainer");cellsContainer.style.webkitPerspective=pers+"px";while(true){iter++;if(iter>100||alreadyCheckedPers[pers]>5){if(lastValueWhenInBorders){cellsContainer.style.webkitPerspective=lastValueWhenInBorders+"px"}break}if(!alreadyCheckedPers[pers]){alreadyCheckedPers[pers]=0}alreadyCheckedPers[pers]++;var delta=20;var width=0;var el=els[els.length-1];var rect=el.getBoundingClientRect();var normWDelta=25;var wDelta=viewPortWidth-rect.right;if(wDelta<normWDelta&&wDelta>0&&rect.left>0){break}var inBorders=false;if(wDelta<0){pers+=delta}else{if(firstEl.getBoundingClientRect().left>normWDelta){inBorders=true;lastValueWhenInBorders=pers}pers-=delta}var scaleRatio=rect.width/el.offsetWidth;if(inBorders&&scaleRatio<=fvdSpeedDial.Config.FANCY_SIDE_DIALS_MAX_SCALE&&scaleRatio>=fvdSpeedDial.Config.FANCY_SIDE_DIALS_MIN_SCALE){console.log("DONE#1");break}cellsContainer.style.webkitPerspective=pers+"px"}},rebuildCells:function(params){var l=new Log;l.profile.start("preparing tasks");l.profile.start("total");var that=this;params=params||{};var rebuildCellsParams=params;if(!params.doNotZeroFancySpecialDecrementCount){this.fancySpecialDecrementCount=0}var speedDialContent=document.getElementById("speedDialContent");speedDialContent.setAttribute("style",fvdSpeedDial.Prefs.get("sd.display_mode"));this.refreshExpandState({ifcollapsed:true});var displayType=this.currentDisplayType();var thumbsMode=this.currentThumbsMode();var cellSize=this._currentCellSize();document.body.setAttribute("thumbsmode",thumbsMode);document.body.setAttribute("displaymode",fvdSpeedDial.Prefs.get("sd.display_mode"));document.body.setAttribute("displaytype",displayType);var activeScrollingType=fvdSpeedDial.SpeedDial.Scrolling.activeScrollingType();var container=null;var containerId=null;var tmpContainer=null;function _getContainer(){var listContainer=that._listContainer();var cellsContainer=that._cellsContainer();var c;if(that.currentThumbsMode()=="list"){c=listContainer}else{c=cellsContainer}return c}container=_getContainer();tmpContainer=container.cloneNode(true);while(tmpContainer.firstChild){tmpContainer.removeChild(tmpContainer.firstChild)}containerId=container.getAttribute("id");var finishBuildCallback=function(params){speedDialContent.style.width="";tmpContainer.style.width="";l.profile.start("finishBuildCallback");document.body.setAttribute("scrollingtype",activeScrollingType);if(that.currentThumbsMode()!="list"){var containerSize=that._dialsAreaSize({objects:tmpContainer.childNodes.length});if(containerSize.width&&activeScrollingType=="vertical"){tmpContainer.style.width=containerSize.width+"px"}}if(that._cellsRebuildCallback){that._cellsRebuildCallback()}if(displayType=="recentlyclosed"){document.getElementById("groupsWidthSetter").setAttribute("hidden",true)}else{document.getElementById("groupsWidthSetter").removeAttribute("hidden")}if(thumbsMode=="list"){cellsContainer.setAttribute("hidden",true);document.getElementById("listContainerParent").removeAttribute("hidden")}else{listContainer.setAttribute("hidden",true);document.getElementById("listContainerParent").setAttribute("hidden",true)}container=_getContainer();container.parentNode.replaceChild(tmpContainer,container);tmpContainer.removeAttribute("hidden");setTimeout(function(){that.refreshExpandState()},0);if(thumbsMode=="list"){var listViewMenus=document.getElementsByClassName("listViewMenu");for(var i=0;i!=listViewMenus.length;i++){listViewMenus[i].setAttribute("hidden",true)}document.getElementById("listNoItemsToDisplay").setAttribute("hidden",true);if(params){if(params.noitems){document.getElementById("listNoItemsToDisplay").removeAttribute("hidden");document.getElementById("listViewTypeSelector").setAttribute("hidden",true);return}}document.getElementById("listViewTypeSelector").removeAttribute("hidden");var listContainerParent=document.getElementById("listContainerParent");var size=that.Builder.listViewContainerSize(tmpContainer,countInRow);tmpContainer.style.height=size.height+"px";tmpContainer.style.width=size.width+"px";if(size.width!=0){listContainerParent.style.width=size.width+"px"}that.setListViewType();var neededMenu=document.getElementById(displayType+"ListViewMenu");neededMenu.removeAttribute("hidden")}else{document.getElementById("listViewTypeSelector").setAttribute("hidden",true);that.correctPerspective();if(fvdSpeedDial.SpeedDial.Scrolling.activeScrollingType()=="vertical"){tmpContainer.style.height=fvdSpeedDial.SpeedDial.Builder.cellsContainerHeight(tmpContainer.childNodes.length,that.cellsInRowMax(null,null,{objects:tmpContainer.childNodes.length}).cols,cellSize)+"px"}if(activeScrollingType=="horizontal"){var rows=parseInt(tmpContainer.getAttribute("rows"),10);var cell=tmpContainer.childNodes[0];var cellWidth=cell.offsetWidth;var cellsPerRow=Math.ceil(tmpContainer.childNodes.length/rows);speedDialContent.style.width=cellWidth*cellsPerRow+"px"}}if(fvdSpeedDial.Prefs.get("sd.display_mode")=="fancy"&&!that.has3D()){if(_b(fvdSpeedDial.Prefs.get("sd.no3d_first"))){fvdSpeedDial.Prefs.set("sd.no3d_first",false);return fvdSpeedDial.Prefs.set("sd.display_mode","standard")}document.getElementById("cellsContainer").setAttribute("hidden",true);document.getElementById("listContainer").setAttribute("hidden",true);document.getElementById("no3dmessage").removeAttribute("hidden")}else{document.getElementById("no3dmessage").setAttribute("hidden",true)}that.Builder.refreshLastRow();l.profile.end("finishBuildCallback");l.profile.end("total");console.log("** rebuildCells **\n",l.toString());that.onBuildCompleted.callListeners(rebuildCellsParams)};if(thumbsMode=="list"){tmpContainer.style.height=""}else{}var countInRow=null;var gridParams=this.cellsInRowMax();countInRow=gridParams.cols;l.profile.end("preparing tasks");if(this.currentDisplayType()=="speeddial"){var groupId=this.currentGroupId();var order=null;var limit=null;if(parseInt(groupId,10)===0){order="`clicks` DESC";limit=fvdSpeedDial.Prefs.get("sd.all_groups_limit_dials")}fvdSpeedDial.Utils.Async.chain([function(next){if(params.dials){return next()}l.profile.start("fetch dials from db");fvdSpeedDial.Storage.listDials(order,groupId,limit,function(data){l.profile.end("fetch dials from db");params.dials=data;next()})},function(){var data=params.dials;if(that.currentThumbsMode()!="list"){var displayDialBg=fvdSpeedDial.Prefs.get("sd.display_dial_background");l.profile.start("build cells html");gridParams=that.cellsInRowMax(null,null,{objects:data.length});if(fvdSpeedDial.SpeedDial.Scrolling.activeScrollingType()=="horizontal"&&!gridParams.rows){activeScrollingType="vertical"}countInRow=gridParams.cols;if(gridParams.rows){countInRow=Math.ceil(data.length/gridParams.rows);if(_b(fvdSpeedDial.Prefs.get("sd.display_plus_cells"))){countInRow++}}var i=0;var countRowsFilled=Math.ceil(data.length/countInRow);tmpContainer.setAttribute("rows",countRowsFilled);var lastRow=[];var plusCellsCount=countRowsFilled*countInRow-data.length;for(;i!=data.length;i++){data[i].displayDialBg=displayDialBg;var cell=that.Builder.cell(data[i],i,countInRow,displayType,thumbsMode,cellSize,countRowsFilled);if(plusCellsCount!=0&&cell.getAttribute("row")==countRowsFilled-1){lastRow.push(cell)}var needAnimateAppear=false;if(data[i].id==that.justAddedId){cell.style.opacity=0;that.justAddedId=null;needAnimateAppear=true}tmpContainer.appendChild(cell);if(needAnimateAppear){(function(cell){setTimeout(function(){cell.style.webkitTransform=cell.style.webkitTransform.replace("scale(0)","");cell.style.opacity="";fvdSpeedDial.Utils.scrollToElem(cell)},0)})(cell)}}if(_b(fvdSpeedDial.Prefs.get("sd.display_plus_cells"))){if(plusCellsCount==0){plusCellsCount=countInRow}for(var j=0;j!=plusCellsCount;j++,i++){var cell=that.Builder.plusCell(i,countInRow,cellSize,countRowsFilled);cell.setAttribute("id","plus_cell_"+j);tmpContainer.appendChild(cell);lastRow.push(cell)}}l.profile.end("build cells html")}else{var countInCol=that.Builder.listElemCountInCol(countInRow,data.length);for(var i=0;i!=data.length;i++){var elem=that.Builder.listElem(i,countInCol,data[i],displayType);tmpContainer.appendChild(elem)}}finishBuildCallback()}])}else if(this.currentDisplayType()=="mostvisited"){var interval=this.currentGroupId();if(this.currentThumbsMode()!="list"){fvdSpeedDial.Storage.MostVisited.getData({interval:interval,type:"host",count:fvdSpeedDial.Prefs.get("sd.max_most_visited_records")},function(data){if(gridParams.rows){countInRow=Math.ceil(data.length/gridParams.rows)}for(var i=0;i!=data.length;i++){var row=data[i];(function(i){fvdSpeedDial.Storage.MostVisited.extendData(row,function(mvData){var cell=that.Builder.cell(mvData,i,countInRow,displayType,thumbsMode,cellSize);tmpContainer.appendChild(cell);if(i==data.length-1){finishBuildCallback()}})})(i)}if(!data.length){finishBuildCallback()}})}else{var t=(new Date).getTime();fvdSpeedDial.Storage.MostVisited.getData({interval:interval,type:"host",count:fvdSpeedDial.Prefs.get("sd.max_most_visited_records")},function(data){var countInCol=that.Builder.listElemCountInCol(countInRow,data.length);for(var i=0;i!=data.length;i++){var row=data[i];(function(i){fvdSpeedDial.Storage.MostVisited.extendData(row,function(mvData){var cell=that.Builder.listElem(i,countInCol,mvData,displayType);tmpContainer.appendChild(cell);if(i==data.length-1){finishBuildCallback()}})})(i)}if(!data.length){finishBuildCallback({noitems:true})}})}}else if(this.currentDisplayType()=="recentlyclosed"){fvdSpeedDial.Storage.RecentlyClosed.getData({count:fvdSpeedDial.Prefs.get("sd.max_recently_closed_records")},function(data){var countInCol=that.Builder.listElemCountInCol(countInRow,data.length);for(var i=0;i!=data.length;i++){var row=data[i];var cell=that.Builder.listElem(i,countInCol,data[i],displayType);tmpContainer.appendChild(cell)}finishBuildCallback({noitems:data.length==0})})}},removeGroup:function(groupId,callback,params){var removeFromBase=function(){fvdSpeedDial.Utils.Async.chain([function(chainCallback){fvdSpeedDial.Sync.addDataToSync({category:"deleteGroups",data:groupId,translate:"group"},function(){fvdSpeedDial.Storage.groupDelete(groupId,function(){chainCallback()})})},function(chainCallback){fvdSpeedDial.Storage.listDials(null,groupId,null,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,apCallback){fvdSpeedDial.Storage.deleteDial(dial.id);apCallback()},function(){if(callback){callback(true)}})})}])};fvdSpeedDial.Storage.groupsCount(function(countGroups){if(countGroups==1){fvdSpeedDial.Dialogs.alert(_("dlg_alert_cannot_remove_group_title"),_("dlg_alert_cannot_remove_group_text"));if(callback){callback(false)}}else{fvdSpeedDial.Storage.getGroup(groupId,function(group){if(group!=null){if(group.count_dials==0||params&&params.noConfirmIfHaveDials){removeFromBase();if(callback){callback(true)}}else{fvdSpeedDial.Dialogs.confirm(_("dlg_confirm_remove_group_title"),_("dlg_confirm_remove_group_text").replace("%count%",group.count_dials),function(result){if(result){removeFromBase()}if(callback){callback(result)}})}}})}})},currentGroupId:function(){if(this.currentDisplayType()=="speeddial"){if(this._nowOpenedGroup!==null){return this._nowOpenedGroup}var id=fvdSpeedDial.Prefs.get("sd.default_group");if(id==-1){id=fvdSpeedDial.Prefs.get("sd.last_opened_group")}this._nowOpenedGroup=id;return id}else if(this.currentDisplayType()=="mostvisited"){return fvdSpeedDial.Prefs.get("sd.most_visited_interval")}else{return null}},setCurrentGroupId:function(id){if(this.currentDisplayType()=="speeddial"){if(this.currentGroupId()==id){return}this._nowOpenedGroup=id;fvdSpeedDial.Prefs.set("sd.last_opened_group",id)}else if(this.currentDisplayType()=="mostvisited"){if(this.currentGroupId()==id){return}fvdSpeedDial.Prefs.set("sd.most_visited_interval",id)}else{return}this.sheduleRebuild();this.sheduleRebuildGroupsList()},setCurrentThumbsMode:function(mode){switch(this.currentDisplayType()){case"speeddial":fvdSpeedDial.Prefs.set("sd.thumbs_type",mode);break;case"mostvisited":fvdSpeedDial.Prefs.set("sd.thumbs_type_most_visited",mode);break}},currentThumbsMode:function(){switch(this.currentDisplayType()){case"speeddial":return fvdSpeedDial.Prefs.get("sd.thumbs_type");break;case"mostvisited":return fvdSpeedDial.Prefs.get("sd.thumbs_type_most_visited");break;case"recentlyclosed":return"list";break}},cirlceDisplayType:function(direction){direction=direction||1;var list=this._displayModesList.slice();if(!_b(fvdSpeedDial.Prefs.get("sd.enable_top_sites"))){var index=list.indexOf("speeddial");list.splice(index,1)}if(!_b(fvdSpeedDial.Prefs.get("sd.enable_recently_closed"))){var index=list.indexOf("recentlyclosed");list.splice(index,1)}if(!_b(fvdSpeedDial.Prefs.get("sd.enable_most_visited"))){var index=list.indexOf("mostvisited");list.splice(index,1)}var mode=this.currentDisplayType();var modeIndex=list.indexOf(mode);var nextModeIndex=modeIndex+direction;if(nextModeIndex>=list.length){nextModeIndex=0}else if(nextModeIndex<0){nextModeIndex=list.length-1}var nextMode=list[nextModeIndex];this.setCurrentDisplayType(nextMode)},setCurrentDisplayType:function(type){this._displayType=type;fvdSpeedDial.Prefs.set("sd.last_selected_display_type",type);fvdSpeedDial.ContextMenus.setGlobalMenu(type);this.sheduleFullRebuild();this.refreshShowHideButton()},currentDisplayType:function(){if(this._displayType==null){if(fvdSpeedDial.Prefs.get("sd.display_type")=="last_selected"){this._displayType=fvdSpeedDial.Prefs.get("sd.last_selected_display_type")}else{this._displayType=fvdSpeedDial.Prefs.get("sd.display_type")}}return this._displayType},cellsInRowMax:function(settingsColumnsCount,displayMode,additional){displayMode=displayMode||fvdSpeedDial.Prefs.get("sd.display_mode");additional=additional||{};if(typeof additional.objects=="undefined"){additional.objects=-1}else if(typeof additional.objects=="function"){additional.objects=additional.objects()}settingsColumnsCount=settingsColumnsCount||this._currentSettingsColumnsCount();var countRows=null;if(this.currentThumbsMode()=="list"){if(settingsColumnsCount!="auto"){var autoCount=this.cellsInRowMax("auto").cols;if(settingsColumnsCount>autoCount){settingsColumnsCount=autoCount}return{cols:settingsColumnsCount}}var documentWidth=this._viewportWidth();var count=Math.floor(documentWidth/(this._listElemSize.width+this._listElemMarginX));if(count<=0){count=1}return{cols:count}}else{if(settingsColumnsCount!="auto"){if(fvdSpeedDial.SpeedDial.Scrolling.activeScrollingType()=="horizontal"){return{rows:settingsColumnsCount}}else{return{cols:settingsColumnsCount}}}var documentWidth=this._viewportWidth();var sdWrapper=document.getElementById("speedDialWrapper");var documentHeight=this._viewportHeightForHorizScroll();if(sdWrapper.hasAttribute("extraheight")){documentHeight-=parseInt(sdWrapper.getAttribute("extraheight"))}var cellSize=this._currentCellSize();var cellsMarginY=this.cellsMarginY();var effectiveCellSize=cellSize.height;effectiveCellSize+=34;effectiveCellSize+=21;countRows=Math.floor(documentHeight/(effectiveCellSize+this._cellsMarginX));var count=Math.floor(documentWidth/(cellSize.width+this._cellsMarginX));if(displayMode=="fancy"){count--;if(this.fancySpecialDecrementCount){count-=this.fancySpecialDecrementCount}}if(count<=0){count=1}if(fvdSpeedDial.SpeedDial.Scrolling.activeScrollingType()=="horizontal"){if(additional.objects>=0){if(countRows*count>additional.objects){countRows=null}}}else{countRows=null}}var result={cols:count,rows:countRows};if(displayMode=="fancy"&&!_b(fvdSpeedDial.Prefs.get("sd.display_plus_cells"))&&result.cols&&additional.objects>=0){if(result.cols>additional.objects){result.cols=additional.objects}}return result},sheduleRebuild:function(){this._needRebuild=true},sheduleFullRebuild:function(params){fvdSpeedDial.SpeedDialMisc.sheduleRebuild();this.sheduleRebuildGroupsList();this.sheduleRebuild()},makeThumb:function(dialId,url,type,delay,saveImage){if(typeof saveImage=="undefined"){saveImage=true}var that=this;chrome.tabs.getSelected(null,function(tab){fvdSpeedDial.ThumbMaker.screenTab({tabId:tab.id,type:type,dialId:dialId,width:that.getMaxCellWidth()*window.devicePixelRatio,url:url,delay:delay,saveImage:saveImage});chrome.tabs.update(tab.id,{url:url})})},openAllDialsInGrop:function(groupId){var that=this;fvdSpeedDial.Storage.listDials(null,groupId,null,function(dials){try{for(var i=0;i!=dials.length;i++){fvdSpeedDial.Utils.Opener.backgroundTab(dials[i].url);that.addDialClick(dials[i].id)}}catch(ex){}})},refreshAllDialsInGroup:function(groupId){var that=this;if(groupId==0){fvdSpeedDial.Storage.listDials("",groupId,fvdSpeedDial.Prefs.get("sd.all_groups_limit_dials"),function(dials){var ids=[];dials.forEach(function(dial){ids.push(dial.id)});fvdSpeedDial.Storage.resetAutoDialsForGroup({ids:ids},function(){that.sheduleRebuild()})})}else{fvdSpeedDial.Storage.resetAutoDialsForGroup({groupId:groupId},function(){that.sheduleRebuild()})}},addDialClick:function(dialId){var that=this;fvdSpeedDial.Storage.getDial(dialId,function(data){
if(!data){return false}var newClicks=data.clicks+1;fvdSpeedDial.Storage.updateDial(dialId,{clicks:newClicks},function(){try{var cell=that._getSpeedDialCellById(dialId);var clicksCount=cell.getElementsByClassName("clicksCount")[0];clicksCount.textContent=newClicks}catch(ex){}})})},sheduleRebuildGroupsList:function(){this._needRebuildGroupsList=true},Groups:{getGroupFont:function(){var group=document.querySelector("#groupsBox .group");var style;var needRemoveGroup=false;if(!group){group=document.createElement("div");group.className="group";document.querySelector("#groupsBox").appendChild(group);style=window.getComputedStyle(group);needRemoveGroup=true}else{style=window.getComputedStyle(group)}var font=style.font;if(needRemoveGroup){group.parentNode.removeChild(group)}return font},rebuildGroupsList:function(){var l=new Log;l.profile.start("total");l.profile.start("preparations");var that=fvdSpeedDial.SpeedDial;var isAdditionalListOpened=false;try{if(document.getElementsByClassName("additionalGroupsList")[0].getAttribute("active")==1){isAdditionalListOpened=true}}catch(ex){}document.getElementById("speedDialGroupsWrapper").setAttribute("type",that.currentDisplayType());var groupsBox=document.getElementById("groupsBox");var tmpContainer=groupsBox.cloneNode(true);while(tmpContainer.firstChild){tmpContainer.removeChild(tmpContainer.firstChild)}l.profile.end("preparations");if(that.currentDisplayType()=="speeddial"){var countInPopularGroup=0;fvdSpeedDial.Utils.Async.chain([function(chainCallback){if(_b(fvdSpeedDial.Prefs.get("sd.display_popular_group"))){l.profile.start("fetch total count dials");fvdSpeedDial.Storage.countDials({uniqueUrl:true},function(count){l.profile.end("fetch total count dials");countInPopularGroup=Math.min(fvdSpeedDial.Prefs.get("sd.all_groups_limit_dials"),count);chainCallback()})}else{chainCallback()}},function(){l.profile.start("fetch groups list");fvdSpeedDial.Storage.groupsList(function(groups){l.profile.end("fetch groups list");var currentGroupId=fvdSpeedDial.SpeedDial.currentGroupId();var groupFound=false;for(var i=0;i!=groups.length;i++){if(groups[i].id==currentGroupId){groupFound=true;break}}if(currentGroupId==0){groupFound=true}if(!groupFound){if(!groups.length){return}fvdSpeedDial.SpeedDial.setCurrentGroupId(groups[0].id);fvdSpeedDial.SpeedDial.sheduleFullRebuild();return}l.profile.start("building groups html");var sdMenu=document.querySelector("#searchBar .activeContent");var groupsBoxMaxWidth=that._viewportWidth()-20-document.getElementById("fastMenuToggleButton").offsetWidth-15-20-18-12-that._groupElemMargin-10;if(_b(fvdSpeedDial.Prefs.get("sd.main_menu_displayed"))){groupsBoxMaxWidth-=sdMenu.offsetWidth}var groupsFont=fvdSpeedDial.SpeedDial.Groups.getGroupFont();var groupsActiveWidth=0;var maxGroupsInMainList=0;function incActiveWidth(text){var groupSize=that._groupElemXPadding*2+fvdSpeedDial.Utils.measureText(groupsFont,text)+that._groupElemMargin;if(groupSize>that._groupElemMaxWidth){groupSize=that._groupElemMaxWidth}groupsActiveWidth+=groupSize}if(_b(fvdSpeedDial.Prefs.get("sd.display_popular_group"))){var item=fvdSpeedDial.SpeedDial.Builder.Groups.item(_("newtab_popular_group_title")+" ("+countInPopularGroup+")",0);fvdSpeedDial.ContextMenus.assignToElem(item,"speeddialGroup");tmpContainer.appendChild(item);incActiveWidth(item.textContent)}for(var i=0;i!=groups.length;i++){incActiveWidth(groups[i].name+" ("+groups[i].count_dials+")");if(groupsActiveWidth>=groupsBoxMaxWidth){break}maxGroupsInMainList++}var groupsInMainListCount=maxGroupsInMainList;var groupsInMainList=groups.splice(0,groupsInMainListCount);var groupsInAdditionalList=groups;for(var i=0;i!=groupsInMainList.length;i++){item=fvdSpeedDial.SpeedDial.Builder.Groups.item(groupsInMainList[i].name,groupsInMainList[i].id,groupsInMainList[i].count_dials);fvdSpeedDial.ContextMenus.assignToElem(item,"speeddialGroup");tmpContainer.appendChild(item)}if(groupsInAdditionalList.length>0){var additionalGroupsButton=fvdSpeedDial.SpeedDial.Builder.Groups.additionalGroupsButton();tmpContainer.appendChild(additionalGroupsButton);var additionalList=fvdSpeedDial.SpeedDial.Builder.Groups.additionalList(groupsInAdditionalList);additionalList.setAttribute("active",0);tmpContainer.appendChild(additionalList)}item=document.createElement("div");item.setAttribute("class","group add");var image=document.createElement("div");image.setAttribute("class","image");item.appendChild(image);item.addEventListener("click",function(event){fvdSpeedDial.Dialogs.addGroup()},true);tmpContainer.appendChild(item);groupsBox=document.getElementById("groupsBox");groupsBox.parentNode.replaceChild(tmpContainer,groupsBox);l.profile.end("building groups html");if(isAdditionalListOpened){that.Groups.displayAdditionalList({disableAnimation:true})}setTimeout(function(){fvdSpeedDial.ContextMenus.rebuildSpeedDialCellMenu()},0);try{var currentGroupId=that.currentGroupId();var item=document.getElementById("group_select_"+currentGroupId);document.getElementById("groupsBoxContainer").scrollLeft=item.offsetLeft}catch(ex){}l.profile.end("total");console.log("**Groups**\n",l.toString());if(_loadLog){_loadLog.profile.end("Total Loading");console.log("** Total Loading **\n",_loadLog.toString());_loadLog=null}})}])}else if(that.currentDisplayType()=="mostvisited"){for(var i=0;i!=that._mostVisitedIntervals.length;i++){var interval=that._mostVisitedIntervals[i];var item=fvdSpeedDial.SpeedDial.Builder.Groups.item(_("newtab_mostvisited_interval_"+interval),interval);tmpContainer.appendChild(item)}groupsBox.parentNode.replaceChild(tmpContainer,groupsBox)}else{groupsBox.parentNode.replaceChild(tmpContainer,groupsBox)}},displayAdditionalList:function(params){params=params||{};var that=this;try{var listElem=document.getElementsByClassName("additionalGroupsList")[0];if(listElem.getAttribute("active")==1){this.closeAdditionalList();return}var btn=document.getElementsByClassName("additionalGroupsButton")[0];var pos=fvdSpeedDial.Utils.getOffset(btn);listElem.style.left=pos.left+"px";if(params.disableAnimation){listElem.setAttribute("disableanim",1);setTimeout(function(){listElem.removeAttribute("disableanim")},500)}listElem.setAttribute("active",1);document.addEventListener("click",that.closeAdditionalList,false)}catch(ex){}},closeAdditionalList:function(){try{var listElem=document.getElementsByClassName("additionalGroupsList")[0];listElem.setAttribute("active",0);document.removeEventListener("click",fvdSpeedDial.SpeedDial.Groups.closeAdditionalList)}catch(ex){}}},syncMostVisited:function(){fvdSpeedDial.Storage.MostVisited.invalidateCache(true);if(this.currentDisplayType()=="mostvisited"){this.sheduleFullRebuild()}},mostVisitedRestoreRemoved:function(){var that=this;fvdSpeedDial.Storage.MostVisited.restoreRemoved(function(){if(that.currentDisplayType()=="mostvisited"){that.sheduleFullRebuild()}})},openAllCurrentMostVisitedLinks:function(){fvdSpeedDial.Storage.MostVisited.getData({interval:fvdSpeedDial.SpeedDial.currentGroupId(),count:fvdSpeedDial.Prefs.get("sd.max_most_visited_records")},function(data){for(var i=0;i!=data.length;i++){fvdSpeedDial.Utils.Opener.backgroundTab(data[i].url)}})},removeAllCurrentMostVisitedLinks:function(){fvdSpeedDial.Dialogs.confirm(_("dlg_confirm_remove_links_all_title"),_("dlg_confirm_remove_links_all_text"),function(r){if(r){fvdSpeedDial.Storage.MostVisited.getData({interval:fvdSpeedDial.SpeedDial.currentGroupId(),count:fvdSpeedDial.Prefs.get("sd.max_most_visited_records")},function(data){for(var i=0;i!=data.length;i++){(function(i){fvdSpeedDial.Storage.MostVisited.deleteId(data[i].id,function(result){if(i==data.length-1){fvdSpeedDial.SpeedDial.sheduleFullRebuild()}})})(i)}})}})},openAllCurrentRecentlyClosedLinks:function(){fvdSpeedDial.Storage.RecentlyClosed.getData({count:fvdSpeedDial.Prefs.get("sd.max_recently_closed_records")},function(data){for(var i=0;i!=data.length;i++){fvdSpeedDial.Utils.Opener.backgroundTab(data[i].url)}})},removeAllCurrentRecentlyClosedLinks:function(){fvdSpeedDial.Dialogs.confirm(_("dlg_confirm_remove_links_all_title"),_("dlg_confirm_remove_links_all_text"),function(r){if(r){fvdSpeedDial.Storage.RecentlyClosed.removeAll(function(){fvdSpeedDial.SpeedDial.sheduleFullRebuild()})}})},wrapperDblClick:function(event){this.toggleExpand()},getExpandState:function(){var currentState=_b(fvdSpeedDial.Prefs.get("sd."+this.currentDisplayType()+"_expanded"));if(fvdSpeedDial.PowerOffClient.isHidden()){return false}return currentState},toggleExpand:function(){if(fvdSpeedDial.PowerOffClient.isHidden()){return}var newVal=!_b(fvdSpeedDial.Prefs.get("sd."+fvdSpeedDial.SpeedDial.currentDisplayType()+"_expanded"));fvdSpeedDial.Prefs.set("sd."+fvdSpeedDial.SpeedDial.currentDisplayType()+"_expanded",newVal)},refreshShowHideButton:function(){var b=document.querySelector("#searchBar .rightMenu .showHide");if(this.getExpandState()){b.setAttribute("active","1")}else{b.setAttribute("active","0")}},refreshExpandState:function(args){var currentState=this.getExpandState();if(args){if(args.ifcollapsed){if(currentState){return}}}var wrapper=document.getElementById("speedDialWrapper");wrapper.setAttribute("expanded",currentState?1:0);var that=this;if(!currentState){var collapsedContainer=document.querySelector("#speedDialCollapsedContent");if(fvdSpeedDial.PowerOffClient.isHidden()){collapsedContainer.setAttribute("type","poweroff")}else if(fvdSpeedDial.PowerOff.isEnabled()){collapsedContainer.setAttribute("type","poweroffmessage")}else{collapsedContainer.setAttribute("type","simple")}}that.refreshSpeedDialWrapperHeight();that.refreshShowHideButton();that.refreshLightCollapsedMessageVisibility()},refreshLightCollapsedMessageVisibility:function(){var collapsedContainer=document.querySelector("#speedDialCollapsedContent");var collapsedType=collapsedContainer.getAttribute("type");var needShow=false;switch(collapsedType){case"poweroffmessage":if(!_b(fvdSpeedDial.Prefs.get("collapsed_message.without_poweroff.display"))){needShow=true}break;case"simple":if(!_b(fvdSpeedDial.Prefs.get("collapsed_message.with_poweroff.display"))){needShow=true}break}if(this.getExpandState()){needShow=false}if(needShow){fvdSpeedDial.lightCollapsedMessage.show()}else{fvdSpeedDial.lightCollapsedMessage.hide()}},refreshBackground:function(){fvdSpeedDial.Storage.getMisc("sd.background",function(imageUrl){var bgData={color:fvdSpeedDial.Prefs.get("sd.background_color"),useColor:_b(fvdSpeedDial.Prefs.get("sd.background_color_enabled")),imageUrl:imageUrl+"?"+Math.random(),imageType:fvdSpeedDial.Prefs.get("sd.background_url_type")};var bgContainer=document.documentElement;fvdSpeedDial.Background.setToElem(bgData,bgContainer)})},refreshCSS:function(){fvdSpeedDial.CSS.refresh()},sheduleCSSRefresh:function(){var that=this;this._needCSSRefresh=true;setTimeout(function(){if(that._needCSSRefresh){that.refreshCSS()}},100)},sheduleBackgroundRefresh:function(){var that=this;this._needBackgroundRefresh=true;setTimeout(function(){if(that._needBackgroundRefresh){that.refreshBackground()}},100)},_needRebuildChecker:function(){if(fvdSpeedDial.SpeedDial._needRebuildGroupsList){fvdSpeedDial.SpeedDial._needRebuildGroupsList=false;fvdSpeedDial.SpeedDial.Groups.rebuildGroupsList()}if(fvdSpeedDial.SpeedDial._needRebuild){fvdSpeedDial.SpeedDial._needRebuild=false;fvdSpeedDial.SpeedDial.rebuildCells()}},_getSpeedDialCellById:function(dialId){return document.getElementById("dialCell_"+dialId)},_viewportWidth:function(){var maxRightScrollbarWidth=20;return window.innerWidth-maxRightScrollbarWidth},_viewportHeightForHorizScroll:function(){return window.innerHeight-document.getElementById("cellsContainer").getBoundingClientRect().top},_viewportHeight:function(){return document.body.scrollHeight},_prefsListener:function(name,value){if("sd.thumbs_type"==name||"sd.top_sites_columns"==name){if(name=="sd.thumbs_type"){fvdSpeedDial.Prefs.set("sd.top_sites_columns","auto")}if(fvdSpeedDial.SpeedDial.currentDisplayType()=="speeddial"){fvdSpeedDial.SpeedDial.sheduleRebuild()}}else if("sd.scrolling"==name){window.scrollTo(0,0)}else if("sd.display_mode"==name){window.scrollTo(0,0)}else if("sd.all_groups_limit_dials"==name){if(fvdSpeedDial.SpeedDial.currentDisplayType()=="speeddial"){if(fvdSpeedDial.SpeedDial.currentGroupId()==0){fvdSpeedDial.SpeedDial.sheduleRebuild()}}}else if("sd.thumbs_type_most_visited"==name||"sd.most_visited_columns"==name||"sd.max_most_visited_records"==name){if(fvdSpeedDial.SpeedDial.currentDisplayType()=="mostvisited"){fvdSpeedDial.SpeedDial.sheduleRebuild()}if(name=="sd.thumbs_type_most_visited"){fvdSpeedDial.Prefs.set("sd.most_visited_columns","auto")}}else if("sd.max_recently_closed_records"==name||"sd.recentlyclosed_columns"==name){if(fvdSpeedDial.SpeedDial.currentDisplayType()=="recentlyclosed"){fvdSpeedDial.SpeedDial.sheduleRebuild()}}else if(name=="sd.search_bar_expanded"){fvdSpeedDial.SpeedDial.refreshSpeedDialWrapperHeight()}else if(["sd.enable_top_sites","sd.enable_most_visited","sd.enable_recently_closed"].indexOf(name)!=-1){fvdSpeedDial.SpeedDial._displayType=null}else if(["sd.speeddial_expanded","sd.mostvisited_expanded","sd.recentlyclosed_expanded"].indexOf(name)!=-1){var displayType=name.replace("sd.","").replace("_expanded","");if(displayType==fvdSpeedDial.SpeedDial.currentDisplayType()){fvdSpeedDial.SpeedDial.refreshExpandState()}if(value&&fvdSpeedDial.Prefs.get("sd.display_mode")=="fancy"){fvdSpeedDial.SpeedDial.sheduleRebuild()}}else if(name.indexOf("sd.text.")==0||["sd.show_urls_under_dials","sd.dials_opacity","sd.show_icons_and_titles_above_dials","sd.display_dial_background","sd.display_quick_menu_and_clicks"].indexOf(name)!=-1){fvdSpeedDial.SpeedDial.sheduleCSSRefresh()}else if(name.indexOf("sd.background")==0){fvdSpeedDial.SpeedDial.sheduleBackgroundRefresh()}else if(name=="collapsed_message.with_poweroff.display"||name=="collapsed_message.without_poweroff.display"){fvdSpeedDial.SpeedDial.refreshCollapsedMessages();fvdSpeedDial.SpeedDial.refreshLightCollapsedMessageVisibility()}else if(name=="sd.display_mirror"){fvdSpeedDial.SpeedDial.refreshEnableMirrors()}else if(name=="sd.main_menu_displayed"){fvdSpeedDial.SpeedDial.Groups.rebuildGroupsList()}},_getDialIdByCell:function(cell){return cell.getAttribute("id").replace("dialCell_","")},_getGroupByItem:function(item){return item.getAttribute("id").replace("group_select_","")},_dialsAreaSize:function(params){if(typeof params.objects=="undefined"){params.objects=document.getElementById("cellsContainer").childNodes.length}var cellSize=this._currentCellSize();var cellsInRow=this.cellsInRowMax(null,null,params).cols;var areaWidth=cellSize.width*cellsInRow+(cellsInRow-1)*this._cellsMarginX;return{width:areaWidth}},_currentSettingsColumnsCount:function(){switch(this.currentDisplayType()){case"speeddial":return fvdSpeedDial.Prefs.get("sd.top_sites_columns");break;case"mostvisited":return fvdSpeedDial.Prefs.get("sd.most_visited_columns");break;case"recentlyclosed":return fvdSpeedDial.Prefs.get("sd.recentlyclosed_columns");break}},_currentListElemSize:function(){if(this.currentDisplayType()=="mostvisited"){return this._listElemSizeMostVisited}else{return this._listElemSize}},_currentCellSize:function(){var size=null;var that=this;if(fvdSpeedDial.Prefs.get("sd.display_mode")=="fancy"){size=parseInt(fvdSpeedDial.Prefs.get("sd.custom_dial_size_fancy"))}else{size=parseInt(fvdSpeedDial.Prefs.get("sd.custom_dial_size"))}return{width:size,height:Math.round(size/that._cellsSizeRatio)}},_listContainer:function(){return document.getElementById("listContainer")},_cellsContainer:function(){return document.getElementById("cellsContainer")}};fvdSpeedDial.SpeedDial=new SpeedDial})();(function(){var ThumbManager=function(){function onHiddenCaptureFinished(params,resultData){if(resultData&&params.id&&params.type){var dataUrl=resultData.dataUrl;var title=resultData.title;var thumbSize=resultData.thumbSize;switch(params.type){case"speeddial":fvdSpeedDial.Storage.getDial(params.id,function(oldDial){if(!oldDial){return}var resultData={auto_title:title};if(oldDial){if(!oldDial.title&&oldDial.auto_title!=title){fvdSpeedDial.Sync.addDataToSync({category:"dials",data:params.id,translate:"dial"})}}if(params.saveImage){resultData.thumb=dataUrl;resultData.screen_maked=1;resultData.thumb_width=thumbSize.width;resultData.thumb_height=thumbSize.height;resultData.last_preview_update=(new Date).getTime()}fvdSpeedDial.Storage.updateDial(params.id,resultData,function(){})});break;case"mostvisited":resultData={auto_title:title};if(params.saveImage){resultData.thumb_source_type="screen";resultData.thumb=dataUrl;resultData.screen_maked=1;resultData.thumb_width=thumbSize.width;resultData.thumb_height=thumbSize.height;resultData.get_screen_method="auto"}fvdSpeedDial.Storage.MostVisited.updateData(params.id,resultData,function(){});break}}}function isQueued(params){var queue=fvdSpeedDial.HiddenCaptureQueue.getQueue();var currentItem=fvdSpeedDial.HiddenCaptureQueue.getCurrentItem();if(currentItem){if(currentItem.params.type==params.type&&currentItem.params.id==params.id){return true}}for(var i=0;i!=queue.length;i++){var item=queue[i];if(item.params.type==params.type&&item.params.id==params.id){return true}}return false}this.hiddenCaptureThumb=function(aParams,callback){if(typeof aParams.saveImage=="undefined"){aParams.saveImage=true}if(typeof aParams.resetScreenMaked=="undefined"){aParams.resetScreenMaked=true}fvdSpeedDial.Utils.Async.chain([function(chainCallback){if(aParams.resetScreenMaked){if(aParams.type=="speeddial"){fvdSpeedDial.Storage.updateDial(aParams.data.id,{screen_maked:0},function(){chainCallback()})}else if(aParams.type=="mostvisited"){fvdSpeedDial.Storage.MostVisited.updateData(aParams.data.id,{screen_maked:0},function(){chainCallback()})}}else{chainCallback()}},function(chainCallback){if(aParams.data.url){chainCallback()}else{if(aParams.type=="speeddial"){fvdSpeedDial.Storage.getDial(aParams.data.id,function(dial){aParams.data.url=dial.url;aParams.elemId="dialCell_"+aParams.data.id;chainCallback()})}else if(aParams.type=="mostvisited"){fvdSpeedDial.Storage.MostVisited.getById(aParams.data.id,aParams.interval,"host",function(row){aParams.data.url=row.url;aParams.elemId="dialCell_"+aParams.data.id;chainCallback()})}}},function(){var data=aParams.data;var elem=aParams.elem;if(elem){if(aParams.saveImage){elem.setAttribute("loadscreen",1);var screen=elem.querySelector(".body .preview-image");if(screen){fvdSpeedDial.Utils.removeScreenPreview(screen)}}}var params={url:data.url,id:data.id,elemId:aParams.elemId,type:aParams.type,saveImage:aParams.saveImage,interval:aParams.interval};if(!isQueued(params)){fvdSpeedDial.HiddenCaptureQueue.capture(params,callback)}else{}}])};Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg.action=="hiddencapture:done"){onHiddenCaptureFinished(msg.params,msg.result)}else if(msg.action=="thumbmanager:hiddenCaptureThumb"){var cb=function(){};fvdSpeedDial.SpeedDial.ThumbManager.hiddenCaptureThumb(msg.params,function(res){if(msg.wantResponse){sendResponse(res)}});if(msg.waitResponse){return true}}})};fvdSpeedDial.SpeedDial.ThumbManager=new ThumbManager})();(function(){var MostVisited=function(){};window.MostVisited=MostVisited;MostVisited.prototype={_cache:{},_shortCache:{},_maxRetrieveResultSet:5e3,init:function(){var that=this},getAvailableCount:function(interval,callback){this.getData({interval:interval,type:"host",count:this._maxRetrieveResultSet},function(data){callback(data.length)})},isRemoved:function(id,callback){fvdSpeedDial.Storage._connection.transaction(function(tx){tx.executeSql("SELECT EXISTS(SELECT * FROM `mostvisited_extended` WHERE `id` = ? AND `removed` = ?) as ex",[id,1],function(tx,results){callback(results.rows.item(0).ex==1)})})},deleteId:function(id,callback){var that=this;this.updateData(id,{removed:1},function(result){that.invalidateCache();callback(result)})},restoreRemoved:function(callback){var that=this;fvdSpeedDial.Storage._connection.transaction(function(tx){tx.executeSql("UPDATE `mostvisited_extended` SET `removed` = 0 WHERE `removed` = 1",[],function(tx,results){that.invalidateCache();if(callback){callback()}})})},updateData:function(id,data,callback){var query="INSERT INTO `mostvisited_extended`( `id` ) VALUES (?)";fvdSpeedDial.Utils.Async.chain([function(next){if(!data.thumb||typeof data.thumb!="string"||data.thumb.indexOf("data:")!==0){return next()}var thumb=fvdSpeedDial.Utils.dataURIToBlob(data.thumb),ext=fvdSpeedDial.Utils.typeToExt(thumb.type);fvdSpeedDial.Storage.FileSystem.write("/"+fvdSpeedDial.Config.FS_MOSTVISITED_PREVIEW_DIR+"/"+id+"."+ext,thumb,function(err,url){if(err){throw err}data.thumb=url;next()})},function(){fvdSpeedDial.Storage._connection.transaction(function(tx){tx.executeSql(query,[id],function(tx,results){var updateData=fvdSpeedDial.Storage._getUpdateData(data);updateData.dataArray.push(id);if(data.thumb){updateData.strings.push("`thumb_version` = `thumb_version` + 1")}tx.executeSql("UPDATE `mostvisited_extended` SET "+updateData.strings.join(", ")+" WHERE `id` = ?",updateData.dataArray,function(tx,results){if(callback){callback({result:results.rowsAffected==1})}})})})}])},getExtendedData:function(cb){fvdSpeedDial.Storage._connection.transaction(function(tx){tx.executeSql("SELECT * FROM `mostvisited_extended`",[],function(tx,results){var r=[];for(var i=0;i!=results.rows.length;i++){r.push(results.rows.item(i))}cb(r)})})},extendData:function(oldData,callback){var data={};for(var k in oldData){data[k]=oldData[k]}fvdSpeedDial.Storage._connection.transaction(function(tx){tx.executeSql("SELECT `title`, `auto_title`, `thumb_source_type`, `thumb_url`, `screen_maked`, `thumb`,"+" `screen_delay`, `thumb_version`,"+"`thumb_width`, `thumb_height`, `get_screen_method` FROM `mostvisited_extended` WHERE `id` = ?",[data.id],function(tx,results){if(results.rows.length==1){var dbData=results.rows.item(0);data.title=dbData.title;data.thumb_source_type=dbData.thumb_source_type;data.thumb_url=dbData.thumb_url;data.screen_maked=dbData.screen_maked;data.thumb=dbData.thumb;data.screen_delay=dbData.screen_delay;data.auto_title=dbData.auto_title;data.thumb_width=dbData.thumb_width;data.thumb_height=dbData.thumb_height;data.get_screen_method=dbData.get_screen_method;data.thumb_version=dbData.thumb_version}if(!data.thumb_source_type){data.thumb_source_type="screen"}if(!data.thumb_url){data.thumb_url=""}if(!data.screen_maked){data.screen_maked=0}if(!data.thumb){data.thumb=""}if(typeof data.screen_delay=="undefined"){data.screen_delay=fvdSpeedDial.Prefs.get("sd.preview_creation_delay_default")}data.displayTitle=data.title?data.title:data.auto_title?data.auto_title:"";callback(data)},function(){console.log(arguments)})})},invalidateCache:function(full){this._shortCache={};if(full){this._cache={}}},getById:function(id,interval,type,callback){this.getData({interval:interval,type:type,count:1,cond:{id:id}},function(data){for(var i=0;i!=data.length;i++){callback(data[i]);return}callback(null)})},getDataByHost:function(interval,host,callback){var data=this.getData({interval:interval,type:"url",count:this._maxRetrieveResultSet,cond:{host:host}},function(data){callback(data)})},getData:function(params,callback){var interval=params.interval,type=params.type,count=params.count,cond=params.cond;type=type||"host";var shortCacheResult=this._getFromShortCache([interval,type,count,cond]);if(shortCacheResult){callback(shortCacheResult);return}var needReloadCache=false;if(typeof this._cache[interval]=="undefined"||typeof this._cache[interval][type]=="undefined"){needReloadCache=true}else if((new Date).getTime()-this._cache[interval].time>fvdSpeedDial.Prefs.get("sd.most_visited_cache_life_time")){needReloadCache=true}var that=this;var callbackCalled=false;var afterGetData=function(preData){var result=[];if(cond){var tmp=[];for(var i=0;i!=preData.length;i++){var d=preData[i];if(cond.host&&cond.host!=d.host){continue}if(cond.id&&cond.id!=d.id){continue}tmp.push(d)}preData=tmp}if(preData.length==0){callback([]);return}function __checkEnd(){that._setToShortCache([interval,type,count,cond],result);callback(result)}fvdSpeedDial.Utils.Async.arrayProcess(preData,function(d,apCallback){if(d.url.indexOf("chrome-extension://")===0){return apCallback()}if(result.length==count){return __checkEnd()}try{fvdSpeedDial.Storage.isDenyUrl(d.url,function(deny){if(!callbackCalled){if(!deny){that.isRemoved(d.id,function(removed){if(!removed){result.push(d)}apCallback()})}else{apCallback()}}})}catch(ex){apCallback()}},function(){__checkEnd()})};if(needReloadCache){var that=this;this.reloadCacheForInterval(interval,function(){afterGetData(that._cache[interval][type].slice(0,that._cache[interval][type].length))})}else{afterGetData(this._cache[interval][type].slice(0,this._cache[interval][type].length))}},reloadCacheForInterval:function(interval,reloadCacheForInterval_callback){var period=this._intervalToDatePeriod(interval);var that=this;chrome.history.search({text:"",startTime:period.start,endTime:period.end,maxResults:this._maxRetrieveResultSet},function(items){that._orderHistoryResults(items);var resultByHost={};var resultByUrl=[];var workFinishCallback=function(){var resultByHostArray=[];for(var host in resultByHost){resultByHostArray.push(resultByHost[host])}that._cache[interval]={url:resultByUrl,host:resultByHostArray,time:(new Date).getTime()};if(reloadCacheForInterval_callback){reloadCacheForInterval_callback()}};for(var i=0;i!=items.length;i++){var item=items[i];if(item.url.toLowerCase().indexOf("http")!==0){item.invalid=true}try{item.host=fvdSpeedDial.Utils.parseUrl(item.url,"host").toLowerCase().replace("www.","")}catch(ex){continue}if(typeof resultByHost[item.host]=="undefined"){resultByHost[item.host]=item;resultByHost[item.host].inGroup=1;resultByHost[item.host].totalVisits=item.visitCount}else{resultByHost[item.host].inGroup++;resultByHost[item.host].totalVisits+=item.visitCount}resultByUrl.push(item)}workFinishCallback()})},_getFromShortCache:function(args){var key=JSON.stringify(args);if(typeof this._shortCache[key]=="undefined"){return null}var record=this._shortCache[key];if((new Date).getTime()-record.time>fvdSpeedDial.Prefs.get("sd.most_visited_cache_life_time")){delete this._shortCache[key];return null}return this._shortCache[key].data},_setToShortCache:function(args,data){var key=JSON.stringify(args);this._shortCache[key]={time:(new Date).getTime(),data:data}},_orderHistoryResults:function(items){for(var i=0;i<items.length-1;i++){for(var j=i;j!=items.length;j++){if(items[i].visitCount<items[j].visitCount){var tmp=items[j];items[j]=items[i];items[i]=tmp}}}},_intervalToDatePeriod:function(interval){switch(interval){case"all_time":return{start:1,end:(new Date).getTime()};break;case"month":return{start:(new Date).getTime()-30*24*60*60*1e3,end:(new Date).getTime()};break;case"week":return{start:(new Date).getTime()-7*24*60*60*1e3,end:(new Date).getTime()};break}}};this.Storage.MostVisited=new MostVisited}).apply(fvdSpeedDial);(function(){var RecentlyClosed=function(){var that=this;chrome.tabs.onUpdated.addListener(function(tabId){chrome.tabs.get(tabId,function(tab){that._tabsData[tabId]=tab})});chrome.tabs.onRemoved.addListener(function(tabId){try{if(that._tabsData[tabId]){var tab=that._tabsData[tabId];if(!that.hasUrl(tab.url)){fvdSpeedDial.Storage.isDenyUrl(tab.url,function(deny){tab.displayTitle=tab.title;tab.deny=deny;that._tabs.unshift(tab);that._tabs.slice(0,fvdSpeedDial.Prefs.get("sd.max_recently_closed_records"));Broadcaster.sendMessage({action:"foundRecentlyClosed",needActiveTab:true})})}delete that._tabsData[tabId]}}catch(ex){}})};RecentlyClosed.prototype={_tabs:[],_tabsData:{},getAvailableCount:function(callback){callback(this._tabs.length)},checkDenyAll:function(callback){var that=this;var tabsToRemove=[];var tabsLength=this._tabs.length;for(var i=0;i!=tabsLength;i++){(function(i){fvdSpeedDial.Storage.isDenyUrl(that._tabs[i].url,function(deny){if(deny){that._tabs[i].deny=true}else{that._tabs[i].deny=false}if(i==tabsLength-1){for(var j=0;j!=tabsToRemove.length;j++){var index=that._tabs.indexOf(tabsToRemove[j]);if(index!=-1){that._tabs.splice(index,1)}}if(callback){callback()}}})})(i)}if(tabsLength==0){if(callback){callback()}}},hasUrl:function(url){for(var i=0;i!=this._tabs.length;i++){if(this._tabs[i].url==url){return true}}return false},remove:function(id,callback){for(var i=0;i!=this._tabs.length;i++){if(this._tabs[i].id==id){this._tabs.splice(i,1);break}}if(callback){callback()}},removeAll:function(callback){this._tabs=[];if(callback){callback()}},getData:function(params,callback){var count=params.count;var result=[];for(var i=0;i!=this._tabs.length&&result.length<count;i++){if(this._tabs[i].deny){continue}result.push(this._tabs[i])}callback(result)},get:function(id,callback){for(var i=0;i!=this._tabs.length;i++){if(this._tabs[i].id==id){callback(this._tabs[i]);break}}}};this.Storage.RecentlyClosed=new RecentlyClosed}).apply(fvdSpeedDial);(function(){var Apps=function(){};Apps.prototype={storePositions:function(positions,callback){fvdSpeedDial.Storage.setMisc("apps_positions",JSON.stringify(positions),callback)},get:function(callback){chrome.management.getAll(function(extensions){chrome.management.get("ahfgeienlihckogmohjhadlkjgocpleb",function(webstoreApp){if(webstoreApp){extensions.push(webstoreApp)}var apps=[];for(var i=0;i!=extensions.length;i++){var ext=extensions[i];if(!ext.isApp){continue}if(!ext.enabled){continue}apps.push(ext)}fvdSpeedDial.Storage.getMisc("apps_positions",function(result){try{var positions=JSON.parse(result);for(var i=0;i!=apps.length;i++){if(positions[apps[i].id]){apps[i].position=positions[apps[i].id]}else{apps[i].position=Number.MAX_VALUE}}}catch(ex){}apps.sort(function(a,b){return a.position-b.position});callback(apps)})})})}};this.Apps=new Apps}).apply(fvdSpeedDial.Storage);(function(){Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg.action=="proxy:storage"){var startTime=(new Date).getTime();if(msg.wantResponse){msg.args.push(function(){var duration=((new Date).getTime()-startTime)/1e3;sendResponse({args:Array.prototype.slice.call(arguments),receiveTime:startTime,duration:duration})})}var accessObj=fvdSpeedDial.Storage,parts=msg.method.split("."),m=parts.pop();parts.forEach(function(part){accessObj=accessObj[part]});accessObj[m].apply(accessObj,msg.args);if(msg.wantResponse){return true}}})})();(function(){var RedundancyStorage={_dbInst:null,_db:function(cb){var self=this;if(this._dbInst){return cb(this._dbInst)}var request=indexedDB.open("FSRedundancy",1);request.onupgradeneeded=function(event){var db=event.target.result;var objectStore=db.createObjectStore("fs_store",{keyPath:"path"})};request.onerror=function(event){console.error("Fatal! Can't request indexedDB.")};request.onsuccess=function(event){self._dbInst=event.target.result;cb(self._dbInst)}},set:function(path,contents,cb){cb=cb||function(){};this._db(function(db){var transaction=db.transaction(["fs_store"],"readwrite");transaction.onerror=function(event){cb(event)};var request=transaction.objectStore("fs_store").put({path:path,contents:contents});request.onsuccess=function(event){cb(null)}})},get:function(path,cb){this._db(function(db){var transaction=db.transaction(["fs_store"]);var request=transaction.objectStore("fs_store").get(path);request.onerror=function(event){cb(event)};request.onsuccess=function(event){cb(null,request.result.contents)}})},"delete":function(path,cb){cb=cb||function(){};this._db(function(db){var transaction=db.transaction(["fs_store"],"readwrite");transaction.onerror=function(event){cb(event)};var request=transaction.objectStore("fs_store").delete(path);request.onsuccess=function(event){cb(null)}})},getAllPaths:function(cb){this._db(function(db){var transaction=db.transaction(["fs_store"]);var objectStore=transaction.objectStore("fs_store");var paths=[];objectStore.openCursor().onsuccess=function(event){var cursor=event.target.result;if(cursor){paths.push(cursor.key);cursor.continue()}else{cb(null,paths)}}})}};var FileSystem=function(){var self=this;

var _state="normal";var _fs=null;function request(callback){if(_fs){return callback(_fs)}webkitRequestFileSystem(window.PERSISTENT,1024*1024*1024,function(fs){_fs=fs;callback(fs)})}function _parseDir(path){var index=path.lastIndexOf("/");if(index==-1){return"."}var dir=path.substr(0,index);if(!dir){dir="/"}return dir}function init(){request(function(fs){fs.root.getDirectory("backups",{create:true},function(dir){dir.getDirectory("bookmarks",{create:true},function(){});dir.getDirectory("sd",{create:true},function(){})})})}this.__defineGetter__("redundancyStorage",function(){return RedundancyStorage});this.__defineSetter__("state",function(val){_state=val;Broadcaster.sendMessage({action:"storage:fs:updatestate",state:val})});this.__defineGetter__("state",function(){return _state});this.dirContents=function(path,callback){request(function(fs){function toArray(list){return Array.prototype.slice.call(list||[],0)}fs.root.getDirectory(path,{create:true},function(dir){var dirReader=dir.createReader();var entries=[];var readEntries=function(){dirReader.readEntries(function(results){if(!results.length){entries.sort();var names=[];entries.forEach(function(entry){names.push(entry.name.replace(path,""))});callback(names)}else{entries=entries.concat(toArray(results));readEntries()}},function(){callback(false)})};readEntries()},function(){callback(false)})})};this.makeDir=function(path,callback){request(function(fs){fs.root.getDirectory(path,{create:true},function(dir){callback()})})};this.removeDir=function(path,callback){request(function(fs){fs.root.getDirectory(path,{create:true},function(dir){dir.removeRecursively(function(){callback(true)},function(){callback(false)})})})};this.removeByURL=function(url,cb){webkitResolveLocalFileSystemURL(url,function(entry){RedundancyStorage.delete(entry.fullPath);entry.remove(cb,cb)},cb)};this.readAsDataURL=function(name,callback){request(function(fs){fs.root.getFile(name,null,function(fileEntry){fileEntry.file(function(f){var reader=new FileReader;reader.onload=function(e){callback(null,e.target.result)};reader.readAsDataURL(f)})},function(err){console.log("Fail get entry for",name);callback(err)})})};this.readAsDataURLbyURL=function(url,callback){webkitResolveLocalFileSystemURL(url,function(fileEntry){fileEntry.file(function(f){var reader=new FileReader;reader.onload=function(e){callback(null,e.target.result)};reader.readAsDataURL(f)})},function(err){console.log("Fail get entry for",name);callback(err)})};this.read=function(name,callback){request(function(fs){fs.root.getFile(name,null,function(fileEntry){fileEntry.file(function(f){var reader=new FileReader;reader.onload=function(e){callback(null,e.target.result)};reader.readAsArrayBuffer(f)})},function(err){console.log("Fail get entry for",name);callback(err)})})};this.truncate=function(name,callback){request(function(fs){fs.root.getFile(name,{create:true},function(fileEntry){fileEntry.createWriter(function(f){f.onwriteend=function(event){callback(null)};f.onerror=function(err){callback(err)};f.truncate(0)})})})};this.getEntryByURL=function(url,cb){webkitResolveLocalFileSystemURL(url,function(entry){cb(null,entry)},cb)};this.existsByURL=function(url,cb){webkitResolveLocalFileSystemURL(url,function(entry){cb(null,true)},function(){cb(null,false)})};this.getEntry=function(name,cb){request(function(fs){fs.root.getFile(name,null,function(fileEntry){cb(null,fileEntry)},function(err){cb(err)})})};this.write=function(name,text,params,callback){if(typeof params=="function"){callback=params;params={}}if(typeof params.redundancy=="undefined"){params.redundancy=true}console.log("Write File",name);var dir=_parseDir(name);self.makeDir(dir,function(){self.truncate(name,function(err){if(err){return callback(err)}request(function(fs){fs.root.getFile(name,{create:true},function(fileEntry){fileEntry.createWriter(function(f){var cbCalled=false;f.onwriteend=function(event){if(cbCalled){return}cbCalled=true;console.log("Write end for",name,f.length);var fURL=fileEntry.toURL();fvdSpeedDial.Utils.Async.chain([function(next){if(params.redundancy){var reader=new FileReader;var _nextCalled=false;reader.onload=function(e){if(_nextCalled){return}_nextCalled=true;RedundancyStorage.set(name,e.target.result,function(err){console.log("Redundancy set",name,err);next()})};reader.onerror=function(){if(_nextCalled){return}_nextCalled=true;return next()};reader.readAsDataURL(blob)}else{next()}},function(){callback(null,fURL)}])};f.onerror=function(err){if(cbCalled){return}cbCalled=true;console.error("Twrite file error",err);callback(err)};var blob=new Blob([text]);f.write(blob)})})})})})};this.checkIntegrity=function(){var notExistsFiles=[];fvdSpeedDial.Utils.Async.chain([function(next){RedundancyStorage.getAllPaths(function(err,paths){if(err){return console.error("FS Integity check: fail get paths from redundancy storage")}fvdSpeedDial.Utils.Async.arrayProcess(paths,function(path,apNext){self.getEntry(path,function(err,entry){if(err){notExistsFiles.push(path)}apNext()})},function(){next()})})},function(next){if(!notExistsFiles.length){return next()}self.state="restoring";fvdSpeedDial.Utils.Async.arrayProcess(notExistsFiles,function(path,apNext){RedundancyStorage.get(path,function(err,contents){var blob=fvdSpeedDial.Utils.dataURIToBlob(contents);self.write(path,blob,{redundancy:true},function(err){console.log("File written ",path," result",err);apNext()})})},function(){next()})},function(){setTimeout(function(){self.state="normal"},3e3)}])};this.exists=function(name,callback){request(function(fs){fs.root.getFile(name,null,function(fileEntry){callback(true)},function(){callback(false)})})};document.addEventListener("DOMContentLoaded",function(){init()},false)};window.addEventListener("load",function(){fvdSpeedDial.Storage.FileSystem.checkIntegrity()},false);Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg.action=="storage:fs:getState"){sendResponse(fvdSpeedDial.Storage.FileSystem.state);return true}});fvdSpeedDial.Storage.FileSystem=new FileSystem})();(function(){var createTablesRequests={dials:"CREATE TABLE IF NOT EXISTS dials "+"(url TEXT, display_url TEXT, title TEXT, `auto_title` TEXT,"+"thumb_source_type TEXT, thumb_url TEXT,"+"position INT, group_id INT, deny INT, clicks INT, `screen_maked` INT,"+"`thumb` TEXT, `thumb_version` INT DEFAULT 0,"+"`screen_delay` INT, `thumb_width` INT, `thumb_height` INT, `global_id` TEXT,"+"`get_screen_method`  VARCHAR DEFAULT 'manual', `update_interval` TEXT, "+"`last_preview_update` INT, `need_sync_screen` INT)",mostvisited_extended:"CREATE TABLE IF NOT EXISTS mostvisited_extended "+"(id INT UNIQUE ON CONFLICT IGNORE, `title` TEXT,"+"`auto_title` TEXT, thumb_source_type TEXT, thumb_url TEXT, `screen_maked` INT,"+"`thumb` TEXT, `thumb_version` INT DEFAULT 0, `removed` INT, `screen_delay` INT,"+"`thumb_width` INT, `thumb_height` INT,"+"`get_screen_method`  VARCHAR DEFAULT 'manual')",deny:"CREATE TABLE IF NOT EXISTS deny(sign TEXT, effective_sign TEXT, type TEXT)",misc:"CREATE TABLE IF NOT EXISTS misc( `name` TEXT  UNIQUE ON CONFLICT REPLACE, `value` TEXT )",groups:"CREATE TABLE IF NOT EXISTS groups "+"(id INTEGER PRIMARY KEY, name TEXT, position INT, global_id TEXT, sync INT DEFAULT 1)"};var requiredIndexes=[{name:"dials_global_id",sql:"CREATE INDEX dials_global_id ON dials(global_id)"},{name:"groups_global_id",sql:"CREATE INDEX groups_global_id ON groups(global_id)"},{name:"dials_group_id",sql:"CREATE INDEX dials_group_id ON dials(group_id, deny)"}];var requiredFields=[{table:"dials",fields:[{name:"global_id",sql:"ALTER TABLE `dials` ADD COLUMN `global_id` TEXT"},{name:"get_screen_method",sql:"ALTER TABLE `dials` ADD COLUMN `get_screen_method` VARCHAR DEFAULT 'manual'"},{name:"need_sync_screen",sql:["ALTER TABLE `dials` ADD COLUMN `need_sync_screen` INT","UPDATE `dials` SET `need_sync_screen` = 1 WHERE `thumb_source_type` = 'local_file' "+"OR ( `thumb_source_type` = 'screen' AND `get_screen_method` = 'manual' )"]},{name:"thumb_version",sql:"ALTER TABLE `dials` ADD COLUMN `thumb_version` INT DEFAULT 0"},{name:"update_interval",sql:"ALTER TABLE `dials` ADD COLUMN `update_interval` TEXT"},{name:"last_preview_update",sql:"ALTER TABLE `dials` ADD COLUMN `last_preview_update` INT"},{name:"display_url",sql:"ALTER TABLE `dials` ADD COLUMN `display_url` TEXT"}]},{table:"groups",fields:[{name:"global_id",sql:"ALTER TABLE `groups` ADD COLUMN `global_id` TEXT"},{name:"sync",sql:"ALTER TABLE `groups` ADD COLUMN `sync` INT DEFAULT 1"}]},{table:"mostvisited_extended",fields:[{name:"get_screen_method",sql:"ALTER TABLE `mostvisited_extended` ADD COLUMN `get_screen_method`  VARCHAR DEFAULT 'manual'"},{name:"thumb_version",sql:"ALTER TABLE `mostvisited_extended` ADD COLUMN `thumb_version` INT DEFAULT 0"}]}];fvdSpeedDial.Storage.initStorage=function(tx,databaseBackup,callback){var that=fvdSpeedDial.Storage;var failCreateTable=function(table,trx,err){fvdSpeedDial.AppLog.err("Fail to create table",table,err.message)};var currentTables;var tablesCreated=[];var backupRestored=false;fvdSpeedDial.Utils.Async.chain([function(callback2){that._getTables(tx,function(tables){currentTables=tables;callback2()})},function(callback2){fvdSpeedDial.Utils.Async.arrayProcess(Object.keys(createTablesRequests),function(table,next){if(currentTables.indexOf(table)!==-1){return next()}tx.executeSql(createTablesRequests[table],[],function(){fvdSpeedDial.AppLog.info("Create "+table+" table: OK");tablesCreated.push(table);next()},failCreateTable.bind(null,table))},callback2)},function(chainCallback){fvdSpeedDial.Utils.Async.arrayProcess(requiredFields,function(tableData,arrayProcessCallbackTable){that._tableFields(tableData.table,function(fields){fvdSpeedDial.Utils.Async.arrayProcess(tableData.fields,function(field,arrayProcessCallbackField){if(fields.indexOf(field.name)==-1&&fields.length>0){fvdSpeedDial.AppLog.info("Not found field",field.name,"in",tableData.table,"try create");var sqls=field.sql;if(!(sqls instanceof Array)){sqls=[sqls]}fvdSpeedDial.Utils.Async.arrayProcess(sqls,function(sql,apCallbackSqls){tx.executeSql(sql,[],function(){if(field.after){field.after(tx,function(){apCallbackSqls()})}else{apCallbackSqls()}},function(error){console.log("Can't alter table",error)})},function(){arrayProcessCallbackField()},true)}else{arrayProcessCallbackField()}},function(){arrayProcessCallbackTable()},true)},tx)},function(){chainCallback()},true)},function(chainCallback){that._getIndexes(function(indexes){fvdSpeedDial.Utils.Async.arrayProcess(requiredIndexes,function(index,arrayProcessCallback){if(indexes.indexOf(index.name)==-1){fvdSpeedDial.AppLog.info("Not found index",index.name,"create it");tx.executeSql(index.sql,[],function(){arrayProcessCallback()})}else{arrayProcessCallback()}},function(){chainCallback()},true)},tx)},function(callback2){if(tablesCreated.indexOf("groups")!==-1&&tablesCreated.indexOf("dials")!==-1&&databaseBackup){databaseBackup.restore(tx,function(err){if(err){fvdSpeedDial.AppLog.info("! Backup hasn't been restored",err.message);console.info("Backup hasn't been restored(probably everything is ok)",err.message)}else{fvdSpeedDial.AppLog.info("Important! SpeedDial database has been restored.");backupRestored=true}callback2()})}else{callback2()}},function(callback2){if(backupRestored){return callback2()}if(tablesCreated.indexOf("groups")===-1||tablesCreated.indexOf("dials")===-1){return callback2()}var dialsCreated=[];var groupDials;fvdSpeedDial.Utils.Async.chain([function(next){ServerDials.fetch({userType:"new"},function(err,dials){console.log("FETCHED",dials);if(err){groupDials=[];fvdSpeedDial.AppLog.err("Fail to fetch dials from the server",err);console.error("Fail to fetch dials from the server",err)}else{fvdSpeedDial.AppLog.info("Fetched",dials.length," dials from the server");groupDials=dials}next()})},function(next){var processDial=function(dialData,done){dialData.get_screen_method=dialData.thumb_source_type!="url"?"auto":"custom";that.addDial(dialData,function(res){if(res){dialData.id=res.id;dialsCreated.push(dialData)}if(dialData.thumb_source_type=="url"){fvdSpeedDial.ThumbMaker.getImageDataPath({imgUrl:dialData.thumb_url,screenWidth:fvdSpeedDial.SpeedDial.getMaxCellWidth()},function(dataUrl,thumbSize){fvdSpeedDial.Storage.updateDial(res.id,{thumb:dataUrl,thumb_width:Math.round(thumbSize.width),thumb_height:Math.round(thumbSize.height)},function(){chrome.runtime.sendMessage({action:"forceRebuild"})})})}done()})};fvdSpeedDial.Utils.Async.arrayProcess(groupDials,processDial,next)},function(){fvdSpeedDial.AppLog.info("Created",dialsCreated.length," default dials");Broadcaster.sendMessage({action:"defaultDialsCreated",dials:dialsCreated});callback2()}])},function(){if(tablesCreated.length){fvdSpeedDial.AppLog.info("Tables created: "+tablesCreated.join(", "))}fvdSpeedDial.AppLog.info("Initialization complete");callback(true)}])}})();(function(){fvdSpeedDial.Storage.onDataChanged.addListener(function(){fvdSpeedDial.DatabaseBackup.scheduleBackup()});Broadcaster.onMessage.addListener(function(message){if(message.action==="miscDataSet"&&message.name==="sd.background"){fvdSpeedDial.DatabaseBackup.doBackgroundBackup()}});var checkWindowInterval;function stopCheckWindowInterval(){try{clearInterval(checkWindowInterval)}catch(ex){}finally{checkWindowInterval=null}}function startCheckBackupWindowInterval(){stopCheckWindowInterval();debug.log("DatabaseBackup: wait for a backup window");checkWindowInterval=setInterval(function(){if(fvdSpeedDial.DatabaseBackup.isRestoring){return}chrome.idle.queryState(fvdSpeedDial.Config.IDLE_TIME_FOR_DATABASE_BACKUP,function(state){if(state==="idle"){debug.log("DatabaseBackup: idle state found");stopCheckWindowInterval();fvdSpeedDial.DatabaseBackup.doBackup()}})},1e4)}function BackupRestore(){this.data=null}BackupRestore.prototype.restore=function(tx,cb){if(typeof tx==="function"){cb=tx;tx=null}debug.log("Start restoring database backup, restore data is",this.data);fvdSpeedDial.DatabaseBackup.isRestoring=true;Broadcaster.sendMessage({action:"startDBRestore"});function end(){fvdSpeedDial.DatabaseBackup.isRestoring=false;Broadcaster.sendMessage({action:"finishDBRestore"})}var restoreTimeout=setTimeout(function(){end();fvdSpeedDial.AppLog.info("Backup restoring has been timed out");cb(new Error("backup restore timed out"))},5*60*1e3);var startTime=(new Date).getTime();fvdSpeedDial.Storage.restoreTablesDataInOneTransaction(this.data,function(){debug.log("Database backup has been restored");var endTime=(new Date).getTime();fvdSpeedDial.AppLog.info("Restore duration: "+(endTime-startTime)/1e3);clearTimeout(restoreTimeout);end();cb(null)},null,tx)};fvdSpeedDial.DatabaseBackup={isRestoring:false,isBackupScheduled:function(){var v=false;try{v=JSON.parse(localStorage.databasebackup_scheduled)}catch(ex){}return v},setBackupScheduled:function(set){localStorage.databasebackup_scheduled=JSON.stringify(set)},scheduleBackup:function(){if(this.isBackupScheduled()){return}this.setBackupScheduled(true);startCheckBackupWindowInterval()},getBackup:function(cb){chrome.storage.local.get(["database_backup"],function(data){if(!data.database_backup){return cb(new Error("backup is not available"))}var backup=new BackupRestore;backup.data=data.database_backup;cb(null,backup)})},doBackgroundBackup:function(cb){var self=this;debug.log("DatabaseBackup: do background backup");cb=cb||function(){};fvdSpeedDial.Storage.getMisc("sd.background",function(fileUrl){if(!fileUrl){return cb(null)}fvdSpeedDial.Storage.FileSystem.readAsDataURLbyURL(fileUrl,function(err,data){if(err){cb(err)}if(data){chrome.storage.local.set({background_backup:data},cb)}else{cb(null)}})})},doBackup:function(cb){var self=this;debug.log("DatabaseBackup: do database backup");cb=cb||function(){};var data=[];fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.Storage.fullDump(function(err,_data){if(err){return cb(err)}debug.log("DatabaseBackup: full dump received");data=_data;next()})},function(next){if(Object.keys(data).length===0){console.error("Trying to backup an empty tables set, ignore backuping");return next()}chrome.storage.local.set({database_backup:data},next)},function(){self.setBackupScheduled(false);debug.log("DatabaseBackup: backup finished");cb(null)}])},restoreBackgroundBackup:function(cb){chrome.storage.local.get(["background_backup"],function(data){if(data.background_backup){fvdSpeedDial.Storage.setMisc("sd.background",data.background_backup,function(){cb(null,true)})}else{cb(null,false)}})},restore:function(cb){this.getBackup(function(err,backup){if(err){return cb(err)}fvdSpeedDial.Storage.transaction(function(tx){backup.restore(tx,cb)})})}};if(fvdSpeedDial.DatabaseBackup.isBackupScheduled()){startCheckBackupWindowInterval()}Broadcaster.onMessage.addListener(function(msg,sender,sendResponse){if(msg&&msg.action==="databaseBackup:getState"){sendResponse(fvdSpeedDial.DatabaseBackup.isRestoring?"restoring":"normal")}})})();(function(){var localStorageCopy={};var needToBackup=false;window.addEventListener("storage",function(){fvdSpeedDial.DatabaseBackup.LocalStorage.restoreBackupIfStorageEmpty()},false);setInterval(function(){if(needToBackup){fvdSpeedDial.DatabaseBackup.LocalStorage.doBackup()}},5e3);Broadcaster.onMessage.addListener(function(message){if(message.action==="pref:changed"){fvdSpeedDial.DatabaseBackup.LocalStorage.schedule()}});function localStorageToObject(){var res={};for(var i=0,len=localStorage.length;i<len;++i){var key=localStorage.key(i);var value=localStorage.getItem(key);res[key]=value}return res}fvdSpeedDial.DatabaseBackup.LocalStorage={schedule:function(){needToBackup=true},doBackup:function(cb){debug.log("LocalStorageBackup: do");needToBackup=false;cb=cb||function(){};var data=localStorageToObject();localStorageCopy=data;chrome.storage.local.set({localstorage_backup:localStorageCopy},cb)},restoreBackupIfStorageEmpty:function(cb){cb=cb||function(){};if(localStorage.length===0){this.restoreBackup(cb)}else{cb(null,false)}},restoreBackup:function(cb){cb=cb||function(){};var restore=function(data){for(var k in data){localStorage[k]=data[k]}debug.log("LocalStorage backup has just been restored",new Date);Broadcaster.sendMessage({action:"finishLocalStorageRestore"})};if(Object.keys(localStorageCopy).length){restore(localStorageCopy);return cb()}chrome.storage.local.get(["localstorage_backup"],function(data){if(!data.localstorage_backup){return cb()}restore(data.localstorage_backup);cb()})}}})();(function(){var ContextMenu=function(){function prefListener(key,value){if(key=="sd.show_in_context_menu"){fvdSpeedDial.ContextMenu.rebuild()}}Broadcaster.onMessage.addListener(function(msg){if(msg.action=="pref:changed"){prefListener(msg.name,msg.vaue)}})};ContextMenu.prototype={_mainId:null,needRebuild:false,init:function(){var that=this;setInterval(function(){if(that.needRebuild){that.rebuild();that.needRebuild=false}},200)},sheduleRebuild:function(){this.needRebuild=true},rebuild:function(){if(this._mainId){chrome.contextMenus.remove(this._mainId);this._mainId=null}if(!_b(fvdSpeedDial.Prefs.get("sd.show_in_context_menu"))){return}this._mainId=chrome.contextMenus.create({type:"normal",title:_("cm_main_title"),contexts:["page","link"]});var that=this;fvdSpeedDial.Storage.groupsList(function(groups){for(var i=0;i!=groups.length;i++){(function(i){var groupTitle=groups[i].name;if(i==0){groupTitle=_("cm_add_to")+groupTitle}chrome.contextMenus.create({type:"normal",title:groupTitle,contexts:["page","link"],parentId:that._mainId,onclick:function(clickData,tab){if(clickData.linkUrl){that.addLinkToSpeedDial(clickData,groups[i].id,tab)}else{that.addTabToSpeedDial(tab,groups[i].id)}}})})(i)}})},checkDialExists:function(data,callback){var that=this;fvdSpeedDial.Storage.dialExists({url:data.url},function(exists){if(exists){that.showAlreadyExistsMessage(data.tabId,callback)}else{callback(true)}})},addLinkToSpeedDial:function(clickData,groupId,tab){var that=this;this.checkDialExists({tabId:tab.id,url:clickData.linkUrl},function(canAdd){if(!canAdd){return}fvdSpeedDial.Storage.addDial({url:clickData.linkUrl,title:"",thumb_source_type:"screen",group_id:groupId,get_screen_method:"auto"},function(result){if(result.result){fvdSpeedDial.Sync.addDataToSync({category:["dials","newDials"],data:result.id,translate:"dial"})}});that.showSuccessAdded(tab.id)})},addTabToSpeedDial:function(tab,groupId){var that=this;this.checkDialExists({tabId:tab.id,url:tab.url},function(canAdd){if(!canAdd){return}fvdSpeedDial.Storage.addDial({url:tab.url,title:tab.title,thumb_source_type:"screen",group_id:groupId,get_screen_method:"auto"},function(result){if(result.result){fvdSpeedDial.Sync.addDataToSync({category:["dials","newDials"],data:result.id,translate:"dial"})}});that.showSuccessAdded(tab.id)})},showSuccessAdded:function(tabId){this.injectScripts(tabId,function(){chrome.tabs.sendMessage(tabId,{action:"dialAdded",text:_("cs_dial_added")})})},showAlreadyExistsMessage:function(tabId,callback){if(_b(fvdSpeedDial.Prefs.get("sd.display_dial_already_exists_dialog"))){this.injectScripts(tabId,function(){chrome.tabs.sendMessage(tabId,{action:"alreadyExists",text:_("dlg_confirm_dial_exists_text"),checkText:_("newtab_do_not_display_migrate"),addDialText:_("dlg_button_add_dial"),cancelText:_("dlg_button_cancel")},callback)})}else{callback(true)}},injectScripts:function(tabId,callback){chrome.tabs.executeScript(tabId,{file:"/content-scripts/fvdsdadd/cs.js"},function(){chrome.tabs.insertCSS(tabId,{file:"/content-scripts/fvdsdadd/cs.css"},function(){callback()})})}};this.ContextMenu=new ContextMenu;window.addEventListener("load",function(){fvdSpeedDial.ContextMenu.init()},false)}).apply(fvdSpeedDial);require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var config=require("config");var history=require("platform_specific/history");var async=require("async");var debug=require("platform_specific/debug");var escapeStringRegExp=require("escape-string-regexp");function HistorySearch(){this.fetchHistoryFor=config.fetchHistoryFor;this.historyData=""}HistorySearch.prototype.getMinHistoryTime=function(){return(new Date).getTime()-this.fetchHistoryFor};HistorySearch.prototype.isAnyHistoryFound=function(cb){history.isAnyHistoryFoundBefore(this.getMinHistoryTime(),cb)};HistorySearch.prototype.init=function(cb){var self=this;var minHistoryTime=this.getMinHistoryTime();debug.log("Fetch history since",new Date(minHistoryTime));history.search(minHistoryTime,"",function(err,items){if(err){return cb(err)}var lines=items.map(function(item){return item.url+"|"+item.visitCount});debug.log("History data URLs count:",lines.length);self.historyData=lines.join("\n").toLowerCase();debug.log("History data size:",self.historyData.length/1024/1024,"MB");cb(null)})};HistorySearch.prototype.getVisitsCountBySign=function(sign){var regExp=new RegExp(escapeStringRegExp(sign)+"[^\\|]+\\|([0-9]+)","ig");var m;var visits=0;do{m=regExp.exec(this.historyData);if(m){visits+=parseInt(m[1])}}while(m);return visits};HistorySearch.prototype.getChoices=function(dialsChoices,cb){var self=this;var choices=[];var startLookUpTime=(new Date).getTime();dialsChoices.forEach(function(dialChoice){if(!dialChoice.checkHost){debug.log("checkHost is not provided for",dialChoice,"skip");return}var visitsCount=self.getVisitsCountBySign(dialChoice.checkHost);debug.log("Count visits:",dialChoice.checkHost,visitsCount);if(visitsCount>=config.minVisits){debug.log("Host",dialChoice.checkHost,"found in the history, add choice",dialChoice);dialChoice.orderValue=visitsCount;choices.push(dialChoice)}else{debug.log("Host",dialChoice.checkHost," not found in the history(or visits count less than needed)")}});setTimeout(function(){cb(null,choices)},0)};module.exports=HistorySearch},{async:8,config:"config","escape-string-regexp":9,"platform_specific/debug":3,"platform_specific/history":4}],2:[function(require,module,exports){var debug=require("platform_specific/debug");var async=require("async");var HistorySearch=require("./historySearch");var config=require("config");var history=require("platform_specific/history");module.exports={_getTheBestChoice:function(choices){var selectedChoice;for(var i=0;i!=choices.length;i++){var choice=choices[i];if(choice.bestMatch){selectedChoice=choice;break}}return selectedChoice},pickDials:function(dials,cb){var self=this;var result=[];var addAnyWayDials=[];Object.keys(dials).forEach(function(globalId){var dialChoices=dials[globalId];if(dialChoices.length===1&&dialChoices[0].addAnyWay&&dialChoices[0].bestMatch){var dial=dialChoices[0];dial.globalId=globalId;debug.log("Found anyway dial with one choice with the best match",dial);addAnyWayDials.push(dial);delete dials[globalId]}});var historySearch=new HistorySearch;var checkHistory=false;var globalIds=Object.keys(dials);async.series([function(next){if(!globalIds.length){return next()}if(!history.isHistoryAvailable()){return next()}checkHistory=true;var startInitTime=(new Date).getTime();historySearch.init(function(){var endInitTime=(new Date).getTime();var historyInitDuration=(endInitTime-startInitTime)/1e3;debug.log("History init duration:",historyInitDuration+"s");next()})},function(next){if(checkHistory){async.each(globalIds,function(globalId,eachNext){var choices=dials[globalId];choices=choices.filter(function(choice){return!choice.noHistoryOnly});historySearch.getChoices(choices,function(err,historyChoices){if(err){return debug.log("Fail to search in history",err,historyChoices)}if(historyChoices.length>1){debug.log("history result is ambiguous, get the best choice");var dial=self._getTheBestChoice(choices);if(dial){dial.globalId=globalId;debug.log("Found the best choice(fallback from history)",dial);result.push(dial)}}else if(historyChoices.length===1){result.push(historyChoices[0])}eachNext()})},function(){result.sort(function(a,b){return b.orderValue-a.orderValue});debug.log("Ordered picked dials list("+result.length+"):");result.forEach(function(dial){debug.log(dial.title,dial.orderValue)});debug.log("Slice dials to count",config.maxDials);result=result.slice(0,config.maxDials);next()})}else{debug.log("Do not check history, add only the best choices of noHistory dials");for(var globalId in dials){var choices=dials[globalId];var dial=self._getTheBestChoice(choices);if(dial&&dial.noHistory){dial.globalId=globalId;debug.log("Found the best choice",dial);result.push(dial)}}next()}},function(){result=addAnyWayDials.concat(result);cb(null,result)}])}}},{"./historySearch":1,async:8,config:"config","platform_specific/debug":3,"platform_specific/history":4}],3:[function(require,module,exports){var config=require("config");var debug={log:function(){if(!config.debug){return}var args=Array.prototype.slice.call(arguments);console.log.apply(console,args)}};module.exports=debug},{config:"config"}],4:[function(require,module,exports){var async=require("async");var debug=require("platform_specific/debug");module.exports={exists:function(startTime,query,cb){chrome.history.search({text:query,startTime:startTime,maxResults:1},function(items){debug.log("Search in the history for",query,"found",items);cb(null,items.length>0)})},isHistoryAvailable:function(){return true},isAnyHistoryFoundBefore:function(time,cb){chrome.history.search({maxResults:1,text:"",endTime:time,startTime:0},function(items){cb(null,items.length>0)})},search:function(startTime,query,cb){chrome.history.search({text:query,startTime:startTime,maxResults:1e4},function(items){debug.log("Search all items in the history for",query,"found",items.length);cb(null,items)})}}},{async:8,"platform_specific/debug":3}],5:[function(require,module,exports){exports.setTimeout=window.setTimeout.bind(window);exports.setInterval=window.setInterval.bind(window);exports.getXHR=function(){return new XMLHttpRequest}},{}],6:[function(require,module,exports){module.exports={_prefix:"_serverdials_",_key:function(k){return this._prefix+k},get:function(key){return localStorage[this._key(key)]},set:function(key,value){localStorage[this._key(key)]=value},hasKey:function(key){return localStorage.hasOwnProperty(this._key(key))}}},{}],7:[function(require,module,exports){var async=require("async");var config=require("config");var URL=require("url");var debug=require("platform_specific/debug");var dialPicker=require("./picker");var misc=require("platform_specific/misc");var storage=require("platform_specific/storage");var ServerDials={serverUrl:"http://fvdspeeddial.com/fst/dials.php",mapFunction:null,mapClass:null,installTime:null,userType:null,clientSoftware:null,country:null,onDialsUpdate:{listeners:[],addListener:function(fn){if(this.listeners.indexOf(fn)===-1){this.listeners.push(fn)}},removeListener:function(fn){var index=this.listeners.indexOf(fn);if(index!==-1){this.listeners.splice(index,1)}},callListeners:function(){var args=Array.prototype.slice.call(arguments);this.listeners.forEach(function(listener){listener.apply(window,args)})}},setConfig:function(key,value){config[key]=value;return this},setMapFunction:function(func){this.mapFunction=func;return this},setMapClass:function(mapClass){this.mapClass=mapClass;return this},setInstallTime:function(installTime){this.installTime=installTime;return this},setUserType:function(userType){this.userType=userType;return this},setClientSoftware:function(clientSoftware){this.clientSoftware=clientSoftware;return this},setCountry:function(country){this.country=country},getLastUpdateRequestTime:function(){return storage.get("_serverDialsLastUpdateTime")},setLastUpdateRequestTime:function(){storage.set("_serverDialsLastUpdateTime",(new Date).getTime())},getExcludeDialsGlobalIds:function(){var globalIds=[];if(storage.get("_serverDialsExcludeGlobalIds")){try{globalIds=JSON.parse(storage.get("_serverDialsExcludeGlobalIds"))}catch(ex){}}if(!Array.isArray(globalIds)){globalIds=[]}return globalIds},addToExcludeDialsGlobalIds:function(globalIds){var exclude=this.getExcludeDialsGlobalIds();for(var i=0;i!=globalIds.length;i++){if(exclude.indexOf(globalIds[i])!==-1){continue}exclude.push(globalIds[i])}storage.set("_serverDialsExcludeGlobalIds",JSON.stringify(exclude))},_mapResult:function(result,cb){var self=this;async.series([function(next){if(self.mapFunction){result=result.map(self.mapFunction)}next()},function(next){if(!self.mapClass){return next()}var mapper=new self.mapClass;mapper.init(result,function(){result=result.map(mapper.map.bind(mapper));next()})},function(){cb(null,result)}])},fetch:function(params,cb){var self=this;params=params||{};if(this.clientSoftware){params.clientSoftware=this.clientSoftware}if(this.country){params.country=this.country}var exclude=this.getExcludeDialsGlobalIds();if(exclude.length&&!params.dontExclude){params.exclude=exclude.join(",")}var paramsArr=[];for(var k in params){paramsArr.push(k+"="+encodeURIComponent(params[k]))}var url=this.serverUrl+"?"+paramsArr.join("&");var xhr=misc.getXHR();debug.log("Fetch dials from url",url);xhr.open("GET",url);xhr.onload=function(){try{var dials=JSON.parse(xhr.responseText);self.addToExcludeDialsGlobalIds(Object.keys(dials));debug.log("Loaded dials count: ",Object.keys(dials).length);async.waterfall([function(next){dialPicker.pickDials(dials,next)},function(result){self._mapResult(result,function(err,result){if(err){return cb(err)}debug.log("Fetching dials finished, found",result.length,"dials");cb(null,result)})}])}catch(ex){cb(ex)}};xhr.onerror=function(err){cb(err)};xhr.send(null)},fetchUpdates:function(){if(config.disableUpdates){return debug.log("updates are disabled\n")}if(!this.installTime&&!this.userType){return debug.log("can't run dials update because neither installTime nor userType are set");

}var self=this;var now=(new Date).getTime();var lastUpdateTime=this.getLastUpdateRequestTime();if(!lastUpdateTime){this.setLastUpdateRequestTime();return}var elapsedTimeFromUpdate=now-lastUpdateTime;if(elapsedTimeFromUpdate<config.updateRequestInterval){return}debug.log("Elapsed from last update",elapsedTimeFromUpdate,"need interval",config.updateRequestInterval);var params={};if(this.installTime){params.installTime=this.installTime}if(this.userType){params.userType=this.userType}debug.log("Start fetchin dials updates");this.fetch(params,function(err,dials){self.setLastUpdateRequestTime();if(err){return debug.log("Fail to fetch dials",err)}if(dials&&dials.length){self.onDialsUpdate.callListeners(dials)}})}};misc.setInterval(ServerDials.fetchUpdates.bind(ServerDials),60*1e3);module.exports=ServerDials},{"./picker":2,async:8,config:"config","platform_specific/debug":3,"platform_specific/misc":5,"platform_specific/storage":6,url:15}],8:[function(require,module,exports){(function(process,global){(function(){var async={};function noop(){}function identity(v){return v}function toBool(v){return!!v}function notId(v){return!v}var previous_async;var root=typeof self==="object"&&self.self===self&&self||typeof global==="object"&&global.global===global&&global||this;if(root!=null){previous_async=root.async}async.noConflict=function(){root.async=previous_async;return async};function only_once(fn){return function(){if(fn===null)throw new Error("Callback was already called.");fn.apply(this,arguments);fn=null}}function _once(fn){return function(){if(fn===null)return;fn.apply(this,arguments);fn=null}}var _toString=Object.prototype.toString;var _isArray=Array.isArray||function(obj){return _toString.call(obj)==="[object Array]"};var _isObject=function(obj){var type=typeof obj;return type==="function"||type==="object"&&!!obj};function _isArrayLike(arr){return _isArray(arr)||typeof arr.length==="number"&&arr.length>=0&&arr.length%1===0}function _arrayEach(arr,iterator){var index=-1,length=arr.length;while(++index<length){iterator(arr[index],index,arr)}}function _map(arr,iterator){var index=-1,length=arr.length,result=Array(length);while(++index<length){result[index]=iterator(arr[index],index,arr)}return result}function _range(count){return _map(Array(count),function(v,i){return i})}function _reduce(arr,iterator,memo){_arrayEach(arr,function(x,i,a){memo=iterator(memo,x,i,a)});return memo}function _forEachOf(object,iterator){_arrayEach(_keys(object),function(key){iterator(object[key],key)})}function _indexOf(arr,item){for(var i=0;i<arr.length;i++){if(arr[i]===item)return i}return-1}var _keys=Object.keys||function(obj){var keys=[];for(var k in obj){if(obj.hasOwnProperty(k)){keys.push(k)}}return keys};function _keyIterator(coll){var i=-1;var len;var keys;if(_isArrayLike(coll)){len=coll.length;return function next(){i++;return i<len?i:null}}else{keys=_keys(coll);len=keys.length;return function next(){i++;return i<len?keys[i]:null}}}function _restParam(func,startIndex){startIndex=startIndex==null?func.length-1:+startIndex;return function(){var length=Math.max(arguments.length-startIndex,0);var rest=Array(length);for(var index=0;index<length;index++){rest[index]=arguments[index+startIndex]}switch(startIndex){case 0:return func.call(this,rest);case 1:return func.call(this,arguments[0],rest)}}}function _withoutIndex(iterator){return function(value,index,callback){return iterator(value,callback)}}var _setImmediate=typeof setImmediate==="function"&&setImmediate;var _delay=_setImmediate?function(fn){_setImmediate(fn)}:function(fn){setTimeout(fn,0)};if(typeof process==="object"&&typeof process.nextTick==="function"){async.nextTick=process.nextTick}else{async.nextTick=_delay}async.setImmediate=_setImmediate?_delay:async.nextTick;async.forEach=async.each=function(arr,iterator,callback){return async.eachOf(arr,_withoutIndex(iterator),callback)};async.forEachSeries=async.eachSeries=function(arr,iterator,callback){return async.eachOfSeries(arr,_withoutIndex(iterator),callback)};async.forEachLimit=async.eachLimit=function(arr,limit,iterator,callback){return _eachOfLimit(limit)(arr,_withoutIndex(iterator),callback)};async.forEachOf=async.eachOf=function(object,iterator,callback){callback=_once(callback||noop);object=object||[];var iter=_keyIterator(object);var key,completed=0;while((key=iter())!=null){completed+=1;iterator(object[key],key,only_once(done))}if(completed===0)callback(null);function done(err){completed--;if(err){callback(err)}else if(key===null&&completed<=0){callback(null)}}};async.forEachOfSeries=async.eachOfSeries=function(obj,iterator,callback){callback=_once(callback||noop);obj=obj||[];var nextKey=_keyIterator(obj);var key=nextKey();function iterate(){var sync=true;if(key===null){return callback(null)}iterator(obj[key],key,only_once(function(err){if(err){callback(err)}else{key=nextKey();if(key===null){return callback(null)}else{if(sync){async.setImmediate(iterate)}else{iterate()}}}}));sync=false}iterate()};async.forEachOfLimit=async.eachOfLimit=function(obj,limit,iterator,callback){_eachOfLimit(limit)(obj,iterator,callback)};function _eachOfLimit(limit){return function(obj,iterator,callback){callback=_once(callback||noop);obj=obj||[];var nextKey=_keyIterator(obj);if(limit<=0){return callback(null)}var done=false;var running=0;var errored=false;(function replenish(){if(done&&running<=0){return callback(null)}while(running<limit&&!errored){var key=nextKey();if(key===null){done=true;if(running<=0){callback(null)}return}running+=1;iterator(obj[key],key,only_once(function(err){running-=1;if(err){callback(err);errored=true}else{replenish()}}))}})()}}function doParallel(fn){return function(obj,iterator,callback){return fn(async.eachOf,obj,iterator,callback)}}function doParallelLimit(fn){return function(obj,limit,iterator,callback){return fn(_eachOfLimit(limit),obj,iterator,callback)}}function doSeries(fn){return function(obj,iterator,callback){return fn(async.eachOfSeries,obj,iterator,callback)}}function _asyncMap(eachfn,arr,iterator,callback){callback=_once(callback||noop);arr=arr||[];var results=_isArrayLike(arr)?[]:{};eachfn(arr,function(value,index,callback){iterator(value,function(err,v){results[index]=v;callback(err)})},function(err){callback(err,results)})}async.map=doParallel(_asyncMap);async.mapSeries=doSeries(_asyncMap);async.mapLimit=doParallelLimit(_asyncMap);async.inject=async.foldl=async.reduce=function(arr,memo,iterator,callback){async.eachOfSeries(arr,function(x,i,callback){iterator(memo,x,function(err,v){memo=v;callback(err)})},function(err){callback(err,memo)})};async.foldr=async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,identity).reverse();async.reduce(reversed,memo,iterator,callback)};async.transform=function(arr,memo,iterator,callback){if(arguments.length===3){callback=iterator;iterator=memo;memo=_isArray(arr)?[]:{}}async.eachOf(arr,function(v,k,cb){iterator(memo,v,k,cb)},function(err){callback(err,memo)})};function _filter(eachfn,arr,iterator,callback){var results=[];eachfn(arr,function(x,index,callback){iterator(x,function(v){if(v){results.push({index:index,value:x})}callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})}async.select=async.filter=doParallel(_filter);async.selectLimit=async.filterLimit=doParallelLimit(_filter);async.selectSeries=async.filterSeries=doSeries(_filter);function _reject(eachfn,arr,iterator,callback){_filter(eachfn,arr,function(value,cb){iterator(value,function(v){cb(!v)})},callback)}async.reject=doParallel(_reject);async.rejectLimit=doParallelLimit(_reject);async.rejectSeries=doSeries(_reject);function _createTester(eachfn,check,getResult){return function(arr,limit,iterator,cb){function done(){if(cb)cb(getResult(false,void 0))}function iteratee(x,_,callback){if(!cb)return callback();iterator(x,function(v){if(cb&&check(v)){cb(getResult(true,x));cb=iterator=false}callback()})}if(arguments.length>3){eachfn(arr,limit,iteratee,done)}else{cb=iterator;iterator=limit;eachfn(arr,iteratee,done)}}}async.any=async.some=_createTester(async.eachOf,toBool,identity);async.someLimit=_createTester(async.eachOfLimit,toBool,identity);async.all=async.every=_createTester(async.eachOf,notId,notId);async.everyLimit=_createTester(async.eachOfLimit,notId,notId);function _findGetResult(v,x){return x}async.detect=_createTester(async.eachOf,identity,_findGetResult);async.detectSeries=_createTester(async.eachOfSeries,identity,_findGetResult);async.detectLimit=_createTester(async.eachOfLimit,identity,_findGetResult);async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){if(err){callback(err)}else{callback(null,{value:x,criteria:criteria})}})},function(err,results){if(err){return callback(err)}else{callback(null,_map(results.sort(comparator),function(x){return x.value}))}});function comparator(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0}};async.auto=function(tasks,concurrency,callback){if(typeof arguments[1]==="function"){callback=concurrency;concurrency=null}callback=_once(callback||noop);var keys=_keys(tasks);var remainingTasks=keys.length;if(!remainingTasks){return callback(null)}if(!concurrency){concurrency=remainingTasks}var results={};var runningTasks=0;var hasError=false;var listeners=[];function addListener(fn){listeners.unshift(fn)}function removeListener(fn){var idx=_indexOf(listeners,fn);if(idx>=0)listeners.splice(idx,1)}function taskComplete(){remainingTasks--;_arrayEach(listeners.slice(0),function(fn){fn()})}addListener(function(){if(!remainingTasks){callback(null,results)}});_arrayEach(keys,function(k){if(hasError)return;var task=_isArray(tasks[k])?tasks[k]:[tasks[k]];var taskCallback=_restParam(function(err,args){runningTasks--;if(args.length<=1){args=args[0]}if(err){var safeResults={};_forEachOf(results,function(val,rkey){safeResults[rkey]=val});safeResults[k]=args;hasError=true;callback(err,safeResults)}else{results[k]=args;async.setImmediate(taskComplete)}});var requires=task.slice(0,task.length-1);var len=requires.length;var dep;while(len--){if(!(dep=tasks[requires[len]])){throw new Error("Has nonexistent dependency in "+requires.join(", "))}if(_isArray(dep)&&_indexOf(dep,k)>=0){throw new Error("Has cyclic dependencies")}}function ready(){return runningTasks<concurrency&&_reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},true)&&!results.hasOwnProperty(k)}if(ready()){runningTasks++;task[task.length-1](taskCallback,results)}else{addListener(listener)}function listener(){if(ready()){runningTasks++;removeListener(listener);task[task.length-1](taskCallback,results)}}})};async.retry=function(times,task,callback){var DEFAULT_TIMES=5;var DEFAULT_INTERVAL=0;var attempts=[];var opts={times:DEFAULT_TIMES,interval:DEFAULT_INTERVAL};function parseTimes(acc,t){if(typeof t==="number"){acc.times=parseInt(t,10)||DEFAULT_TIMES}else if(typeof t==="object"){acc.times=parseInt(t.times,10)||DEFAULT_TIMES;acc.interval=parseInt(t.interval,10)||DEFAULT_INTERVAL}else{throw new Error("Unsupported argument type for 'times': "+typeof t)}}var length=arguments.length;if(length<1||length>3){throw new Error("Invalid arguments - must be either (task), (task, callback), (times, task) or (times, task, callback)")}else if(length<=2&&typeof times==="function"){callback=task;task=times}if(typeof times!=="function"){parseTimes(opts,times)}opts.callback=callback;opts.task=task;function wrappedTask(wrappedCallback,wrappedResults){function retryAttempt(task,finalAttempt){return function(seriesCallback){task(function(err,result){seriesCallback(!err||finalAttempt,{err:err,result:result})},wrappedResults)}}function retryInterval(interval){return function(seriesCallback){setTimeout(function(){seriesCallback(null)},interval)}}while(opts.times){var finalAttempt=!(opts.times-=1);attempts.push(retryAttempt(opts.task,finalAttempt));if(!finalAttempt&&opts.interval>0){attempts.push(retryInterval(opts.interval))}}async.series(attempts,function(done,data){data=data[data.length-1];(wrappedCallback||opts.callback)(data.err,data.result)})}return opts.callback?wrappedTask():wrappedTask};async.waterfall=function(tasks,callback){callback=_once(callback||noop);if(!_isArray(tasks)){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}if(!tasks.length){return callback()}function wrapIterator(iterator){return _restParam(function(err,args){if(err){callback.apply(null,[err].concat(args))}else{var next=iterator.next();if(next){args.push(wrapIterator(next))}else{args.push(callback)}ensureAsync(iterator).apply(null,args)}})}wrapIterator(async.iterator(tasks))()};function _parallel(eachfn,tasks,callback){callback=callback||noop;var results=_isArrayLike(tasks)?[]:{};eachfn(tasks,function(task,key,callback){task(_restParam(function(err,args){if(args.length<=1){args=args[0]}results[key]=args;callback(err)}))},function(err){callback(err,results)})}async.parallel=function(tasks,callback){_parallel(async.eachOf,tasks,callback)};async.parallelLimit=function(tasks,limit,callback){_parallel(_eachOfLimit(limit),tasks,callback)};async.series=function(tasks,callback){_parallel(async.eachOfSeries,tasks,callback)};async.iterator=function(tasks){function makeCallback(index){function fn(){if(tasks.length){tasks[index].apply(null,arguments)}return fn.next()}fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null};return fn}return makeCallback(0)};async.apply=_restParam(function(fn,args){return _restParam(function(callArgs){return fn.apply(null,args.concat(callArgs))})});function _concat(eachfn,arr,fn,callback){var result=[];eachfn(arr,function(x,index,cb){fn(x,function(err,y){result=result.concat(y||[]);cb(err)})},function(err){callback(err,result)})}async.concat=doParallel(_concat);async.concatSeries=doSeries(_concat);async.whilst=function(test,iterator,callback){callback=callback||noop;if(test()){var next=_restParam(function(err,args){if(err){callback(err)}else if(test.apply(this,args)){iterator(next)}else{callback.apply(null,[null].concat(args))}});iterator(next)}else{callback(null)}};async.doWhilst=function(iterator,test,callback){var calls=0;return async.whilst(function(){return++calls<=1||test.apply(this,arguments)},iterator,callback)};async.until=function(test,iterator,callback){return async.whilst(function(){return!test.apply(this,arguments)},iterator,callback)};async.doUntil=function(iterator,test,callback){return async.doWhilst(iterator,function(){return!test.apply(this,arguments)},callback)};async.during=function(test,iterator,callback){callback=callback||noop;var next=_restParam(function(err,args){if(err){callback(err)}else{args.push(check);test.apply(this,args)}});var check=function(err,truth){if(err){callback(err)}else if(truth){iterator(next)}else{callback(null)}};test(check)};async.doDuring=function(iterator,test,callback){var calls=0;async.during(function(next){if(calls++<1){next(null,true)}else{test.apply(this,arguments)}},iterator,callback)};function _queue(worker,concurrency,payload){if(concurrency==null){concurrency=1}else if(concurrency===0){throw new Error("Concurrency must not be zero")}function _insert(q,data,pos,callback){if(callback!=null&&typeof callback!=="function"){throw new Error("task callback must be a function")}q.started=true;if(!_isArray(data)){data=[data]}if(data.length===0&&q.idle()){return async.setImmediate(function(){q.drain()})}_arrayEach(data,function(task){var item={data:task,callback:callback||noop};if(pos){q.tasks.unshift(item)}else{q.tasks.push(item)}if(q.tasks.length===q.concurrency){q.saturated()}});async.setImmediate(q.process)}function _next(q,tasks){return function(){workers-=1;var removed=false;var args=arguments;_arrayEach(tasks,function(task){_arrayEach(workersList,function(worker,index){if(worker===task&&!removed){workersList.splice(index,1);removed=true}});task.callback.apply(task,args)});if(q.tasks.length+workers===0){q.drain()}q.process()}}var workers=0;var workersList=[];var q={tasks:[],concurrency:concurrency,payload:payload,saturated:noop,empty:noop,drain:noop,started:false,paused:false,push:function(data,callback){_insert(q,data,false,callback)},kill:function(){q.drain=noop;q.tasks=[]},unshift:function(data,callback){_insert(q,data,true,callback)},process:function(){while(!q.paused&&workers<q.concurrency&&q.tasks.length){var tasks=q.payload?q.tasks.splice(0,q.payload):q.tasks.splice(0,q.tasks.length);var data=_map(tasks,function(task){return task.data});if(q.tasks.length===0){q.empty()}workers+=1;workersList.push(tasks[0]);var cb=only_once(_next(q,tasks));worker(data,cb)}},length:function(){return q.tasks.length},running:function(){return workers},workersList:function(){return workersList},idle:function(){return q.tasks.length+workers===0},pause:function(){q.paused=true},resume:function(){if(q.paused===false){return}q.paused=false;var resumeCount=Math.min(q.concurrency,q.tasks.length);for(var w=1;w<=resumeCount;w++){async.setImmediate(q.process)}}};return q}async.queue=function(worker,concurrency){var q=_queue(function(items,cb){worker(items[0],cb)},concurrency,1);return q};async.priorityQueue=function(worker,concurrency){function _compareTasks(a,b){return a.priority-b.priority}function _binarySearch(sequence,item,compare){var beg=-1,end=sequence.length-1;while(beg<end){var mid=beg+(end-beg+1>>>1);if(compare(item,sequence[mid])>=0){beg=mid}else{end=mid-1}}return beg}function _insert(q,data,priority,callback){if(callback!=null&&typeof callback!=="function"){throw new Error("task callback must be a function")}q.started=true;if(!_isArray(data)){data=[data]}if(data.length===0){return async.setImmediate(function(){q.drain()})}_arrayEach(data,function(task){var item={data:task,priority:priority,callback:typeof callback==="function"?callback:noop};q.tasks.splice(_binarySearch(q.tasks,item,_compareTasks)+1,0,item);if(q.tasks.length===q.concurrency){q.saturated()}async.setImmediate(q.process)})}var q=async.queue(worker,concurrency);q.push=function(data,priority,callback){_insert(q,data,priority,callback)};delete q.unshift;return q};async.cargo=function(worker,payload){return _queue(worker,1,payload)};function _console_fn(name){return _restParam(function(fn,args){fn.apply(null,args.concat([_restParam(function(err,args){if(typeof console==="object"){if(err){if(console.error){console.error(err)}}else if(console[name]){_arrayEach(args,function(x){console[name](x)})}}})]))})}async.log=_console_fn("log");async.dir=_console_fn("dir");async.memoize=function(fn,hasher){var memo={};var queues={};var has=Object.prototype.hasOwnProperty;hasher=hasher||identity;var memoized=_restParam(function memoized(args){var callback=args.pop();var key=hasher.apply(null,args);if(has.call(memo,key)){async.setImmediate(function(){callback.apply(null,memo[key])})}else if(has.call(queues,key)){queues[key].push(callback)}else{queues[key]=[callback];fn.apply(null,args.concat([_restParam(function(args){memo[key]=args;var q=queues[key];delete queues[key];for(var i=0,l=q.length;i<l;i++){q[i].apply(null,args)}})]))}});memoized.memo=memo;memoized.unmemoized=fn;return memoized};async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}};function _times(mapper){return function(count,iterator,callback){mapper(_range(count),iterator,callback)}}async.times=_times(async.map);async.timesSeries=_times(async.mapSeries);async.timesLimit=function(count,limit,iterator,callback){return async.mapLimit(_range(count),limit,iterator,callback)};async.seq=function(){var fns=arguments;return _restParam(function(args){var that=this;var callback=args[args.length-1];if(typeof callback=="function"){args.pop()}else{callback=noop}async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([_restParam(function(err,nextargs){cb(err,nextargs)})]))},function(err,results){callback.apply(that,[err].concat(results))})})};async.compose=function(){return async.seq.apply(null,Array.prototype.reverse.call(arguments))};function _applyEach(eachfn){return _restParam(function(fns,args){var go=_restParam(function(args){var that=this;var callback=args.pop();return eachfn(fns,function(fn,_,cb){fn.apply(that,args.concat([cb]))},callback)});if(args.length){return go.apply(this,args)}else{return go}})}async.applyEach=_applyEach(async.eachOf);async.applyEachSeries=_applyEach(async.eachOfSeries);async.forever=function(fn,callback){var done=only_once(callback||noop);var task=ensureAsync(fn);function next(err){if(err){return done(err)}task(next)}next()};function ensureAsync(fn){return _restParam(function(args){var callback=args.pop();args.push(function(){var innerArgs=arguments;if(sync){async.setImmediate(function(){callback.apply(null,innerArgs)})}else{callback.apply(null,innerArgs)}});var sync=true;fn.apply(this,args);sync=false})}async.ensureAsync=ensureAsync;async.constant=_restParam(function(values){var args=[null].concat(values);return function(callback){return callback.apply(this,args)}});async.wrapSync=async.asyncify=function asyncify(func){return _restParam(function(args){var callback=args.pop();var result;try{result=func.apply(this,args)}catch(e){return callback(e)}if(_isObject(result)&&typeof result.then==="function"){result.then(function(value){callback(null,value)})["catch"](function(err){callback(err.message?err:new Error(err))})}else{callback(null,result)}})};if(typeof module==="object"&&module.exports){module.exports=async}else if(typeof define==="function"&&define.amd){define([],function(){return async})}else{root.async=async}})()}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{_process:10}],9:[function(require,module,exports){"use strict";var matchOperatorsRe=/[|\\{}()[\]^$+*?.]/g;module.exports=function(str){if(typeof str!=="string"){throw new TypeError("Expected a string")}return str.replace(matchOperatorsRe,"\\$&")}},{}],10:[function(require,module,exports){var process=module.exports={};var cachedSetTimeout;var cachedClearTimeout;(function(){try{cachedSetTimeout=setTimeout}catch(e){cachedSetTimeout=function(){throw new Error("setTimeout is not defined")}}try{cachedClearTimeout=clearTimeout}catch(e){cachedClearTimeout=function(){throw new Error("clearTimeout is not defined")}}})();var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue)}else{queueIndex=-1}if(queue.length){drainQueue()}}function drainQueue(){if(draining){return}var timeout=cachedSetTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run()}}queueIndex=-1;len=queue.length}currentQueue=null;draining=false;cachedClearTimeout(timeout)}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i]}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){cachedSetTimeout(drainQueue,0)}};function Item(fun,array){this.fun=fun;this.array=array}Item.prototype.run=function(){this.fun.apply(null,this.array)};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],11:[function(require,module,exports){(function(global){(function(root){var freeExports=typeof exports=="object"&&exports&&!exports.nodeType&&exports;var freeModule=typeof module=="object"&&module&&!module.nodeType&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal){root=freeGlobal}var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^\x20-\x7E]/,regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw new RangeError(errors[type])}function map(array,fn){var length=array.length;var result=[];while(length--){result[length]=fn(array[length])}return result}function mapDomain(string,fn){var parts=string.split("@");var result="";if(parts.length>1){result=parts[0]+"@";string=parts[1]}string=string.replace(regexSeparators,".");var labels=string.split(".");var encoded=map(labels,fn).join(".");return result+encoded}function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){return map(array,function(value){var output="";if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value);return output}).join("")}function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22}if(codePoint-65<26){return codePoint-65}if(codePoint-97<26){return codePoint-97}return base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)}function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin)}return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0}for(j=0;j<basic;++j){if(input.charCodeAt(j)>=128){error("not-basic")}output.push(input.charCodeAt(j))}for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error("invalid-input")}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error("overflow")}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error("overflow")}w*=baseMinusT}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error("overflow")}n+=floor(i/out);i%=out;output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<128){output.push(stringFromCharCode(currentValue))}}handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter)}while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue}}handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error("overflow")}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error("overflow")}if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount}}++delta;++n}return output.join("")}function toUnicode(input){return mapDomain(input,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(input){return mapDomain(input,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}punycode={version:"1.4.1",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define("punycode",function(){return punycode})}else if(freeExports&&freeModule){if(module.exports==freeExports){freeModule.exports=punycode}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key])}}}else{root.punycode=punycode}})(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],12:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],13:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],14:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":12,"./encode":13}],15:[function(require,module,exports){"use strict";var punycode=require("punycode");var util=require("./util");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={
javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&util.isObject(url)&&url instanceof Url)return url;var u=new Url;u.parse(url,parseQueryString,slashesDenoteHost);return u}Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!util.isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var queryIndex=url.indexOf("?"),splitter=queryIndex!==-1&&queryIndex<url.indexOf("#")?"?":"#",uSplit=url.split(splitter),slashRegex=/\\/g;uSplit[0]=uSplit[0].replace(slashRegex,"/");url=uSplit.join(splitter);var rest=url;rest=rest.trim();if(!slashesDenoteHost&&url.split("#").length===1){var simplePath=simplePathPattern.exec(rest);if(simplePath){this.path=rest;this.href=rest;this.pathname=simplePath[1];if(simplePath[2]){this.search=simplePath[2];if(parseQueryString){this.query=querystring.parse(this.search.substr(1))}else{this.query=this.search.substr(1)}}else if(parseQueryString){this.search="";this.query={}}return this}}var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}var auth,atSign;if(hostEnd===-1){atSign=rest.lastIndexOf("@")}else{atSign=rest.lastIndexOf("@",hostEnd)}if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth)}hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}if(hostEnd===-1)hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);this.parseHost();this.hostname=this.hostname||"";var ipv6Hostname=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}this.hostname=validParts.join(".");break}}}}if(this.hostname.length>hostnameMaxLen){this.hostname=""}else{this.hostname=this.hostname.toLowerCase()}if(!ipv6Hostname){this.hostname=punycode.toASCII(this.hostname)}var p=this.port?":"+this.port:"";var h=this.hostname||"";this.host=h+p;this.href+=this.host;if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];if(rest.indexOf(ae)===-1)continue;var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){this.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query)}rest=rest.slice(0,qm)}else if(parseQueryString){this.search="";this.query={}}if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname="/"}if(this.pathname||this.search){var p=this.pathname||"";var s=this.search||"";this.path=p+s}this.href=this.format();return this};function urlFormat(obj){if(util.isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format()}Url.prototype.format=function(){var auth=this.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=this.protocol||"",pathname=this.pathname||"",hash=this.hash||"",host=false,query="";if(this.host){host=auth+this.host}else if(this.hostname){host=auth+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]");if(this.port){host+=":"+this.port}}if(this.query&&util.isObject(this.query)&&Object.keys(this.query).length){query=querystring.stringify(this.query)}var search=this.search||query&&"?"+query||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match)});search=search.replace("#","%23");return protocol+host+pathname+search+hash};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative)}Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format()};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative)}Url.prototype.resolveObject=function(relative){if(util.isString(relative)){var rel=new Url;rel.parse(relative,false,true);relative=rel}var result=new Url;var tkeys=Object.keys(this);for(var tk=0;tk<tkeys.length;tk++){var tkey=tkeys[tk];result[tkey]=this[tkey]}result.hash=relative.hash;if(relative.href===""){result.href=result.format();return result}if(relative.slashes&&!relative.protocol){var rkeys=Object.keys(relative);for(var rk=0;rk<rkeys.length;rk++){var rkey=rkeys[rk];if(rkey!=="protocol")result[rkey]=relative[rkey]}if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname="/"}result.href=result.format();return result}if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){var keys=Object.keys(relative);for(var v=0;v<keys.length;v++){var k=keys[v];result[k]=relative[k]}result.href=result.format();return result}result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");result.pathname=relPath.join("/")}else{result.pathname=relative.pathname}result.search=relative.search;result.query=relative.query;result.host=relative.host||"";result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;if(result.pathname||result.search){var p=result.pathname||"";var s=result.search||"";result.path=p+s}result.slashes=result.slashes||relative.slashes;result.href=result.format();return result}var isSourceAbs=result.pathname&&result.pathname.charAt(0)==="/",isRelAbs=relative.host||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic){result.hostname="";result.port=null;if(result.host){if(srcPath[0]==="")srcPath[0]=result.host;else srcPath.unshift(result.host)}result.host="";if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}relative.host=null}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){result.host=relative.host||relative.host===""?relative.host:result.host;result.hostname=relative.hostname||relative.hostname===""?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query}else if(!util.isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}result.search=relative.search;result.query=relative.query;if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.href=result.format();return result}if(!srcPath.length){result.pathname=null;if(result.search){result.path="/"+result.search}else{result.path=null}result.href=result.format();return result}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(result.host||relative.host||srcPath.length>1)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last==="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){result.hostname=result.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||result.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}if(!srcPath.length){result.pathname=null;result.path=null}else{result.pathname=srcPath.join("/")}if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){this.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)this.hostname=host}},{"./util":16,punycode:11,querystring:14}],16:[function(require,module,exports){"use strict";module.exports={isString:function(arg){return typeof arg==="string"},isObject:function(arg){return typeof arg==="object"&&arg!==null},isNull:function(arg){return arg===null},isNullOrUndefined:function(arg){return arg==null}}},{}],17:[function(require,module,exports){var ServerDialsImport=require("./lib/serverdials");if(typeof window!=="undefined"){window.ServerDials=ServerDialsImport}else{EXPORTED_SYMBOLS=["ServerDials"];ServerDials=ServerDialsImport}},{"./lib/serverdials":7}],config:[function(require,module,exports){module.exports={updateRequestInterval:24*3600*1e3,fetchHistoryFor:24*3600*60*1e3,minVisits:4,maxDials:8}},{}]},{},[17]);(function(){function refreshNewTabPages(){var refreshUrls=["dragon://newtab/",fvdSpeedDial.Config.NEWTAB_URL];refreshUrls.forEach(function(url){chrome.tabs.query({url:url},function(tabs){if(!tabs){console.log("Fail get tab",url,chrome.runtime.lastError);return}for(var i=0;i!=tabs.length;i++){if(tabs[i].status=="loading"){continue}chrome.tabs.update(tabs[i].id,{url:chrome.extension.getURL("newtab.html")})}})})}ServerDials.setMapClass(function(){var serverGroupsIds={};this.init=function(serverDials,cb){debug.log("init serverdials mapper");var serverGroupsMap={};serverDials.forEach(function(serverDial){serverGroupsMap[serverDial.group.globalId]=serverDial.group});var serverGroupsGlobalIds=Object.keys(serverGroupsMap);debug.log("found server groups",serverGroupsGlobalIds);fvdSpeedDial.Utils.Async.each(serverGroupsGlobalIds,function(serverGroupGlobalId,next){var serverGroup=serverGroupsMap[serverGroupGlobalId];var id=0;fvdSpeedDial.Utils.Async.chain([function(next2){fvdSpeedDial.Storage.groupIdByGlobalId(serverGroup.globalId,function(_id){if(!_id){debug.log("need to create group",serverGroup);fvdSpeedDial.Storage.groupAdd({global_id:serverGroup.globalId,name:serverGroup.name},function(res){if(!res.id){throw new Exception("Fail to create group "+serverGroup.globalId)}debug.log("group created, id:",res.id);id=res.id;next2()})}else{debug.log("group",serverGroup,"already in db with id",_id);id=_id;next2()}})},function(){serverGroupsIds[serverGroup.globalId]=id;next()}])},function(){debug.log("Init complete");cb()})};this.map=function(serverDial){var dial={url:serverDial.url,display_url:serverDial.displayUrl,global_id:serverDial.globalId,title:serverDial.title,thumb_url:serverDial.previewUrl,group_id:serverGroupsIds[serverDial.group.globalId]};if(serverDial.previewUrl){dial.thumb_url=serverDial.previewUrl;dial.thumb_source_type="url"}else{dial.thumb_source_type="screen"}return dial}});ServerDials.onDialsUpdate.addListener(function(dials){var defaultGroupId;fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.Storage.syncGetGroupId("default",function(id){defaultGroupId=id;next()})},function(){if(!defaultGroupId){console.info("Can't create a dial from the server, default group isn't exist");return}fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dialData,next){dialData.group_id=defaultGroupId;fvdSpeedDial.Storage.addDial(dialData,function(res){if(!res){return next()}dialData.id=res.id;fvdSpeedDial.ThumbMaker.getImageDataPath({imgUrl:dialData.thumb_url,screenWidth:fvdSpeedDial.SpeedDial.getMaxCellWidth()},function(dataUrl,thumbSize){fvdSpeedDial.Storage.updateDial(res.id,{thumb:dataUrl,thumb_width:Math.round(thumbSize.width),thumb_height:Math.round(thumbSize.height)},next)})})},function(){chrome.runtime.sendMessage({action:"forceRebuild"})})}])});ServerDials.setConfig("disableUpdates",true);Broadcaster.onMessage.addListener(function(message){if(message.action==="storage:fs:updatestate"&&message.state==="normal"||message.action==="finishLocalStorageRestore"){debug.log("Check background existance...");fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.Storage.getMisc("sd.background",function(fileUrl){if(!fileUrl){console.info("background file isn't set");return}fvdSpeedDial.Storage.FileSystem.existsByURL(fileUrl,function(err,exists){if(exists){console.info("background exists");return}fvdSpeedDial.DatabaseBackup.restoreBackgroundBackup(function(err,restored){console.info("Background backup is restored?",err,restored)})})})}])}});window.addEventListener("unload",function(){fvdSpeedDial.AppLog.info("Chrome/Extension turned off");fvdSpeedDial.AppLog.write()},false);window.addEventListener("load",function(){try{fvdSpeedDial.AppLog.info("Speed Dial "+chrome.runtime.getManifest().version+" Start Up, installed at",new Date(parseInt(fvdSpeedDial.Prefs.get("sd.install_time"))).toUTCString());fvdSpeedDial.AppLog.info("Chrome version",fvdSpeedDial.Utils.getChromeVersion());chrome.runtime.getPlatformInfo(function(platformInfo){fvdSpeedDial.AppLog.info("Platform",platformInfo)})}catch(ex){}fvdSpeedDial.DatabaseBackup.LocalStorage.restoreBackupIfStorageEmpty(function(err,restored){if(fvdSpeedDial.Prefs.get("sd.install_time")==null){Broadcaster.sendMessage({action:"first-install"});fvdSpeedDial.isFirstRunSession=true;fvdSpeedDial.Prefs.set("sd.install_time",(new Date).getTime());fvdSpeedDial.Prefs.set("widgets.opened",false);fvdSpeedDial.Prefs.set("sd.display_superfish",true);chrome.management.get("idgeoanibcknhniccgaoaiolihidecjn",function(app){if(chrome.runtime.lastError){console.log("Fail to get SD app",chrome.runtime.lastError)}if(app){return}if(!fvdSpeedDial.Config.MUTE_WELCOME){}});setTimeout(function(){chrome.tabs.query({url:fvdSpeedDial.Config.NEWTAB_URL},function(tabs){if(tabs.length===0){chrome.tabs.create({url:fvdSpeedDial.Config.NEWTAB_URL,active:true})}else{chrome.tabs.update(tabs[0].id,{active:true})}})},500);fvdSpeedDial.Prefs.set("display_themes_message",false);setTimeout(function(){fvdSpeedDial.Prefs.set("display_themes_message",true)},2*60*1e3)}});fvdSpeedDial.Localizer.localizeCurrentPage();fvdSpeedDial.Storage.MostVisited.init();fvdSpeedDial.Storage.connect(function(){fvdSpeedDial.ContextMenu.rebuild()});fvdSpeedDial.Storage.addGroupsCallback(function(){fvdSpeedDial.ContextMenu.sheduleRebuild()});fvdSpeedDial.Storage.addDialsCallback(function(message){if(message.action=="remove"){try{fvdSpeedDial.HiddenCaptureQueue.removeFromQueueById(message.data.id)}catch(ex){}}});fvdSpeedDial.Storage.addGroupsCallback(function(data){if(data.action=="remove"){if(data.groupId==fvdSpeedDial.Prefs.get("sd.default_group")){fvdSpeedDial.Storage.groupsList(function(groups){var group=groups[0];var newId=group.id;fvdSpeedDial.Prefs.set("sd.default_group",newId)})}else{chrome.runtime.sendMessage({action:"forceRebuild",resetActiveGroup:true,needDisplayType:"speeddial"})}}});function _prefChangeCallback(name,value){if(["sd.enable_top_sites","sd.enable_most_visited","sd.enable_recently_closed"].indexOf(name)!=-1){var enableSpeedDial=_b(fvdSpeedDial.Prefs.get("sd.enable_top_sites"));var enableMostVisited=_b(fvdSpeedDial.Prefs.get("sd.enable_most_visited"));var enableRecentlyClosed=_b(fvdSpeedDial.Prefs.get("sd.enable_recently_closed"));var disabledItems=[];if(!enableSpeedDial){disabledItems.push("speeddial")}if(!enableMostVisited){disabledItems.push("mostvisited")}if(!enableRecentlyClosed){disabledItems.push("recentlyclosed")}try{var type=fvdSpeedDial.Utils.arrayDiff(["speeddial","mostvisited","recentlyclosed"],disabledItems);type=type[0];if(disabledItems.indexOf(fvdSpeedDial.Prefs.get("sd.display_type"))!=-1){fvdSpeedDial.Prefs.set("sd.display_type",type)}if(disabledItems.indexOf(fvdSpeedDial.Prefs.get("sd.last_selected_display_type"))!=-1){fvdSpeedDial.Prefs.set("sd.last_selected_display_type",type)}}catch(ex){}chrome.runtime.sendMessage({action:"forceRebuild",needActiveTab:true})}else if(name=="sd.scrolling"){fvdSpeedDial.Prefs.set("sd.recentlyclosed_columns","auto");fvdSpeedDial.Prefs.set("sd.top_sites_columns","auto")}else if(name=="sd.display_popular_group"){fvdSpeedDial.Utils.Async.chain([function(chainCallback){if(0==fvdSpeedDial.Prefs.get("sd.default_group")){fvdSpeedDial.Storage.groupsList(function(groups){var group=groups[0];var newId=group.id;fvdSpeedDial.Prefs.set("sd.default_group",newId);chainCallback()})}else{chainCallback()}},function(){chrome.runtime.sendMessage({action:"forceRebuild",resetActiveGroup:true,needDisplayType:"speeddial"})}])}}refreshNewTabPages();chrome.browserAction.onClicked.addListener(function(tab){if(tab._ignore){return}var foundTabId=null;var foundTabIndex;fvdSpeedDial.Utils.Async.chain([function(chainCallback){chrome.tabs.query({url:fvdSpeedDial.Config.NEWTAB_URL},function(tabs){if(tabs.length>0){foundTabId=tabs[0].id;foundTabIndex=tabs[0].index}chainCallback()})},function(chainCallback){chrome.tabs.query({url:chrome.extension.getURL("newtab.html")},function(tabs){if(tabs.length>0){foundTabId=tabs[0].id}chainCallback()})},function(){if(!foundTabId){chrome.tabs.create({url:"newtab.html#force-display",active:true})}else{chrome.tabs.update(foundTabId,{active:true})}}])});if(["custom","list"].indexOf(fvdSpeedDial.Prefs.get("sd.thumbs_type"))==-1){fvdSpeedDial.Prefs.set("sd.custom_dial_size",fvdSpeedDial.SpeedDial._cellsSizes[fvdSpeedDial.Prefs.get("sd.thumbs_type")]);fvdSpeedDial.Prefs.set("sd.thumbs_type","custom")}if(["custom","list"].indexOf(fvdSpeedDial.Prefs.get("sd.thumbs_type_most_visited"))==-1){fvdSpeedDial.Prefs.set("sd.thumbs_type_most_visited","custom")}Broadcaster.onMessage.addListener(function(message,sender,callback){if(message&&message.action=="isSurfCanyonEnabled"){callback(_b(fvdSpeedDial.Prefs.get("surfcanyon.enabled")));return true}else if(message.action=="deny:changed"){fvdSpeedDial.Storage.RecentlyClosed.checkDenyAll(function(){fvdSpeedDial.Storage.refreshDenyDials(function(){fvdSpeedDial.Storage.MostVisited.invalidateCache();chrome.runtime.sendMessage({action:"forceRebuild",needActiveTab:true})})})}else if(message.action=="pref:changed"){_prefChangeCallback(message.name,message.value)}else if(message.action=="sync:activitystatechanged"){_refreshSyncActivityState()}});function _refreshSyncActivityState(){var active=fvdSpeedDial.Sync.isActive();fvdSpeedDial.Storage._markRemove=active}_refreshSyncActivityState();setInterval(function(){fvdSpeedDial.Storage.getDialsToPreviewUpdate(function(dialsToUpdate){dialsToUpdate.forEach(function(dial){fvdSpeedDial.HiddenCaptureQueue.capture({saveImage:true,id:dial.id,url:dial.url,type:"speeddial"})})})},6e4);if(chrome.runtime.setUninstallURL){chrome.runtime.setUninstallURL(fvdSpeedDial.Config.UNINSTALL_URL)}else{console.info("set uninstall url is not available")}ServerDials.setInstallTime(Math.round(parseInt(fvdSpeedDial.Prefs.get("sd.install_time"))/1e3)).setClientSoftware("chrome_addon")},true)})();var Aes={};Aes.cipher=function(input,w){var Nb=4;var Nr=w.length/Nb-1;var state=[[],[],[],[]];for(var i=0;i<4*Nb;i++)state[i%4][Math.floor(i/4)]=input[i];state=Aes.addRoundKey(state,w,0,Nb);for(var round=1;round<Nr;round++){state=Aes.subBytes(state,Nb);state=Aes.shiftRows(state,Nb);state=Aes.mixColumns(state,Nb);state=Aes.addRoundKey(state,w,round,Nb)}state=Aes.subBytes(state,Nb);state=Aes.shiftRows(state,Nb);state=Aes.addRoundKey(state,w,Nr,Nb);var output=new Array(4*Nb);for(var i=0;i<4*Nb;i++)output[i]=state[i%4][Math.floor(i/4)];return output};Aes.keyExpansion=function(key){var Nb=4;var Nk=key.length/4;var Nr=Nk+6;var w=new Array(Nb*(Nr+1));var temp=new Array(4);for(var i=0;i<Nk;i++){var r=[key[4*i],key[4*i+1],key[4*i+2],key[4*i+3]];w[i]=r}for(var i=Nk;i<Nb*(Nr+1);i++){w[i]=new Array(4);for(var t=0;t<4;t++)temp[t]=w[i-1][t];if(i%Nk==0){temp=Aes.subWord(Aes.rotWord(temp));for(var t=0;t<4;t++)temp[t]^=Aes.rCon[i/Nk][t]}else if(Nk>6&&i%Nk==4){temp=Aes.subWord(temp)}for(var t=0;t<4;t++)w[i][t]=w[i-Nk][t]^temp[t]}return w};Aes.subBytes=function(s,Nb){for(var r=0;r<4;r++){for(var c=0;c<Nb;c++)s[r][c]=Aes.sBox[s[r][c]]}return s};Aes.shiftRows=function(s,Nb){var t=new Array(4);for(var r=1;r<4;r++){for(var c=0;c<4;c++)t[c]=s[r][(c+r)%Nb];for(var c=0;c<4;c++)s[r][c]=t[c]}return s};Aes.mixColumns=function(s,Nb){for(var c=0;c<4;c++){var a=new Array(4);var b=new Array(4);for(var i=0;i<4;i++){a[i]=s[i][c];b[i]=s[i][c]&128?s[i][c]<<1^283:s[i][c]<<1}s[0][c]=b[0]^a[1]^b[1]^a[2]^a[3];s[1][c]=a[0]^b[1]^a[2]^b[2]^a[3];s[2][c]=a[0]^a[1]^b[2]^a[3]^b[3];s[3][c]=a[0]^b[0]^a[1]^a[2]^b[3]}return s};Aes.addRoundKey=function(state,w,rnd,Nb){for(var r=0;r<4;r++){for(var c=0;c<Nb;c++)state[r][c]^=w[rnd*4+c][r]}return state};Aes.subWord=function(w){for(var i=0;i<4;i++)w[i]=Aes.sBox[w[i]];return w};Aes.rotWord=function(w){var tmp=w[0];for(var i=0;i<3;i++)w[i]=w[i+1];w[3]=tmp;return w};Aes.sBox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22];Aes.rCon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]];Aes.Ctr={};Aes.Ctr.encrypt=function(plaintext,password,nBits){var blockSize=16;if(!(nBits==128||nBits==192||nBits==256))return"";plaintext=Utf8.encode(plaintext);password=Utf8.encode(password);var nBytes=nBits/8;var pwBytes=new Array(nBytes);for(var i=0;i<nBytes;i++){pwBytes[i]=isNaN(password.charCodeAt(i))?0:password.charCodeAt(i)}var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));var counterBlock=new Array(blockSize);var nonce=(new Date).getTime();var nonceMs=nonce%1e3;var nonceSec=Math.floor(nonce/1e3);var nonceRnd=Math.floor(Math.random()*65535);for(var i=0;i<2;i++)counterBlock[i]=nonceMs>>>i*8&255;for(var i=0;i<2;i++)counterBlock[i+2]=nonceRnd>>>i*8&255;for(var i=0;i<4;i++)counterBlock[i+4]=nonceSec>>>i*8&255;var ctrTxt="";for(var i=0;i<8;i++)ctrTxt+=String.fromCharCode(counterBlock[i]);var keySchedule=Aes.keyExpansion(key);var blockCount=Math.ceil(plaintext.length/blockSize);var ciphertxt=new Array(blockCount);for(var b=0;b<blockCount;b++){for(var c=0;c<4;c++)counterBlock[15-c]=b>>>c*8&255;for(var c=0;c<4;c++)counterBlock[15-c-4]=b/4294967296>>>c*8;var cipherCntr=Aes.cipher(counterBlock,keySchedule);var blockLength=b<blockCount-1?blockSize:(plaintext.length-1)%blockSize+1;var cipherChar=new Array(blockLength);for(var i=0;i<blockLength;i++){cipherChar[i]=cipherCntr[i]^plaintext.charCodeAt(b*blockSize+i);cipherChar[i]=String.fromCharCode(cipherChar[i])}ciphertxt[b]=cipherChar.join("")}var ciphertext=ctrTxt+ciphertxt.join("");ciphertext=Base64.encode(ciphertext);return ciphertext};Aes.Ctr.decrypt=function(ciphertext,password,nBits){var blockSize=16;if(!(nBits==128||nBits==192||nBits==256))return"";ciphertext=Base64.decode(ciphertext);password=Utf8.encode(password);var nBytes=nBits/8;var pwBytes=new Array(nBytes);for(var i=0;i<nBytes;i++){pwBytes[i]=isNaN(password.charCodeAt(i))?0:password.charCodeAt(i)}var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));var counterBlock=new Array(8);ctrTxt=ciphertext.slice(0,8);for(var i=0;i<8;i++)counterBlock[i]=ctrTxt.charCodeAt(i);var keySchedule=Aes.keyExpansion(key);var nBlocks=Math.ceil((ciphertext.length-8)/blockSize);var ct=new Array(nBlocks);for(var b=0;b<nBlocks;b++)ct[b]=ciphertext.slice(8+b*blockSize,8+b*blockSize+blockSize);ciphertext=ct;var plaintxt=new Array(ciphertext.length);for(var b=0;b<nBlocks;b++){for(var c=0;c<4;c++)counterBlock[15-c]=b>>>c*8&255;for(var c=0;c<4;c++)counterBlock[15-c-4]=(b+1)/4294967296-1>>>c*8&255;var cipherCntr=Aes.cipher(counterBlock,keySchedule);var plaintxtByte=new Array(ciphertext[b].length);for(var i=0;i<ciphertext[b].length;i++){plaintxtByte[i]=cipherCntr[i]^ciphertext[b].charCodeAt(i);plaintxtByte[i]=String.fromCharCode(plaintxtByte[i])}plaintxt[b]=plaintxtByte.join("")}var plaintext=plaintxt.join("");plaintext=Utf8.decode(plaintext);return plaintext};var Base64={};Base64.code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";Base64.encode=function(str,utf8encode){utf8encode=typeof utf8encode=="undefined"?false:utf8encode;var o1,o2,o3,bits,h1,h2,h3,h4,e=[],pad="",c,plain,coded;var b64=Base64.code;plain=utf8encode?str.encodeUTF8():str;c=plain.length%3;if(c>0){while(c++<3){pad+="=";plain+="\x00"}}for(c=0;c<plain.length;c+=3){o1=plain.charCodeAt(c);o2=plain.charCodeAt(c+1);o3=plain.charCodeAt(c+2);bits=o1<<16|o2<<8|o3;h1=bits>>18&63;h2=bits>>12&63;h3=bits>>6&63;h4=bits&63;e[c/3]=b64.charAt(h1)+b64.charAt(h2)+b64.charAt(h3)+b64.charAt(h4)}coded=e.join("");coded=coded.slice(0,coded.length-pad.length)+pad;return coded};Base64.decode=function(str,utf8decode){utf8decode=typeof utf8decode=="undefined"?false:utf8decode;var o1,o2,o3,h1,h2,h3,h4,bits,d=[],plain,coded;var b64=Base64.code;coded=utf8decode?str.decodeUTF8():str;for(var c=0;c<coded.length;c+=4){h1=b64.indexOf(coded.charAt(c));h2=b64.indexOf(coded.charAt(c+1));h3=b64.indexOf(coded.charAt(c+2));h4=b64.indexOf(coded.charAt(c+3));bits=h1<<18|h2<<12|h3<<6|h4;o1=bits>>>16&255;o2=bits>>>8&255;o3=bits&255;d[c/4]=String.fromCharCode(o1,o2,o3);if(h4==64)d[c/4]=String.fromCharCode(o1,o2);if(h3==64)d[c/4]=String.fromCharCode(o1)}plain=d.join("");return utf8decode?plain.decodeUTF8():plain};var Utf8={};Utf8.encode=function(strUni){var strUtf=strUni.replace(/[\u0080-\u07ff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(192|cc>>6,128|cc&63)});strUtf=strUtf.replace(/[\u0800-\uffff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(224|cc>>12,128|cc>>6&63,128|cc&63)});return strUtf};Utf8.decode=function(strUtf){var strUni=strUtf.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(c){var cc=(c.charCodeAt(0)&15)<<12|(c.charCodeAt(1)&63)<<6|c.charCodeAt(2)&63;return String.fromCharCode(cc)});strUni=strUni.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(c){var cc=(c.charCodeAt(0)&31)<<6|c.charCodeAt(1)&63;return String.fromCharCode(cc)});return strUni};function RGBColor(color_string){this.ok=false;if(color_string.charAt(0)=="#"){color_string=color_string.substr(1,6)}color_string=color_string.replace(/ /g,"");color_string=color_string.toLowerCase();var simple_colors={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",
teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};for(var key in simple_colors){if(color_string==key){color_string=simple_colors[key]}}var color_defs=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(bits){return[parseInt(bits[1]),parseInt(bits[2]),parseInt(bits[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(bits){return[parseInt(bits[1],16),parseInt(bits[2],16),parseInt(bits[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(bits){return[parseInt(bits[1]+bits[1],16),parseInt(bits[2]+bits[2],16),parseInt(bits[3]+bits[3],16)]}}];for(var i=0;i<color_defs.length;i++){var re=color_defs[i].re;var processor=color_defs[i].process;var bits=re.exec(color_string);if(bits){channels=processor(bits);this.r=channels[0];this.g=channels[1];this.b=channels[2];this.ok=true}}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r;this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g;this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b;this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"};this.toHex=function(){var r=this.r.toString(16);var g=this.g.toString(16);var b=this.b.toString(16);if(r.length==1)r="0"+r;if(g.length==1)g="0"+g;if(b.length==1)b="0"+b;return"#"+r+g+b};this.getHelpXML=function(){var examples=new Array;for(var i=0;i<color_defs.length;i++){var example=color_defs[i].example;for(var j=0;j<example.length;j++){examples[examples.length]=example[j]}}for(var sc in simple_colors){examples[examples.length]=sc}var xml=document.createElement("ul");xml.setAttribute("id","rgbcolor-examples");for(var i=0;i<examples.length;i++){try{var list_item=document.createElement("li");var list_color=new RGBColor(examples[i]);var example_div=document.createElement("div");example_div.style.cssText="margin: 3px; "+"border: 1px solid black; "+"background:"+list_color.toHex()+"; "+"color:"+list_color.toHex();example_div.appendChild(document.createTextNode("test"));var list_item_value=document.createTextNode(" "+examples[i]+" -> "+list_color.toRGB()+" -> "+list_color.toHex());list_item.appendChild(example_div);list_item.appendChild(list_item_value);xml.appendChild(list_item)}catch(e){}}return xml}}var mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];var shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];function stackBlurImage(imageID,canvasID,radius,blurAlphaChannel){var img=document.getElementById(imageID);var w=img.naturalWidth;var h=img.naturalHeight;var canvas=document.getElementById(canvasID);canvas.style.width=w+"px";canvas.style.height=h+"px";canvas.width=w;canvas.height=h;var context=canvas.getContext("2d");context.clearRect(0,0,w,h);context.drawImage(img,0,0);if(isNaN(radius)||radius<1)return;if(blurAlphaChannel)stackBlurCanvasRGBA(canvasID,0,0,w,h,radius);else stackBlurCanvasRGB(canvasID,0,0,w,h,radius)}function stackBlurCanvasRGBA(id,top_x,top_y,width,height,radius){if(isNaN(radius)||radius<1)return;radius|=0;var canvas=document.getElementById(id);var context=canvas.getContext("2d");var imageData;try{try{imageData=context.getImageData(top_x,top_y,width,height)}catch(e){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");imageData=context.getImageData(top_x,top_y,width,height)}catch(e){alert("Cannot access local image");throw new Error("unable to access local image data: "+e);return}}}catch(e){alert("Cannot access image");throw new Error("unable to access image data: "+e)}var pixels=imageData.data;var x,y,i,p,yp,yi,yw,r_sum,g_sum,b_sum,a_sum,r_out_sum,g_out_sum,b_out_sum,a_out_sum,r_in_sum,g_in_sum,b_in_sum,a_in_sum,pr,pg,pb,pa,rbs;var div=radius+radius+1;var w4=width<<2;var widthMinus1=width-1;var heightMinus1=height-1;var radiusPlus1=radius+1;var sumFactor=radiusPlus1*(radiusPlus1+1)/2;var stackStart=new BlurStack;var stack=stackStart;for(i=1;i<div;i++){stack=stack.next=new BlurStack;if(i==radiusPlus1)var stackEnd=stack}stack.next=stackStart;var stackIn=null;var stackOut=null;yw=yi=0;var mul_sum=mul_table[radius];var shg_sum=shg_table[radius];for(y=0;y<height;y++){r_in_sum=g_in_sum=b_in_sum=a_in_sum=r_sum=g_sum=b_sum=a_sum=0;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next}for(i=1;i<radiusPlus1;i++){p=yi+((widthMinus1<i?widthMinus1:i)<<2);r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[p+1])*rbs;b_sum+=(stack.b=pb=pixels[p+2])*rbs;a_sum+=(stack.a=pa=pixels[p+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next}stackIn=stackStart;stackOut=stackEnd;for(x=0;x<width;x++){pixels[yi+3]=pa=a_sum*mul_sum>>shg_sum;if(pa!=0){pa=255/pa;pixels[yi]=(r_sum*mul_sum>>shg_sum)*pa;pixels[yi+1]=(g_sum*mul_sum>>shg_sum)*pa;pixels[yi+2]=(b_sum*mul_sum>>shg_sum)*pa}else{pixels[yi]=pixels[yi+1]=pixels[yi+2]=0}r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=yw+((p=x+radius+1)<widthMinus1?p:widthMinus1)<<2;r_in_sum+=stackIn.r=pixels[p];g_in_sum+=stackIn.g=pixels[p+1];b_in_sum+=stackIn.b=pixels[p+2];a_in_sum+=stackIn.a=pixels[p+3];r_sum+=r_in_sum;g_sum+=g_in_sum;b_sum+=b_in_sum;a_sum+=a_in_sum;stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=4}yw+=width}for(x=0;x<width;x++){g_in_sum=b_in_sum=a_in_sum=r_in_sum=g_sum=b_sum=a_sum=r_sum=0;yi=x<<2;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);a_out_sum=radiusPlus1*(pa=pixels[yi+3]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;a_sum+=sumFactor*pa;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack.a=pa;stack=stack.next}yp=width;for(i=1;i<=radius;i++){yi=yp+x<<2;r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[yi+1])*rbs;b_sum+=(stack.b=pb=pixels[yi+2])*rbs;a_sum+=(stack.a=pa=pixels[yi+3])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;a_in_sum+=pa;stack=stack.next;if(i<heightMinus1){yp+=width}}yi=x;stackIn=stackStart;stackOut=stackEnd;for(y=0;y<height;y++){p=yi<<2;pixels[p+3]=pa=a_sum*mul_sum>>shg_sum;if(pa>0){pa=255/pa;pixels[p]=(r_sum*mul_sum>>shg_sum)*pa;pixels[p+1]=(g_sum*mul_sum>>shg_sum)*pa;pixels[p+2]=(b_sum*mul_sum>>shg_sum)*pa}else{pixels[p]=pixels[p+1]=pixels[p+2]=0}r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;a_sum-=a_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;a_out_sum-=stackIn.a;p=x+((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width<<2;r_sum+=r_in_sum+=stackIn.r=pixels[p];g_sum+=g_in_sum+=stackIn.g=pixels[p+1];b_sum+=b_in_sum+=stackIn.b=pixels[p+2];a_sum+=a_in_sum+=stackIn.a=pixels[p+3];stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;a_out_sum+=pa=stackOut.a;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;a_in_sum-=pa;stackOut=stackOut.next;yi+=width}}context.putImageData(imageData,top_x,top_y)}function stackBlurCanvasRGB(id,top_x,top_y,width,height,radius){if(isNaN(radius)||radius<1)return;radius|=0;var canvas=document.getElementById(id);var context=canvas.getContext("2d");var imageData;try{try{imageData=context.getImageData(top_x,top_y,width,height)}catch(e){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");imageData=context.getImageData(top_x,top_y,width,height)}catch(e){alert("Cannot access local image");throw new Error("unable to access local image data: "+e);return}}}catch(e){alert("Cannot access image");throw new Error("unable to access image data: "+e)}var pixels=imageData.data;var x,y,i,p,yp,yi,yw,r_sum,g_sum,b_sum,r_out_sum,g_out_sum,b_out_sum,r_in_sum,g_in_sum,b_in_sum,pr,pg,pb,rbs;var div=radius+radius+1;var w4=width<<2;var widthMinus1=width-1;var heightMinus1=height-1;var radiusPlus1=radius+1;var sumFactor=radiusPlus1*(radiusPlus1+1)/2;var stackStart=new BlurStack;var stack=stackStart;for(i=1;i<div;i++){stack=stack.next=new BlurStack;if(i==radiusPlus1)var stackEnd=stack}stack.next=stackStart;var stackIn=null;var stackOut=null;yw=yi=0;var mul_sum=mul_table[radius];var shg_sum=shg_table[radius];for(y=0;y<height;y++){r_in_sum=g_in_sum=b_in_sum=r_sum=g_sum=b_sum=0;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack=stack.next}for(i=1;i<radiusPlus1;i++){p=yi+((widthMinus1<i?widthMinus1:i)<<2);r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[p+1])*rbs;b_sum+=(stack.b=pb=pixels[p+2])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;stack=stack.next}stackIn=stackStart;stackOut=stackEnd;for(x=0;x<width;x++){pixels[yi]=r_sum*mul_sum>>shg_sum;pixels[yi+1]=g_sum*mul_sum>>shg_sum;pixels[yi+2]=b_sum*mul_sum>>shg_sum;r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;p=yw+((p=x+radius+1)<widthMinus1?p:widthMinus1)<<2;r_in_sum+=stackIn.r=pixels[p];g_in_sum+=stackIn.g=pixels[p+1];b_in_sum+=stackIn.b=pixels[p+2];r_sum+=r_in_sum;g_sum+=g_in_sum;b_sum+=b_in_sum;stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;stackOut=stackOut.next;yi+=4}yw+=width}for(x=0;x<width;x++){g_in_sum=b_in_sum=r_in_sum=g_sum=b_sum=r_sum=0;yi=x<<2;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;stack=stackStart;for(i=0;i<radiusPlus1;i++){stack.r=pr;stack.g=pg;stack.b=pb;stack=stack.next}yp=width;for(i=1;i<=radius;i++){yi=yp+x<<2;r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[yi+1])*rbs;b_sum+=(stack.b=pb=pixels[yi+2])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;stack=stack.next;if(i<heightMinus1){yp+=width}}yi=x;stackIn=stackStart;stackOut=stackEnd;for(y=0;y<height;y++){p=yi<<2;pixels[p]=r_sum*mul_sum>>shg_sum;pixels[p+1]=g_sum*mul_sum>>shg_sum;pixels[p+2]=b_sum*mul_sum>>shg_sum;r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;p=x+((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width<<2;r_sum+=r_in_sum+=stackIn.r=pixels[p];g_sum+=g_in_sum+=stackIn.g=pixels[p+1];b_sum+=b_in_sum+=stackIn.b=pixels[p+2];stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;stackOut=stackOut.next;yi+=width}}context.putImageData(imageData,top_x,top_y)}function BlurStack(){this.r=0;this.g=0;this.b=0;this.a=0;this.next=null}(function(global,factory){"use strict";if(typeof define!=="undefined"&&define.amd){define("canvgModule",["rgbcolor","stackblur"],factory)}else if(typeof module!=="undefined"&&module.exports){module.exports=factory(require("rgbcolor"),require("stackblur"))}global.canvg=factory(global.RGBColor,global.stackBlur)})(typeof window!=="undefined"?window:this,function(RGBColor,stackBlur){var canvg=function(target,s,opts){if(target==null&&s==null&&opts==null){var svgTags=document.querySelectorAll("svg");for(var i=0;i<svgTags.length;i++){var svgTag=svgTags[i];var c=document.createElement("canvas");c.width=svgTag.clientWidth;c.height=svgTag.clientHeight;svgTag.parentNode.insertBefore(c,svgTag);svgTag.parentNode.removeChild(svgTag);var div=document.createElement("div");div.appendChild(svgTag);canvg(c,div.innerHTML)}return}if(typeof target=="string"){target=document.getElementById(target)}if(target.svg!=null)target.svg.stop();var svg=build(opts||{});if(!(target.childNodes.length==1&&target.childNodes[0].nodeName=="OBJECT"))target.svg=svg;var ctx=target.getContext("2d");if(typeof s.documentElement!="undefined"){svg.loadXmlDoc(ctx,s)}else if(s.substr(0,1)=="<"){svg.loadXml(ctx,s)}else{svg.load(ctx,s)}};var matchesSelector;if(typeof Element.prototype.matches!="undefined"){matchesSelector=function(node,selector){return node.matches(selector)}}else if(typeof Element.prototype.webkitMatchesSelector!="undefined"){matchesSelector=function(node,selector){return node.webkitMatchesSelector(selector)}}else if(typeof Element.prototype.mozMatchesSelector!="undefined"){matchesSelector=function(node,selector){return node.mozMatchesSelector(selector)}}else if(typeof Element.prototype.msMatchesSelector!="undefined"){matchesSelector=function(node,selector){return node.msMatchesSelector(selector)}}else if(typeof Element.prototype.oMatchesSelector!="undefined"){matchesSelector=function(node,selector){return node.oMatchesSelector(selector)}}else{if(typeof jQuery==="function"||typeof Zepto==="function"){matchesSelector=function(node,selector){return $(node).is(selector)}}if(typeof matchesSelector==="undefined"){matchesSelector=Sizzle.matchesSelector}}var attributeRegex=/(\[[^\]]+\])/g;var idRegex=/(#[^\s\+>~\.\[:]+)/g;var classRegex=/(\.[^\s\+>~\.\[:]+)/g;var pseudoElementRegex=/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi;var pseudoClassWithBracketsRegex=/(:[\w-]+\([^\)]*\))/gi;var pseudoClassRegex=/(:[^\s\+>~\.\[:]+)/g;var elementRegex=/([^\s\+>~\.\[:]+)/g;function getSelectorSpecificity(selector){var typeCount=[0,0,0];var findMatch=function(regex,type){var matches=selector.match(regex);if(matches==null){return}typeCount[type]+=matches.length;selector=selector.replace(regex," ")};selector=selector.replace(/:not\(([^\)]*)\)/g,"     $1 ");selector=selector.replace(/{[^]*/gm," ");findMatch(attributeRegex,1);findMatch(idRegex,0);findMatch(classRegex,1);findMatch(pseudoElementRegex,2);findMatch(pseudoClassWithBracketsRegex,1);findMatch(pseudoClassRegex,1);selector=selector.replace(/[\*\s\+>~]/g," ");selector=selector.replace(/[#\.]/g," ");findMatch(elementRegex,2);return typeCount.join("")}function build(opts){var svg={opts:opts};svg.FRAMERATE=30;svg.MAX_VIRTUAL_PIXELS=3e4;svg.log=function(msg){};if(svg.opts["log"]==true&&typeof console!="undefined"){svg.log=function(msg){console.log(msg)}}svg.init=function(ctx){var uniqueId=0;svg.UniqueId=function(){uniqueId++;return"canvg"+uniqueId};svg.Definitions={};svg.Styles={};svg.StylesSpecificity={};svg.Animations=[];svg.Images=[];svg.ctx=ctx;svg.ViewPort=new function(){this.viewPorts=[];this.Clear=function(){this.viewPorts=[]};this.SetCurrent=function(width,height){this.viewPorts.push({width:width,height:height})};this.RemoveCurrent=function(){this.viewPorts.pop()};this.Current=function(){return this.viewPorts[this.viewPorts.length-1]};this.width=function(){return this.Current().width};this.height=function(){return this.Current().height};this.ComputeSize=function(d){if(d!=null&&typeof d=="number")return d;if(d=="x")return this.width();if(d=="y")return this.height();return Math.sqrt(Math.pow(this.width(),2)+Math.pow(this.height(),2))/Math.sqrt(2)}}};svg.init();svg.ImagesLoaded=function(){for(var i=0;i<svg.Images.length;i++){if(!svg.Images[i].loaded)return false}return true};svg.trim=function(s){return s.replace(/^\s+|\s+$/g,"")};svg.compressSpaces=function(s){return s.replace(/[\s\r\t\n]+/gm," ")};svg.ajax=function(url){var AJAX;if(window.XMLHttpRequest){AJAX=new XMLHttpRequest}else{AJAX=new ActiveXObject("Microsoft.XMLHTTP")}if(AJAX){AJAX.open("GET",url,false);AJAX.send(null);return AJAX.responseText}return null};svg.parseXml=function(xml){if(typeof Windows!="undefined"&&typeof Windows.Data!="undefined"&&typeof Windows.Data.Xml!="undefined"){var xmlDoc=new Windows.Data.Xml.Dom.XmlDocument;var settings=new Windows.Data.Xml.Dom.XmlLoadSettings;settings.prohibitDtd=false;xmlDoc.loadXml(xml,settings);return xmlDoc}else if(window.DOMParser){var parser=new DOMParser;return parser.parseFromString(xml,"text/xml")}else{xml=xml.replace(/<!DOCTYPE svg[^>]*>/,"");var xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(xml);return xmlDoc}};svg.Property=function(name,value){this.name=name;this.value=value};svg.Property.prototype.getValue=function(){return this.value};svg.Property.prototype.hasValue=function(){return this.value!=null&&this.value!==""};svg.Property.prototype.numValue=function(){if(!this.hasValue())return 0;var n=parseFloat(this.value);if((this.value+"").match(/%$/)){n=n/100}return n};svg.Property.prototype.valueOrDefault=function(def){if(this.hasValue())return this.value;return def};svg.Property.prototype.numValueOrDefault=function(def){if(this.hasValue())return this.numValue();return def};svg.Property.prototype.addOpacity=function(opacityProp){var newValue=this.value;if(opacityProp.value!=null&&opacityProp.value!=""&&typeof this.value=="string"){var color=new RGBColor(this.value);if(color.ok){newValue="rgba("+color.r+", "+color.g+", "+color.b+", "+opacityProp.numValue()+")"}}return new svg.Property(this.name,newValue)};svg.Property.prototype.getDefinition=function(){var name=this.value.match(/#([^\)'"]+)/);if(name){name=name[1]}if(!name){name=this.value}return svg.Definitions[name]};svg.Property.prototype.isUrlDefinition=function(){return this.value.indexOf("url(")==0};svg.Property.prototype.getFillStyleDefinition=function(e,opacityProp){var def=this.getDefinition();if(def!=null&&def.createGradient){return def.createGradient(svg.ctx,e,opacityProp)}if(def!=null&&def.createPattern){if(def.getHrefAttribute().hasValue()){var pt=def.attribute("patternTransform");def=def.getHrefAttribute().getDefinition();if(pt.hasValue()){def.attribute("patternTransform",true).value=pt.value}}return def.createPattern(svg.ctx,e)}return null};svg.Property.prototype.getDPI=function(viewPort){return 96};svg.Property.prototype.getEM=function(viewPort){var em=12;var fontSize=new svg.Property("fontSize",svg.Font.Parse(svg.ctx.font).fontSize);if(fontSize.hasValue())em=fontSize.toPixels(viewPort);return em};svg.Property.prototype.getUnits=function(){var s=this.value+"";return s.replace(/[0-9\.\-]/g,"")};svg.Property.prototype.toPixels=function(viewPort,processPercent){if(!this.hasValue())return 0;var s=this.value+"";if(s.match(/em$/))return this.numValue()*this.getEM(viewPort);if(s.match(/ex$/))return this.numValue()*this.getEM(viewPort)/2;if(s.match(/px$/))return this.numValue();if(s.match(/pt$/))return this.numValue()*this.getDPI(viewPort)*(1/72);if(s.match(/pc$/))return this.numValue()*15;if(s.match(/cm$/))return this.numValue()*this.getDPI(viewPort)/2.54;if(s.match(/mm$/))return this.numValue()*this.getDPI(viewPort)/25.4;if(s.match(/in$/))return this.numValue()*this.getDPI(viewPort);if(s.match(/%$/))return this.numValue()*svg.ViewPort.ComputeSize(viewPort);var n=this.numValue();if(processPercent&&n<1)return n*svg.ViewPort.ComputeSize(viewPort);return n};svg.Property.prototype.toMilliseconds=function(){if(!this.hasValue())return 0;var s=this.value+"";if(s.match(/s$/))return this.numValue()*1e3;if(s.match(/ms$/))return this.numValue();return this.numValue()};svg.Property.prototype.toRadians=function(){if(!this.hasValue())return 0;var s=this.value+"";if(s.match(/deg$/))return this.numValue()*(Math.PI/180);if(s.match(/grad$/))return this.numValue()*(Math.PI/200);if(s.match(/rad$/))return this.numValue();return this.numValue()*(Math.PI/180)};var textBaselineMapping={baseline:"alphabetic","before-edge":"top","text-before-edge":"top",middle:"middle",central:"middle","after-edge":"bottom","text-after-edge":"bottom",ideographic:"ideographic",alphabetic:"alphabetic",hanging:"hanging",mathematical:"alphabetic"};svg.Property.prototype.toTextBaseline=function(){if(!this.hasValue())return null;return textBaselineMapping[this.value]};svg.Font=new function(){this.Styles="normal|italic|oblique|inherit";this.Variants="normal|small-caps|inherit";this.Weights="normal|bold|bolder|lighter|100|200|300|400|500|600|700|800|900|inherit";this.CreateFont=function(fontStyle,fontVariant,fontWeight,fontSize,fontFamily,inherit){var f=inherit!=null?this.Parse(inherit):this.CreateFont("","","","","",svg.ctx.font);return{fontFamily:fontFamily||f.fontFamily,fontSize:fontSize||f.fontSize,fontStyle:fontStyle||f.fontStyle,fontWeight:fontWeight||f.fontWeight,fontVariant:fontVariant||f.fontVariant,toString:function(){return[this.fontStyle,this.fontVariant,this.fontWeight,this.fontSize,this.fontFamily].join(" ")}}};var that=this;this.Parse=function(s){var f={};var d=svg.trim(svg.compressSpaces(s||"")).split(" ");var set={fontSize:false,fontStyle:false,fontWeight:false,fontVariant:false};var ff="";for(var i=0;i<d.length;i++){if(!set.fontStyle&&that.Styles.indexOf(d[i])!=-1){if(d[i]!="inherit")f.fontStyle=d[i];set.fontStyle=true}else if(!set.fontVariant&&that.Variants.indexOf(d[i])!=-1){if(d[i]!="inherit")f.fontVariant=d[i];set.fontStyle=set.fontVariant=true}else if(!set.fontWeight&&that.Weights.indexOf(d[i])!=-1){if(d[i]!="inherit")f.fontWeight=d[i];set.fontStyle=set.fontVariant=set.fontWeight=true}else if(!set.fontSize){if(d[i]!="inherit")f.fontSize=d[i].split("/")[0];set.fontStyle=set.fontVariant=set.fontWeight=set.fontSize=true}else{if(d[i]!="inherit")ff+=d[i]}}if(ff!="")f.fontFamily=ff;return f}};svg.ToNumberArray=function(s){var a=svg.trim(svg.compressSpaces((s||"").replace(/,/g," "))).split(" ");for(var i=0;i<a.length;i++){a[i]=parseFloat(a[i])}return a};svg.Point=function(x,y){this.x=x;this.y=y};svg.Point.prototype.angleTo=function(p){return Math.atan2(p.y-this.y,p.x-this.x)};svg.Point.prototype.applyTransform=function(v){var xp=this.x*v[0]+this.y*v[2]+v[4];var yp=this.x*v[1]+this.y*v[3]+v[5];this.x=xp;this.y=yp};svg.CreatePoint=function(s){var a=svg.ToNumberArray(s);return new svg.Point(a[0],a[1])};svg.CreatePath=function(s){var a=svg.ToNumberArray(s);var path=[];for(var i=0;i<a.length;i+=2){path.push(new svg.Point(a[i],a[i+1]))}return path};svg.BoundingBox=function(x1,y1,x2,y2){this.x1=Number.NaN;this.y1=Number.NaN;this.x2=Number.NaN;this.y2=Number.NaN;this.x=function(){return this.x1};this.y=function(){return this.y1};this.width=function(){return this.x2-this.x1};this.height=function(){return this.y2-this.y1};this.addPoint=function(x,y){if(x!=null){if(isNaN(this.x1)||isNaN(this.x2)){this.x1=x;this.x2=x}if(x<this.x1)this.x1=x;if(x>this.x2)this.x2=x}if(y!=null){if(isNaN(this.y1)||isNaN(this.y2)){this.y1=y;this.y2=y}if(y<this.y1)this.y1=y;if(y>this.y2)this.y2=y}};this.addX=function(x){this.addPoint(x,null)};this.addY=function(y){this.addPoint(null,y)};this.addBoundingBox=function(bb){this.addPoint(bb.x1,bb.y1);this.addPoint(bb.x2,bb.y2)};this.addQuadraticCurve=function(p0x,p0y,p1x,p1y,p2x,p2y){var cp1x=p0x+2/3*(p1x-p0x);var cp1y=p0y+2/3*(p1y-p0y);var cp2x=cp1x+1/3*(p2x-p0x);var cp2y=cp1y+1/3*(p2y-p0y);this.addBezierCurve(p0x,p0y,cp1x,cp2x,cp1y,cp2y,p2x,p2y)};this.addBezierCurve=function(p0x,p0y,p1x,p1y,p2x,p2y,p3x,p3y){var p0=[p0x,p0y],p1=[p1x,p1y],p2=[p2x,p2y],p3=[p3x,p3y];this.addPoint(p0[0],p0[1]);this.addPoint(p3[0],p3[1]);for(i=0;i<=1;i++){var f=function(t){return Math.pow(1-t,3)*p0[i]+3*Math.pow(1-t,2)*t*p1[i]+3*(1-t)*Math.pow(t,2)*p2[i]+Math.pow(t,3)*p3[i]};var b=6*p0[i]-12*p1[i]+6*p2[i];var a=-3*p0[i]+9*p1[i]-9*p2[i]+3*p3[i];var c=3*p1[i]-3*p0[i];if(a==0){if(b==0)continue;var t=-c/b;if(0<t&&t<1){if(i==0)this.addX(f(t));if(i==1)this.addY(f(t))}continue}var b2ac=Math.pow(b,2)-4*c*a;if(b2ac<0)continue;var t1=(-b+Math.sqrt(b2ac))/(2*a);if(0<t1&&t1<1){if(i==0)this.addX(f(t1));if(i==1)this.addY(f(t1))}var t2=(-b-Math.sqrt(b2ac))/(2*a);if(0<t2&&t2<1){if(i==0)this.addX(f(t2));if(i==1)this.addY(f(t2))}}};this.isPointInBox=function(x,y){return this.x1<=x&&x<=this.x2&&this.y1<=y&&y<=this.y2};this.addPoint(x1,y1);this.addPoint(x2,y2)};svg.Transform=function(v){var that=this;this.Type={};this.Type.translate=function(s){this.p=svg.CreatePoint(s);this.apply=function(ctx){ctx.translate(this.p.x||0,this.p.y||0)};this.unapply=function(ctx){ctx.translate(-1*this.p.x||0,-1*this.p.y||0)};this.applyToPoint=function(p){p.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0])}};this.Type.rotate=function(s){var a=svg.ToNumberArray(s);this.angle=new svg.Property("angle",a[0]);this.cx=a[1]||0;this.cy=a[2]||0;this.apply=function(ctx){ctx.translate(this.cx,this.cy);ctx.rotate(this.angle.toRadians());ctx.translate(-this.cx,-this.cy)};this.unapply=function(ctx){ctx.translate(this.cx,this.cy);ctx.rotate(-1*this.angle.toRadians());ctx.translate(-this.cx,-this.cy)};this.applyToPoint=function(p){var a=this.angle.toRadians();p.applyTransform([1,0,0,1,this.p.x||0,this.p.y||0]);p.applyTransform([Math.cos(a),Math.sin(a),-Math.sin(a),Math.cos(a),0,0]);p.applyTransform([1,0,0,1,-this.p.x||0,-this.p.y||0])}};this.Type.scale=function(s){this.p=svg.CreatePoint(s);this.apply=function(ctx){ctx.scale(this.p.x||1,this.p.y||this.p.x||1)};this.unapply=function(ctx){ctx.scale(1/this.p.x||1,1/this.p.y||this.p.x||1)};this.applyToPoint=function(p){p.applyTransform([this.p.x||0,0,0,this.p.y||0,0,0])}};this.Type.matrix=function(s){this.m=svg.ToNumberArray(s);this.apply=function(ctx){ctx.transform(this.m[0],this.m[1],this.m[2],this.m[3],this.m[4],this.m[5])};this.unapply=function(ctx){var a=this.m[0];var b=this.m[2];var c=this.m[4];var d=this.m[1];var e=this.m[3];var f=this.m[5];var g=0;var h=0;var i=1;var det=1/(a*(e*i-f*h)-b*(d*i-f*g)+c*(d*h-e*g));ctx.transform(det*(e*i-f*h),det*(f*g-d*i),det*(c*h-b*i),det*(a*i-c*g),det*(b*f-c*e),det*(c*d-a*f))};this.applyToPoint=function(p){p.applyTransform(this.m)}};this.Type.SkewBase=function(s){this.base=that.Type.matrix;this.base(s);this.angle=new svg.Property("angle",s)};this.Type.SkewBase.prototype=new this.Type.matrix;this.Type.skewX=function(s){this.base=that.Type.SkewBase;this.base(s);this.m=[1,0,Math.tan(this.angle.toRadians()),1,0,0]};this.Type.skewX.prototype=new this.Type.SkewBase;this.Type.skewY=function(s){this.base=that.Type.SkewBase;this.base(s);this.m=[1,Math.tan(this.angle.toRadians()),0,1,0,0]};this.Type.skewY.prototype=new this.Type.SkewBase;this.transforms=[];this.apply=function(ctx){for(var i=0;i<this.transforms.length;i++){this.transforms[i].apply(ctx)}};this.unapply=function(ctx){for(var i=this.transforms.length-1;i>=0;i--){this.transforms[i].unapply(ctx)}};this.applyToPoint=function(p){for(var i=0;i<this.transforms.length;i++){this.transforms[i].applyToPoint(p)}};var data=svg.trim(svg.compressSpaces(v)).replace(/\)([a-zA-Z])/g,") $1").replace(/\)(\s?,\s?)/g,") ").split(/\s(?=[a-z])/);for(var i=0;i<data.length;i++){var type=svg.trim(data[i].split("(")[0]);var s=data[i].split("(")[1].replace(")","");var transform=new this.Type[type](s);transform.type=type;this.transforms.push(transform)}};svg.AspectRatio=function(ctx,aspectRatio,width,desiredWidth,height,desiredHeight,minX,minY,refX,refY){aspectRatio=svg.compressSpaces(aspectRatio);aspectRatio=aspectRatio.replace(/^defer\s/,"");var align=aspectRatio.split(" ")[0]||"xMidYMid";var meetOrSlice=aspectRatio.split(" ")[1]||"meet";var scaleX=width/desiredWidth;var scaleY=height/desiredHeight;var scaleMin=Math.min(scaleX,scaleY);var scaleMax=Math.max(scaleX,scaleY);if(meetOrSlice=="meet"){desiredWidth*=scaleMin;desiredHeight*=scaleMin}if(meetOrSlice=="slice"){desiredWidth*=scaleMax;desiredHeight*=scaleMax}refX=new svg.Property("refX",refX);refY=new svg.Property("refY",refY);if(refX.hasValue()&&refY.hasValue()){ctx.translate(-scaleMin*refX.toPixels("x"),-scaleMin*refY.toPixels("y"))}else{if(align.match(/^xMid/)&&(meetOrSlice=="meet"&&scaleMin==scaleY||meetOrSlice=="slice"&&scaleMax==scaleY))ctx.translate(width/2-desiredWidth/2,0);if(align.match(/YMid$/)&&(meetOrSlice=="meet"&&scaleMin==scaleX||meetOrSlice=="slice"&&scaleMax==scaleX))ctx.translate(0,height/2-desiredHeight/2);if(align.match(/^xMax/)&&(meetOrSlice=="meet"&&scaleMin==scaleY||meetOrSlice=="slice"&&scaleMax==scaleY))ctx.translate(width-desiredWidth,0);if(align.match(/YMax$/)&&(meetOrSlice=="meet"&&scaleMin==scaleX||meetOrSlice=="slice"&&scaleMax==scaleX))ctx.translate(0,height-desiredHeight)}if(align=="none")ctx.scale(scaleX,scaleY);else if(meetOrSlice=="meet")ctx.scale(scaleMin,scaleMin);else if(meetOrSlice=="slice")ctx.scale(scaleMax,scaleMax);ctx.translate(minX==null?0:-minX,minY==null?0:-minY)};svg.Element={};svg.EmptyProperty=new svg.Property("EMPTY","");svg.Element.ElementBase=function(node){this.attributes={};this.styles={};this.stylesSpecificity={};this.children=[];this.attribute=function(name,createIfNotExists){var a=this.attributes[name];if(a!=null)return a;if(createIfNotExists==true){a=new svg.Property(name,"");this.attributes[name]=a}return a||svg.EmptyProperty};this.getHrefAttribute=function(){for(var a in this.attributes){if(a=="href"||a.match(/:href$/)){return this.attributes[a]}}return svg.EmptyProperty};this.style=function(name,createIfNotExists,skipAncestors){var s=this.styles[name];if(s!=null)return s;var a=this.attribute(name);if(a!=null&&a.hasValue()){this.styles[name]=a;return a}if(skipAncestors!=true){var p=this.parent;if(p!=null){var ps=p.style(name);if(ps!=null&&ps.hasValue()){return ps}}}if(createIfNotExists==true){s=new svg.Property(name,"");this.styles[name]=s}return s||svg.EmptyProperty};this.render=function(ctx){if(this.style("display").value=="none")return;if(this.style("visibility").value=="hidden")return;ctx.save();if(this.style("mask").hasValue()){var mask=this.style("mask").getDefinition();if(mask!=null)mask.apply(ctx,this)}else if(this.style("filter").hasValue()){var filter=this.style("filter").getDefinition();if(filter!=null)filter.apply(ctx,this)}else{this.setContext(ctx);this.renderChildren(ctx);this.clearContext(ctx)}ctx.restore()};this.setContext=function(ctx){};this.clearContext=function(ctx){};this.renderChildren=function(ctx){for(var i=0;i<this.children.length;i++){this.children[i].render(ctx)}};this.addChild=function(childNode,create){var child=childNode;if(create)child=svg.CreateElement(childNode);child.parent=this;if(child.type!="title"){this.children.push(child)}};this.addStylesFromStyleDefinition=function(){for(var selector in svg.Styles){if(selector[0]!="@"&&matchesSelector(node,selector)){
var styles=svg.Styles[selector];var specificity=svg.StylesSpecificity[selector];if(styles!=null){for(var name in styles){var existingSpecificity=this.stylesSpecificity[name];if(typeof existingSpecificity=="undefined"){existingSpecificity="000"}if(specificity>existingSpecificity){this.styles[name]=styles[name];this.stylesSpecificity[name]=specificity}}}}}};if(node!=null&&node.nodeType==1){for(var i=0;i<node.attributes.length;i++){var attribute=node.attributes[i];this.attributes[attribute.nodeName]=new svg.Property(attribute.nodeName,attribute.value)}this.addStylesFromStyleDefinition();if(this.attribute("style").hasValue()){var styles=this.attribute("style").value.split(";");for(var i=0;i<styles.length;i++){if(svg.trim(styles[i])!=""){var style=styles[i].split(":");var name=svg.trim(style[0]);var value=svg.trim(style[1]);this.styles[name]=new svg.Property(name,value)}}}if(this.attribute("id").hasValue()){if(svg.Definitions[this.attribute("id").value]==null){svg.Definitions[this.attribute("id").value]=this}}for(var i=0;i<node.childNodes.length;i++){var childNode=node.childNodes[i];if(childNode.nodeType==1)this.addChild(childNode,true);if(this.captureTextNodes&&(childNode.nodeType==3||childNode.nodeType==4)){var text=childNode.value||childNode.text||childNode.textContent||"";if(svg.compressSpaces(text)!=""){this.addChild(new svg.Element.tspan(childNode),false)}}}}};svg.Element.RenderedElementBase=function(node){this.base=svg.Element.ElementBase;this.base(node);this.setContext=function(ctx){if(this.style("fill").isUrlDefinition()){var fs=this.style("fill").getFillStyleDefinition(this,this.style("fill-opacity"));if(fs!=null)ctx.fillStyle=fs}else if(this.style("fill").hasValue()){var fillStyle=this.style("fill");if(fillStyle.value=="currentColor")fillStyle.value=this.style("color").value;if(fillStyle.value!="inherit")ctx.fillStyle=fillStyle.value=="none"?"rgba(0,0,0,0)":fillStyle.value}if(this.style("fill-opacity").hasValue()){var fillStyle=new svg.Property("fill",ctx.fillStyle);fillStyle=fillStyle.addOpacity(this.style("fill-opacity"));ctx.fillStyle=fillStyle.value}if(this.style("stroke").isUrlDefinition()){var fs=this.style("stroke").getFillStyleDefinition(this,this.style("stroke-opacity"));if(fs!=null)ctx.strokeStyle=fs}else if(this.style("stroke").hasValue()){var strokeStyle=this.style("stroke");if(strokeStyle.value=="currentColor")strokeStyle.value=this.style("color").value;if(strokeStyle.value!="inherit")ctx.strokeStyle=strokeStyle.value=="none"?"rgba(0,0,0,0)":strokeStyle.value}if(this.style("stroke-opacity").hasValue()){var strokeStyle=new svg.Property("stroke",ctx.strokeStyle);strokeStyle=strokeStyle.addOpacity(this.style("stroke-opacity"));ctx.strokeStyle=strokeStyle.value}if(this.style("stroke-width").hasValue()){var newLineWidth=this.style("stroke-width").toPixels();ctx.lineWidth=newLineWidth==0?.001:newLineWidth}if(this.style("stroke-linecap").hasValue())ctx.lineCap=this.style("stroke-linecap").value;if(this.style("stroke-linejoin").hasValue())ctx.lineJoin=this.style("stroke-linejoin").value;if(this.style("stroke-miterlimit").hasValue())ctx.miterLimit=this.style("stroke-miterlimit").value;if(this.style("stroke-dasharray").hasValue()&&this.style("stroke-dasharray").value!="none"){var gaps=svg.ToNumberArray(this.style("stroke-dasharray").value);if(typeof ctx.setLineDash!="undefined"){ctx.setLineDash(gaps)}else if(typeof ctx.webkitLineDash!="undefined"){ctx.webkitLineDash=gaps}else if(typeof ctx.mozDash!="undefined"&&!(gaps.length==1&&gaps[0]==0)){ctx.mozDash=gaps}var offset=this.style("stroke-dashoffset").numValueOrDefault(1);if(typeof ctx.lineDashOffset!="undefined"){ctx.lineDashOffset=offset}else if(typeof ctx.webkitLineDashOffset!="undefined"){ctx.webkitLineDashOffset=offset}else if(typeof ctx.mozDashOffset!="undefined"){ctx.mozDashOffset=offset}}if(typeof ctx.font!="undefined"){ctx.font=svg.Font.CreateFont(this.style("font-style").value,this.style("font-variant").value,this.style("font-weight").value,this.style("font-size").hasValue()?this.style("font-size").toPixels()+"px":"",this.style("font-family").value).toString()}if(this.style("transform",false,true).hasValue()){var transform=new svg.Transform(this.style("transform",false,true).value);transform.apply(ctx)}if(this.style("clip-path",false,true).hasValue()){var clip=this.style("clip-path",false,true).getDefinition();if(clip!=null)clip.apply(ctx)}if(this.style("opacity").hasValue()){ctx.globalAlpha=this.style("opacity").numValue()}}};svg.Element.RenderedElementBase.prototype=new svg.Element.ElementBase;svg.Element.PathElementBase=function(node){this.base=svg.Element.RenderedElementBase;this.base(node);this.path=function(ctx){if(ctx!=null)ctx.beginPath();return new svg.BoundingBox};this.renderChildren=function(ctx){this.path(ctx);svg.Mouse.checkPath(this,ctx);if(ctx.fillStyle!=""){if(this.style("fill-rule").valueOrDefault("inherit")!="inherit"){ctx.fill(this.style("fill-rule").value)}else{ctx.fill()}}if(ctx.strokeStyle!="")ctx.stroke();var markers=this.getMarkers();if(markers!=null){if(this.style("marker-start").isUrlDefinition()){var marker=this.style("marker-start").getDefinition();marker.render(ctx,markers[0][0],markers[0][1])}if(this.style("marker-mid").isUrlDefinition()){var marker=this.style("marker-mid").getDefinition();for(var i=1;i<markers.length-1;i++){marker.render(ctx,markers[i][0],markers[i][1])}}if(this.style("marker-end").isUrlDefinition()){var marker=this.style("marker-end").getDefinition();marker.render(ctx,markers[markers.length-1][0],markers[markers.length-1][1])}}};this.getBoundingBox=function(){return this.path()};this.getMarkers=function(){return null}};svg.Element.PathElementBase.prototype=new svg.Element.RenderedElementBase;svg.Element.svg=function(node){this.base=svg.Element.RenderedElementBase;this.base(node);this.baseClearContext=this.clearContext;this.clearContext=function(ctx){this.baseClearContext(ctx);svg.ViewPort.RemoveCurrent()};this.baseSetContext=this.setContext;this.setContext=function(ctx){ctx.strokeStyle="rgba(0,0,0,0)";ctx.lineCap="butt";ctx.lineJoin="miter";ctx.miterLimit=4;if(typeof ctx.font!="undefined"&&typeof window.getComputedStyle!="undefined"){ctx.font=window.getComputedStyle(ctx.canvas).getPropertyValue("font")}this.baseSetContext(ctx);if(!this.attribute("x").hasValue())this.attribute("x",true).value=0;if(!this.attribute("y").hasValue())this.attribute("y",true).value=0;ctx.translate(this.attribute("x").toPixels("x"),this.attribute("y").toPixels("y"));var width=svg.ViewPort.width();var height=svg.ViewPort.height();if(!this.attribute("width").hasValue())this.attribute("width",true).value="100%";if(!this.attribute("height").hasValue())this.attribute("height",true).value="100%";if(typeof this.root=="undefined"){width=this.attribute("width").toPixels("x");height=this.attribute("height").toPixels("y");var x=0;var y=0;if(this.attribute("refX").hasValue()&&this.attribute("refY").hasValue()){x=-this.attribute("refX").toPixels("x");y=-this.attribute("refY").toPixels("y")}if(this.attribute("overflow").valueOrDefault("hidden")!="visible"){ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(width,y);ctx.lineTo(width,height);ctx.lineTo(x,height);ctx.closePath();ctx.clip()}}svg.ViewPort.SetCurrent(width,height);if(this.attribute("viewBox").hasValue()){var viewBox=svg.ToNumberArray(this.attribute("viewBox").value);var minX=viewBox[0];var minY=viewBox[1];width=viewBox[2];height=viewBox[3];svg.AspectRatio(ctx,this.attribute("preserveAspectRatio").value,svg.ViewPort.width(),width,svg.ViewPort.height(),height,minX,minY,this.attribute("refX").value,this.attribute("refY").value);svg.ViewPort.RemoveCurrent();svg.ViewPort.SetCurrent(viewBox[2],viewBox[3])}}};svg.Element.svg.prototype=new svg.Element.RenderedElementBase;svg.Element.rect=function(node){this.base=svg.Element.PathElementBase;this.base(node);this.path=function(ctx){var x=this.attribute("x").toPixels("x");var y=this.attribute("y").toPixels("y");var width=this.attribute("width").toPixels("x");var height=this.attribute("height").toPixels("y");var rx=this.attribute("rx").toPixels("x");var ry=this.attribute("ry").toPixels("y");if(this.attribute("rx").hasValue()&&!this.attribute("ry").hasValue())ry=rx;if(this.attribute("ry").hasValue()&&!this.attribute("rx").hasValue())rx=ry;rx=Math.min(rx,width/2);ry=Math.min(ry,height/2);if(ctx!=null){ctx.beginPath();ctx.moveTo(x+rx,y);ctx.lineTo(x+width-rx,y);ctx.quadraticCurveTo(x+width,y,x+width,y+ry);ctx.lineTo(x+width,y+height-ry);ctx.quadraticCurveTo(x+width,y+height,x+width-rx,y+height);ctx.lineTo(x+rx,y+height);ctx.quadraticCurveTo(x,y+height,x,y+height-ry);ctx.lineTo(x,y+ry);ctx.quadraticCurveTo(x,y,x+rx,y);ctx.closePath()}return new svg.BoundingBox(x,y,x+width,y+height)}};svg.Element.rect.prototype=new svg.Element.PathElementBase;svg.Element.circle=function(node){this.base=svg.Element.PathElementBase;this.base(node);this.path=function(ctx){var cx=this.attribute("cx").toPixels("x");var cy=this.attribute("cy").toPixels("y");var r=this.attribute("r").toPixels();if(ctx!=null){ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2,true);ctx.closePath()}return new svg.BoundingBox(cx-r,cy-r,cx+r,cy+r)}};svg.Element.circle.prototype=new svg.Element.PathElementBase;svg.Element.ellipse=function(node){this.base=svg.Element.PathElementBase;this.base(node);this.path=function(ctx){var KAPPA=4*((Math.sqrt(2)-1)/3);var rx=this.attribute("rx").toPixels("x");var ry=this.attribute("ry").toPixels("y");var cx=this.attribute("cx").toPixels("x");var cy=this.attribute("cy").toPixels("y");if(ctx!=null){ctx.beginPath();ctx.moveTo(cx,cy-ry);ctx.bezierCurveTo(cx+KAPPA*rx,cy-ry,cx+rx,cy-KAPPA*ry,cx+rx,cy);ctx.bezierCurveTo(cx+rx,cy+KAPPA*ry,cx+KAPPA*rx,cy+ry,cx,cy+ry);ctx.bezierCurveTo(cx-KAPPA*rx,cy+ry,cx-rx,cy+KAPPA*ry,cx-rx,cy);ctx.bezierCurveTo(cx-rx,cy-KAPPA*ry,cx-KAPPA*rx,cy-ry,cx,cy-ry);ctx.closePath()}return new svg.BoundingBox(cx-rx,cy-ry,cx+rx,cy+ry)}};svg.Element.ellipse.prototype=new svg.Element.PathElementBase;svg.Element.line=function(node){this.base=svg.Element.PathElementBase;this.base(node);this.getPoints=function(){return[new svg.Point(this.attribute("x1").toPixels("x"),this.attribute("y1").toPixels("y")),new svg.Point(this.attribute("x2").toPixels("x"),this.attribute("y2").toPixels("y"))]};this.path=function(ctx){var points=this.getPoints();if(ctx!=null){ctx.beginPath();ctx.moveTo(points[0].x,points[0].y);ctx.lineTo(points[1].x,points[1].y)}return new svg.BoundingBox(points[0].x,points[0].y,points[1].x,points[1].y)};this.getMarkers=function(){var points=this.getPoints();var a=points[0].angleTo(points[1]);return[[points[0],a],[points[1],a]]}};svg.Element.line.prototype=new svg.Element.PathElementBase;svg.Element.polyline=function(node){this.base=svg.Element.PathElementBase;this.base(node);this.points=svg.CreatePath(this.attribute("points").value);this.path=function(ctx){var bb=new svg.BoundingBox(this.points[0].x,this.points[0].y);if(ctx!=null){ctx.beginPath();ctx.moveTo(this.points[0].x,this.points[0].y)}for(var i=1;i<this.points.length;i++){bb.addPoint(this.points[i].x,this.points[i].y);if(ctx!=null)ctx.lineTo(this.points[i].x,this.points[i].y)}return bb};this.getMarkers=function(){var markers=[];for(var i=0;i<this.points.length-1;i++){markers.push([this.points[i],this.points[i].angleTo(this.points[i+1])])}markers.push([this.points[this.points.length-1],markers[markers.length-1][1]]);return markers}};svg.Element.polyline.prototype=new svg.Element.PathElementBase;svg.Element.polygon=function(node){this.base=svg.Element.polyline;this.base(node);this.basePath=this.path;this.path=function(ctx){var bb=this.basePath(ctx);if(ctx!=null){ctx.lineTo(this.points[0].x,this.points[0].y);ctx.closePath()}return bb}};svg.Element.polygon.prototype=new svg.Element.polyline;svg.Element.path=function(node){this.base=svg.Element.PathElementBase;this.base(node);var d=this.attribute("d").value;d=d.replace(/,/gm," ");for(var i=0;i<2;i++)d=d.replace(/([MmZzLlHhVvCcSsQqTtAa])([^\s])/gm,"$1 $2");d=d.replace(/([^\s])([MmZzLlHhVvCcSsQqTtAa])/gm,"$1 $2");d=d.replace(/([0-9])([+\-])/gm,"$1 $2");for(var i=0;i<2;i++)d=d.replace(/(\.[0-9]*)(\.)/gm,"$1 $2");d=d.replace(/([Aa](\s+[0-9]+){3})\s+([01])\s*([01])/gm,"$1 $3 $4 ");d=svg.compressSpaces(d);d=svg.trim(d);this.PathParser=new function(d){this.tokens=d.split(" ");this.reset=function(){this.i=-1;this.command="";this.previousCommand="";this.start=new svg.Point(0,0);this.control=new svg.Point(0,0);this.current=new svg.Point(0,0);this.points=[];this.angles=[]};this.isEnd=function(){return this.i>=this.tokens.length-1};this.isCommandOrEnd=function(){if(this.isEnd())return true;return this.tokens[this.i+1].match(/^[A-Za-z]$/)!=null};this.isRelativeCommand=function(){switch(this.command){case"m":case"l":case"h":case"v":case"c":case"s":case"q":case"t":case"a":case"z":return true;break}return false};this.getToken=function(){this.i++;return this.tokens[this.i]};this.getScalar=function(){return parseFloat(this.getToken())};this.nextCommand=function(){this.previousCommand=this.command;this.command=this.getToken()};this.getPoint=function(){var p=new svg.Point(this.getScalar(),this.getScalar());return this.makeAbsolute(p)};this.getAsControlPoint=function(){var p=this.getPoint();this.control=p;return p};this.getAsCurrentPoint=function(){var p=this.getPoint();this.current=p;return p};this.getReflectedControlPoint=function(){if(this.previousCommand.toLowerCase()!="c"&&this.previousCommand.toLowerCase()!="s"&&this.previousCommand.toLowerCase()!="q"&&this.previousCommand.toLowerCase()!="t"){return this.current}var p=new svg.Point(2*this.current.x-this.control.x,2*this.current.y-this.control.y);return p};this.makeAbsolute=function(p){if(this.isRelativeCommand()){p.x+=this.current.x;p.y+=this.current.y}return p};this.addMarker=function(p,from,priorTo){if(priorTo!=null&&this.angles.length>0&&this.angles[this.angles.length-1]==null){this.angles[this.angles.length-1]=this.points[this.points.length-1].angleTo(priorTo)}this.addMarkerAngle(p,from==null?null:from.angleTo(p))};this.addMarkerAngle=function(p,a){this.points.push(p);this.angles.push(a)};this.getMarkerPoints=function(){return this.points};this.getMarkerAngles=function(){for(var i=0;i<this.angles.length;i++){if(this.angles[i]==null){for(var j=i+1;j<this.angles.length;j++){if(this.angles[j]!=null){this.angles[i]=this.angles[j];break}}}}return this.angles}}(d);this.path=function(ctx){var pp=this.PathParser;pp.reset();var bb=new svg.BoundingBox;if(ctx!=null)ctx.beginPath();while(!pp.isEnd()){pp.nextCommand();switch(pp.command){case"M":case"m":var p=pp.getAsCurrentPoint();pp.addMarker(p);bb.addPoint(p.x,p.y);if(ctx!=null)ctx.moveTo(p.x,p.y);pp.start=pp.current;while(!pp.isCommandOrEnd()){var p=pp.getAsCurrentPoint();pp.addMarker(p,pp.start);bb.addPoint(p.x,p.y);if(ctx!=null)ctx.lineTo(p.x,p.y)}break;case"L":case"l":while(!pp.isCommandOrEnd()){var c=pp.current;var p=pp.getAsCurrentPoint();pp.addMarker(p,c);bb.addPoint(p.x,p.y);if(ctx!=null)ctx.lineTo(p.x,p.y)}break;case"H":case"h":while(!pp.isCommandOrEnd()){var newP=new svg.Point((pp.isRelativeCommand()?pp.current.x:0)+pp.getScalar(),pp.current.y);pp.addMarker(newP,pp.current);pp.current=newP;bb.addPoint(pp.current.x,pp.current.y);if(ctx!=null)ctx.lineTo(pp.current.x,pp.current.y)}break;case"V":case"v":while(!pp.isCommandOrEnd()){var newP=new svg.Point(pp.current.x,(pp.isRelativeCommand()?pp.current.y:0)+pp.getScalar());pp.addMarker(newP,pp.current);pp.current=newP;bb.addPoint(pp.current.x,pp.current.y);if(ctx!=null)ctx.lineTo(pp.current.x,pp.current.y)}break;case"C":case"c":while(!pp.isCommandOrEnd()){var curr=pp.current;var p1=pp.getPoint();var cntrl=pp.getAsControlPoint();var cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,p1);bb.addBezierCurve(curr.x,curr.y,p1.x,p1.y,cntrl.x,cntrl.y,cp.x,cp.y);if(ctx!=null)ctx.bezierCurveTo(p1.x,p1.y,cntrl.x,cntrl.y,cp.x,cp.y)}break;case"S":case"s":while(!pp.isCommandOrEnd()){var curr=pp.current;var p1=pp.getReflectedControlPoint();var cntrl=pp.getAsControlPoint();var cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,p1);bb.addBezierCurve(curr.x,curr.y,p1.x,p1.y,cntrl.x,cntrl.y,cp.x,cp.y);if(ctx!=null)ctx.bezierCurveTo(p1.x,p1.y,cntrl.x,cntrl.y,cp.x,cp.y)}break;case"Q":case"q":while(!pp.isCommandOrEnd()){var curr=pp.current;var cntrl=pp.getAsControlPoint();var cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,cntrl);bb.addQuadraticCurve(curr.x,curr.y,cntrl.x,cntrl.y,cp.x,cp.y);if(ctx!=null)ctx.quadraticCurveTo(cntrl.x,cntrl.y,cp.x,cp.y)}break;case"T":case"t":while(!pp.isCommandOrEnd()){var curr=pp.current;var cntrl=pp.getReflectedControlPoint();pp.control=cntrl;var cp=pp.getAsCurrentPoint();pp.addMarker(cp,cntrl,cntrl);bb.addQuadraticCurve(curr.x,curr.y,cntrl.x,cntrl.y,cp.x,cp.y);if(ctx!=null)ctx.quadraticCurveTo(cntrl.x,cntrl.y,cp.x,cp.y)}break;case"A":case"a":while(!pp.isCommandOrEnd()){var curr=pp.current;var rx=pp.getScalar();var ry=pp.getScalar();var xAxisRotation=pp.getScalar()*(Math.PI/180);var largeArcFlag=pp.getScalar();var sweepFlag=pp.getScalar();var cp=pp.getAsCurrentPoint();var currp=new svg.Point(Math.cos(xAxisRotation)*(curr.x-cp.x)/2+Math.sin(xAxisRotation)*(curr.y-cp.y)/2,-Math.sin(xAxisRotation)*(curr.x-cp.x)/2+Math.cos(xAxisRotation)*(curr.y-cp.y)/2);var l=Math.pow(currp.x,2)/Math.pow(rx,2)+Math.pow(currp.y,2)/Math.pow(ry,2);if(l>1){rx*=Math.sqrt(l);ry*=Math.sqrt(l)}var s=(largeArcFlag==sweepFlag?-1:1)*Math.sqrt((Math.pow(rx,2)*Math.pow(ry,2)-Math.pow(rx,2)*Math.pow(currp.y,2)-Math.pow(ry,2)*Math.pow(currp.x,2))/(Math.pow(rx,2)*Math.pow(currp.y,2)+Math.pow(ry,2)*Math.pow(currp.x,2)));if(isNaN(s))s=0;var cpp=new svg.Point(s*rx*currp.y/ry,s*-ry*currp.x/rx);var centp=new svg.Point((curr.x+cp.x)/2+Math.cos(xAxisRotation)*cpp.x-Math.sin(xAxisRotation)*cpp.y,(curr.y+cp.y)/2+Math.sin(xAxisRotation)*cpp.x+Math.cos(xAxisRotation)*cpp.y);var m=function(v){return Math.sqrt(Math.pow(v[0],2)+Math.pow(v[1],2))};var r=function(u,v){return(u[0]*v[0]+u[1]*v[1])/(m(u)*m(v))};var a=function(u,v){return(u[0]*v[1]<u[1]*v[0]?-1:1)*Math.acos(r(u,v))};var a1=a([1,0],[(currp.x-cpp.x)/rx,(currp.y-cpp.y)/ry]);var u=[(currp.x-cpp.x)/rx,(currp.y-cpp.y)/ry];var v=[(-currp.x-cpp.x)/rx,(-currp.y-cpp.y)/ry];var ad=a(u,v);if(r(u,v)<=-1)ad=Math.PI;if(r(u,v)>=1)ad=0;var dir=1-sweepFlag?1:-1;var ah=a1+dir*(ad/2);var halfWay=new svg.Point(centp.x+rx*Math.cos(ah),centp.y+ry*Math.sin(ah));pp.addMarkerAngle(halfWay,ah-dir*Math.PI/2);pp.addMarkerAngle(cp,ah-dir*Math.PI);bb.addPoint(cp.x,cp.y);if(ctx!=null){var r=rx>ry?rx:ry;var sx=rx>ry?1:rx/ry;var sy=rx>ry?ry/rx:1;ctx.translate(centp.x,centp.y);ctx.rotate(xAxisRotation);ctx.scale(sx,sy);ctx.arc(0,0,r,a1,a1+ad,1-sweepFlag);ctx.scale(1/sx,1/sy);ctx.rotate(-xAxisRotation);ctx.translate(-centp.x,-centp.y)}}break;case"Z":case"z":if(ctx!=null)ctx.closePath();pp.current=pp.start}}return bb};this.getMarkers=function(){var points=this.PathParser.getMarkerPoints();var angles=this.PathParser.getMarkerAngles();var markers=[];for(var i=0;i<points.length;i++){markers.push([points[i],angles[i]])}return markers}};svg.Element.path.prototype=new svg.Element.PathElementBase;svg.Element.pattern=function(node){this.base=svg.Element.ElementBase;this.base(node);this.createPattern=function(ctx,element){var width=this.attribute("width").toPixels("x",true);var height=this.attribute("height").toPixels("y",true);var tempSvg=new svg.Element.svg;tempSvg.attributes["viewBox"]=new svg.Property("viewBox",this.attribute("viewBox").value);tempSvg.attributes["width"]=new svg.Property("width",width+"px");tempSvg.attributes["height"]=new svg.Property("height",height+"px");tempSvg.attributes["transform"]=new svg.Property("transform",this.attribute("patternTransform").value);tempSvg.children=this.children;var c=document.createElement("canvas");c.width=width;c.height=height;var cctx=c.getContext("2d");if(this.attribute("x").hasValue()&&this.attribute("y").hasValue()){cctx.translate(this.attribute("x").toPixels("x",true),this.attribute("y").toPixels("y",true))}for(var x=-1;x<=1;x++){for(var y=-1;y<=1;y++){cctx.save();tempSvg.attributes["x"]=new svg.Property("x",x*c.width);tempSvg.attributes["y"]=new svg.Property("y",y*c.height);tempSvg.render(cctx);cctx.restore()}}var pattern=ctx.createPattern(c,"repeat");return pattern}};svg.Element.pattern.prototype=new svg.Element.ElementBase;svg.Element.marker=function(node){this.base=svg.Element.ElementBase;this.base(node);this.baseRender=this.render;this.render=function(ctx,point,angle){ctx.translate(point.x,point.y);if(this.attribute("orient").valueOrDefault("auto")=="auto")ctx.rotate(angle);if(this.attribute("markerUnits").valueOrDefault("strokeWidth")=="strokeWidth")ctx.scale(ctx.lineWidth,ctx.lineWidth);ctx.save();var tempSvg=new svg.Element.svg;tempSvg.attributes["viewBox"]=new svg.Property("viewBox",this.attribute("viewBox").value);tempSvg.attributes["refX"]=new svg.Property("refX",this.attribute("refX").value);tempSvg.attributes["refY"]=new svg.Property("refY",this.attribute("refY").value);tempSvg.attributes["width"]=new svg.Property("width",this.attribute("markerWidth").value);tempSvg.attributes["height"]=new svg.Property("height",this.attribute("markerHeight").value);tempSvg.attributes["fill"]=new svg.Property("fill",this.attribute("fill").valueOrDefault("black"));tempSvg.attributes["stroke"]=new svg.Property("stroke",this.attribute("stroke").valueOrDefault("none"));tempSvg.children=this.children;tempSvg.render(ctx);ctx.restore();if(this.attribute("markerUnits").valueOrDefault("strokeWidth")=="strokeWidth")ctx.scale(1/ctx.lineWidth,1/ctx.lineWidth);if(this.attribute("orient").valueOrDefault("auto")=="auto")ctx.rotate(-angle);ctx.translate(-point.x,-point.y)}};svg.Element.marker.prototype=new svg.Element.ElementBase;svg.Element.defs=function(node){this.base=svg.Element.ElementBase;this.base(node);this.render=function(ctx){}};svg.Element.defs.prototype=new svg.Element.ElementBase;svg.Element.GradientBase=function(node){this.base=svg.Element.ElementBase;this.base(node);this.stops=[];for(var i=0;i<this.children.length;i++){var child=this.children[i];if(child.type=="stop")this.stops.push(child)}this.getGradient=function(){};this.gradientUnits=function(){return this.attribute("gradientUnits").valueOrDefault("objectBoundingBox")};this.attributesToInherit=["gradientUnits"];this.inheritStopContainer=function(stopsContainer){for(var i=0;i<this.attributesToInherit.length;i++){var attributeToInherit=this.attributesToInherit[i];if(!this.attribute(attributeToInherit).hasValue()&&stopsContainer.attribute(attributeToInherit).hasValue()){this.attribute(attributeToInherit,true).value=stopsContainer.attribute(attributeToInherit).value}}};this.createGradient=function(ctx,element,parentOpacityProp){var stopsContainer=this;if(this.getHrefAttribute().hasValue()){stopsContainer=this.getHrefAttribute().getDefinition();this.inheritStopContainer(stopsContainer)}var addParentOpacity=function(color){if(parentOpacityProp.hasValue()){var p=new svg.Property("color",color);return p.addOpacity(parentOpacityProp).value}return color};var g=this.getGradient(ctx,element);if(g==null)return addParentOpacity(stopsContainer.stops[stopsContainer.stops.length-1].color);for(var i=0;i<stopsContainer.stops.length;i++){g.addColorStop(stopsContainer.stops[i].offset,addParentOpacity(stopsContainer.stops[i].color))}if(this.attribute("gradientTransform").hasValue()){var rootView=svg.ViewPort.viewPorts[0];var rect=new svg.Element.rect;rect.attributes["x"]=new svg.Property("x",-svg.MAX_VIRTUAL_PIXELS/3);rect.attributes["y"]=new svg.Property("y",-svg.MAX_VIRTUAL_PIXELS/3);rect.attributes["width"]=new svg.Property("width",svg.MAX_VIRTUAL_PIXELS);rect.attributes["height"]=new svg.Property("height",svg.MAX_VIRTUAL_PIXELS);var group=new svg.Element.g;group.attributes["transform"]=new svg.Property("transform",this.attribute("gradientTransform").value);group.children=[rect];var tempSvg=new svg.Element.svg;tempSvg.attributes["x"]=new svg.Property("x",0);tempSvg.attributes["y"]=new svg.Property("y",0);tempSvg.attributes["width"]=new svg.Property("width",rootView.width);tempSvg.attributes["height"]=new svg.Property("height",rootView.height);tempSvg.children=[group];var c=document.createElement("canvas");c.width=rootView.width;c.height=rootView.height;var tempCtx=c.getContext("2d");tempCtx.fillStyle=g;tempSvg.render(tempCtx);return tempCtx.createPattern(c,"no-repeat")}return g}};svg.Element.GradientBase.prototype=new svg.Element.ElementBase;svg.Element.linearGradient=function(node){this.base=svg.Element.GradientBase;this.base(node);this.attributesToInherit.push("x1");this.attributesToInherit.push("y1");this.attributesToInherit.push("x2");this.attributesToInherit.push("y2");this.getGradient=function(ctx,element){var bb=this.gradientUnits()=="objectBoundingBox"?element.getBoundingBox():null;if(!this.attribute("x1").hasValue()&&!this.attribute("y1").hasValue()&&!this.attribute("x2").hasValue()&&!this.attribute("y2").hasValue()){this.attribute("x1",true).value=0;this.attribute("y1",true).value=0;this.attribute("x2",true).value=1;this.attribute("y2",true).value=0}var x1=this.gradientUnits()=="objectBoundingBox"?bb.x()+bb.width()*this.attribute("x1").numValue():this.attribute("x1").toPixels("x");var y1=this.gradientUnits()=="objectBoundingBox"?bb.y()+bb.height()*this.attribute("y1").numValue():this.attribute("y1").toPixels("y");var x2=this.gradientUnits()=="objectBoundingBox"?bb.x()+bb.width()*this.attribute("x2").numValue():this.attribute("x2").toPixels("x");var y2=this.gradientUnits()=="objectBoundingBox"?bb.y()+bb.height()*this.attribute("y2").numValue():this.attribute("y2").toPixels("y");if(x1==x2&&y1==y2)return null;return ctx.createLinearGradient(x1,y1,x2,y2)}};svg.Element.linearGradient.prototype=new svg.Element.GradientBase;svg.Element.radialGradient=function(node){this.base=svg.Element.GradientBase;this.base(node);this.attributesToInherit.push("cx");this.attributesToInherit.push("cy");this.attributesToInherit.push("r");this.attributesToInherit.push("fx");this.attributesToInherit.push("fy");this.getGradient=function(ctx,element){var bb=element.getBoundingBox();if(!this.attribute("cx").hasValue())this.attribute("cx",true).value="50%";if(!this.attribute("cy").hasValue())this.attribute("cy",true).value="50%";if(!this.attribute("r").hasValue())this.attribute("r",true).value="50%";var cx=this.gradientUnits()=="objectBoundingBox"?bb.x()+bb.width()*this.attribute("cx").numValue():this.attribute("cx").toPixels("x");var cy=this.gradientUnits()=="objectBoundingBox"?bb.y()+bb.height()*this.attribute("cy").numValue():this.attribute("cy").toPixels("y");var fx=cx;var fy=cy;if(this.attribute("fx").hasValue()){fx=this.gradientUnits()=="objectBoundingBox"?bb.x()+bb.width()*this.attribute("fx").numValue():this.attribute("fx").toPixels("x")}if(this.attribute("fy").hasValue()){fy=this.gradientUnits()=="objectBoundingBox"?bb.y()+bb.height()*this.attribute("fy").numValue():this.attribute("fy").toPixels("y")}var r=this.gradientUnits()=="objectBoundingBox"?(bb.width()+bb.height())/2*this.attribute("r").numValue():this.attribute("r").toPixels();return ctx.createRadialGradient(fx,fy,0,cx,cy,r)}};svg.Element.radialGradient.prototype=new svg.Element.GradientBase;svg.Element.stop=function(node){this.base=svg.Element.ElementBase;this.base(node);this.offset=this.attribute("offset").numValue();if(this.offset<0)this.offset=0;if(this.offset>1)this.offset=1;var stopColor=this.style("stop-color",true);if(stopColor.value==="")stopColor.value="#000";if(this.style("stop-opacity").hasValue())stopColor=stopColor.addOpacity(this.style("stop-opacity"));this.color=stopColor.value};svg.Element.stop.prototype=new svg.Element.ElementBase;svg.Element.AnimateBase=function(node){this.base=svg.Element.ElementBase;this.base(node);svg.Animations.push(this);this.duration=0;this.begin=this.attribute("begin").toMilliseconds();this.maxDuration=this.begin+this.attribute("dur").toMilliseconds();this.getProperty=function(){var attributeType=this.attribute("attributeType").value;var attributeName=this.attribute("attributeName").value;if(attributeType=="CSS"){return this.parent.style(attributeName,true)}return this.parent.attribute(attributeName,true)};this.initialValue=null;this.initialUnits="";this.removed=false;this.calcValue=function(){return""};this.update=function(delta){if(this.initialValue==null){this.initialValue=this.getProperty().value;this.initialUnits=this.getProperty().getUnits()}if(this.duration>this.maxDuration){if(this.attribute("repeatCount").value=="indefinite"||this.attribute("repeatDur").value=="indefinite"){this.duration=0}else if(this.attribute("fill").valueOrDefault("remove")=="freeze"&&!this.frozen){this.frozen=true;this.parent.animationFrozen=true;this.parent.animationFrozenValue=this.getProperty().value}else if(this.attribute("fill").valueOrDefault("remove")=="remove"&&!this.removed){this.removed=true;this.getProperty().value=this.parent.animationFrozen?this.parent.animationFrozenValue:this.initialValue;return true}return false}this.duration=this.duration+delta;var updated=false;if(this.begin<this.duration){var newValue=this.calcValue();if(this.attribute("type").hasValue()){var type=this.attribute("type").value;newValue=type+"("+newValue+")"}this.getProperty().value=newValue;updated=true}return updated};this.from=this.attribute("from");this.to=this.attribute("to");this.values=this.attribute("values");if(this.values.hasValue())this.values.value=this.values.value.split(";");this.progress=function(){var ret={progress:(this.duration-this.begin)/(this.maxDuration-this.begin)};if(this.values.hasValue()){var p=ret.progress*(this.values.value.length-1);var lb=Math.floor(p),ub=Math.ceil(p);ret.from=new svg.Property("from",parseFloat(this.values.value[lb]));ret.to=new svg.Property("to",parseFloat(this.values.value[ub]));ret.progress=(p-lb)/(ub-lb)}else{ret.from=this.from;ret.to=this.to}return ret}};svg.Element.AnimateBase.prototype=new svg.Element.ElementBase;svg.Element.animate=function(node){this.base=svg.Element.AnimateBase;this.base(node);this.calcValue=function(){var p=this.progress();var newValue=p.from.numValue()+(p.to.numValue()-p.from.numValue())*p.progress;return newValue+this.initialUnits}};svg.Element.animate.prototype=new svg.Element.AnimateBase;svg.Element.animateColor=function(node){this.base=svg.Element.AnimateBase;this.base(node);this.calcValue=function(){var p=this.progress();var from=new RGBColor(p.from.value);var to=new RGBColor(p.to.value);if(from.ok&&to.ok){var r=from.r+(to.r-from.r)*p.progress;var g=from.g+(to.g-from.g)*p.progress;var b=from.b+(to.b-from.b)*p.progress;return"rgb("+parseInt(r,10)+","+parseInt(g,10)+","+parseInt(b,10)+")"}return this.attribute("from").value}};svg.Element.animateColor.prototype=new svg.Element.AnimateBase;svg.Element.animateTransform=function(node){this.base=svg.Element.AnimateBase;this.base(node);this.calcValue=function(){var p=this.progress();var from=svg.ToNumberArray(p.from.value);var to=svg.ToNumberArray(p.to.value);var newValue="";for(var i=0;i<from.length;i++){newValue+=from[i]+(to[i]-from[i])*p.progress+" "}return newValue}};svg.Element.animateTransform.prototype=new svg.Element.animate;svg.Element.font=function(node){this.base=svg.Element.ElementBase;this.base(node);this.horizAdvX=this.attribute("horiz-adv-x").numValue();this.isRTL=false;this.isArabic=false;this.fontFace=null;this.missingGlyph=null;this.glyphs=[];for(var i=0;i<this.children.length;i++){var child=this.children[i];if(child.type=="font-face"){this.fontFace=child;if(child.style("font-family").hasValue()){svg.Definitions[child.style("font-family").value]=this}}else if(child.type=="missing-glyph")this.missingGlyph=child;else if(child.type=="glyph"){if(child.arabicForm!=""){this.isRTL=true;this.isArabic=true;if(typeof this.glyphs[child.unicode]=="undefined")this.glyphs[child.unicode]=[];this.glyphs[child.unicode][child.arabicForm]=child}else{this.glyphs[child.unicode]=child}}}};svg.Element.font.prototype=new svg.Element.ElementBase;svg.Element.fontface=function(node){this.base=svg.Element.ElementBase;this.base(node);this.ascent=this.attribute("ascent").value;

this.descent=this.attribute("descent").value;this.unitsPerEm=this.attribute("units-per-em").numValue()};svg.Element.fontface.prototype=new svg.Element.ElementBase;svg.Element.missingglyph=function(node){this.base=svg.Element.path;this.base(node);this.horizAdvX=0};svg.Element.missingglyph.prototype=new svg.Element.path;svg.Element.glyph=function(node){this.base=svg.Element.path;this.base(node);this.horizAdvX=this.attribute("horiz-adv-x").numValue();this.unicode=this.attribute("unicode").value;this.arabicForm=this.attribute("arabic-form").value};svg.Element.glyph.prototype=new svg.Element.path;svg.Element.text=function(node){this.captureTextNodes=true;this.base=svg.Element.RenderedElementBase;this.base(node);this.baseSetContext=this.setContext;this.setContext=function(ctx){this.baseSetContext(ctx);var textBaseline=this.style("dominant-baseline").toTextBaseline();if(textBaseline==null)textBaseline=this.style("alignment-baseline").toTextBaseline();if(textBaseline!=null)ctx.textBaseline=textBaseline};this.getBoundingBox=function(){var x=this.attribute("x").toPixels("x");var y=this.attribute("y").toPixels("y");var fontSize=this.parent.style("font-size").numValueOrDefault(svg.Font.Parse(svg.ctx.font).fontSize);return new svg.BoundingBox(x,y-fontSize,x+Math.floor(fontSize*2/3)*this.children[0].getText().length,y)};this.renderChildren=function(ctx){this.x=this.attribute("x").toPixels("x");this.y=this.attribute("y").toPixels("y");if(this.attribute("dx").hasValue())this.x+=this.attribute("dx").toPixels("x");if(this.attribute("dy").hasValue())this.y+=this.attribute("dy").toPixels("y");this.x+=this.getAnchorDelta(ctx,this,0);for(var i=0;i<this.children.length;i++){this.renderChild(ctx,this,i)}};this.getAnchorDelta=function(ctx,parent,startI){var textAnchor=this.style("text-anchor").valueOrDefault("start");if(textAnchor!="start"){var width=0;for(var i=startI;i<parent.children.length;i++){var child=parent.children[i];if(i>startI&&child.attribute("x").hasValue())break;width+=child.measureTextRecursive(ctx)}return-1*(textAnchor=="end"?width:width/2)}return 0};this.renderChild=function(ctx,parent,i){var child=parent.children[i];if(child.attribute("x").hasValue()){child.x=child.attribute("x").toPixels("x")+parent.getAnchorDelta(ctx,parent,i);if(child.attribute("dx").hasValue())child.x+=child.attribute("dx").toPixels("x")}else{if(child.attribute("dx").hasValue())parent.x+=child.attribute("dx").toPixels("x");child.x=parent.x}parent.x=child.x+child.measureText(ctx);if(child.attribute("y").hasValue()){child.y=child.attribute("y").toPixels("y");if(child.attribute("dy").hasValue())child.y+=child.attribute("dy").toPixels("y")}else{if(child.attribute("dy").hasValue())parent.y+=child.attribute("dy").toPixels("y");child.y=parent.y}parent.y=child.y;child.render(ctx);for(var i=0;i<child.children.length;i++){parent.renderChild(ctx,child,i)}}};svg.Element.text.prototype=new svg.Element.RenderedElementBase;svg.Element.TextElementBase=function(node){this.base=svg.Element.RenderedElementBase;this.base(node);this.getGlyph=function(font,text,i){var c=text[i];var glyph=null;if(font.isArabic){var arabicForm="isolated";if((i==0||text[i-1]==" ")&&i<text.length-2&&text[i+1]!=" ")arabicForm="terminal";if(i>0&&text[i-1]!=" "&&i<text.length-2&&text[i+1]!=" ")arabicForm="medial";if(i>0&&text[i-1]!=" "&&(i==text.length-1||text[i+1]==" "))arabicForm="initial";if(typeof font.glyphs[c]!="undefined"){glyph=font.glyphs[c][arabicForm];if(glyph==null&&font.glyphs[c].type=="glyph")glyph=font.glyphs[c]}}else{glyph=font.glyphs[c]}if(glyph==null)glyph=font.missingGlyph;return glyph};this.renderChildren=function(ctx){var customFont=this.parent.style("font-family").getDefinition();if(customFont!=null){var fontSize=this.parent.style("font-size").numValueOrDefault(svg.Font.Parse(svg.ctx.font).fontSize);var fontStyle=this.parent.style("font-style").valueOrDefault(svg.Font.Parse(svg.ctx.font).fontStyle);var text=this.getText();if(customFont.isRTL)text=text.split("").reverse().join("");var dx=svg.ToNumberArray(this.parent.attribute("dx").value);for(var i=0;i<text.length;i++){var glyph=this.getGlyph(customFont,text,i);var scale=fontSize/customFont.fontFace.unitsPerEm;ctx.translate(this.x,this.y);ctx.scale(scale,-scale);var lw=ctx.lineWidth;ctx.lineWidth=ctx.lineWidth*customFont.fontFace.unitsPerEm/fontSize;if(fontStyle=="italic")ctx.transform(1,0,.4,1,0,0);glyph.render(ctx);if(fontStyle=="italic")ctx.transform(1,0,-.4,1,0,0);ctx.lineWidth=lw;ctx.scale(1/scale,-1/scale);ctx.translate(-this.x,-this.y);this.x+=fontSize*(glyph.horizAdvX||customFont.horizAdvX)/customFont.fontFace.unitsPerEm;if(typeof dx[i]!="undefined"&&!isNaN(dx[i])){this.x+=dx[i]}}return}if(ctx.fillStyle!="")ctx.fillText(svg.compressSpaces(this.getText()),this.x,this.y);if(ctx.strokeStyle!="")ctx.strokeText(svg.compressSpaces(this.getText()),this.x,this.y)};this.getText=function(){};this.measureTextRecursive=function(ctx){var width=this.measureText(ctx);for(var i=0;i<this.children.length;i++){width+=this.children[i].measureTextRecursive(ctx)}return width};this.measureText=function(ctx){var customFont=this.parent.style("font-family").getDefinition();if(customFont!=null){var fontSize=this.parent.style("font-size").numValueOrDefault(svg.Font.Parse(svg.ctx.font).fontSize);var measure=0;var text=this.getText();if(customFont.isRTL)text=text.split("").reverse().join("");var dx=svg.ToNumberArray(this.parent.attribute("dx").value);for(var i=0;i<text.length;i++){var glyph=this.getGlyph(customFont,text,i);measure+=(glyph.horizAdvX||customFont.horizAdvX)*fontSize/customFont.fontFace.unitsPerEm;if(typeof dx[i]!="undefined"&&!isNaN(dx[i])){measure+=dx[i]}}return measure}var textToMeasure=svg.compressSpaces(this.getText());if(!ctx.measureText)return textToMeasure.length*10;ctx.save();this.setContext(ctx);var width=ctx.measureText(textToMeasure).width;ctx.restore();return width}};svg.Element.TextElementBase.prototype=new svg.Element.RenderedElementBase;svg.Element.tspan=function(node){this.captureTextNodes=true;this.base=svg.Element.TextElementBase;this.base(node);this.text=svg.compressSpaces(node.value||node.text||node.textContent||"");this.getText=function(){if(this.children.length>0){return""}return this.text}};svg.Element.tspan.prototype=new svg.Element.TextElementBase;svg.Element.tref=function(node){this.base=svg.Element.TextElementBase;this.base(node);this.getText=function(){var element=this.getHrefAttribute().getDefinition();if(element!=null)return element.children[0].getText()}};svg.Element.tref.prototype=new svg.Element.TextElementBase;svg.Element.a=function(node){this.base=svg.Element.TextElementBase;this.base(node);this.hasText=node.childNodes.length>0;for(var i=0;i<node.childNodes.length;i++){if(node.childNodes[i].nodeType!=3)this.hasText=false}this.text=this.hasText?node.childNodes[0].value:"";this.getText=function(){return this.text};this.baseRenderChildren=this.renderChildren;this.renderChildren=function(ctx){if(this.hasText){this.baseRenderChildren(ctx);var fontSize=new svg.Property("fontSize",svg.Font.Parse(svg.ctx.font).fontSize);svg.Mouse.checkBoundingBox(this,new svg.BoundingBox(this.x,this.y-fontSize.toPixels("y"),this.x+this.measureText(ctx),this.y))}else if(this.children.length>0){var g=new svg.Element.g;g.children=this.children;g.parent=this;g.render(ctx)}};this.onclick=function(){window.open(this.getHrefAttribute().value)};this.onmousemove=function(){svg.ctx.canvas.style.cursor="pointer"}};svg.Element.a.prototype=new svg.Element.TextElementBase;svg.Element.image=function(node){this.base=svg.Element.RenderedElementBase;this.base(node);var href=this.getHrefAttribute().value;if(href==""){return}var isSvg=href.match(/\.svg$/);svg.Images.push(this);this.loaded=false;if(!isSvg){this.img=document.createElement("img");if(svg.opts["useCORS"]==true){this.img.crossOrigin="Anonymous"}var self=this;this.img.onload=function(){self.loaded=true};this.img.onerror=function(){svg.log('ERROR: image "'+href+'" not found');self.loaded=true};this.img.src=href}else{this.img=svg.ajax(href);this.loaded=true}this.renderChildren=function(ctx){var x=this.attribute("x").toPixels("x");var y=this.attribute("y").toPixels("y");var width=this.attribute("width").toPixels("x");var height=this.attribute("height").toPixels("y");if(width==0||height==0)return;ctx.save();if(isSvg){ctx.drawSvg(this.img,x,y,width,height)}else{ctx.translate(x,y);svg.AspectRatio(ctx,this.attribute("preserveAspectRatio").value,width,this.img.width,height,this.img.height,0,0);ctx.drawImage(this.img,0,0)}ctx.restore()};this.getBoundingBox=function(){var x=this.attribute("x").toPixels("x");var y=this.attribute("y").toPixels("y");var width=this.attribute("width").toPixels("x");var height=this.attribute("height").toPixels("y");return new svg.BoundingBox(x,y,x+width,y+height)}};svg.Element.image.prototype=new svg.Element.RenderedElementBase;svg.Element.g=function(node){this.base=svg.Element.RenderedElementBase;this.base(node);this.getBoundingBox=function(){var bb=new svg.BoundingBox;for(var i=0;i<this.children.length;i++){bb.addBoundingBox(this.children[i].getBoundingBox())}return bb}};svg.Element.g.prototype=new svg.Element.RenderedElementBase;svg.Element.symbol=function(node){this.base=svg.Element.RenderedElementBase;this.base(node);this.render=function(ctx){}};svg.Element.symbol.prototype=new svg.Element.RenderedElementBase;svg.Element.style=function(node){this.base=svg.Element.ElementBase;this.base(node);var css="";for(var i=0;i<node.childNodes.length;i++){css+=node.childNodes[i].data}css=css.replace(/(\/\*([^*]|[\r\n]|(\*+([^*\/]|[\r\n])))*\*+\/)|(^[\s]*\/\/.*)/gm,"");css=svg.compressSpaces(css);var cssDefs=css.split("}");for(var i=0;i<cssDefs.length;i++){if(svg.trim(cssDefs[i])!=""){var cssDef=cssDefs[i].split("{");var cssClasses=cssDef[0].split(",");var cssProps=cssDef[1].split(";");for(var j=0;j<cssClasses.length;j++){var cssClass=svg.trim(cssClasses[j]);if(cssClass!=""){var props=svg.Styles[cssClass]||{};for(var k=0;k<cssProps.length;k++){var prop=cssProps[k].indexOf(":");var name=cssProps[k].substr(0,prop);var value=cssProps[k].substr(prop+1,cssProps[k].length-prop);if(name!=null&&value!=null){props[svg.trim(name)]=new svg.Property(svg.trim(name),svg.trim(value))}}svg.Styles[cssClass]=props;svg.StylesSpecificity[cssClass]=getSelectorSpecificity(cssClass);if(cssClass=="@font-face"){var fontFamily=props["font-family"].value.replace(/"/g,"");var srcs=props["src"].value.split(",");for(var s=0;s<srcs.length;s++){if(srcs[s].indexOf('format("svg")')>0){var urlStart=srcs[s].indexOf("url");var urlEnd=srcs[s].indexOf(")",urlStart);var url=srcs[s].substr(urlStart+5,urlEnd-urlStart-6);var doc=svg.parseXml(svg.ajax(url));var fonts=doc.getElementsByTagName("font");for(var f=0;f<fonts.length;f++){var font=svg.CreateElement(fonts[f]);svg.Definitions[fontFamily]=font}}}}}}}}};svg.Element.style.prototype=new svg.Element.ElementBase;svg.Element.use=function(node){this.base=svg.Element.RenderedElementBase;this.base(node);this.baseSetContext=this.setContext;this.setContext=function(ctx){this.baseSetContext(ctx);if(this.attribute("x").hasValue())ctx.translate(this.attribute("x").toPixels("x"),0);if(this.attribute("y").hasValue())ctx.translate(0,this.attribute("y").toPixels("y"))};var element=this.getHrefAttribute().getDefinition();this.path=function(ctx){if(element!=null)element.path(ctx)};this.getBoundingBox=function(){if(element!=null)return element.getBoundingBox()};this.renderChildren=function(ctx){if(element!=null){var tempSvg=element;if(element.type=="symbol"){tempSvg=new svg.Element.svg;tempSvg.type="svg";tempSvg.attributes["viewBox"]=new svg.Property("viewBox",element.attribute("viewBox").value);tempSvg.attributes["preserveAspectRatio"]=new svg.Property("preserveAspectRatio",element.attribute("preserveAspectRatio").value);tempSvg.attributes["overflow"]=new svg.Property("overflow",element.attribute("overflow").value);tempSvg.children=element.children}if(tempSvg.type=="svg"){if(this.attribute("width").hasValue())tempSvg.attributes["width"]=new svg.Property("width",this.attribute("width").value);if(this.attribute("height").hasValue())tempSvg.attributes["height"]=new svg.Property("height",this.attribute("height").value)}var oldParent=tempSvg.parent;tempSvg.parent=null;tempSvg.render(ctx);tempSvg.parent=oldParent}}};svg.Element.use.prototype=new svg.Element.RenderedElementBase;svg.Element.mask=function(node){this.base=svg.Element.ElementBase;this.base(node);this.apply=function(ctx,element){var x=this.attribute("x").toPixels("x");var y=this.attribute("y").toPixels("y");var width=this.attribute("width").toPixels("x");var height=this.attribute("height").toPixels("y");if(width==0&&height==0){var bb=new svg.BoundingBox;for(var i=0;i<this.children.length;i++){bb.addBoundingBox(this.children[i].getBoundingBox())}var x=Math.floor(bb.x1);var y=Math.floor(bb.y1);var width=Math.floor(bb.width());var height=Math.floor(bb.height())}var mask=element.attribute("mask").value;element.attribute("mask").value="";var cMask=document.createElement("canvas");cMask.width=x+width;cMask.height=y+height;var maskCtx=cMask.getContext("2d");this.renderChildren(maskCtx);var c=document.createElement("canvas");c.width=x+width;c.height=y+height;var tempCtx=c.getContext("2d");element.render(tempCtx);tempCtx.globalCompositeOperation="destination-in";tempCtx.fillStyle=maskCtx.createPattern(cMask,"no-repeat");tempCtx.fillRect(0,0,x+width,y+height);ctx.fillStyle=tempCtx.createPattern(c,"no-repeat");ctx.fillRect(0,0,x+width,y+height);element.attribute("mask").value=mask};this.render=function(ctx){}};svg.Element.mask.prototype=new svg.Element.ElementBase;svg.Element.clipPath=function(node){this.base=svg.Element.ElementBase;this.base(node);this.apply=function(ctx){var oldBeginPath=CanvasRenderingContext2D.prototype.beginPath;CanvasRenderingContext2D.prototype.beginPath=function(){};var oldClosePath=CanvasRenderingContext2D.prototype.closePath;CanvasRenderingContext2D.prototype.closePath=function(){};oldBeginPath.call(ctx);for(var i=0;i<this.children.length;i++){var child=this.children[i];if(typeof child.path!="undefined"){var transform=null;if(child.style("transform",false,true).hasValue()){transform=new svg.Transform(child.style("transform",false,true).value);transform.apply(ctx)}child.path(ctx);CanvasRenderingContext2D.prototype.closePath=oldClosePath;if(transform){transform.unapply(ctx)}}}oldClosePath.call(ctx);ctx.clip();CanvasRenderingContext2D.prototype.beginPath=oldBeginPath;CanvasRenderingContext2D.prototype.closePath=oldClosePath};this.render=function(ctx){}};svg.Element.clipPath.prototype=new svg.Element.ElementBase;svg.Element.filter=function(node){this.base=svg.Element.ElementBase;this.base(node);this.apply=function(ctx,element){var bb=element.getBoundingBox();var x=Math.floor(bb.x1);var y=Math.floor(bb.y1);var width=Math.floor(bb.width());var height=Math.floor(bb.height());var filter=element.style("filter").value;element.style("filter").value="";var px=0,py=0;for(var i=0;i<this.children.length;i++){var efd=this.children[i].extraFilterDistance||0;px=Math.max(px,efd);py=Math.max(py,efd)}var c=document.createElement("canvas");c.width=width+2*px;c.height=height+2*py;var tempCtx=c.getContext("2d");tempCtx.translate(-x+px,-y+py);element.render(tempCtx);for(var i=0;i<this.children.length;i++){if(typeof this.children[i].apply==="function"){this.children[i].apply(tempCtx,0,0,width+2*px,height+2*py)}}ctx.drawImage(c,0,0,width+2*px,height+2*py,x-px,y-py,width+2*px,height+2*py);element.style("filter",true).value=filter};this.render=function(ctx){}};svg.Element.filter.prototype=new svg.Element.ElementBase;svg.Element.feMorphology=function(node){this.base=svg.Element.ElementBase;this.base(node);this.apply=function(ctx,x,y,width,height){}};svg.Element.feMorphology.prototype=new svg.Element.ElementBase;svg.Element.feComposite=function(node){this.base=svg.Element.ElementBase;this.base(node);this.apply=function(ctx,x,y,width,height){}};svg.Element.feComposite.prototype=new svg.Element.ElementBase;svg.Element.feColorMatrix=function(node){this.base=svg.Element.ElementBase;this.base(node);var matrix=svg.ToNumberArray(this.attribute("values").value);switch(this.attribute("type").valueOrDefault("matrix")){case"saturate":var s=matrix[0];matrix=[.213+.787*s,.715-.715*s,.072-.072*s,0,0,.213-.213*s,.715+.285*s,.072-.072*s,0,0,.213-.213*s,.715-.715*s,.072+.928*s,0,0,0,0,0,1,0,0,0,0,0,1];break;case"hueRotate":var a=matrix[0]*Math.PI/180;var c=function(m1,m2,m3){return m1+Math.cos(a)*m2+Math.sin(a)*m3};matrix=[c(.213,.787,-.213),c(.715,-.715,-.715),c(.072,-.072,.928),0,0,c(.213,-.213,.143),c(.715,.285,.14),c(.072,-.072,-.283),0,0,c(.213,-.213,-.787),c(.715,-.715,.715),c(.072,.928,.072),0,0,0,0,0,1,0,0,0,0,0,1];break;case"luminanceToAlpha":matrix=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,.2125,.7154,.0721,0,0,0,0,0,0,1];break}function imGet(img,x,y,width,height,rgba){return img[y*width*4+x*4+rgba]}function imSet(img,x,y,width,height,rgba,val){img[y*width*4+x*4+rgba]=val}function m(i,v){var mi=matrix[i];return mi*(mi<0?v-255:v)}this.apply=function(ctx,x,y,width,height){var srcData=ctx.getImageData(0,0,width,height);for(var y=0;y<height;y++){for(var x=0;x<width;x++){var r=imGet(srcData.data,x,y,width,height,0);var g=imGet(srcData.data,x,y,width,height,1);var b=imGet(srcData.data,x,y,width,height,2);var a=imGet(srcData.data,x,y,width,height,3);imSet(srcData.data,x,y,width,height,0,m(0,r)+m(1,g)+m(2,b)+m(3,a)+m(4,1));imSet(srcData.data,x,y,width,height,1,m(5,r)+m(6,g)+m(7,b)+m(8,a)+m(9,1));imSet(srcData.data,x,y,width,height,2,m(10,r)+m(11,g)+m(12,b)+m(13,a)+m(14,1));imSet(srcData.data,x,y,width,height,3,m(15,r)+m(16,g)+m(17,b)+m(18,a)+m(19,1))}}ctx.clearRect(0,0,width,height);ctx.putImageData(srcData,0,0)}};svg.Element.feColorMatrix.prototype=new svg.Element.ElementBase;svg.Element.feGaussianBlur=function(node){this.base=svg.Element.ElementBase;this.base(node);this.blurRadius=Math.floor(this.attribute("stdDeviation").numValue());this.extraFilterDistance=this.blurRadius;this.apply=function(ctx,x,y,width,height){if(typeof stackBlur.canvasRGBA=="undefined"){svg.log("ERROR: StackBlur.js must be included for blur to work");return}ctx.canvas.id=svg.UniqueId();ctx.canvas.style.display="none";document.body.appendChild(ctx.canvas);stackBlur.canvasRGBA(ctx.canvas.id,x,y,width,height,this.blurRadius);document.body.removeChild(ctx.canvas)}};svg.Element.feGaussianBlur.prototype=new svg.Element.ElementBase;svg.Element.title=function(node){};svg.Element.title.prototype=new svg.Element.ElementBase;svg.Element.desc=function(node){};svg.Element.desc.prototype=new svg.Element.ElementBase;svg.Element.MISSING=function(node){svg.log("ERROR: Element '"+node.nodeName+"' not yet implemented.")};svg.Element.MISSING.prototype=new svg.Element.ElementBase;svg.CreateElement=function(node){var className=node.nodeName.replace(/^[^:]+:/,"");className=className.replace(/\-/g,"");var e=null;if(typeof svg.Element[className]!="undefined"){e=new svg.Element[className](node)}else{e=new svg.Element.MISSING(node)}e.type=node.nodeName;return e};svg.load=function(ctx,url){svg.loadXml(ctx,svg.ajax(url))};svg.loadXml=function(ctx,xml){svg.loadXmlDoc(ctx,svg.parseXml(xml))};svg.loadXmlDoc=function(ctx,dom){svg.init(ctx);var mapXY=function(p){var e=ctx.canvas;while(e){p.x-=e.offsetLeft;p.y-=e.offsetTop;e=e.offsetParent}if(window.scrollX)p.x+=window.scrollX;if(window.scrollY)p.y+=window.scrollY;return p};if(svg.opts["ignoreMouse"]!=true){ctx.canvas.onclick=function(e){var p=mapXY(new svg.Point(e!=null?e.clientX:event.clientX,e!=null?e.clientY:event.clientY));svg.Mouse.onclick(p.x,p.y)};ctx.canvas.onmousemove=function(e){var p=mapXY(new svg.Point(e!=null?e.clientX:event.clientX,e!=null?e.clientY:event.clientY));svg.Mouse.onmousemove(p.x,p.y)}}var e=svg.CreateElement(dom.documentElement);e.root=true;e.addStylesFromStyleDefinition();var isFirstRender=true;var draw=function(){svg.ViewPort.Clear();if(ctx.canvas.parentNode)svg.ViewPort.SetCurrent(ctx.canvas.parentNode.clientWidth,ctx.canvas.parentNode.clientHeight);if(svg.opts["ignoreDimensions"]!=true){if(e.style("width").hasValue()){ctx.canvas.width=e.style("width").toPixels("x");ctx.canvas.style.width=ctx.canvas.width+"px"}if(e.style("height").hasValue()){ctx.canvas.height=e.style("height").toPixels("y");ctx.canvas.style.height=ctx.canvas.height+"px"}}var cWidth=ctx.canvas.clientWidth||ctx.canvas.width;var cHeight=ctx.canvas.clientHeight||ctx.canvas.height;if(svg.opts["ignoreDimensions"]==true&&e.style("width").hasValue()&&e.style("height").hasValue()){cWidth=e.style("width").toPixels("x");cHeight=e.style("height").toPixels("y")}svg.ViewPort.SetCurrent(cWidth,cHeight);if(svg.opts["offsetX"]!=null)e.attribute("x",true).value=svg.opts["offsetX"];if(svg.opts["offsetY"]!=null)e.attribute("y",true).value=svg.opts["offsetY"];if(svg.opts["scaleWidth"]!=null||svg.opts["scaleHeight"]!=null){var xRatio=null,yRatio=null,viewBox=svg.ToNumberArray(e.attribute("viewBox").value);if(svg.opts["scaleWidth"]!=null){if(e.attribute("width").hasValue())xRatio=e.attribute("width").toPixels("x")/svg.opts["scaleWidth"];else if(!isNaN(viewBox[2]))xRatio=viewBox[2]/svg.opts["scaleWidth"]}if(svg.opts["scaleHeight"]!=null){if(e.attribute("height").hasValue())yRatio=e.attribute("height").toPixels("y")/svg.opts["scaleHeight"];else if(!isNaN(viewBox[3]))yRatio=viewBox[3]/svg.opts["scaleHeight"]}if(xRatio==null){xRatio=yRatio}if(yRatio==null){yRatio=xRatio}e.attribute("width",true).value=svg.opts["scaleWidth"];e.attribute("height",true).value=svg.opts["scaleHeight"];e.style("transform",true,true).value+=" scale("+1/xRatio+","+1/yRatio+")"}if(svg.opts["ignoreClear"]!=true){ctx.clearRect(0,0,cWidth,cHeight)}e.render(ctx);if(isFirstRender){isFirstRender=false;if(typeof svg.opts["renderCallback"]=="function")svg.opts["renderCallback"](dom)}};var waitingForImages=true;if(svg.ImagesLoaded()){waitingForImages=false;draw()}svg.intervalID=setInterval(function(){var needUpdate=false;if(waitingForImages&&svg.ImagesLoaded()){waitingForImages=false;needUpdate=true}if(svg.opts["ignoreMouse"]!=true){needUpdate=needUpdate|svg.Mouse.hasEvents()}if(svg.opts["ignoreAnimation"]!=true){for(var i=0;i<svg.Animations.length;i++){needUpdate=needUpdate|svg.Animations[i].update(1e3/svg.FRAMERATE)}}if(typeof svg.opts["forceRedraw"]=="function"){if(svg.opts["forceRedraw"]()==true)needUpdate=true}if(needUpdate){draw();svg.Mouse.runEvents()}},1e3/svg.FRAMERATE)};svg.stop=function(){if(svg.intervalID){clearInterval(svg.intervalID)}};svg.Mouse=new function(){this.events=[];this.hasEvents=function(){return this.events.length!=0};this.onclick=function(x,y){this.events.push({type:"onclick",x:x,y:y,run:function(e){if(e.onclick)e.onclick()}})};this.onmousemove=function(x,y){this.events.push({type:"onmousemove",x:x,y:y,run:function(e){if(e.onmousemove)e.onmousemove()}})};this.eventElements=[];this.checkPath=function(element,ctx){for(var i=0;i<this.events.length;i++){var e=this.events[i];if(ctx.isPointInPath&&ctx.isPointInPath(e.x,e.y))this.eventElements[i]=element}};this.checkBoundingBox=function(element,bb){for(var i=0;i<this.events.length;i++){var e=this.events[i];if(bb.isPointInBox(e.x,e.y))this.eventElements[i]=element}};this.runEvents=function(){svg.ctx.canvas.style.cursor="";for(var i=0;i<this.events.length;i++){var e=this.events[i];var element=this.eventElements[i];while(element){e.run(element);element=element.parent}}this.events=[];this.eventElements=[]}};return svg}if(typeof CanvasRenderingContext2D!="undefined"){CanvasRenderingContext2D.prototype.drawSvg=function(s,dx,dy,dw,dh){canvg(this.canvas,s,{ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true,offsetX:dx,offsetY:dy,scaleWidth:dw,scaleHeight:dh})}}return canvg});(function(){window.MemoryCache={_data:{},set:function(key,value,timeoutValue){timeoutValue=timeoutValue||3e5;var self=this;var obj={};if(this._data[key]){try{clearTimeout(this._data[key].timeout)}catch(ex){}obj=this._data[key]}else{this._data[key]=obj}obj.timeout=setTimeout(function(){self._data[key]=null},timeoutValue);obj.value=value},del:function(key){if(!this._data[key]){return}try{clearTimeout(this._data[key].timeout)}catch(ex){}delete this._data[key]},get:function(key){if(!this._data[key]){return null}return this._data[key].value}}})();(function(){var isFirstInstall=false;function runMigrations(lastV,currentV){console.log("Run migrations. lastver:",lastV,"currentver:",currentV);var migrations=[];var migrationsCompleted={};var countRunned=0;migrations.push(function(done){if(lastV<=673||!lastV){countRunned++;console.log("Migrate local thumbs to file system");fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.Storage.listDials(null,null,null,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,apNext){if(!dial.thumb||typeof dial.thumb!="string"||dial.thumb.indexOf("data")!==0){return apNext()}fvdSpeedDial.Storage.updateDial(dial.id,{thumb:dial.thumb},apNext)},next)})},function(next){fvdSpeedDial.Storage.MostVisited.getExtendedData(function(data){fvdSpeedDial.Utils.Async.arrayProcess(data,function(item,apNext){if(!item.thumb||typeof item.thumb!="string"||item.thumb.indexOf("data")!==0){return apNext()}fvdSpeedDial.Storage.MostVisited.updateData(item.id,{thumb:item.thumb},apNext)},next)})},function(next){fvdSpeedDial.Storage.getMisc("sd.background",function(data){if(!data||typeof data!="string"||data.indexOf("data:")===-1){return next()}fvdSpeedDial.Storage.setMisc("sd.background",data,next)})},function(){migrationsCompleted.datauri2fs=true;done()}])}else{done()}});migrations.push(function(done){if(lastV<=679||!lastV){if(migrationsCompleted.datauri2fs){return done()}countRunned++;fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.Storage.listDials(null,null,null,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,apNext){if(!dial.thumb||typeof dial.thumb!="string"||dial.thumb.indexOf("filesystem:")!==0){return apNext()}fvdSpeedDial.Storage.FileSystem.getEntryByURL(dial.thumb,function(err,entry){if(err){return apNext()}fvdSpeedDial.Storage.FileSystem.read(entry.fullPath,function(err,contents){if(err){return apNext()}fvdSpeedDial.Storage.FileSystem.write(entry.fullPath,contents,function(err){apNext()})})})},next)})},function(next){fvdSpeedDial.Storage.getMisc("sd.background",function(data){if(!data||typeof data!="string"||data.indexOf("filesystem:")!==0){return next()}fvdSpeedDial.Storage.FileSystem.getEntryByURL(data,function(err,entry){if(err){return next()}fvdSpeedDial.Storage.FileSystem.read(entry.fullPath,function(err,contents){if(err){return next()}fvdSpeedDial.Storage.FileSystem.write(entry.fullPath,contents,function(err){next()})})})})},function(){done()}])}else{done()}});migrations.push(function(done){if(lastV<=680||!lastV){if(migrationsCompleted.datauri2fs){return done()}countRunned++;fvdSpeedDial.Utils.Async.chain([function(next){fvdSpeedDial.Storage.listDials(null,null,null,function(dials){fvdSpeedDial.Utils.Async.arrayProcess(dials,function(dial,apNext){if(!dial.thumb||typeof dial.thumb!="string"||dial.thumb.indexOf("filesystem:")!==0){return apNext()}fvdSpeedDial.Storage.FileSystem.getEntryByURL(dial.thumb,function(err,entry){if(err){return apNext()}fvdSpeedDial.Storage.FileSystem.readAsDataURL(entry.fullPath,function(err,contents){if(err){return apNext()}fvdSpeedDial.Storage.FileSystem.redundancyStorage.delete(entry.fullPath);fvdSpeedDial.Storage.updateDial(dial.id,{thumb:contents},apNext)})})},next)})},function(){done()}])}else{done()}});migrations.push(function(done){if(currentV==721){fvdSpeedDial.Prefs.set("sd.enable_search",true)}done()});migrations.push(function(){console.log("Migrations process completed, runned",countRunned,"migrations");chrome.runtime.sendMessage({action:"forceRebuild"})});fvdSpeedDial.Utils.Async.chain(migrations)}chrome.runtime.onInstalled.addListener(function(details){if(details.reason=="install"){isFirstInstall=true}});Broadcaster.onMessage.addListener(function(msg){if(msg.action=="storage:connected"){var currentV=chrome.runtime.getManifest().version,lastV=localStorage["__v2vmigrations_last_ver"];currentV=parseInt(currentV.replace(/\./g,""),10);if(lastV){lastV=parseInt(lastV.replace(/\./g,""),10)}if(lastV!=currentV){localStorage["__v2vmigrations_last_ver"]=chrome.runtime.getManifest().version;if(isFirstInstall){return}runMigrations(lastV,currentV)}}})})();(function(){Broadcaster.onMessage.addListener(function(message){if(message.action==="web:pp-donate-success"){localStorage["paypal-donate-state"]=JSON.stringify({date:(new Date).getTime()})}})})();